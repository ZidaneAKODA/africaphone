<!--
  üì± Application Mobile-First 100 % ‚Äì Optimis√©e UNIQUEMENT pour smartphones.
  üé® Style ultra-professionnel exig√© √† CHAQUE modification.
  ü§ñ je m'adresse a toi CHATGPT
-->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>BookShop</title>


  <link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
   <style>
    body { visibility: hidden; }
  </style>

  <!-- Google Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
 <!-- 1) Firebase (compat) SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-functions-compat.js"></script>

  <!-- 2) Initialisation Firebase & Auth -->
  <script>
    // Remplace par ta config
    const firebaseConfig = {
      apiKey: "AIzaSyCvNZ5lhKdP_6W-eRle-7zCmFqejSfRuto",
      authDomain: "shoptel-35c7e.firebaseapp.com",
      projectId: "shoptel-35c7e",
      storageBucket: "shoptel-35c7e.appspot.com",
      messagingSenderId: "541177101809",
      appId: "1:541177101809:web:5ae3ea186f198558371850",
      measurementId: "G-VH4MCV6Y6E"
    };

  // 1) Initialise l‚Äôapp et Auth UNE SEULE FOIS
  firebase.initializeApp(firebaseConfig);


  // 2) D√®s que l‚Äô√©tat d‚Äôauth est connu‚Ä¶
  
const auth   = firebase.auth();
const fn     = firebase.functions();
const db = firebase.firestore();

// fonction callable pour v√©rifier le code
const verifyActivationCode = fn.httpsCallable('verifyActivationCode');



  
  </script>

 
  

  <style>
   /* ‚Äî‚Äî‚Äî Gestion de la visibilit√© des ‚Äúpages‚Äù ‚Äî‚Äî‚Äî */
main.page {
  display: none;           /* cach√©e par d√©faut */
  flex: 1 1 auto;          /* occupe l‚Äôespace restant */
  width: 100%;             /* toute la largeur */
  overflow-y: auto;        /* scroll interne si besoin */
  /* padding-bottom pour laisser la place √† la nav en bas */
  padding-bottom: calc(56px + env(safe-area-inset-bottom));
}

main.page.visible {
  display: flex;           /* devient visible et flex */
  flex-direction: column;
}


    :root{
      --primary-text:#222;
      --secondary-text:#555;
      --border-radius-pill:2rem;
      --ebay-red:#e53238;
      --ebay-blue:#0064d2;
      --ebay-yellow:#f5af02;
      --ebay-green:#86b817;
      --accent:#0064d2;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

    html,body{
      width:100%;height:100%;
      font-family:'Roboto',sans-serif;
      background:#fff;color:var(--primary-text);
      -webkit-font-smoothing:antialiased;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
      display:flex;flex-direction:column;
      height:100vh;height:100dvh;
    }

    /* PAGE MANAGEMENT */
    /* Nouveau code √† copier-coller */
.page {
  display: none;           /* cach√©e par d√©faut */
  flex: 1 1 auto;          /* grandit pour remplir l‚Äôespace */
  width: 100%;             /* occupe toute la largeur */
  overflow-y: auto;        /* scroll interne si besoin */
}

.page.visible {
  display: flex;           /* devient un flex-container vertical */
  flex-direction: column;
}


    /* COMMON STYLES */
    header{padding:1rem 1rem 0.5rem}
    .cart{margin-left:auto;font-size:1.6rem;color:var(--primary-text)}

    .search-wrapper{
      margin-top:0.75rem;position:relative
    }
    .search-wrapper input{
      width:100%;padding:0.75rem 3.25rem 0.75rem 2.75rem;
      border:none;border-radius:var(--border-radius-pill);
      background:#f4f4f4;font-size:1rem;outline:none;cursor:pointer
    }
    .search-wrapper .bi-search{
      position:absolute;left:1rem;top:50%;
      transform:translateY(-50%);font-size:1.1rem;color:var(--secondary-text)
    }
    .search-wrapper .actions{
      position:absolute;right:0.75rem;top:50%;
      transform:translateY(-50%);display:flex;gap:0.5rem;
      font-size:1.6rem;color:var(--secondary-text)
    }

    .signin-card{text-align:center;margin:0.5rem 0 1.2rem}
    .signin-card p{
      font-size:1.05rem;color:var(--secondary-text);
      margin-bottom:1rem;line-height:1.4
    }
    .signin-actions{display:flex;justify-content:center;gap:1rem}

    .btn-outline{
      flex:0 0 42%;padding:0.7rem 1rem;border:2px solid var(--accent);
      border-radius:var(--border-radius-pill);background:#fff;
      font-weight:500;color:var(--accent);font-size:1rem;
      transition:all 0.2s ease;outline:none
    }
    .btn-outline:active{background:var(--accent);color:#fff}

    .promo-block{
      background:#f5f5f5;padding:1.5rem 1rem;margin-bottom:1.2rem
    }
    .promo-block h2{font-size:1.6rem;margin-bottom:0.5rem}
    .promo-block p{
      color:var(--secondary-text);font-size:1rem;line-height:1.4;margin-bottom:1rem
    }
    .btn-primary{
      padding:0.85rem 1.5rem;background:var(--accent);color:#fff;border:none;
      border-radius:var(--border-radius-pill);font-size:1rem;font-weight:600;
      box-shadow:0 4px 10px rgba(0,0,0,0.1);outline:none
    }
    .btn-primary:active{background:#014fa5}

    .trending{padding:0 1rem 5.5rem}
    .trending h3{font-size:1.35rem;margin-bottom:0.75rem}
    .trend-list{
      display:flex;gap:1.25rem;overflow-x:auto;padding-bottom:0.5rem;
      -ms-overflow-style:none;scrollbar-width:none
    }
    .trend-list::-webkit-scrollbar{display:none}
    .trend-item{
      flex:0 0 auto;text-align:center;user-select:none;padding:0.5rem
    }
    .trend-item img{
      width:5.3rem;height:5.3rem;border-radius:50%;object-fit:cover;
      box-shadow:0 2px 6px rgba(0,0,0,0.12)
    }
    .trend-item .product-name{display:block;margin-top:0.5rem;font-weight:500}
    .trend-item .price{
      display:block;margin:0.25rem 0 0.75rem;color:var(--ebay-red);font-weight:600
    }
    .btn-add{font-size:0.85rem;padding:0.4rem 0.8rem}

    /* NAVIGATION BAR */
    nav{
      position:fixed;bottom:0;left:0;width:100%;background:#fff;
      border-top:1px solid #e0e0e0;z-index:30
    }
    .nav-inner{display:flex;justify-content:space-evenly;align-items:center;padding:0.4rem 0}
    .nav-link{
      flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
      font-size:0.8rem;color:var(--secondary-text);outline:none;user-select:none;
      position:relative;overflow:hidden;padding:0.6rem 0;border-radius:var(--border-radius-pill);
      background:none;border:none;cursor:pointer;text-decoration:none
    }
    .nav-link i{font-size:1.25rem}
    .nav-link.active{color:var(--accent);background:rgba(0,100,210,0.12)}

    /* RIPPLE EFFECT */
    .ripple{
      position:absolute;border-radius:50%;transform:scale(0);
      background:rgba(0,100,210,0.25);animation:ripple 600ms linear;pointer-events:none
    }
    @keyframes ripple{to{transform:scale(4);opacity:0}}

    /* CATALOG OVERLAY (devient id="catalog") */
    #catalog{
      position:fixed;inset:0;z-index:20;padding:1rem;background:#fff;
      display:flex;flex-direction:column;height:100vh;
      opacity:0;pointer-events:none;transform:translateY(2%);
      transition:opacity 0.3s ease,transform 0.3s ease
    }
    #catalog.visible{
      opacity:1;pointer-events:auto;transform:translateY(0)
    }

    /* === Home page actions === */
    .home-actions{
      display:flex;justify-content:space-around;gap:1rem;padding:1rem
    }
    .btn-action{
      flex:1;display:flex;align-items:center;justify-content:center;gap:0.5rem;
      padding:0.8rem 1rem;border:none;border-radius:var(--border-radius-pill);
      font-size:1rem;font-weight:500;box-shadow:0 2px 6px rgba(0,0,0,0.12);
      transition:transform 0.1s ease,box-shadow 0.1s ease;color:#fff;cursor:pointer
    }
    .btn-action:active{transform:translateY(1px);box-shadow:0 1px 3px rgba(0,0,0,0.2)}
    .btn-sell{background:var(--ebay-green)}
    .btn-buy {background:var(--ebay-blue)}

    /* === Stock info card === */
    .stock-card{
      background:var(--ebay-yellow);border-radius:var(--border-radius-pill);
      margin:0 1rem 1.5rem;padding:0.75rem 1rem;text-align:center;
      box-shadow:0 2px 6px rgba(0,0,0,0.1)
    }
    .stock-count{font-size:1.8rem;font-weight:700;color:var(--primary-text)}
    .stock-label{font-size:0.95rem;color:var(--secondary-text)}

    /* ---------- Info cards sans ombre, avec cadre ---------- */
.info-cards {
  display: flex;
  gap: 0.5rem;                /* espace r√©duit */
  padding: 0.5rem 1rem;       /* haut/bas + cot√©s */
  margin-bottom: 0.5rem;      /* pour espacer du contenu suivant */
  overflow-x: auto;           /* scroll si besoin */
}

.info-card {
  flex: 1;
  background: #fff;                     /* fond blanc pour bien contraster */
  border: 1px solid #ddd;              /* cadre fin, gris clair */
  border-radius: 0.5rem;               /* bords l√©g√®rement arrondis */
  padding: 0.6rem;                      /* padding interne r√©duit */
  text-align: center;
  min-width: 0;                         /* emp√™che le d√©passement */
}

.info-number {
  font-size: 1.2rem;                    /* taille de police compacte */
  font-weight: 600;
  color: var(--ebay-blue);
  line-height: 1.2;
}

.info-label {
  font-size: 0.75rem;                   /* l√©gende plus petite */
  color: var(--secondary-text);
  margin-top: 0.2rem;
}
.info-cards {
  /* transition douce sur opacit√© et hauteur */
  transition: opacity 0.3s ease, max-height 0.3s ease, margin-bottom 0.3s ease, padding 0.3s ease;
  /* fixer une hauteur max suffisante pour le contenu */
  max-height: 200px;        /* ajustez selon la hauteur de vos cards */
  overflow: hidden;
}

.info-cards.fade-out {
  opacity: 0;
  max-height: 0;
  margin-bottom: 0;
  padding-top: 0;
  padding-bottom: 0;
  pointer-events: none;     /* pour ne plus capter les clics */
}


/* Add this below your existing .info-card styles */

.books-list {
  display: flex;
  flex-direction: column;      /* vertical stack */
  gap: 1rem;                   /* space between cards */
  padding: 1rem;               /* inner spacing */
}

.book-card {
  border: 1px solid #ddd;
  border-radius: 0.5rem;
  padding: 1rem;
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.book-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--primary-text);
}

.book-price {
  font-size: 1rem;
  font-weight: 500;
  color: var(--ebay-red);
  margin-bottom: 0.25rem;
}

.book-quantity {
  font-size: 0.9rem;
  color: var(--secondary-text);
}


/* R√©duire l‚Äôespace au-dessus de la barre de recherche sur la page Catalog */
main#catalog > header {
  padding-top: 0.5rem; /* Avant : 1rem ; ajustez √† votre go√ªt */
}

/* (Optionnel) Si vous pr√©f√©rez bouger la barre elle-m√™me */
main#catalog .search-wrapper {
  margin-top: -0.25rem; /* d√©place la barre vers le haut */
}

/* 1) On force la carte √† 100% de la largeur du conteneur */
.books-list .book-card {
  width: 100%;               /* pleine largeur */
  box-sizing: border-box;    /* inclut le padding/les bordures */
  margin: 0 auto;            /* centre au cas o√π tu fixes un max-width */
}

/* dans ta feuille de styles, apr√®s les d√©finitions existantes */

main#catalog {
  padding: 0;
  margin: 0;
}





  </style>
</head>

<body>

  <script>
  class AppInput extends HTMLElement {
    constructor() {
      super();
      const shadow = this.attachShadow({ mode: 'open' });
      const inp = document.createElement('input');

      // 1) Ajoute les attributs anti-autocomplete
      inp.setAttribute('autocomplete', 'off');
      inp.setAttribute('autocorrect',  'off');
      inp.setAttribute('autocapitalize', 'none');
      inp.setAttribute('spellcheck',    'false');

      // 2) Refl√®te √† la vol√©e les attributs usuels pass√©s sur <app-input>
      ['type','placeholder','name','id','value','list'].forEach(name => {
        if (this.hasAttribute(name)) {
          inp.setAttribute(name, this.getAttribute(name));
        }
      });

      // 3) R√©injecte dans le DOM
      shadow.appendChild(inp);
    }
  }

  customElements.define('app-input', AppInput);
</script>


  <!-- HOME PAGE -->
  <main id="home" class="page visible">
    <header><h2 style="padding:1rem">Acceuil</h2></header>

    <!-- Action buttons -->
    <div class="home-actions">
      <button class="btn-action btn-sell" data-hash="sell" aria-label="Sell">
        <i class="bi bi-tag-fill"></i><span>Vendre</span>
      </button>
      <button class="btn-action btn-buy" data-hash="supply" aria-label="Approvisionnement">
        <i class="bi bi-cart-fill"></i><span>Approvisionnement</span>
      </button>

      <!-- Bouton PWA hidden par d√©faut -->
<button id="btn-install" class="btn-primary"
        style="display:none;margin:0 1rem 1rem 1rem;">
  <i class="bi bi-download" style="margin-right:0.5rem;"></i>
  Installer l‚Äôapplication
</button>

    </div>
  </main>

  <!-- SELL PAGE -->
<main id="sell" class="page">
  <!-- Styles sp√©cifiques √† la page SELL -->
  <style>
/* === Styles sp√©cifiques √† la page SELL === */
#sell .sell-header {
  display: flex;
  align-items: center;
  padding: 0.75rem 1rem;
  background: #fff;
  border-bottom: 1px solid #e0e0e0;
}

#sell .sell-header .btn-close {
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0.5rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--primary-text);
  margin-right: 0.75rem;
  cursor: pointer;
  outline: none;
}

#sell .sell-header .search-wrapper {
  flex: 1;
  position: relative;
  margin-top: 0;
}

#sell .sell-header .search-wrapper .bi-search {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.1rem;
  color: var(--secondary-text);
}

#sell .sell-header #search-input-sell {
  width: 100%;
  padding: 0.75rem 2.5rem;
  border: none;
  border-radius: var(--border-radius-pill);
  font-size: 1rem;
  outline: none;
}

#sell .sell-header .search-wrapper .actions {
  position: absolute;
  right: 1rem;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 0.5rem;
  font-size: 1.6rem;
  color: var(--secondary-text);
}

/* === Styles pour les book-cards et le bouton d'ajout au panier === */
#sell .book-card {
  position: relative;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 0.5rem;
  padding: 1rem;
  margin-bottom: 1rem;
}

#sell .book-card .btn-add-to-cart {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  width: 2.5rem;
  height: 2.5rem;
  border: none;
  border-radius: 50%;
  background: var(--ebay-blue);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 1.4rem;
  cursor: pointer;
  box-shadow: none;
  transition: background 0.2s ease;
}

#sell .book-card .btn-add-to-cart:hover {
  background: #0052a3;
}

#sell .book-card .btn-add-to-cart:active {
  background: #004080;
}
/* apr√®s vos styles existants, id√©alement √† la toute fin de votre feuille */
main.page {
  /* 56px = hauteur approximative de votre nav + 1rem de marge de confort */
  padding-bottom: calc(56px + env(safe-area-inset-bottom));
}


</style>


  <!-- Barre de recherche (mise √† jour) -->
  <header class="sell-header">
    <button class="btn-close" data-hash="home" aria-label="Quitter la page de vente">
      <i class="bi bi-x-lg"></i>
    </button>
    <div class="search-wrapper">
      <i class="bi bi-search"></i>
      <input
        type="search"
        id="search-input-sell"
        placeholder="Rechercher"
        aria-label="Recherche catalogue"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
      >
      <div class="actions">
        <i class="bi bi-cart"></i>
      </div>
    </div>
  </header>

  <!-- Liste des livres -->
  <div id="catalog-results-sell">
    <div class="books-list">
     <div class="book-card">
  <h4 class="book-title">The Great Gatsby</h4>
  <p class="book-price">$10.99</p>
  <p class="book-quantity">Quantity: 3</p>

  <!-- Nouveau bouton d'ajout -->
  <button class="btn-add-to-cart" aria-label="Ajouter au panier">
    <i class="bi bi-cart-plus"></i>
  </button>
</div>

      <div class="book-card">
        <h4 class="book-title">1984</h4>
        <p class="book-price">$8.50</p>
        <p class="book-quantity">Quantity: 5</p>
      </div>
      <!-- r√©p√©tez autant de .book-card que n√©cessaire -->
    </div>
  </div>
</main>

<!-- APPROVISIONNEMENT PAGE -->
<main id="supply" class="page">
  <style>
    /* === Styles Approvisionnement === */
    header#supply-header {
      padding: 1rem;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
    }
    header#supply-header h2 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary-text);
    }

    .books-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
    }
/* Chip ‚ÄúAjouter un livre‚Äù ‚Äì mobile-only */
.search-noresult {
  display: inline-flex;
  align-items: center;
  padding: 0.75rem 1rem;                 /* plus confortable au pouce */
  border-radius: var(--border-radius-pill);
  background: rgba(0,100,210,0.1);
  color: var(--accent);
  font-size: 1rem;
  line-height: 1.2;
  cursor: pointer;
  user-select: none;
  /* on ne met plus de pseudo-hover */
  transition: background 0.2s;
}
.search-noresult:active {
  background: rgba(0,100,210,0.2);      /* feedback tactile */
}
.search-noresult i {
  margin-left: 0.5rem;
  font-size: 1.3rem;
  color: var(--accent);
}


    .book-card {
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      padding: 1rem;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      position: relative;
    }
    .book-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--primary-text);
    }
    .book-quantity {
      font-size: 0.9rem;
      color: var(--secondary-text);
      margin-bottom: 0.25rem;
    }
    .book-price {
      font-size: 1rem;
      font-weight: 500;
      color: var(--ebay-red);
      margin-bottom: 0.25rem;
    }
    .book-date {
      font-size: 0.75rem;
      color: var(--secondary-text);
    }

    /* Floating Action Button */
    .fab {
      position: fixed;
      bottom: calc(56px + env(safe-area-inset-bottom) + 1rem);
      right: 1rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--ebay-green);
      color: #fff;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 30;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .fab:active {
      background: #5ea83a;
    }
    /* Skeleton loader */
.skeleton-batch-card {
  background: #f4f4f4;
  height: 100px;
  margin: 0.75rem 1rem;
  border-radius: 0.5rem;
  animation: pulse 1.5s infinite ease-in-out;
}

@keyframes pulse {
  0%   { opacity: 1; }
  50%  { opacity: 0.4; }
  100% { opacity: 1; }
}

/* Nouvelle batch card */
.supply-batch-card {
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 0.5rem;
  margin: 0.75rem 1rem;
  padding: 1rem;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.supply-batch-card header {
  display: flex;
  justify-content: space-between;
  align-items: baseline;
  margin-bottom: 0.5rem;
}

.supply-batch-card header strong {
  font-size: 1rem;
}

.supply-batch-card header small {
  font-size: 0.75rem;
  color: var(--secondary-text);
}

.supply-batch-card ul {
  list-style: none;
  padding-left: 0;
  margin: 0;
}

.supply-batch-card li {
  font-size: 0.9rem;
  margin-bottom: 0.25rem;
}

  </style>

  <!-- En-t√™te -->
  <header id="supply-header">
    <h2>Approvisionnement</h2>
  </header>

  <!-- Liste hard-cod√©e des approvisionnements pass√©s -->
  <div id="supply-list" class="books-list">
  </div>

  <!-- Bouton flottant ‚ÄúNouvel approvisionnement‚Äù -->
  <button id="btn-new-supply" class="fab" aria-label="Nouvel approvisionnement">
    <i class="bi bi-plus-lg"></i>
  </button>

  <script>
    // Gestion du clic sur le FAB
    document.getElementById('btn-new-supply')
      .addEventListener('click', () => {
        // Ex : passer √† une page/#new-supply ou ouvrir un modal
        location.hash = 'new-supply';
      });
  </script>
  <script>
  auth.onAuthStateChanged(user => {
    if (!user) {
      // rediriger si pas connect√©
      return window.location.replace('login.html');
    }

    const suppliesRef = db
      .collection('users')
      .doc(user.uid)
      .collection('supplies')
      .orderBy('date', 'desc');

    const supplyListEl = document.getElementById('supply-list');

    // ‚ë† Skeleton loader en attendant Firestore
    supplyListEl.innerHTML = Array(3)
      .fill('')
      .map(() => '<div class="skeleton-batch-card"></div>')
      .join('');

    // ‚ë° On stocke la fonction pour pouvoir se d√©sabonner
    const unsubscribe = suppliesRef.onSnapshot(snapshot => {
      supplyListEl.innerHTML = ''; // on vide √† chaque update

      if (snapshot.empty) {
        supplyListEl.innerHTML = '<p style="padding:1rem;color:#555;">Aucun approvisionnement pour l‚Äôinstant.</p>';
        return;
      }

      snapshot.forEach(doc => {
        const supply = doc.data();
        const dateObj = supply.date?.toDate() || new Date();
        const dateStr = dateObj.toLocaleDateString('fr-FR', {
          day: '2-digit', month: '2-digit', year: 'numeric'
        });

        // Calcul du total du batch
        const totalBatch = supply.lines.reduce((sum, l) => sum + l.quantity * l.unitCost, 0);

        // Cr√©ation de la carte
        const batchCard = document.createElement('div');
        batchCard.className = 'supply-batch-card';
        batchCard.innerHTML = `
          <header>
            <strong>${supply.supplierName}</strong>
            <small>Le ${dateStr} ‚Ä¢ ${totalBatch.toLocaleString('fr-FR', {
              style: 'currency', currency: 'XOF'
            })}</small>
          </header>
          <ul>
            ${supply.lines.map(line =>
              `<li>
                ${line.title} ‚Äì Qt√© : ${line.quantity}, PU : ${line.unitCost.toLocaleString('fr-FR',{
                  style:'currency',currency:'XOF'
                })}
              </li>`
            ).join('')}
          </ul>
        `;
        supplyListEl.appendChild(batchCard);
      });
    }, err => {
      console.error('Erreur Firestore supplies :', err);
      supplyListEl.innerHTML = '<p style="padding:1rem;color:#e53238;">Erreur de chargement</p>';
    });

    // ‚ë¢ Se d√©sabonner proprement si la page se d√©charge
    window.addEventListener('beforeunload', () => unsubscribe());
  });
</script>


</main>
<!-- NOUVEL APPRO ‚Äì 100 % MOBILE -->
<main id="new-supply" class="page">
  <!-- ‚óâ STYLE -->
  <style>
    :root {
      --primary:#212121; --secondary:#616161; --accent:#0064d2;
      --surface:#ffffff; --radius:.5rem; --elevation:0 1px 4px rgba(0,0,0,.18);
    }
    #new-supply {display:none;flex-direction:column;height:100vh;background:var(--surface)}
    #new-supply.visible{display:flex}

    /* √âtapes */
    .step{display:none;flex:1;padding:1rem 1rem calc(56px + env(safe-area-inset-bottom))}
    .step.active{display:flex;flex-direction:column}
    h2{font-size:1.25rem;font-weight:500;margin-bottom:1rem}

    /* Champs */
    .form-group{margin-bottom:1rem}
    label{font-size:.9rem;color:var(--secondary);margin-bottom:.25rem;display:block}
    input[type=text],input[type=number],input[type=search]{
      width:100%;padding:.8rem;border:1px solid #ddd;border-radius:var(--radius);
      font-size:1rem;outline:none
    }

    /* Ligne article */
    .line-row{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;margin-bottom:.6rem}
    .book-search-wrap{position:relative;flex:1 1 100%}
    .line-qty,.line-cost{flex:1 1 calc(50% - .3rem);min-width:110px}
    .line-total{font-weight:600;margin-left:auto}
    .remove-line{background:none;border:none;font-size:1.4rem;color:#e53935}

    /* FAB ‚Äú+ ligne‚Äù */
    .fab{position:fixed;right:1rem;bottom:calc(70px + env(safe-area-inset-bottom));width:56px;height:56px;
      border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:1.7rem;
      display:flex;align-items:center;justify-content:center;box-shadow:var(--elevation);z-index:40}

    /* Nav wizard */
    .wizard-nav{position:fixed;left:0;bottom:env(safe-area-inset-bottom);width:100%;
      display:flex;gap:.6rem;padding:.7rem 1rem;background:var(--surface);box-shadow:0 -2px 8px rgba(0,0,0,.09)}
    .btn{flex:1;padding:.8rem;font-size:1rem;font-weight:500;border:none;border-radius:var(--radius)}
    .btn.primary{background:var(--accent);color:#fff}.btn.primary:disabled{background:#bfc8d7}
    .btn.secondary{background:#f5f5f5}.btn.secondary:disabled{opacity:.6}

    /* R√©sum√© */
    .summary{padding:1rem;background:#f9f9f9;border-radius:var(--radius);margin-bottom:1rem}
    .summary div{margin-bottom:.3rem}

    /* ‚òÖ Aspect ‚Äúbouton‚Äù pour le champ Livre */
.line-row .book-search {
  background:#f4f4f4;      /* la m√™me couleur que tes autres inputs */
  cursor:pointer;          /* petit pointeur main */
}

/* ‚òÖ On masque le curseur texte quand m√™me */
.line-row .book-search[readonly]{
  caret-color:transparent;
}

/* === √âtape 3 : Allocation du co√ªt d‚Äôachat === */
.step[data-step="3"] {
  display: none;
  flex-direction: column;
  padding: 1rem;
}
.step[data-step="3"].active {
  display: flex;
}
.step[data-step="3"] h2 {
  font-size: 1.3rem;
  text-align: center;
  margin-bottom: 1rem;
}
.step[data-step="3"] .form-group {
  margin-bottom: 1.5rem;
}
.step[data-step="3"] .form-group label {
  font-size: 0.9rem;
  color: var(--secondary);
  margin-bottom: 0.3rem;
  display: block;
}
.step[data-step="3"] .form-group input {
  width: 100%;
  padding: 0.8rem;
  font-size: 1rem;
  border: 1px solid #ddd;
  border-radius: 0.5rem;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.step[data-step="3"] .cost-allocation-list {
  display: flex;
  flex-direction: column;
  gap: 0.75rem;
  margin-bottom: 1.5rem;
}
.step[data-step="3"] .allocation-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f9f9f9;
  padding: 0.75rem 1rem;
  border-radius: 0.5rem;
}
.step[data-step="3"] .allocation-item .item-label {
  font-size: 0.95rem;
  flex: 1;
}
.step[data-step="3"] .allocation-item .item-cost {
  font-size: 1rem;
  font-weight: 600;
}

/* === R√©sum√© en cartes avec ic√¥nes color√©es, sans ombre === */
.summary-cards {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  padding: 0 1rem 1rem;
}

.summary-card {
  background: #fff;
  border: 1px solid #e0e0e0;
  border-radius: 0.75rem;
  padding: 1rem;
}

/* Ligne interne */
.summary-card .line {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
}
.summary-card .line:last-child {
  margin-bottom: 0;
}

/* Groupe gauche (ic√¥ne + label) */
.summary-card .line .left {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

/* Ic√¥nes */
.summary-card .icon {
  font-size: 1.1rem;
  color: var(--secondary-text);
}
.summary-card .icon.accent {
  color: var(--accent);
}

/* Label */
.summary-card .label {
  font-size: 0.9rem;
  color: var(--secondary-text);
}

/* Valeur */
.summary-card .value {
  font-size: 1rem;
  font-weight: 600;
  color: var(--primary-text);
}

/* Accentuation des valeurs cl√©s */
.summary-card .value.accent {
  color: var(--accent);
}

/* S√©paration visuelle avant la ligne Total */
.summary-card .line.total {
  border-top: 1px solid #f0f0f0;
  padding-top: 0.75rem;
  margin-top: 0.75rem;
}



  </style>

  <!-- ‚óâ TEMPLATE ligne -->
  <template id="tmpl-line">
    <div class="line-row" data-id="">
      <div class="book-search-wrap">
        <input type="text"
             class="book-search"
             placeholder="Choisir un livre"
             readonly         
             autocomplete="off"
             autocorrect="off"
             autocapitalize="none"
             spellcheck="false">
      </div>
      <input type="number" class="line-qty"  min="1" value="1">
      <input type="number" class="line-cost" step="0.01" value="0.00">
      <div class="line-total">‚Ç¨0.00</div>
      <button type="button" class="remove-line" aria-label="Supprimer">√ó</button>
    </div>
  </template>

  <!-- ‚óâ √âTAPE 1 : Fournisseur -->
  <div class="step active" data-step="1">
    <h2>Fournisseur</h2>
    <div class="form-group">
      <label for="supplier-search">Nom du fournisseur</label>
      <input id="supplier-search" type="search" placeholder="Rechercher ou saisir" autocomplete="off"
             autocorrect="off" autocapitalize="none" spellcheck="false">
    </div>
    <div class="wizard-nav">
      <button class="btn secondary" data-next disabled>Suivant ‚Üí</button>
    </div>
  </div>

  <!-- ‚óâ √âTAPE 2 : Articles -->
  <div class="step" data-step="2">
    <h2>Articles</h2>
    <div id="lines-container"></div>
    <button id="add-line-btn" class="fab" aria-label="Ajouter une ligne">+</button>
    <div class="wizard-nav">
      <button class="btn secondary" data-prev>‚Üê Pr√©c√©dent</button>
      <button class="btn primary"   data-next disabled>Suivant ‚Üí</button>
    </div>
  </div>

    <!-- ‚óâ √âTAPE 3 : Allocation du co√ªt d‚Äôachat -->
  <div class="step" data-step="3">
    <h2>Allocation du co√ªt d‚Äôachat</h2>

    <div class="form-group">
      <label for="additional-cost">Co√ªt suppl√©mentaire (‚Ç¨)</label>
      <input
        id="additional-cost"
        type="number"
        step="0.01"
        min="0"
        placeholder="0.00"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
      >
    </div>

    <div class="cost-allocation-list">
      <!-- Les allocations seront inject√©es ici -->
    </div>

    <div class="wizard-nav">
      <button class="btn secondary" data-prev>‚Üê Pr√©c√©dent</button>
      <button class="btn primary" data-next disabled>Suivant ‚Üí</button>
    </div>
  </div>

    <!-- ‚óâ √âTAPE 4 : R√©sum√© -->
  <div class="step" data-step="4">
    <h2>R√©sum√©</h2>
    <div class="summary">
   <div class="summary-cards" id="summary-cards"><!-- JS injecte ici --></div>
</div>

    <div class="wizard-nav">
      <button class="btn secondary" data-prev>‚Üê Pr√©c√©dent</button>
      <button id="submit-supply" class="btn primary" disabled>Valider & envoyer</button>
    </div>
  </div>



  <!-- ‚óâ SCRIPT -->
  <script>
    (function(){
      /*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ VARIABLES GLOBALES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
      const db  = firebase.firestore();
      const auth= firebase.auth();
      const suppliers=[];            // charge-les ailleurs si besoin

      /*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ R√âFS DOM ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
      const main      = document.getElementById('new-supply');
      const steps     = [...main.querySelectorAll('.step')];
      const supplierI = main.querySelector('#supplier-search');
      const linesC    = main.querySelector('#lines-container');
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ R√©f√©rences DOM pour l‚Äô√©tape 3 & 4 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const additionalCostI = main.querySelector('#additional-cost');
      const allocationList  = main.querySelector('.cost-allocation-list');

    
      const tmplLine  = document.getElementById('tmpl-line').content;
      const sumQtyEl  = main.querySelector('#sum-qty');
      const sumCostEl = main.querySelector('#sum-cost');
      const addLineBtn= main.querySelector('#add-line-btn');
      const submitBtn = main.querySelector('#submit-supply');

      /*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ WIZARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
      let step=1;
      function showStep(n){steps.forEach(s=>s.classList.toggle('active',+s.dataset.step===n))}
      main.addEventListener('click',e=>{
        if (e.target.matches('[data-next]:not([disabled])')) {
    step++;
    // si on atteint la 4·µâ √©tape, on reconstruit le r√©sum√©
    if (step === 4) updateSummary();
    showStep(step);
  }
        if(e.target.matches('[data-prev]')){step--;showStep(step)}
      });
      showStep(step);

      /*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FOURNISSEUR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
      supplierI.addEventListener('input',()=>main.querySelector('[data-step="1"] [data-next]').disabled=!supplierI.value.trim());

      /*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ AJOUT LIGNE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
      let lineId=0;
      addLineBtn.addEventListener('click',()=>addLine());
      function addLine(data={}){
        lineId++;
        const row = document.importNode(tmplLine,true).firstElementChild;
        row.dataset.id=lineId;
        const bookI=row.querySelector('.book-search');
        bookI.readOnly = true;                     // ‚ë° s√©curit√© JS
       bookI.addEventListener('click', () => {
  currentBookInput = bookI;
  // on navigue vers notre nouvelle page
  location.hash = 'select-book';
});

        const qtyI =row.querySelector('.line-qty');
        const costI=row.querySelector('.line-cost');
        const total=row.querySelector('.line-total');

        // pr√©remplissage √©ventuel
        if(data.title)bookI.value=data.title;
        if(data.qty)  qtyI.value=data.qty;
        if(data.cost) costI.value=data.cost;

        
        /*‚îÄ‚îÄ Calcul ligne & r√©sum√© ‚îÄ‚îÄ*/
        function updateLine(){
          const q=parseInt(qtyI.value,10)||0;
          const c=parseFloat(costI.value)||0;
          total.textContent='‚Ç¨'+(q*c).toFixed(2);
          updateSummary();
        }
        qtyI.addEventListener('input',updateLine);
        costI.addEventListener('input',updateLine);

        /*‚îÄ‚îÄ suppression ligne ‚îÄ‚îÄ*/
        row.querySelector('.remove-line').addEventListener('click',()=>{
          row.remove();updateSummary();toggleStep2Next();
        });

        linesC.append(row);
        updateLine();toggleStep2Next();
      }


additionalCostI.addEventListener('input', () => {
  // 1) lecture du co√ªt suppl√©mentaire
  const addCost = parseFloat(additionalCostI.value) || 0;

  // 2) r√©cup√©ration des lignes
  const rows = [...linesC.children];

  // 3) calcul de la quantit√© totale de tous les livres
  const totalQty = rows.reduce((sum, r) => {
    const q = parseInt(r.querySelector('.line-qty').value, 10) || 0;
    return sum + q;
  }, 0);

  // 4) calcul du co√ªt suppl√©mentaire **par unit√©**
  const unitExtra = totalQty > 0 ? addCost / totalQty : 0;

  // 5) on vide la liste d‚Äôaffichage des allocations
  allocationList.innerHTML = '';

  // 6) pour chaque ligne, on met √† jour le co√ªt unitaire et le total ligne
  rows.forEach(r => {
    const qty       = parseInt(r.querySelector('.line-qty').value, 10) || 0;
    const costInput = r.querySelector('.line-cost');

    // a) on stocke **une seule fois** le co√ªt de base
    if (!costInput.dataset.baseCost) {
      costInput.dataset.baseCost = costInput.value;
    }
    const base = parseFloat(costInput.dataset.baseCost) || 0;

    // b) nouveau co√ªt unitaire = co√ªt de base + part unitaire du co√ªt supp
    const newUnitCost = base + unitExtra;

    // c) mise √† jour des champs UI
    costInput.value = newUnitCost.toFixed(2);
    r.querySelector('.line-total')
     .textContent = '‚Ç¨' + (qty * newUnitCost).toFixed(2);

    // d) affichage de la ligne d‚Äôallocation (montant total ajout√© pour cette ligne)
    const extraTotal = qty * unitExtra;
    const title      = r.querySelector('.book-search').value || '‚Äì';
    const div        = document.createElement('div');
    div.className    = 'allocation-item';
    div.innerHTML    = `
      <div class="item-label">${title}</div>
      <div class="item-cost">+‚Ç¨${extraTotal.toFixed(2)}</div>
    `;
    allocationList.appendChild(div);
  });

  // 7) activation du bouton ‚ÄúSuivant‚Äù si la saisie est valide
  main
    .querySelector('[data-step="3"] [data-next]')
    .disabled = addCost < 0;
});



function updateSummary() {
  const rows = [...linesC.children];
  const cardsContainer = document.getElementById('summary-cards');
  cardsContainer.innerHTML = '';

  const totalAdd = parseFloat(additionalCostI.value) || 0;
  const totalQty = rows.reduce((s,r) => s + (parseInt(r.querySelector('.line-qty').value,10)||0), 0);
  const extraPerUnit = totalQty > 0 ? totalAdd / totalQty : 0;

  rows.forEach(r => {
    const title = r.querySelector('.book-search').value || '‚Äì';
    const qty   = parseInt(r.querySelector('.line-qty').value,10) || 0;
    const base  = parseFloat(r.querySelector('.line-cost').dataset.baseCost) || parseFloat(r.querySelector('.line-cost').value) || 0;
    const extraLineTotal = qty * extraPerUnit;
    const unitCost = base + extraPerUnit;
    const lineTotal = unitCost * qty;

    const card = document.createElement('div');
    card.className = 'summary-card';
    card.innerHTML = `
      <div class="line">
        <div class="left">
          <i class="bi bi-book-fill icon"></i>
          <span class="label">Article</span>
        </div>
        <span class="value">${title}</span>
      </div>
      <div class="line">
        <div class="left">
          <i class="bi bi-currency-euro icon"></i>
          <span class="label">PU (‚Ç¨)</span>
        </div>
        <span class="value">${unitCost.toFixed(2)}</span>
      </div>
      <div class="line">
        <div class="left">
          <i class="bi bi-list-ol icon"></i>
          <span class="label">Qt√©</span>
        </div>
        <span class="value">${qty}</span>
      </div>
      <div class="line">
        <div class="left">
          <i class="bi bi-plus-circle icon accent"></i>
          <span class="label">‚Ç¨ supp.</span>
        </div>
        <span class="value accent">+${extraLineTotal.toFixed(2)}</span>
      </div>
      <div class="line total">
        <div class="left">
          <i class="bi bi-check-circle icon accent"></i>
          <span class="label">Total</span>
        </div>
        <span class="value accent">‚Ç¨${lineTotal.toFixed(2)}</span>
      </div>
    `;
    cardsContainer.appendChild(card);
  });

  submitBtn.disabled = rows.length === 0;
}


function toggleStep2Next() {
  // active ‚ÄúSuivant ‚Üí‚Äù dans l‚Äô√©tape 2 si on a au moins 1 ligne
  main.querySelector('[data-step="2"] [data-next]').disabled =
    linesC.children.length === 0;
}

      /*‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ENVOI FIRESTORE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
      submitBtn.addEventListener('click',async()=>{
        submitBtn.disabled=true;
        const user=auth.currentUser;
        const supplierName=supplierI.value.trim();
        let sup=suppliers.find(s=>s.name===supplierName);
        if(!sup){const ref=await db.collection('suppliers').add({name:supplierName});
                 sup={id:ref.id,name:supplierName}}
        const lines=[...linesC.children].map(r=>({
          title:r.querySelector('.book-search').value,
          quantity:parseInt(r.querySelector('.line-qty').value,10),
          unitCost:parseFloat(r.querySelector('.line-cost').value)
        }));
        const totalQ=parseInt(sumQtyEl.textContent,10);
        const totalC=parseFloat(sumCostEl.textContent.replace('‚Ç¨',''));
        const batch=db.batch();
        const supplyRef=db.collection('users').doc(user.uid).collection('supplies').doc();
        batch.set(supplyRef,{supplierId:sup.id,supplierName:sup.name,
          date:firebase.firestore.FieldValue.serverTimestamp(),
          lines,totalQty:totalQ,totalCost:totalC});
        const uid = auth.currentUser.uid;
const userBooksRef = db
  .collection('users')
  .doc(uid)
  .collection('books');

for(const ln of lines){
  const snap = await userBooksRef
    .where('title','==', ln.title)
    .limit(1).get();
  if (!snap.empty) {
    batch.update(snap.docs[0].ref, {
      quantity: firebase.firestore.FieldValue.increment(ln.quantity)
    });
  }
}
        await batch.commit();
        window.location.hash='supply';
        const toast=document.createElement('div');
        toast.className='toast';toast.textContent='Approvisionnement enregistr√© !';
        Object.assign(toast.style,{position:'fixed',bottom:'64px',left:'50%',transform:'translateX(-50%)',
          background:'#333',color:'#fff',padding:'.8rem 1.4rem',borderRadius:'6px',zIndex:1000});
        document.body.append(toast);setTimeout(()=>toast.remove(),2000);
      });
    })();
  </script>
</main>

<!-- S√©lection de livre pour approvisionnement -->
<main id="select-book" class="page">
  <header class="sell-header">
    <button class="btn-close" aria-label="Annuler">
      <i class="bi bi-x-lg"></i>
    </button>
    <div class="search-wrapper">
      <i class="bi bi-search"></i>
      <input
        type="search"
        id="select-book-search"
        placeholder="Rechercher un livre"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
      >
    </div>
  </header>
  <div id="select-book-results">
    <div class="books-list"></div>
  </div>

  <script>
  (function() {
   window.currentBookInput = null; // Pour savoir quel input remplir

  // Quand on clique dans .book-search ‚Üí ouvrir la page
  document.addEventListener('focusin', function(e) {
    if (e.target.classList.contains('book-search')) {
      currentBookInput = e.target;
      // Remplir la barre de recherche si d√©j√† du texte
      document.getElementById('select-book-search').value = currentBookInput.value || '';
      document.getElementById('select-book-overlay').classList.add('visible');
      document.querySelector('nav').style.display = 'none';
      // Lancer la recherche directe si besoin
      triggerBookSearch();
    }
  });

  // Fermer la page sur ‚ÄúX‚Äù
document.querySelector('#select-book .btn-close').onclick = function() {
  location.hash = 'new-supply';  // ou quel que soit ton ‚Äúretour‚Äù
  currentBookInput = null;
};

  // Recherche dynamique
  const searchInput = document.getElementById('select-book-search');
  const resultList  = document.querySelector('#select-book-results .books-list');

  let debounceT = null;
  searchInput.addEventListener('input', triggerBookSearch);
  searchInput.addEventListener('focus', triggerBookSearch);

  function triggerBookSearch() {
    const t = searchInput.value.trim();
    resultList.innerHTML = '<p style="padding:1rem;">Recherche‚Ä¶</p>';
    clearTimeout(debounceT);
    if (t.length < 2) { resultList.innerHTML = ''; return; }
    debounceT = setTimeout(async () => {
      try {
const uid = auth.currentUser.uid;
const userBooksRef = db
  .collection('users')
  .doc(uid)
  .collection('books');

const snap = await userBooksRef
  .where('title', '>=', t)
  .where('title', '<=', t + '\uf8ff')
  .orderBy('title')
  .limit(15)
  .get();

        resultList.innerHTML = '';
       if (snap.empty) {
  resultList.innerHTML = `
    <div id="add-book-chip" class="search-noresult">
      Ajouter ¬´ ${t} ¬ª
      <i class="bi bi-plus-circle"></i>
    </div>
  `;
  document.getElementById('add-book-chip').addEventListener('click', () => {
    // Ouvre le modal pour ajouter un livre
    openAddBookModal(t);
  });
}
 else {
          snap.forEach(doc => {
            const b = doc.data();
            const div = document.createElement('div');
            div.className = 'book-card';
            div.style.cursor = 'pointer';
            div.innerHTML = `
              <h4 class="book-title">${b.title}</h4>
              <p class="book-price">‚Ç¨${(b.price||0).toFixed(2)}</p>
              <p class="book-quantity">Quantit√©: ${b.quantity || 0}</p>
            `;
            // Quand on clique sur un r√©sultat, remplir l‚Äôinput d‚Äôorigine
            div.onclick = () => {
              if (currentBookInput) {
                currentBookInput.value = b.title;
                // Optionnel : remplir le co√ªt si vide
                const costInput = currentBookInput.closest('.line-row').querySelector('.line-cost');
                if (costInput && !costInput.value) costInput.value = (b.price||0).toFixed(2);
                // Trigger input event pour recalculer
                currentBookInput.dispatchEvent(new Event('input', { bubbles:true }));
              }
              document.getElementById('select-book-overlay').classList.remove('visible');
              document.querySelector('nav').style.removeProperty('display');
              currentBookInput = null;
            };
            resultList.appendChild(div);
          });
        }
      } catch (err) {
        resultList.innerHTML = '<p style="color:#e53238;padding:1rem;">Erreur de recherche</p>';
        console.error(err);
      }
    }, 200);
  }
})();
</script>
</main>

<main id="add-book-modal" class="modal-overlay" aria-hidden="true">
  <style>
   /* default, modal cach√©e */
#add-book-modal.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;                  /* cach√© par d√©faut */
  overflow: hidden;               /* emp√™che le scroll du fond */
  height: 100vh;
  width: 100vw;
  align-items: center;
  justify-content: center;
  z-index: 50;
}

/* quand on veut l‚Äôafficher */
#add-book-modal.modal-overlay.visible {
  display: flex;                  /* on passe en flex (centrage) */
}

/* le conteneur interne */
#add-book-modal .modal {
  background: #fff;
  border-radius: var(--border-radius-pill);
  width: 90%;
  max-width: 360px;
  max-height: calc(100vh - env(safe-area-inset-bottom) - 2rem);
  overflow: hidden;
  padding: 1rem;
  box-shadow: 0 4px 16px rgba(0,0,0,0.2);
}

    #add-book-modal .modal header {
      padding: 1rem;
      border-bottom: 1px solid #eee;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    #add-book-modal .modal-close {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
    }
    #add-book-modal .form-group {
      padding: 0.75rem 1rem;
    }
    #add-book-modal label {
      display: block;
      margin-bottom: 0.4rem;
      font-size: 0.95rem;
      color: var(--secondary-text);
    }
    #add-book-modal input {
      width: 100%;
      padding: 0.7rem;
      border: 1px solid #ddd;
      border-radius: var(--border-radius-pill);
      font-size: 1rem;
      outline: none;
    }
    #add-book-modal button[type="submit"] {
      width: calc(100% - 2rem);
      margin: 1rem;
      padding: 0.85rem;
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--border-radius-pill);
      background: var(--accent);
      color: #fff;
    }
    #add-book-modal button[type="submit"]:active {
      background: #014fa5;
    }

    #add-book-modal .modal {
  /* par d√©faut centr√© verticalement */
  margin: auto;
  top: 50%;
  transform: translateY(-50%);
  position: relative;
  transition: transform 0.2s ease;
}
/* la translation sera g√©r√©e par le JS */

   
  </style>

  <div class="modal">
    <header>
      <h3>Ajouter un nouveau livre</h3>
      <button class="modal-close" aria-label="Fermer">&times;</button>
    </header>
    <form id="form-add-book">
      <div class="form-group">
        <label for="new-book-title">Titre</label>
        <input
  type="search"
  id="new-book-title"
  placeholder="Taper le titre du livre"
  autocomplete="off"
  autocorrect="off"
  autocapitalize="none"
  enterkeyhint="done" 
  spellcheck="false"
>
      </div>
      <button type="submit">Enregistrer</button>
    </form>
  </div>
</main>
 <script>
  // 1) D√©finition de la fonction d‚Äôouverture
  function openAddBookModal(defaultTitle = '') {
    const modal = document.getElementById('add-book-modal');
    if (!modal) return console.error('Modal #add-book-modal introuvable');
    modal.classList.add('visible');
    modal.setAttribute('aria-hidden', 'false');
    const titleInput = document.getElementById('new-book-title');
    if (titleInput && defaultTitle) {
      titleInput.value = defaultTitle;
    }
    // focus apr√®s affichage
    setTimeout(() => titleInput && titleInput.focus(), 100);
  }

  // 2) Attacher le handler au ‚Äúchip‚Äù Ajouter ¬´ ‚Ä¶ ¬ª
  document.addEventListener('click', e => {
    const chip = e.target.closest('#add-book-chip');
    if (!chip) return;
    const suggestedTitle = chip.textContent
      .trim()
      .replace(/^Ajouter ¬´ | ¬ª$/g, '');
    openAddBookModal(suggestedTitle);
  });

  // 3) Fermeture via la croix
  const closeBtn = document.querySelector('#add-book-modal .modal-close');
  if (closeBtn) {
    closeBtn.addEventListener('click', () => {
      const modal = document.getElementById('add-book-modal');
      modal.classList.remove('visible');
      modal.setAttribute('aria-hidden', 'true');
    });
  }

  // 4) Fermeture au clic hors du contenu
  const overlay = document.getElementById('add-book-modal');
  if (overlay) {
    overlay.addEventListener('click', e => {
      if (e.target === overlay) {
        overlay.classList.remove('visible');
        overlay.setAttribute('aria-hidden', 'true');
      }
    });
  }

  // 5) Ajuster la position du modal quand le clavier mobile appara√Æt
  (function() {
    const modalContent = document.querySelector('#add-book-modal .modal');
    if (!modalContent) return;
    const initialH = window.innerHeight;
    window.addEventListener('resize', () => {
      const currentH = window.innerHeight;
      if (currentH < initialH) {
        // clavier ouvert ‚Üí remonter
        modalContent.style.transform = 'translateY(-30%)';
        modalContent.style.transition = 'transform 0.2s';
      } else {
        // clavier ferm√© ‚Üí recentrer
        modalContent.style.transform = '';
      }
    });
  })();

  // 6) Enregistrement du nouveau livre + retour automatique
  const formAddBook = document.getElementById('form-add-book');
  formAddBook.addEventListener('submit', async e => {
    e.preventDefault();
    const titleInput = document.getElementById('new-book-title');
    const newTitle = titleInput.value.trim();
    if (!newTitle) {
      return alert('Veuillez saisir un titre de livre.');
    }
    try {
      const uid = auth.currentUser.uid;
const userBooksRef = db
  .collection('users')
  .doc(uid)
  .collection('books');

await userBooksRef.add({
  title: newTitle,
  price: 0,
  quantity: 0,
  createdAt: firebase.firestore.FieldValue.serverTimestamp()
});

      // Fermer la modal
      const modal = document.getElementById('add-book-modal');
      modal.classList.remove('visible');
      modal.setAttribute('aria-hidden', 'true');

      // Revenir √† la page ‚Äúnew-supply‚Äù
      location.hash = 'new-supply';

      // Pr√©-remplir l‚Äôinput ‚ÄúChoisir un livre‚Äù
      if (window.currentBookInput) {
        window.currentBookInput.value = newTitle;
        window.currentBookInput.dispatchEvent(
          new Event('input', { bubbles: true })
        );
      }
    } catch (err) {
      console.error(err);
      alert("Erreur lors de l'enregistrement du livre : " + err.message);
    }
  });
</script>


  <!-- MY ORDERS PAGE -->
  <main id="orders" class="page">
    <header><h2 style="padding:1rem">My Orders</h2></header>
    <p style="padding:0 1rem 6rem">Your recent orders will appear here‚Ä¶</p>
  </main>

  <!-- CART PAGE -->
  <main id="cart" class="page">
    <header><h2 style="padding:1rem">Panier</h2></header>
    <div style="padding:0 1rem 6rem;">
      <p>Votre panier est actuellement vide</p>
      <button class="btn-primary" style="margin-top:1rem;">View recommendations</button>
    </div>
  </main>

 <!-- ACCOUNT PAGE -->
<main id="account" class="page">
  <!-- Styles sp√©cifiques √† la page ACCOUNT -->
  <style>
    /* cadre horizontal pour le profil */
#account .profile-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 0.5rem;
  padding: 1rem;
  margin: 1rem;            /* aligne √† gauche dans le flow */
  max-width: none;         /* pleine largeur possible */
  box-shadow: none;        /* comme les autres cadres */
}

/* avatar √† gauche, sans centrage */
#account .profile-avatar {
  flex: 0 0 auto;
  margin: 0;
}

/* wrapper texte : colonne, align√© √† gauche */
#account .profile-info {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  text-align: left;
}

    #account .profile-avatar {
      width: 64px;
      height: 64px;
      background: var(--ebay-blue);
      color: #fff;
      font-weight: bold;
      font-size: 2rem;
      border-radius: 50%;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #account h2 { 
      padding: 1rem; 
      font-size: 1.3rem; 
      font-weight: 600; 
    }
    #account #display-name {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    #account #email,
    #account #member-since {
      font-size: 0.95rem;
      color: var(--secondary-text);
      margin-bottom: 0.5rem;
    }

    /* Titres de section */
    #account .section-title {
      padding: 0 1rem;
      margin: 1.5rem 0 0.75rem;
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--primary-text);
    }

    /* Cartes de mises √† jour */
    #account .updates-grid {
      display: flex;
      gap: 0.75rem;
      padding: 0 1rem;
    }
    #account .update-card {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      padding: 1rem;
      cursor: pointer;
    }
    #account .update-card h4 {
      font-size: 1rem;
      margin: 0 0 0.25rem;
    }
    #account .update-card p {
      font-size: 0.85rem;
      color: var(--secondary-text);
      margin: 0;
    }
    #account .update-card i.bi-chevron-right {
      font-size: 1.2rem;
      color: var(--secondary-text);
    }

    /* Liste de gestion interne */
    #account .menu-list {
      margin-top: 0.5rem;
    }
    #account .menu-item {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border: none;
      border-bottom: 1px solid #eee;
      padding: 0.75rem 1rem;
      cursor: pointer;
    }
    #account .menu-item:last-child {
      border-bottom: none;
    }
    #account .menu-item .item-content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    #account .menu-item .item-content i {
      font-size: 1.4rem;
      color: var(--accent);
    }
    #account .menu-item span {
      font-size: 1rem;
      font-weight: 500;
      color: var(--primary-text);
    }
    #account .menu-item small {
      display: block;
      font-size: 0.85rem;
      color: var(--secondary-text);
      margin-top: 0.2rem;
      line-height: 1.2;
    }

    /* Bouton de d√©connexion */
    #account .btn-signout {
      width: calc(100% - 2rem);
      margin: 1rem;
      padding: 0.75rem 1.2rem;
      font-size: 1rem;
      font-weight: 500;
      border: 2px solid var(--accent);
      border-radius: var(--border-radius-pill);
      background: #fff;
      color: var(--accent);
      cursor: pointer;
      text-align: center;
      transition: background 0.2s, color 0.2s;
    }
    #account .btn-signout:active {
      background: var(--accent);
      color: #fff;
    }

    /* 1) autoriser le wrapping pour qu‚Äôun item puisse aller √† la ligne suivante */
#account .updates-grid {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

/* 2) forcer la 2·µâ carte (Commandes r√©centes) √† occuper 100 % de la largeur */
#account .updates-grid .update-card:nth-child(2) {
  flex: 1 1 100%;
  max-width: 100%;
}

/* √† la fin de ta feuille, juste pour le bouton */
#btn-install {
  width: calc(100% - 2rem);  /* m√™me marge que les autres cartes */
}


  </style>

  <!-- En-t√™te -->
  <header><h2>Mon compte</h2></header>

  <div>
    <div class="profile-card">
  <div class="profile-avatar" id="avatar-letter">Z</div>
  <div class="profile-info">
    <div id="display-name">Utilisateur</div>
    <div id="email">email@example.com</div>
    <div id="member-since">Membre depuis: ‚Ä¶</div>
  </div>
</div>


    <!-- Vos mises √† jour -->
    <div class="section-title">Vos mises √† jour</div>
    <div class="updates-grid">
      <div class="update-card" onclick="location.hash='stock-alerts'">
        <div>
          <h4>Alertes de stock</h4>
          <p>Livres bient√¥t √©puis√©s</p>
        </div>
        <i class="bi bi-chevron-right"></i>
      </div>
      <div class="update-card" onclick="location.hash='orders'">
        <div>
          <h4>Commandes r√©centes</h4>
          <p>Voir vos derni√®res commandes</p>
        </div>
        <i class="bi bi-chevron-right"></i>
      </div>
    </div>

    <!-- Gestion interne -->
    <div class="section-title">Gestion</div>
    <div class="menu-list">
      <button class="menu-item" data-hash="inventory">
        <div class="item-content">
          <i class="bi bi-box-seam"></i>
          <div>
            <span>Inventaire</span>
            <small>G√©rer vos livres</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
      <button class="menu-item" data-hash="suppliers">
        <div class="item-content">
          <i class="bi bi-people"></i>
          <div>
            <span>Fournisseurs</span>
            <small>Liste des fournisseurs</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
      <button class="menu-item" data-hash="reports">
        <div class="item-content">
          <i class="bi bi-bar-chart-line"></i>
          <div>
            <span>Rapports</span>
            <small>Statistiques & analyses</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>

    <!-- D√©connexion -->
    <button class="btn-signout" id="btn-signout">D√©connexion</button>
  </div>

  <!-- Script de peuplement & sign out -->
  <script>
    auth.onAuthStateChanged(user => {
      if (user) {
        const name = user.displayName || user.email.split('@')[0] || "Utilisateur";
        document.getElementById('display-name').textContent = name;
        document.getElementById('email').textContent = user.email;
        const creationDate = new Date(user.metadata.creationTime);
        document.getElementById('member-since').textContent =
          'Membre depuis: ' + creationDate.toLocaleDateString(undefined, {
            year: 'numeric', month: 'short', day: 'numeric'
          });
        document.getElementById('avatar-letter').textContent = name[0].toUpperCase();
      }
    });
    document.getElementById('btn-signout').addEventListener('click', () => {
      auth.signOut().then(() => window.location.href = 'login.html');
    });
  </script>
</main>



  <main id="catalog" class="page">
  <!-- barre de recherche ‚Ä¶ -->
  <header>
    <div class="search-wrapper">
      <i class="bi bi-search"></i>
      <input
        type="search"
        id="search-input"
        placeholder="Rechercher dans le catalogue"
        aria-label="Recherche catalogue"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
      >
      <div class="actions">
        <i class="bi bi-cart"></i>
      </div>
    </div>
  </header>

  <!-- Info cards (total livres + valeur) -->
  <div class="info-cards">
    <div class="info-card">
      <div class="info-number" id="total-books">0</div>
      <div class="info-label">Total de livres</div>
    </div>
    <div class="info-card">
      <div class="info-number" id="total-value">‚Ç¨0</div>
      <div class="info-label">Valeur totale</div>
    </div>
  </div>

  <!-- conteneur pour les r√©sultats -->
  <div id="catalog-results">
    <div class="books-list"></div>
  </div>

  <!-- ‚¨á Ici on encapsule tout le JS catalog ‚¨á -->
  <script>
  (function() {
    const booksList      = document.querySelector('#catalog-results .books-list');
    const totalBooksEl   = document.getElementById('total-books');
    const totalValueEl   = document.getElementById('total-value');
    const searchInput    = document.getElementById('search-input');
    const infoCards      = document.querySelector('.info-cards');

    // Masquer les cards lors de la recherche
    searchInput.addEventListener('input', () => {
      if (searchInput.value.trim()) {
        infoCards.classList.add('fade-out');
      } else {
        infoCards.classList.remove('fade-out');
      }
    });

    // Auth + r√©cup√©ration des items
    auth.onAuthStateChanged(user => {
      if (!user) {
        return window.location.replace('login.html');
      }

      const userCatalogRef = db
        .collection('users')
        .doc(user.uid)
        .collection('catalog');

      userCatalogRef.onSnapshot(snapshot => {
        let count = 0;
        let value = 0;
        booksList.innerHTML = '';

        snapshot.forEach(doc => {
          const { title, price, quantity } = doc.data();
          count += quantity;
          value += price * quantity;

          // cr√©ation du book-card
          const card = document.createElement('div');
          card.className = 'book-card';
          card.innerHTML = `
            <h4 class="book-title">${title}</h4>
            <p class="book-price">‚Ç¨${price.toFixed(2)}</p>
            <p class="book-quantity">Quantit√© : ${quantity}</p>
          `;
          booksList.appendChild(card);
        });

        totalBooksEl.textContent = count.toLocaleString();
        totalValueEl.textContent = '‚Ç¨' + value.toFixed(2);
      }, err => {
        console.error('Erreur Firestore catalog :', err);
      });
    });
  })();
  </script>
</main>

  
  <!-- NAVIGATION BAR -->
  <nav aria-label="Main navigation">
    <div class="nav-inner">
      <a href="#home"    data-hash="home"    class="nav-link active" aria-label="Home">
        <i class="bi bi-house"></i><span>Home</span>
      </a>
      <a href="#catalog" data-hash="catalog" class="nav-link" aria-label="Catalog">
        <i class="bi bi-search"></i><span>Catalog</span>
      </a>
      <a href="#cart"    data-hash="cart"    class="nav-link" aria-label="Cart">
        <i class="bi bi-cart"></i><span>Cart</span>
      </a>
      <a href="#account" data-hash="account" class="nav-link" aria-label="Account">
        <i class="bi bi-person"></i><span>Account</span>
      </a>
    </div>
  </nav>

  <main id="activation" class="page">
    <style>
/* --- Page Activation --- */
main#activation.page {
  display: none;           /* cach√©e par d√©faut, comme les autres pages */
  padding: 0 1.5rem;
  flex-direction: column;  /* comme les autres pages */
  align-items: center;
  justify-content: center;
  text-align: center;
}
main#activation.visible {
  display: flex;
}

.activation-container {
  width: 100%;
  max-width: 360px;   /* pour caler la largeur */
}

.activation-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 1.5rem;
  border-radius: 50%;
  background: rgba(0, 200, 150, 0.15); /* couleur pastel */
  display: flex;
  align-items: center;
  justify-content: center;
}
.activation-icon i {
  font-size: 2rem;
  color: #00c896;     /* accent color */
}

main#activation h3 {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}

main#activation p {
  color: var(--secondary-text);
  margin-bottom: 1.5rem;
  line-height: 1.4;
}

.activation-input {
  width: 100%;
  padding: 0.75rem 1rem;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  margin-bottom: 1rem;
  outline: none;
}

.activation-btn {
  width: 100%;
  padding: 0.85rem;
  font-size: 1rem;
  font-weight: 600;
  margin-top: 0.5rem;
}
</style>

  <div class="activation-container">
    <div class="activation-icon">
      <i class="bi bi-box-arrow-in-right"></i>
    </div>
    <h3>Activation du compte</h3>
    <p>Entrez votre code d‚Äôactivation pour finaliser l‚Äôinscription.</p>
    <input
      type="text"
      id="activation-code"
      placeholder="Code d‚Äôactivation"
      class="activation-input"
    >
    <button id="btn-activate" class="btn-primary activation-btn">
      Valider
    </button>
  </div>
</main>

  <!-- SCRIPTS -->
  <script>

    
// gestion du clic ‚ÄúValider‚Äù
document.getElementById('btn-activate').addEventListener('click', async () => {
  const code = document.getElementById('activation-code').value.trim();
  if (!code) return alert('Veuillez entrer le code.');
  try {
    await verifyActivationCode({ code });
    // on force un refresh du token et on recharge
    await auth.currentUser.getIdToken(true);
    location.reload();
  } catch (err) {
    alert(err.message);
  }
});

    /* Tabs inside catalog */
    function toggleTab(tab) {
      ['recent', 'saved'].forEach(t => {
        const el = document.getElementById('tab-' + t);
        el.style.color = '#555';
        el.style.borderBottom = 'none';
      });
      const active = document.getElementById('tab-' + tab);
      active.style.color = '#0064d2';
      active.style.borderBottom = '2px solid #0064d2';
    }



 // ----- Recherche catalogue : fade-out d√®s la frappe ----- //

const searchInput = document.getElementById('search-input');
const infoCards   = document.querySelector('.info-cards');

// √Ä chaque saisie dans l'input
searchInput.addEventListener('input', () => {
  if (searchInput.value.trim() !== '') {
    infoCards.classList.add('fade-out');
  } else {
    infoCards.classList.remove('fade-out');
  }
});


  </script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => {
          console.log('[App] SW enregistr√©, scope :', reg.scope);

          // D√®s qu‚Äôon d√©ploie une nouvelle version (CACHE_NAME incr√©ment√©)‚Ä¶
          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            newSW.addEventListener('statechange', () => {
              // Quand le nouvel SW est pr√™t et qu‚Äôil y avait d√©j√† un SW actif
              if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('[App] Nouvelle version dispo ‚Üí reload');
                window.location.reload();
              }
            });
          });
        })
        .catch(err => console.error('[App] √âchec enregistrement SW :', err));
    });
  }
</script>

<script>
/* === PWA install button === */
let deferredPrompt = null;             // stocke l‚Äô√©v√®nement

// 1) Le navigateur signale que l'app peut √™tre install√©e
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();                  // on annule l‚Äôinvite auto
  deferredPrompt = e;                  // on garde l‚Äôobjet
  document.getElementById('btn-install').style.display = 'block';   // on r√©v√®le le bouton
});

// 2) Clique sur le bouton ‚ÄúInstaller‚Äù
document.getElementById('btn-install').addEventListener('click', async () => {
  if (!deferredPrompt) return;         // s√©curit√©
  document.getElementById('btn-install').disabled = true;           // √©vite le spam

  deferredPrompt.prompt();             // ouvre la modale native
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;               // on ¬´ consomme ¬ª l‚Äô√©v√®nement

  // Si l‚Äôutilisateur a install√© ‚Üí on masque d√©finitivement le bouton
  // Sinon on le r√©-affiche pour qu‚Äôil puisse r√©essayer plus tard
  document.getElementById('btn-install').style.display =
    (outcome === 'accepted') ? 'none' : 'block';
  document.getElementById('btn-install').disabled = false;
});

// 3) Si l'app est finalement install√©e (via menu navigateur, etc.)
window.addEventListener('appinstalled', () => {
  console.log('[PWA] App install√©e üéâ');
  document.getElementById('btn-install').style.display = 'none';
});
</script>
  <script>
  ;(function() {
    const pages     = document.querySelectorAll('.page');
    const nav       = document.querySelector('nav');
    let activated   = false;

    // 1) Auth + activation guard
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.replace('login.html');
        return;
      }
      const tok = await user.getIdTokenResult(true);
      activated = !!tok.claims.activated;
      document.body.style.visibility = 'visible';
      route();
    });

    // 2) Route() unique
    function route() {
      const key = location.hash.slice(1) || 'home';

      // guard activation
      if (!activated && key !== 'activation') {
        history.replaceState(null, '', '#activation');
        return showOnly('activation');
      }

      // fallback if unknown
      if (![...pages].some(p => p.id === key)) {
        location.hash = 'home';
        return showOnly('home');
      }

      // show the requested page
      showOnly(key);
    }

    // helper to show one page, hide others, g√©rer nav & onglets
    function showOnly(pageId) {
      pages.forEach(p =>
        p.classList.toggle('visible', p.id === pageId)
      );
      if (['activation','sell','supply','new-supply','select-book'].includes(pageId)) {
        nav.style.display = 'none';
      } else {
        nav.style.removeProperty('display');
      }
      document.querySelectorAll('[data-hash]').forEach(el =>
        el.classList.toggle('active', el.dataset.hash === pageId)
      );
    }

    // 3) Listeners
    window.addEventListener('hashchange', route);
    document.body.addEventListener('click', e => {
      const el = e.target.closest('[data-hash]');
      if (!el) return;
      if (el.classList.contains('nav-link')) {
        const rect = el.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const ripple = document.createElement('span');
        ripple.className = 'ripple';
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
        ripple.style.top  = (e.clientY - rect.top  - size/2) + 'px';
        el.querySelector('.ripple')?.remove();
        el.appendChild(ripple);
        ripple.addEventListener('animationend', () => ripple.remove());
      }
      if (el.tagName === 'A') e.preventDefault();
      location.hash = el.dataset.hash;
    });

    // Si on est d√©j√† logg√© au chargement
    if (auth.currentUser) {
      auth.currentUser.getIdTokenResult(true).then(tok => {
        activated = !!tok.claims.activated;
        document.body.style.visibility = 'visible';
        route();
      });
    }
  })();
  </script>

</body>

</html>
