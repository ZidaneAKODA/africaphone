<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
  >

  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>


<script>
  // Your Firebase config (same as in index.html)
  const firebaseConfig = {
    apiKey: "AIzaSyCvNZ5lhKdP_6W-eRle-7zCmFqejSfRuto", // IMPORTANT: Keep your actual API key secure and consider environment variables for production
    authDomain: "shoptel-35c7e.firebaseapp.com",
    projectId: "shoptel-35c7e",
    storageBucket: "shoptel-35c7e.appspot.com", // Corrected: .appspot.com is typical for storageBucket
    messagingSenderId: "541177101809",
    appId: "1:541177101809:web:5ae3ea186f198558371850",
    measurementId: "G-VH4MCV6Y6E"
  };

  // Initialize app and Auth
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  // const db = firebase.firestore(); // Initialize Firestore if needed later
  console.log("ðŸ”¥ Firebase Auth initialisÃ© :", auth);

  function withSpinner(buttonId, actionFn) {
    const btn      = document.getElementById(buttonId);
    const textSpan = btn.querySelector('.btn-text');
    const spinner  = btn.querySelector('.loader');

    // Start spinner
    btn.disabled = true;
    if (textSpan) textSpan.style.visibility = 'hidden'; // Check if textSpan exists
    if (spinner) spinner.style.display = 'block'; // Check if spinner exists

    return actionFn()
      .catch(err => {
        // In case of error: stop spinner and restore
        btn.disabled = false;
        if (spinner) spinner.style.display = 'none';
        if (textSpan) textSpan.style.visibility = 'visible';
        throw err; // Re-throw the error to be caught by the caller
      })
      .finally(() => { // Ensure button is re-enabled and spinner hidden even if actionFn doesn't return a promise or if it resolves
        btn.disabled = false;
        if (spinner) spinner.style.display = 'none';
        if (textSpan) textSpan.style.visibility = 'visible';
      });
}

</script>

  <style>
    :root {
      --primary: #1e90ff;
      --bg: #f5f5f5;
      --surface: #fff;
      --text: #333;
      --muted: #888;
      --radius: 8px;
      --transition: 0.3s ease;
    }
    * { box-sizing: border-box; margin:0; padding:0; }
    html, body {
      width:100%; height:100%;
      overflow:hidden;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      -webkit-tap-highlight-color: transparent;
    }

    /* container 2 Ã©crans */
    #app {
      display: flex;
      width:200%; /* Allows for two screens side-by-side */
      height:100%;
      transition: transform var(--transition);
      overscroll-behavior: none; /* Prevents pull-to-refresh issues */
    }
    .screen {
      width:50%; /* Each screen takes half of the #app container */
      height:100%;
      padding: 48px 24px 24px; /* Adjusted padding */
      background: var(--surface);
      overflow-y: auto;
      overscroll-behavior: none;
      -ms-overflow-style: none; scrollbar-width: none; /* Hide scrollbar */
      display: flex; flex-direction: column; align-items: stretch;
    }
    .screen::-webkit-scrollbar { display: none; } /* Hide scrollbar for WebKit */

    /* Logo */
    .logo {
      margin: 48px auto 32px;
      text-align: center;
    }
    .logo img { width:48px; height:48px; }
    .logo h1 {
      margin-top:8px;
      font-size:24px;
      font-weight:400;
      color: var(--text);
    }
    /* Form */
    .form-group {
      position: relative;
      margin-bottom: 20px;
    }
    .form-group label {
      display: block;
      font-size: 14px;
      color: var(--primary);
      margin-bottom: 6px;
    }
    .form-group input {
      width:100%;
      padding:12px 40px 12px 12px; /* Space for icon */
      font-size:16px;
      border:1px solid #ccc;
      border-radius: var(--radius);
      transition: border-color var(--transition), box-shadow var(--transition);
    }
    .form-group input:focus {
      outline:none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px var(--primary-focus, rgba(30, 144, 255, 0.2)); /* Focus ring */
    }
    /* Icons inside inputs */
    .form-group .icon {
      position:absolute;
      top: calc(50% + 10px); /* Adjust based on label height and input padding */
      right:12px;
      transform: translateY(-50%);
      font-size:18px;
      color: var(--muted);
      cursor: pointer;
      transition: color var(--transition);
    }
    .form-group .icon:hover {
      color: var(--primary);
    }
    /* Buttons */
    .btn {
      display:block;
      width:100%;
      padding:14px;
      margin-top:12px;
      font-size:16px;
      font-weight:500;
      text-align:center;
      background: var(--primary);
      color:#fff;
      border:none;
      border-radius:30px; /* Pill shape */
      cursor:pointer;
      transition: transform 0.1s ease, background var(--transition);
      user-select:none; /* Prevent text selection */
      position: relative; /* For spinner positioning */
      overflow: hidden; /* To contain spinner animation effects if any */
    }
    .btn:active {
      transform: scale(0.97); /* Click feedback */
    }
    .btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    /* SPINNER INLINE */
    .btn .loader {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.6);
      border-top-color: #fff; /* Spinner color */
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      display: none; /* Hidden by default */
    }
    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Links */
    .link {
      text-align:center;
      margin-top:16px; /* Increased margin */
      margin-bottom: 16px;
    }
    .link a {
      color: var(--primary);
      font-size:14px;
      text-decoration:none;
      transition: opacity var(--transition);
    }
    .link a:hover {
        text-decoration: underline;
    }
    .link a:active {
      opacity:0.6;
    }
    /* OR separator */
    .or {
      display:flex;
      align-items:center;
      text-align:center;
      font-size:13px;
      color:#aaa;
      margin:24px 0;
    }
    .or::before, .or::after {
      content:'';
      flex:1;
      height:1px;
      background:#ddd;
    }
    .or::before { margin-right:8px; }
    .or::after { margin-left:8px; }

    /* Clear icon for input fields (optional) */
    .clear-icon {
      display: none; /* Hidden by default */
      /* Inherits styling from .form-group .icon */
    }

    /* Error messages */
    .input-error {
      display: none; /* Hidden by default */
      color: #e74c3c; /* Error color */
      font-size: 13px;
      margin-top: 4px;
      align-items: center; /* Align icon and text */
    }
    .input-error.show {
      display: flex; /* Show when class is added */
    }
    .input-error i.error-icon { /* Specific styling for error icon */
      margin-right: 6px;
      font-size: 16px; /* Slightly smaller error icon */
      color: #e74c3c; /* Ensure icon color matches text */
      position: static; /* Override potential absolute positioning */
      cursor: default;
    }

    /* Message Box for alerts */
    .message-box-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    .message-box-overlay.show {
        opacity: 1;
        visibility: visible;
    }
    .message-box {
        background-color: var(--surface);
        padding: 25px;
        border-radius: var(--radius);
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        text-align: center;
        max-width: 80%;
        width: 300px;
    }
    .message-box p {
        margin-bottom: 20px;
        font-size: 16px;
        color: var(--text);
    }
    .message-box button {
        padding: 10px 20px;
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 14px;
    }
    .message-box button:hover {
        opacity: 0.9;
    }

  </style>
</head>
<body>

  <div id="app">
    <div class="screen" id="login-screen">
      <div class="logo">
        <h1>Welcome Back</h1>
      </div>

      <div class="form-group">
        <label for="login-user">Email or Username</label>
        <input type="text" id="login-user" placeholder="Enter your email" autocomplete="email">
        <div class="input-error" id="error-login-user" role="alert">
          <i class="bi bi-exclamation-circle-fill error-icon" aria-hidden="true"></i>
          <span class="error-text"></span>
        </div>
      </div>

      <div class="form-group">
        <label for="login-pw">Password</label>
        <input type="password" id="login-pw" placeholder="Password" autocomplete="current-password">
        <i class="bi bi-eye icon" id="toggle-login"></i>
        <div class="input-error" id="error-login-pw" role="alert" aria-live="assertive">
          <i class="bi bi-exclamation-circle-fill error-icon" aria-hidden="true"></i>
          <span class="error-text"></span>
        </div>
      </div>

      <div class="link"><a href="#" id="reset-pw-link">Reset Password?</a></div>
      <button class="btn" id="btn-login">
        <span class="btn-text">Sign in with email</span>
        <div class="loader"></div>
      </button>

      <div class="or">OR</div>
      <div class="link"><a href="#" id="to-signup">Create an account</a></div>
    </div>

    <div class="screen" id="signup-screen">
      <div class="logo">
        <h1>Create Account</h1>
      </div>

      <div class="form-group">
        <label for="signup-first">First Name</label>
        <input type="text" id="signup-first" placeholder="First Name" autocomplete="given-name">
        <div class="input-error" id="error-signup-first" role="alert">
             <i class="bi bi-exclamation-circle-fill error-icon" aria-hidden="true"></i>
             <span class="error-text"></span>
        </div>
      </div>

      <div class="form-group">
        <label for="signup-last">Last Name</label>
        <input type="text" id="signup-last" placeholder="Last Name" autocomplete="family-name">
        <div class="input-error" id="error-signup-last" role="alert">
             <i class="bi bi-exclamation-circle-fill error-icon" aria-hidden="true"></i>
             <span class="error-text"></span>
        </div>
      </div>

      <div class="form-group">
        <label for="signup-email">Email</label>
        <input type="email" id="signup-email" placeholder="Email" autocomplete="email">
         <div class="input-error" id="error-signup-email" role="alert">
             <i class="bi bi-exclamation-circle-fill error-icon" aria-hidden="true"></i>
             <span class="error-text"></span>
        </div>
      </div>

      <div class="form-group">
        <label for="signup-pw">Password</label>
        <input type="password" id="signup-pw" placeholder="Create a password" autocomplete="new-password">
        <i class="bi bi-eye icon" id="toggle-signup"></i>
        <div class="input-error" id="error-signup-pw" role="alert">
             <i class="bi bi-exclamation-circle-fill error-icon" aria-hidden="true"></i>
             <span class="error-text"></span>
        </div>
      </div>

      <div class="link" style="font-size:13px;line-height:1.4;">
        By signing up, you agree to our <a href="#">Privacy Policy</a> and <a href="#">Terms of Service</a>.
      </div>
      <button class="btn" id="btn-signup">
        <span class="btn-text">Create an account</span>
        <div class="loader"></div>
      </button>

      <div class="or">OR</div>
      <div class="link"><a href="#" id="to-login">Already have an account? Login</a></div>
    </div>
  </div>

  <div class="message-box-overlay" id="message-box-overlay">
    <div class="message-box">
        <p id="message-box-text"></p>
        <button id="message-box-ok">OK</button>
    </div>
  </div>

  <script>
    const app = document.getElementById('app');
    const loginScreen = document.getElementById('login-screen');
    const signupScreen = document.getElementById('signup-screen');

    const toSignup = () => {
        app.style.transform = 'translateX(-50%)';
        clearAllErrors(); // Clear errors when switching screens
        document.title = "Sign Up";
    };
    const toLogin  = () => {
        app.style.transform = 'translateX(0)';
        clearAllErrors(); // Clear errors when switching screens
        document.title = "Login";
    };

    document.getElementById('to-signup').addEventListener('click', e => { e.preventDefault(); toSignup(); });
    document.getElementById('to-login').addEventListener('click',  e => { e.preventDefault(); toLogin(); });

    // Toggle password visibility
    function bindToggle(btnId, inputId, iconVisible = 'bi-eye', iconHidden = 'bi-eye-slash') {
      const btn = document.getElementById(btnId);
      const inp = document.getElementById(inputId);
      if (!btn || !inp) return; // Guard against missing elements

      btn.addEventListener('click', () => {
        if (inp.type === 'password') {
          inp.type = 'text';
          btn.classList.replace(iconVisible, iconHidden);
        } else {
          inp.type = 'password';
          btn.classList.replace(iconHidden, iconVisible);
        }
      });
    }
    bindToggle('toggle-login','login-pw');
    bindToggle('toggle-signup','signup-pw');

    // Touch-swipe navigation
    let startX = 0;
    let isSwiping = false;
    app.addEventListener('touchstart', e => {
        startX = e.touches[0].clientX;
        isSwiping = true;
    }, { passive: true });

    app.addEventListener('touchmove', e => {
        if (!isSwiping) return;
        // Optional: Add visual feedback during swipe if desired
    }, { passive: true });

    app.addEventListener('touchend', e => {
      if (!isSwiping) return;
      isSwiping = false;
      const diff = startX - e.changedTouches[0].clientX;
      const currentTransform = app.style.transform;

      if (diff > 50 && currentTransform !== 'translateX(-50%)') { // Swipe left
        toSignup();
      } else if (diff < -50 && currentTransform === 'translateX(-50%)') { // Swipe right
        toLogin();
      }
    });

    // --- Custom Alert Function ---
    const messageBoxOverlay = document.getElementById('message-box-overlay');
    const messageBoxText = document.getElementById('message-box-text');
    const messageBoxOk = document.getElementById('message-box-ok');

    function customAlert(message) {
        messageBoxText.textContent = message;
        messageBoxOverlay.classList.add('show');
        return new Promise((resolve) => { // Return a promise that resolves when OK is clicked
            messageBoxOk.onclick = () => {
                messageBoxOverlay.classList.remove('show');
                resolve();
            };
        });
    }

    // --- Field Error Utilities ---
    function showFieldError(fieldId, message) {
      const errDiv = document.getElementById(`error-${fieldId}`);
      const inputEl = document.getElementById(fieldId);
      if (errDiv) {
        errDiv.querySelector('.error-text').textContent = message;
        errDiv.classList.add('show');
      }
      if (inputEl) {
          inputEl.setAttribute('aria-invalid', 'true');
          inputEl.setAttribute('aria-describedby', `error-${fieldId}`);
      }
    }

    function clearFieldError(fieldId) {
      const errDiv = document.getElementById(`error-${fieldId}`);
      const inputEl = document.getElementById(fieldId);
      if (errDiv) {
        errDiv.classList.remove('show');
        errDiv.querySelector('.error-text').textContent = '';
      }
      if (inputEl) {
          inputEl.removeAttribute('aria-invalid');
          inputEl.removeAttribute('aria-describedby');
      }
    }

    function clearAllErrors() {
        const errorFields = [
            'login-user', 'login-pw',
            'signup-first', 'signup-last', 'signup-email', 'signup-pw'
        ];
        errorFields.forEach(clearFieldError);
    }


    // Clear error on input
    const allInputs = document.querySelectorAll('#login-screen input, #signup-screen input');
    allInputs.forEach(input => {
      input.addEventListener('input', () => clearFieldError(input.id));
    });


    // --- Sign In Logic ---
    const loginUser = document.getElementById('login-user');
    const loginPw   = document.getElementById('login-pw');
    const btnLogin  = document.getElementById('btn-login');

    if (btnLogin) {
        btnLogin.addEventListener('click', () => {
          // 1) Clear old errors
          clearFieldError('login-user');
          clearFieldError('login-pw');

          // 2) Get and validate values
          const email = loginUser.value.trim();
          const pw    = loginPw.value;
          let isValid = true;

          if (!email) {
            showFieldError('login-user', 'Please enter your email.');
            loginUser.focus();
            isValid = false;
          } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) { // Basic email validation
            showFieldError('login-user', 'Invalid email address format.');
            loginUser.focus();
            isValid = false;
          }

          if (!pw) {
            showFieldError('login-pw', 'Please enter your password.');
            if (isValid) loginPw.focus(); // Only focus if email was valid
            isValid = false;
          }

          if (!isValid) return;

          // 3) Call Firebase with spinner
          withSpinner('btn-login', () =>
            auth.signInWithEmailAndPassword(email, pw)
          )
          .then(() => {
            console.log('User logged in successfully');
            // MODIFIED LINE: Replace history state
            window.location.replace('index.html#home');
          })
          .catch(err => {
            console.error('[Auth] Login error:', err.code, err.message);
            switch (err.code) {
              case 'auth/invalid-email':
                showFieldError('login-user', 'Invalid email address format.');
                loginUser.focus();
                break;
              case 'auth/user-disabled':
                showFieldError('login-user', 'This account has been disabled.');
                loginUser.focus();
                break;
              case 'auth/user-not-found':
              case 'auth/wrong-password':
              case 'auth/invalid-credential': // More recent Firebase versions use this
              case 'auth/invalid-login-credentials': // As per your original code
                showFieldError('login-pw', 'Incorrect email or password.');
                loginPw.focus();
                break;
              default:
                showFieldError('login-user', 'Login failed. Please try again.');
            }
          });
        });
    }


    // --- Sign Up Logic ---
    const signupFirst = document.getElementById('signup-first');
    const signupLast  = document.getElementById('signup-last');
    const signupEmail = document.getElementById('signup-email');
    const signupPw    = document.getElementById('signup-pw');
    const btnSignup   = document.getElementById('btn-signup');

    if (btnSignup) {
        btnSignup.addEventListener('click', () => {
            clearAllErrors(); // Clear previous errors

            const firstname = signupFirst.value.trim();
            const lastname  = signupLast.value.trim();
            const email     = signupEmail.value.trim();
            const password  = signupPw.value;
            let isValid = true;

            if (!firstname) {
                showFieldError('signup-first', 'Please enter your first name.');
                if(isValid) signupFirst.focus();
                isValid = false;
            }
            if (!lastname) {
                showFieldError('signup-last', 'Please enter your last name.');
                if(isValid) signupLast.focus();
                isValid = false;
            }
            if (!email) {
                showFieldError('signup-email', 'Please enter your email address.');
                if(isValid) signupEmail.focus();
                isValid = false;
            } else if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showFieldError('signup-email', 'Invalid email address format.');
                if(isValid) signupEmail.focus();
                isValid = false;
            }
            if (!password) {
                showFieldError('signup-pw', 'Please create a password.');
                if(isValid) signupPw.focus();
                isValid = false;
            } else if (password.length < 6) {
                showFieldError('signup-pw', 'Password must be at least 6 characters.');
                 if(isValid) signupPw.focus();
                isValid = false;
            }

            if (!isValid) return;


            withSpinner('btn-signup', async () => {
                try {
                    const userCred = await auth.createUserWithEmailAndPassword(email, password);
                    await userCred.user.updateProfile({
                        displayName: `${firstname} ${lastname}`
                    });
                    // It's crucial to wait for the token to be refreshed
                    // so that claims (like 'activated') are potentially up-to-date
                    // when index.html is loaded.
                    await auth.currentUser.getIdToken(true); // Force refresh token

                    console.log('User signed up and profile updated');
                    // MODIFIED LINE: Replace history state and redirect to activation
                    window.location.replace('index.html#activation');

                } catch (err) {
                    console.error('[Auth] Signup error:', err.code, err.message);
                    // This error will be re-thrown by withSpinner and caught by the .catch below
                    throw err;
                }
            })
            .catch(err => {
                // Handle errors from createUserWithEmailAndPassword or updateProfile
                switch (err.code) {
                    case 'auth/email-already-in-use':
                        showFieldError('signup-email', 'This email is already registered.');
                        signupEmail.focus();
                        break;
                    case 'auth/invalid-email':
                        showFieldError('signup-email', 'Invalid email address format.');
                        signupEmail.focus();
                        break;
                    case 'auth/weak-password':
                        showFieldError('signup-pw', 'Password is too weak. Min 6 characters.');
                        signupPw.focus();
                        break;
                    default:
                        // Use customAlert for generic errors not tied to a specific field
                        customAlert(err.message || 'Signup failed. Please try again.');
                }
            });
        });
    }

    // --- Reset Password Link (Placeholder) ---
    const resetPwLink = document.getElementById('reset-pw-link');
    if(resetPwLink) {
        resetPwLink.addEventListener('click', (e) => {
            e.preventDefault();
            customAlert('Password reset functionality will be implemented here. For now, please contact support or try signing up if you forgot your details.');
            // TODO: Implement password reset flow
            // Example:
            // const email = loginUser.value.trim();
            // if (!email) {
            //   customAlert('Please enter your email address in the email field first.');
            //   loginUser.focus();
            //   return;
            // }
            // auth.sendPasswordResetEmail(email)
            //   .then(() => customAlert('Password reset email sent! Check your inbox.'))
            //   .catch(err => customAlert('Error sending reset email: ' + err.message));
        });
    }


    // --- Service Worker Registration ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js') // Ensure sw.js is in the root directory
          .then(reg => {
            console.log('[App] SW enregistrÃ©, scope :', reg.scope);

            reg.addEventListener('updatefound', () => {
              const newSW = reg.installing;
              if (newSW) {
                newSW.addEventListener('statechange', () => {
                  if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('[App] Nouvelle version dispo â†’ reload');
                    // Optional: Show a notification to the user before reloading
                    // if (confirm("A new version is available. Reload now?")) {
                    //   window.location.reload();
                    // }
                    customAlert("A new version of the app is available and will be applied.").then(() => {
                        window.location.reload();
                    });
                  }
                });
              }
            });
          })
          .catch(err => console.error('[App] Ã‰chec enregistrement SW :', err));
      });
    }

    // Set initial document title
    if (app.style.transform === 'translateX(-50%)') {
        document.title = "Sign Up";
    } else {
        document.title = "Login";
    }

  </script>
</body>
</html>
