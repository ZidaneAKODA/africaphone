<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>BookShop</title>

  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <style>
    body { visibility: hidden; } /* Initialement caché pour éviter FOUC */
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-functions-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>


  <script>
    // Remplace par ta config
    const firebaseConfig = {
      apiKey: "AIzaSyCvNZ5lhKdP_6W-eRle-7zCmFqejSfRuto", // Replace with your actual API key if necessary
      authDomain: "shoptel-35c7e.firebaseapp.com",
      projectId: "shoptel-35c7e",
      storageBucket: "shoptel-35c7e.appspot.com",
      messagingSenderId: "541177101809",
      appId: "1:541177101809:web:5ae3ea186f198558371850",
      measurementId: "G-VH4MCV6Y6E"
    };

    // 1) Initialise l’app et Auth UNE SEULE FOIS
    firebase.initializeApp(firebaseConfig);
    firebase.firestore().settings({ ignoreUndefinedProperties: true }); // Bonne pratique

    // 2) Dès que l’état d’auth est connu…
    const auth    = firebase.auth();
    const fn      = firebase.functions(); // Si vous utilisez des fonctions Firebase (ex: Europe-west1)
    // const fn = firebase.app().functions('europe-west1'); // Exemple pour une région spécifique
    const db = firebase.firestore();

    // fonction callable pour vérifier le code
    const verifyActivationCode = fn.httpsCallable('verifyActivationCode');
  </script>

  <style>
    /* ——— Gestion de la visibilité des “pages” ——— */
    main.page {
      display: none;              /* cachée par défaut */
      flex: 1 1 auto;             /* occupe l’espace restant */
      width: 100%;                /* toute la largeur */
      overflow-y: auto;           /* scroll interne si besoin */
      /* padding-bottom pour laisser la place à la nav en bas */
      /* Ce padding sera ajusté par le script pour les pages SANS nav principale */
      padding-bottom: calc(56px + env(safe-area-inset-bottom));
    }

    main.page.visible {
      display: flex;              /* devient visible et flex */
      flex-direction: column;
    }

    :root{
      --primary-text:#222;
      --secondary-text:#555;
      --border-radius-pill:2rem;
      --border-radius-card: 0.75rem; /* Updated for consistency */
      --border-color: #e0e0e0; 
      --ebay-red:#e53238;
      --ebay-blue:#0064d2;
      --ebay-yellow:#f5af02;
      --ebay-green:#86b817;
      --accent:#0064d2;
      --surface: #fff; /* Added for consistency with new-supply */
      --stock-low-color: #f5af02; /* Orange for low stock */
      --stock-out-color: #e53238; /* Red for out of stock */
      --action-icon-color: #757575;
      --action-icon-hover-bg: #f0f0f0; /* Used for :active state as well */
      --chart-primary-color: #0064d2;
      --chart-secondary-color: #86b817;
      --chart-profit-color: #28a745;
      --chart-sales-color: #007bff;
      --chart-cogs-color: #ffc107;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

    html,body{
      width:100%;height:100%;
      font-family:'Roboto',sans-serif;
      background:#fff;color:var(--primary-text);
      -webkit-font-smoothing:antialiased;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
      display:flex;flex-direction:column;
      height:100vh;height:100dvh; /* dvh pour une meilleure gestion du viewport sur mobile */
    }

    /* COMMON STYLES */
    header{padding:1rem 1rem 0.5rem}
    .cart{margin-left:auto;font-size:1.6rem;color:var(--primary-text)}

    .search-wrapper{
      margin-top:0.75rem;position:relative
    }
    .search-wrapper input{
      width:100%;padding:0.75rem 3.25rem 0.75rem 2.75rem;
      border:1px solid var(--border-color); 
      border-radius:var(--border-radius-pill);
      background:#f4f4f4;font-size:1rem;outline:none;cursor:pointer;
      box-shadow: none; 
    }
    .search-wrapper .bi-search{
      position:absolute;left:1rem;top:50%;
      transform:translateY(-50%);font-size:1.1rem;color:var(--secondary-text)
    }
    .search-wrapper .actions{
      position:absolute;right:0.75rem;top:50%;
      transform:translateY(-50%);display:flex;gap:0.5rem;
      font-size:1.6rem;color:var(--secondary-text)
    }

    .signin-card{text-align:center;margin:0.5rem 0 1.2rem}
    .signin-card p{
      font-size:1.05rem;color:var(--secondary-text);
      margin-bottom:1rem;line-height:1.4
    }
    .signin-actions{display:flex;justify-content:center;gap:1rem}

    .btn-outline{
      flex:0 0 42%;padding:0.7rem 1rem;border:2px solid var(--accent);
      border-radius:var(--border-radius-pill);background:#fff;
      font-weight:500;color:var(--accent);font-size:1rem;
      transition:all 0.2s ease;outline:none; box-shadow: none;
    }
    .btn-outline:active{background:var(--accent);color:#fff}

    .promo-block{
      background:#f5f5f5;padding:1.5rem 1rem;margin-bottom:1.2rem
    }
    .promo-block h2{font-size:1.6rem;margin-bottom:0.5rem}
    .promo-block p{
      color:var(--secondary-text);font-size:1rem;line-height:1.4;margin-bottom:1rem
    }
    .btn-primary{
      padding:0.85rem 1.5rem;background:var(--accent);color:#fff;border:none;
      border-radius:var(--border-radius-pill);font-size:1rem;font-weight:600;
      box-shadow:none; 
      outline:none;
    }
    .btn-primary:active{background:#014fa5}
    .btn-primary:disabled{background:#ccc; cursor:not-allowed;}


    .trending{padding:0 1rem 5.5rem}
    .trending h3{font-size:1.35rem;margin-bottom:0.75rem}
    .trend-list{
      display:flex;gap:1.25rem;overflow-x:auto;padding-bottom:0.5rem;
      -ms-overflow-style:none;scrollbar-width:none
    }
    .trend-list::-webkit-scrollbar{display:none}
    .trend-item{
      flex:0 0 auto;text-align:center;user-select:none;padding:0.5rem
    }
    .trend-item img{
      width:5.3rem;height:5.3rem;border-radius:50%;object-fit:cover;
      box-shadow:none; 
      border: 1px solid var(--border-color); 
    }
    .trend-item .product-name{display:block;margin-top:0.5rem;font-weight:500}
    .trend-item .price{
      display:block;margin:0.25rem 0 0.75rem;color:var(--ebay-red);font-weight:600
    }
    .btn-add{font-size:0.85rem;padding:0.4rem 0.8rem}

    /* NAVIGATION BAR */
    nav{
      position:fixed;bottom:0;left:0;width:100%;background:#fff;
      border-top:1px solid var(--border-color);z-index:300; /* Augmenté pour être au-dessus des modales potentielles si mal gérées */
    }
    .nav-inner{display:flex;justify-content:space-evenly;align-items:center;padding:0.4rem 0 env(safe-area-inset-bottom) 0;}
    .nav-link{
      flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
      font-size:0.8rem;color:var(--secondary-text);outline:none;user-select:none;
      position:relative;overflow:hidden;padding:0.6rem 0;border-radius:var(--border-radius-pill);
      background:none;border:none;cursor:pointer;text-decoration:none
    }
    .nav-link i{font-size:1.25rem}
    .nav-link.active{color:var(--accent);background:rgba(0,100,210,0.12)}

    /* RIPPLE EFFECT */
    .ripple{
      position:absolute;border-radius:50%;transform:scale(0);
      background:rgba(0,100,210,0.25);animation:ripple 600ms linear;pointer-events:none
    }
    @keyframes ripple{to{transform:scale(4);opacity:0}}

    /* === Home page actions === */
    .home-actions{
      display:flex; flex-wrap: wrap; justify-content:space-around;gap:1rem;padding:1rem
    }
    .btn-action{
      flex:1 1 calc(50% - 1rem); /* Two buttons per row on small screens */
      min-width: 140px; /* Minimum width for buttons */
      display:flex;align-items:center;justify-content:center;gap:0.5rem;
      padding:0.8rem 1rem;border:none;border-radius:var(--border-radius-pill);
      font-size:1rem;font-weight:500;box-shadow:none; 
      border: 1px solid var(--border-color); 
      transition:transform 0.1s ease;color:#fff;cursor:pointer;
      text-decoration: none; /* For <a> tags used as buttons */
    }
    .btn-action:active{transform:translateY(1px);}
    .btn-sell{background:var(--ebay-green)}
    .btn-buy {background:var(--ebay-blue)}

    .btn-reports-card {
        flex: 1 1 100%; 
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1.25rem 1rem;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-card); 
        font-size: 1.1rem;
        font-weight: 500;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
        background: #fff; 
        color: var(--primary-text); 
        cursor: pointer;
        transition: transform 0.1s ease, box-shadow 0.2s ease;
        text-decoration: none;
        margin-top: 0.5rem; 
    }
    .btn-reports-card i {
        font-size: 1.8rem; 
        color: var(--accent); 
        margin-bottom: 0.25rem;
    }
    .btn-reports-card:active {
        transform: translateY(1px);
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    /* === Stock info card === */
    .stock-card{
      background:var(--ebay-yellow);border-radius:var(--border-radius-pill);
      margin:0 1rem 1.5rem;padding:0.75rem 1rem;text-align:center;
      box-shadow:none; 
      border: 1px solid #e6a002; 
    }
    .stock-count{font-size:1.8rem;font-weight:700;color:var(--primary-text)}
    .stock-label{font-size:0.95rem;color:var(--secondary-text)}

    /* ---------- Info cards sans ombre, avec cadre ---------- */
    .info-cards {
      display: flex;
      gap: 0.75rem; 
      padding: 0.75rem 1rem; 
      margin-bottom: 1rem; 
      overflow-x: auto;
      transition: opacity 0.3s ease, max-height 0.3s ease, margin-bottom 0.3s ease, padding 0.3s ease;
      max-height: 200px;
    }
    .info-card {
      flex: 1;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-card);
      padding: 0.75rem; 
      text-align: center;
      min-width: 120px; 
      box-shadow: none; 
    }
    .info-number {
      font-size: 1.3rem; 
      font-weight: 600;
      color: var(--ebay-blue);
      line-height: 1.2;
    }
    .info-label {
      font-size: 0.8rem; 
      color: var(--secondary-text);
      margin-top: 0.25rem; 
    }
    .info-cards.fade-out {
      opacity: 0;
      max-height: 0;
      margin-bottom: 0;
      padding-top: 0;
      padding-bottom: 0;
      pointer-events: none;
    }

    /* === Styles pour la page Catalogue (main#catalog) === */
    main#catalog {
      padding: 0; 
      margin: 0;
    }
    /* Styles pour la liste des livres (communs à #catalog-results-main et #stock-list-results-container) */
    .books-list {
      display: flex;
      flex-direction: column;
      gap: 1rem; 
      padding: 1rem; 
    }
    .book-card-catalog { /* Renommé pour être plus générique si besoin, mais gardons-le pour l'instant */
      display: flex;
      gap: 1rem;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-card);
      padding: 1rem;
      box-shadow: none !important; /* Assurer pas d'ombre */
    }
    .book-card-image-area {
      flex: 0 0 60px; 
      height: 80px; 
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      border-radius: calc(var(--border-radius-card) - 0.25rem);
      overflow: hidden; 
    }
    .book-card-image-area .book-placeholder-icon {
      font-size: 2.5rem; 
      color: var(--secondary-text);
    }
    .book-card-content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem; 
    }
    .book-card-main-info .book-title {
      font-size: 1.15rem; 
      font-weight: 600;
      color: var(--primary-text);
      margin-bottom: 0.25rem;
      line-height: 1.3;
    }
    .book-card-main-info p, .book-card-secondary-info p {
      font-size: 0.9rem;
      color: var(--secondary-text);
      margin-bottom: 0.2rem;
      display: flex; 
      align-items: center;
      gap: 0.4rem; 
    }
    .book-card-main-info p i, .book-card-secondary-info p i {
      font-size: 1rem; 
      color: var(--action-icon-color);
      min-width: 16px; 
      text-align: center;
    }
    .book-card-main-info p span, .book-card-secondary-info p span {
        font-weight: 500; 
        color: var(--primary-text);
    }
    .book-card-main-info .book-price-sell span {
        color: var(--ebay-blue); 
        font-weight: 600;
    }
    .book-card-main-info .stock-value {
        font-weight: 600;
    }
    .book-card-main-info .stock-value.stock-normal { color: var(--ebay-green); }
    .book-card-main-info .stock-value.stock-low { color: var(--stock-low-color); }
    .book-card-main-info .stock-value.stock-out { color: var(--stock-out-color); }
    .book-card-actions {
      margin-top: 0.5rem; 
      padding-top: 0.5rem; 
      border-top: 1px solid #f0f0f0;
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end; 
    }
    .btn-action-icon {
      background-color: transparent;
      border: none;
      color: var(--action-icon-color);
      padding: 0.5rem;
      border-radius: 50%; 
      cursor: pointer;
      font-size: 1.1rem; 
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    .btn-action-icon:active { 
      background-color: var(--action-icon-hover-bg); 
      color: var(--primary-text);
    }
    .btn-action-icon.btn-delete-book:active { 
      background-color: rgba(229, 50, 56, 0.15); 
      color: var(--ebay-red);
    }
    .btn-action-icon i { 
        line-height: 1; 
    }
    .books-list .skeleton-book-card-catalog { /* Utilisé aussi pour stock-list */
        display: flex;
        gap: 1rem;
        background: #f9f9f9;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-card);
        padding: 1rem;
        height: 150px; 
        animation: pulse 1.5s infinite ease-in-out;
    }
      @keyframes pulse {
      0%   { opacity: 1; }
      50%  { opacity: 0.6; }
      100% { opacity: 1; }
    }

    /* === Styles pour la page Historique des Ventes (main#sales) === */
    header#sales-header {
      padding: 1rem;
      background: #fff;
      border-bottom: 1px solid var(--border-color);
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      z-index: 15;
    }
    header#sales-header h2 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary-text);
    }
    #sales-summary-filter-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.75rem 1rem;
        background-color: #f8f9fa; 
        border-bottom: 1px solid var(--border-color);
        gap: 0.75rem; 
        position: -webkit-sticky;
        position: sticky;
        top: 57px; /* Hauteur approximative du header#sales-header */
        z-index: 14; 
        flex-wrap: wrap; 
    }
    #sales-summary-chip {
        font-size: 0.85rem; 
        font-weight: 500;
        padding: 0.4rem 0.8rem;
        background-color: var(--ebay-blue);
        color: white;
        border-radius: var(--border-radius-pill);
        white-space: nowrap;
        flex-shrink: 0; 
    }
    #sales-date-filter-group {
        display: flex;
        align-items: center;
        gap: 0.5rem; 
        flex-grow: 1; 
        justify-content: flex-end; 
    }
    #sales-selected-date-display {
        font-size: 0.85rem;
        color: var(--secondary-text);
        font-weight: 500;
        text-align: right;
    }
    #sales-date-filter-btn {
        background-color: #fff;
        border: 1px solid var(--border-color);
        color: var(--primary-text);
        border-radius: 50%;
        width: 32px; 
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem; 
        cursor: pointer;
        box-shadow: none;
        padding:0;
        flex-shrink: 0;
    }
    #sales-date-filter-btn:active {
        background-color: #e9ecef; 
    }
    #sales-date-filter-btn i {
        line-height: 1; 
    }
    #sales-date-picker {
        position: absolute;
        opacity: 0;
        width: 1px;
        height: 1px;
        overflow: hidden;
        clip: rect(0 0 0 0);
        white-space: nowrap;
        border: 0;
        padding: 0;
        margin: -1px;
    }
    main#sales .sales-list { 
        display: flex;
        flex-direction: column;
        gap: 1rem; 
        padding: 1rem; 
    }
    main#sales .skeleton-sale-card { 
        background: #f9f9f9;
        height: 100px; 
        margin: 0;
        border-radius: var(--border-radius-card);
        animation: pulse 1.5s infinite ease-in-out;
    }
    main#sales .sale-card { 
        background: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-card);
        margin: 0;
        padding: 1rem;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    main#sales .sale-card header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding: 0; 
        border-bottom: 1px solid #efefef; 
        padding-bottom: 0.5rem; 
    }
    main#sales .sale-card header .sale-info {
        flex-grow: 1;
        margin-right: 0.75rem;
    }
    main#sales .sale-card header .sale-info strong { 
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-text);
        display: block;
        margin-bottom: 0.2rem;
    }
    main#sales .sale-card header .sale-info small { 
        font-size: 0.8rem;
        color: var(--secondary-text);
        display: block;
    }
    main#sales .sale-card header .sale-meta {
        text-align: right;
        flex-shrink: 0;
    }
    main#sales .sale-card header .sale-meta .sale-total-amount { 
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--ebay-green);
        display: block;
    }
      main#sales .sale-card header .sale-meta .sale-total-items { 
        font-size: 0.85rem;
        color: var(--secondary-text);
        display: block;
        margin-top: 0.1rem;
    }
    main#sales .sale-card .sale-items-summary { 
        font-size: 0.85rem;
        color: var(--secondary-text);
        padding-top: 0.5rem;
    }

    /* === Styles pour la page Rapports (main#reports) === */
    main#reports header#reports-header {
        padding: 1rem;
        background: #fff;
        border-bottom: 1px solid var(--border-color);
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 15; /* Z-index pour le header de la page rapports */
    }
    main#reports header#reports-header h2 {
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--primary-text);
    }
    .reports-active-filter-summary-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.6rem 1rem;
      background-color: var(--surface);
      border-bottom: 1px solid var(--border-color);
      position: -webkit-sticky;
      position: sticky;
      top: 57px; /* Hauteur du header#reports-header */
      z-index: 14; /* En dessous du header principal de la page rapports */
      font-size: 0.9rem;
    }
    #active-filters-display {
      color: var(--secondary-text);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-right: 0.5rem;
    }
    #btn-open-reports-filters {
      background-color: var(--accent-bg-light, rgba(0,100,210,0.1));
      color: var(--accent);
      border: 1px solid var(--accent-border, rgba(0,100,210,0.3));
      padding: 0.4rem 0.8rem;
      border-radius: var(--border-radius-pill);
      font-weight: 500;
      font-size: 0.85rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 0.4rem;
    }
    #btn-open-reports-filters i { font-size: 1rem; }
    .reports-content-scrollable {
      padding: 0.75rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .kpi-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 0.75rem;
    }
    .kpi-card {
        background-color: var(--surface);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-card);
        padding: 0.75rem;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        gap: 0.2rem;
        box-shadow: none;
    }
    .kpi-card .kpi-icon {
      font-size: 1.3rem;
      color: var(--accent);
      margin-bottom: 0.2rem;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0,100,210,0.1);
    }
    .kpi-card .kpi-icon.revenue { color: var(--chart-sales-color); background-color: rgba(0,123,255,0.08); }
    .kpi-card .kpi-icon.cogs { color: var(--chart-cogs-color); background-color: rgba(255,193,7,0.08); }
    .kpi-card .kpi-icon.profit { color: var(--chart-profit-color); background-color: rgba(40,167,69,0.08); }
    .kpi-card .kpi-icon.sales-count { color: var(--ebay-green); background-color: rgba(134,184,23,0.08); }
    .kpi-card .kpi-icon.items-sold { color: var(--ebay-blue); background-color: rgba(0,100,210,0.08); }
    .kpi-card .kpi-icon.profit-margin { color: var(--ebay-yellow); background-color: rgba(245,175,2,0.08); }
    .kpi-card .kpi-value {
        font-size: 1.4rem;
        font-weight: 600;
        color: var(--primary-text);
        line-height: 1.2;
    }
    .kpi-card .kpi-value.profit { color: var(--chart-profit-color); }
    .kpi-card .kpi-value.revenue { color: var(--chart-sales-color); }
    .kpi-card .kpi-value.cogs { color: var(--chart-cogs-color); }
    .kpi-card .kpi-label {
        font-size: 0.75rem;
        color: var(--secondary-text);
    }
    .report-type-placeholder {
      padding: 1.5rem; text-align: center; color: var(--secondary-text);
      border: 2px dashed var(--border-color); border-radius: var(--border-radius-card);
      margin: 0.75rem; font-size: 0.9rem;
    }

    /* Styles pour le tiroir de filtres (Reports Filter Drawer) */
    .drawer-overlay { /* Utilisé aussi pour catalog-drawer-overlay et stock-sort-drawer-overlay */
      position: fixed; top: 0; left: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.3);
      opacity: 0; visibility: hidden;
      transition: opacity 0.3s ease-out, visibility 0s 0.3s linear;
      z-index: 200; /* Au-dessus de la nav principale */
    }
    .drawer-overlay.visible {
      opacity: 1; visibility: visible;
      transition-delay: 0s;
    }
    .report-filter-drawer, .catalog-sort-drawer { /* Styles communs pour les tiroirs */
      position: fixed; bottom: 0; left: 0;
      width: 100%; 
      background-color: var(--surface);
      border-top-left-radius: 16px; border-top-right-radius: 16px;
      box-shadow: 0 -3px 15px rgba(0,0,0,0.15);
      transform: translateY(100%);
      transition: transform 0.3s ease-out;
      z-index: 210; /* Au-dessus de l'overlay */
      display: flex; flex-direction: column;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .report-filter-drawer { max-height: 85vh; }
    .catalog-sort-drawer { max-height: 75vh; }

    .report-filter-drawer.visible, .catalog-sort-drawer.visible { transform: translateY(0%); }
    
    .report-filter-drawer .drawer-header, .catalog-sort-drawer .drawer-header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.75rem 1rem; border-bottom: 1px solid var(--border-color);
    }
    .report-filter-drawer .drawer-header h4, .catalog-sort-drawer .drawer-header h4 { 
        margin: 0; font-size: 1.1rem; font-weight: 600; 
    }
    .report-filter-drawer .close-drawer-btn, .catalog-sort-drawer .close-drawer-btn {
      background: none; border: none; font-size: 1.5rem; color: var(--secondary-text); cursor: pointer; padding: 0.25rem;
    }
    .report-filter-drawer .drawer-body, .catalog-sort-drawer .drawer-body {
      padding: 1rem; overflow-y: auto; flex-grow: 1;
    }
    .report-filter-drawer .filter-group, .catalog-sort-drawer .filter-group { 
        margin-bottom: 1.25rem; 
    }
    .report-filter-drawer .filter-group:last-child, .catalog-sort-drawer .filter-group:last-child { 
        margin-bottom: 0; 
    }
    .report-filter-drawer .filter-group-title, .catalog-sort-drawer .filter-group-title {
      display: block; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em;
      font-weight: 600; color: var(--secondary-text); margin-bottom: 0.6rem;
      display: flex; align-items: center; gap: 0.4rem;
    }
    .report-filter-drawer .filter-group-title i, .catalog-sort-drawer .filter-group-title i { 
        font-size: 0.9rem; 
    }
    .report-filter-drawer .filter-options {
      display: flex; flex-direction: column; gap: 0.75rem;
    }
    .report-filter-drawer .filter-options select,
    .report-filter-drawer .filter-options input[type="date"] {
      padding: 0.7rem 0.8rem; font-size: 0.95rem;
      border: 1px solid var(--border-color); border-radius: var(--border-radius-card);
      background-color: #fff; box-shadow: none; outline: none;
      width: 100%; height: 42px;
    }
    .report-filter-drawer .custom-date-range-inputs {
      display: none; flex-direction: column; gap: 0.75rem; width: 100%; margin-top: 0.5rem;
    }
    .report-filter-drawer .custom-date-range-inputs.visible { display: flex; }
    .report-filter-drawer .custom-date-inputs-wrapper {
      display: flex; gap: 0.75rem; width: 100%;
    }
    .report-filter-drawer .custom-date-inputs-wrapper > div {
      flex: 1; display: flex; flex-direction: column;
    }
    .report-filter-drawer .custom-date-inputs-wrapper label {
      font-size: 0.7rem; text-transform: uppercase; color: var(--secondary-text); margin-bottom: 0.25rem;
    }
    .report-filter-drawer .drawer-footer, .catalog-sort-drawer .drawer-footer {
      padding: 0.75rem 1rem; border-top: 1px solid var(--border-color);
      background-color: var(--surface);
    }
    .report-filter-drawer .btn-apply-filter.full-width, 
    .catalog-sort-drawer .btn-apply-sort.full-width { /* Style commun pour les boutons d'application */
      width: 100%; padding: 0.8rem; background-color: var(--accent); color: #fff;
      border: none; border-radius: var(--border-radius-pill); font-size: 1rem;
      font-weight: 500; cursor: pointer; display: flex; align-items: center;
      justify-content: center; gap: 0.5rem;
    }
    .report-filter-drawer .btn-apply-filter.full-width:disabled,
    .catalog-sort-drawer .btn-apply-sort.full-width:disabled {
      background-color: #ccc; cursor: not-allowed;
    }
    /* Styles spécifiques pour les options de tri du catalogue */
    .catalog-sort-drawer .sort-options-list {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }
    .catalog-sort-drawer .sort-option {
        display: flex;
        align-items: center;
        padding: 0.6rem 0.25rem;
        border-radius: var(--border-radius-card);
        cursor: pointer;
        transition: background-color 0.15s ease;
    }
    .catalog-sort-drawer .sort-option:hover {
        background-color: #f0f0f0;
    }
    .catalog-sort-drawer .sort-option input[type="radio"] {
        margin-right: 0.75rem;
        transform: scale(1.1);
        accent-color: var(--accent);
    }
    .catalog-sort-drawer .sort-option label {
        font-size: 0.95rem;
        color: var(--primary-text);
        flex-grow: 1;
    }


    /* Styles pour la modale d'ajout de livre (hors du flux des pages) */
    .modal-overlay-container {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6); /* Fond plus sombre pour la modale */
      display: none; /* Caché par défaut */
      align-items: center;
      justify-content: center;
      z-index: 1000; /* Au-dessus de tout */
      padding: 1rem; /* Pour éviter que la modale ne colle aux bords */
    }
    .modal-overlay-container.visible {
      display: flex;
    }
    .modal-overlay-container .modal {
      background: var(--surface);
      border-radius: var(--border-radius-card);
      width: 100%;
      max-width: 400px; /* Largeur max de la modale */
      max-height: calc(100dvh - 4rem); /* Hauteur max avec padding */
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
      border: 1px solid var(--border-color);
    }
    .modal-overlay-container .modal header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-overlay-container .modal header h3 {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 600;
    }
    .modal-overlay-container .modal-close-btn { /* Nom de classe plus spécifique */
      background: none;
      border: none;
      font-size: 1.75rem;
      cursor: pointer;
      color: var(--secondary-text);
      padding: 0.25rem;
      line-height: 1;
    }
    .modal-overlay-container .modal-content {
      padding: 1.25rem; /* Plus de padding interne */
      flex-grow: 1; /* Permet au contenu de grandir si nécessaire */
    }
    .modal-overlay-container .form-group {
      margin-bottom: 1.25rem; /* Espacement augmenté */
    }
    .modal-overlay-container label {
      display: block;
      margin-bottom: 0.5rem; /* Espacement augmenté */
      font-size: 0.9rem;
      color: var(--secondary-text);
      font-weight: 500;
    }
    .modal-overlay-container input[type="search"], /* Cibler spécifiquement */
    .modal-overlay-container input[type="text"] {
      width: 100%;
      padding: 0.85rem; /* Padding augmenté */
      border: 1px solid var(--border-color); /* Bordure plus claire */
      border-radius: var(--border-radius-card);
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s ease, box-shadow 0.2s ease; /* Ajout de box-shadow transition */
      box-shadow: none;
    }
    .modal-overlay-container input[type="search"]:focus,
    .modal-overlay-container input[type="text"]:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(0,100,210,0.2); /* Effet de focus */
    }
    .modal-overlay-container button[type="submit"] {
      width: 100%;
      padding: 0.9rem; /* Padding augmenté */
      font-size: 1rem;
      font-weight: 600;
      border: none;
      border-radius: var(--border-radius-pill);
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      margin-top: 0.75rem; /* Marge augmentée */
      box-shadow:none;
      transition: background-color 0.2s ease;
    }
    .modal-overlay-container button[type="submit"]:hover {
        background-color: #0052a3; /* Assombrir au survol */
    }
    .modal-overlay-container button[type="submit"]:active {
      background: #004080; /* Encore plus sombre à l'activation */
    }
    .modal-overlay-container button[type="submit"]:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    /* Toast pour les messages (feedback) */
    .toast-notification {
        position: fixed;
        bottom: calc(env(safe-area-inset-bottom) + 20px);
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0,0,0,0.8);
        color: white;
        padding: 0.8rem 1.5rem;
        border-radius: var(--border-radius-pill);
        z-index: 2000; /* Au-dessus de tout */
        font-size: 0.9rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        pointer-events: none;
    }
    .toast-notification.visible {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
    .toast-notification.error {
        background-color: var(--ebay-red);
    }
    .toast-notification.success {
        background-color: var(--ebay-green);
    }

    /* Classe générique pour les boutons de retour en haut de page */
    .btn-page-back, .btn-page-close {
      background: none;
      border: none;
      font-size: 1.5rem; /* Ajustez la taille de l'icône */
      color: var(--primary-text);
      cursor: pointer;
      padding: 0.25rem 0.5rem; /* Petit padding pour la zone cliquable */
      line-height: 1; /* Important pour l'alignement vertical de l'icône */
      display: inline-flex;
      align-items: center;
      justify-content: center;
      outline: none;
    }

    /* Ajustement pour les headers qui contiennent ces boutons */
    main.page > header:has(.btn-page-back),
    main.page > header:has(.btn-page-close) {
      display: flex;
      align-items: center;
      /* gap: 0.75rem; /* Espace entre le bouton et le titre si besoin */
    }

    main.page > header:has(.btn-page-back) h2,
    main.page > header:has(.btn-page-close) h2 {
      margin: 0; /* Enlève la marge par défaut du h2 pour un meilleur alignement */
      margin-left: 0.5rem; /* Espace entre le bouton retour et le titre */
      flex-grow: 1; /* Permet au titre de prendre l'espace restant */
    }

    /* Styles pour la page Catalogue (main#catalog) - spécifiques */
    #catalog-main-header { /* Header de la page Catalogue Dashboard */
      padding: 1rem;
      background: #fff;
      border-bottom: 1px solid var(--border-color);
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      z-index: 20;
    }
    #catalog-main-header h2 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary-text);
    }
    .catalog-content-wrapper { /* Conteneur pour le contenu de la page Catalogue Dashboard */
      padding: 0 0 calc(56px + env(safe-area-inset-bottom) + 70px); /* Espace pour nav + FAB */
    }
    .catalog-stats-overview { /* Section des statistiques */
      padding: 1rem;
      background-color: #f8f9fa;
      border-bottom: 1px solid var(--border-color);
    }
    .catalog-stats-overview h3 {
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--primary-text);
      margin: 0 0 1rem 0;
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
    .stat-card {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-card);
      padding: 0.85rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.3rem;
    }
    .stat-card .stat-icon {
      font-size: 1.4rem;
      color: var(--accent);
      margin-bottom: 0.25rem;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background-color: rgba(0,100,210,0.1);
    }
    .stat-card .stat-icon.value { color: var(--ebay-green); background-color: rgba(134,184,23,0.08); }
    .stat-card .stat-icon.low-stock { color: var(--stock-low-color); background-color: rgba(245,175,2,0.08); }
    .stat-card .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--primary-text);
      line-height: 1.2;
    }
    .stat-card .stat-label {
      font-size: 0.8rem;
      color: var(--secondary-text);
    }
    .btn-primary.full-width { /* Pour le bouton PDF et Consulter Stock */
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.8rem 1rem;
      margin-top: 0.5rem; /* Ajout d'un peu d'espace au-dessus */
    }
    /* FAB pour Ajouter un Livre sur la page Catalogue */
    #btn-add-new-book-catalog {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom) + 1rem + 56px); /* Au-dessus de la nav principale */
      right: 1rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--ebay-green);
      color: #fff;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.7rem;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
      z-index: 100;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.2s ease;
    }
    #btn-add-new-book-catalog:active {
      background-color: #76a416;
      transform: scale(0.95);
    }
    .catalog-actions-section { /* Nouvelle section pour les boutons d'action */
        padding: 1rem;
        border-bottom: 1px solid var(--border-color);
    }

    /* Styles pour la nouvelle page Stock List (main#stock-list) */
    #stock-list-header { /* Header de la page Stock List */
        display: flex;
        align-items: center;
        justify-content: space-between; /* Pour espacer le titre et le bouton de tri */
        padding: 0.75rem 1rem; /* Padding standard pour header de page */
        background: #fff;
        border-bottom: 1px solid var(--border-color);
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 20; /* Z-index pour le header */
    }
    #stock-list-header .btn-page-back { /* Bouton retour spécifique */
        margin-right: 0.75rem; /* Espace avant le titre */
    }
    #stock-list-header h2 { /* Titre de la page */
        margin: 0;
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--primary-text);
        flex-grow: 1; /* Permet au titre de prendre l'espace */
    }
    #btn-open-stock-sort-drawer { /* Bouton pour ouvrir le tiroir de tri */
        flex-shrink: 0;
        background-color: var(--accent-bg-light, rgba(0,100,210,0.1));
        color: var(--accent);
        border: 1px solid var(--accent-border, rgba(0,100,210,0.3));
        padding: 0.5rem 0.8rem;
        border-radius: var(--border-radius-pill);
        font-weight: 500;
        font-size: 0.9rem;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
    }
    #btn-open-stock-sort-drawer i { font-size: 1.1rem; }

    .stock-list-search-bar-container { /* Conteneur pour la barre de recherche */
        padding: 0.75rem 1rem;
        background-color: #fff;
        border-bottom: 1px solid var(--border-color);
        position: -webkit-sticky;
        position: sticky;
        top: 57px; /* Hauteur du #stock-list-header, à ajuster si besoin */
        z-index: 15; /* En dessous du header principal de la page, au-dessus du contenu */
    }
    .stock-list-search-bar-container .search-wrapper {
        margin-top: 0; /* Pas de marge en haut pour la barre de recherche ici */
    }

    .stock-list-no-results-message { /* Message si pas de résultats */
        text-align:center; padding:1.5rem 1rem; color:var(--secondary-text); font-size: 0.95rem;
    }


  </style>
</head>

<body>

  <script>
  // Web component pour input (inchangé)
  class AppInput extends HTMLElement {
    constructor() {
      super();
      const shadow = this.attachShadow({ mode: 'open' });
      const inp = document.createElement('input');

      inp.setAttribute('autocomplete', 'off');
      inp.setAttribute('autocorrect',  'off');
      inp.setAttribute('autocapitalize', 'none');
      inp.setAttribute('spellcheck',     'false');

      ['type','placeholder','name','id','value','list'].forEach(name => {
        if (this.hasAttribute(name)) {
          inp.setAttribute(name, this.getAttribute(name));
        }
      });
      shadow.appendChild(inp);
    }
  }
  customElements.define('app-input', AppInput);
  </script>

  <main id="home" class="page visible">
    <header><h2 style="padding:1rem">Accueil</h2></header>
    <div class="home-actions">
      <button class="btn-action btn-sell" data-hash="sell" aria-label="Sell">
        <i class="bi bi-tag-fill"></i><span>Vendre</span>
      </button>
      <button class="btn-action btn-buy" data-hash="supply" aria-label="Approvisionnement">
        <i class="bi bi-cart-fill"></i><span>Approvisionnement</span>
      </button>
      <a href="#reports" data-hash="reports" class="btn-reports-card" aria-label="Rapports et Analyses">
          <i class="bi bi-graph-up-arrow"></i>
          <span>Rapports & Analyses</span>
      </a>
    </div>
    <button id="btn-install" class="btn-primary"
        style="display:none; margin:1rem auto; width: calc(100% - 2rem);">
      <i class="bi bi-download" style="margin-right:0.5rem;"></i>
      Installer l’application
    </button>
  </main>

<main id="sell" class="page">
  <style>
    .sell-step {
      display: none;
      flex-direction: column;
      flex: 1 1 auto; 
      width: 100%;
      overflow-y: auto;
      padding: 0 0 calc(56px + 1rem + env(safe-area-inset-bottom)); 
    }
    .sell-step.active {
      display: flex;
    }
    #sell .sell-header-step1 {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #fff;
      border-bottom: 1px solid var(--border-color);
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      z-index: 15;
    }
    #sell .sell-header-step1 .btn-close-sell {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--primary-text);
      margin-right: 0.75rem;
      cursor: pointer;
      outline: none;
    }
    #sell .sell-header-step1 .search-wrapper {
      flex: 1;
      margin-top: 0;
    }
      #sell .sell-header-step1 #search-input-sell {
      width: 100%;
      padding: 0.75rem 2.5rem; 
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-pill);
      background: #f4f4f4;
      font-size: 1rem;
      outline: none;
      box-shadow: none;
    }
    .sell-step-content {
      padding: 1rem;
      flex-grow: 1;
    }
    .sell-step h3.step-title {
    padding: 1rem 1rem 0.5rem;
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
    background-color: #fff; 
    border-bottom: 1px solid var(--border-color);
    position: -webkit-sticky;
    position: sticky;
    top: 0; 
    z-index: 14; 
    display: flex;         
    align-items: center;      
    justify-content: space-between; 
  }
  .sell-step h3.step-title #btn-clear-sell-cart-step2 {
    background: none;         
    border: none;             
    padding: 0.25rem;         
    margin: 0;                
    cursor: pointer;          
    font-size: 1.3rem;        
    line-height: 1;          
    color: var(--ebay-red);  
  }
  .sell-step h3.step-title #btn-clear-sell-cart-step2 i {
    color: inherit; 
    vertical-align: middle; 
  }
    .wizard-nav-sell {
      position: fixed;
      bottom: env(safe-area-inset-bottom); 
      left: 0;
      width: 100%;
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: #fff;
      border-top: 1px solid var(--border-color);
      z-index: 20; 
    }
    .wizard-nav-sell button {
      flex: 1;
      padding: 0.8rem;
      font-size: 1rem;
      font-weight: 500;
      border-radius: var(--border-radius-pill);
      border: none;
      cursor: pointer;
      box-shadow: none;
    }
    .wizard-nav-sell button.btn-sell-primary {
      background-color: var(--accent);
      color: white;
    }
    .wizard-nav-sell button.btn-sell-primary:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .wizard-nav-sell button.btn-sell-secondary {
      background-color: #f0f0f0;
      color: var(--primary-text);
      border: 1px solid var(--border-color);
    }
    #sell-search-results-container {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    #sell-search-results-container .book-card-sell {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-card);
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: none;
    }
    #sell-search-results-container .book-card-sell .info .title {
      font-weight: 500; font-size: 1rem; color: var(--primary-text); margin-bottom: 0.2rem;
    }
    #sell-search-results-container .book-card-sell .info .details {
      font-size: 0.85rem; color: var(--secondary-text);
    }
    #sell-search-results-container .book-card-sell .info .details .price {
      color: var(--ebay-blue); font-weight: 500;
    }
    #sell-search-results-container .book-card-sell .btn-add-to-sell-cart {
      background: var(--ebay-blue); color: white; border: none; border-radius: 50%;
      width: 36px; height: 36px; font-size: 1.2rem; display: flex;
      align-items: center; justify-content: center; cursor: pointer; box-shadow: none; padding: 0;
    }
    #sell-search-results-container .book-card-sell .btn-add-to-sell-cart.added {
      background: var(--ebay-green);
    }
    #sell-search-results-container .no-results {
      text-align: center; padding: 1rem; color: var(--secondary-text);
    }
    #sell-step1-cart-summary {
        padding: 0.75rem;
        margin-top: 1rem;
        background-color: #f9f9f9;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        text-align: center;
        font-size: 0.9rem;
        color: var(--secondary-text);
    }

    /* Styles pour la liste des articles dans le panier (Étape 2) - MODIFIÉS */
    #sell-cart-items-list-step2 .sell-cart-item {
      display: flex;
      flex-direction: column; /* Titre au-dessus, puis contrôles, puis sous-total */
      gap: 0.75rem; /* Espace entre les sections de l'item */
      padding: 1rem 0.5rem; /* Padding vertical et un peu horizontal pour l'item */
      border-bottom: 1px solid #f0f0f0;
      background-color: #fff; /* Fond blanc pour chaque item */
      border-radius: var(--border-radius-card); /* Coins arrondis pour chaque item */
      margin-bottom: 0.75rem; /* Espace entre les items */
      border: 1px solid var(--border-color); /* Bordure légère */
      box-shadow: none; /* Pas d'ombre */
    }
    #sell-cart-items-list-step2 .sell-cart-item:last-child {
      border-bottom: 1px solid var(--border-color); /* Assurer que le dernier a aussi une bordure en bas */
    }
    #sell-cart-items-list-step2 .sell-cart-item .title {
      font-weight: 600; /* Titre plus en évidence */
      font-size: 1.05rem;
      color: var(--primary-text);
      width: 100%; /* Pleine largeur */
      margin-bottom: 0.25rem; /* Petit espace sous le titre */
      white-space: normal; /* Permettre le retour à la ligne pour les titres longs */
      overflow: visible;
      text-overflow: clip;
    }
    .sell-cart-item-controls { /* Nouveau conteneur pour inputs et bouton supprimer */
      display: flex;
      align-items: center;
      gap: 0.75rem; /* Espace entre les inputs et le bouton */
      width: 100%;
    }
    #sell-cart-items-list-step2 .sell-cart-item input[type="number"].quantity,
    #sell-cart-items-list-step2 .sell-cart-item input[type="number"].price {
      flex: 1 1 0; /* Permet aux inputs de grandir et partager l'espace */
      padding: 0.7rem 0.6rem; /* Inputs plus longs/hauts */
      font-size: 1rem; /* Taille de police pour les inputs */
      text-align: center;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-card); /* Coins arrondis pour inputs */
      box-shadow: none;
      min-width: 70px; /* Largeur minimale pour éviter qu'ils soient trop petits */
    }
    #sell-cart-items-list-step2 .sell-cart-item .remove-item-btn {
      background: none;
      border: none;
      color: var(--ebay-red);
      font-size: 1.5rem; /* Icône de suppression un peu plus grande */
      cursor: pointer;
      padding: 0.4rem; /* Zone de clic un peu plus grande */
      flex-shrink: 0; /* Empêcher le bouton de rétrécir */
      display: flex;
      align-items: center;
      justify-content: center;
    }
      .sell-cart-item-subtotal-wrapper { /* Nouveau conteneur pour le sous-total */
      display: flex;
      justify-content: flex-end; /* Aligner le sous-total à droite */
      margin-top: 0.5rem; /* Espace au-dessus du sous-total */
      width: 100%;
    }
    #sell-cart-items-list-step2 .sell-cart-item .subtotal {
      font-size: 1rem; /* Taille de police pour le sous-total */
      font-weight: 600;
      color: var(--ebay-blue); /* Couleur distinctive pour le sous-total */
      padding: 0.6rem 1rem; /* Padding pour l'effet "encerclé" */
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-pill); /* Coins bien arrondis */
      background-color: #f8f8f8; /* Fond léger pour le sous-total */
      min-width: 100px; /* Largeur minimale */
      text-align: right;
      box-shadow: none;
    }
    /* Fin des styles modifiés pour Étape 2 */

    #sell-cart-empty-message-step2 {
      color: var(--secondary-text); font-style: italic; text-align: center; padding: 1rem;
    }
    .cart-summary-section-step2 { 
      margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);
    }
    .cart-summary-section-step2 .summary-line {
      display: flex; justify-content: space-between; font-size: 1rem; margin-bottom: 0.5rem;
    }
    .cart-summary-section-step2 .summary-line.total span { font-weight: bold; font-size: 1.15rem; }
    .cart-summary-section-step2 .summary-line.total span:last-child { color: var(--ebay-green); }

    .form-group-sell { margin-bottom: 1rem; }
    .form-group-sell label {
      display: block; font-size: 0.9rem; color: var(--secondary-text); margin-bottom: 0.25rem;
    }
    .form-group-sell input {
      width: 100%; padding: 0.7rem 0.8rem; font-size: 1rem;
      border: 1px solid var(--border-color); border-radius: var(--border-radius-card);
      box-shadow: none; outline: none;
    }
    .form-group-sell input:focus { border-color: var(--accent); }

    #sell-summary-customer-info-step4, #sell-summary-items-list-step4, #sell-summary-totals-step4 {
        margin-bottom: 1.5rem;
    }
    #sell-summary-customer-info-step4 p, #sell-summary-totals-step4 p {
        font-size: 0.95rem; margin-bottom: 0.5rem; color: var(--secondary-text);
    }
    #sell-summary-customer-info-step4 p span, #sell-summary-totals-step4 p span {
        font-weight: 500; color: var(--primary-text);
    }
    #sell-summary-items-list-step4 .summary-item {
        display: flex; justify-content: space-between; padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0; font-size: 0.9rem;
    }
    #sell-summary-items-list-step4 .summary-item:last-child { border-bottom: none; }
    #sell-summary-items-list-step4 .summary-item .title { flex-grow: 1; font-weight: 500; }
    #sell-summary-items-list-step4 .summary-item .qty-price,
    #sell-summary-items-list-step4 .summary-item .line-total { text-align: right; min-width: 80px; }
    #sell-summary-items-list-step4 .summary-item .line-total { font-weight: 500; }
    #sell-summary-totals-step4 .grand-total {
        font-size: 1.2rem; font-weight: bold; color: var(--ebay-green);
    }
    #btn-validate-sale-step4 {
        width: 100%; padding: 0.8rem; font-size: 1rem; font-weight: 600;
        border-radius: var(--border-radius-pill); border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        box-shadow: none; background-color: var(--ebay-green); color: white;
    }
    #btn-validate-sale-step4:disabled { background-color: #ccc; cursor: not-allowed; }
    #sell-feedback-message { /* Remplacé par toast-notification global */
      display: none; /* Caché, car on utilise le toast global */
    }
  </style>

  <div class="sell-step active" data-step="1">
    <header class="sell-header-step1">
      <button class="btn-close-sell" data-hash="home" aria-label="Quitter la page de vente">
        <i class="bi bi-x-lg"></i>
      </button>
      <div class="search-wrapper">
        <i class="bi bi-search"></i>
        <input type="search" id="search-input-sell" placeholder="Rechercher un livre à vendre" aria-label="Recherche catalogue de vente" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
      </div>
    </header>
    <div class="sell-step-content">
        <div id="sell-search-results-container">
            <p class="no-results" style="padding-top:1rem;">Commencez par rechercher un livre dans votre stock.</p>
        </div>
    </div>
    <div id="sell-step1-cart-summary">Panier de vente vide.</div>
    <div class="wizard-nav-sell">
      <button id="btn-sell-step1-next" class="btn-sell-primary" data-target-step="2" disabled>Suivant &rarr;</button>
    </div>
  </div>

  <div class="sell-step" data-step="2"> <h3 class="step-title">
        <span style="display: flex; align-items: center; gap: 0.5em;">
            <i class="bi bi-list-ul"></i>
            <span>Articles pour la Vente</span>
        </span>
        <button id="btn-clear-sell-cart-step2" aria-label="Vider le panier">
            <i class="bi bi-cart-x-fill" style="color:var(--ebay-red);"></i>
        </button>
    </h3>
    <div class="sell-step-content"> <div id="sell-cart-items-list-step2">
        </div>
        <div id="sell-cart-empty-message-step2" style="text-align: center; padding: 1rem; color: var(--secondary-text);">
            Le panier de vente est vide.
        </div>
        <div class="cart-summary-section-step2">
            <div class="summary-line"><span>Total Articles:</span> <span id="sell-cart-total-items-step2">0</span></div>
            <div class="summary-line total"><span>Montant Total:</span> <span id="sell-cart-grand-total-step2">XOF 0</span></div>
        </div>
        </div>
    <div class="wizard-nav-sell">
        <button class="btn-sell-secondary" data-target-step="1">&larr; Sélection Livres</button>
        <button id="btn-sell-step2-next" class="btn-sell-primary" data-target-step="3" disabled>Suivant &rarr;</button>
    </div>
</div>

  <div class="sell-step" data-step="3">
    <h3 class="step-title"><i class="bi bi-person-badge"></i> Informations Client</h3>
    <div class="sell-step-content">
        <div class="form-group-sell">
            <label for="sell-customer-name">Nom du client</label>
            <input type="text" id="sell-customer-name" placeholder="Nom et prénom (optionnel)">
        </div>
        <div class="form-group-sell">
            <label for="sell-customer-phone">Numéro de téléphone</label>
            <input type="tel" id="sell-customer-phone" placeholder="Téléphone (optionnel)">
        </div>
    </div>
    <div class="wizard-nav-sell">
      <button class="btn-sell-secondary" data-target-step="2">&larr; Panier</button>
      <button id="btn-sell-step3-next" class="btn-sell-primary" data-target-step="4">Suivant &rarr;</button> </div>
  </div>

  <div class="sell-step" data-step="4">
    <h3 class="step-title"><i class="bi bi-check2-circle"></i> Récapitulatif & Validation</h3>
    <div class="sell-step-content">
        <div id="sell-summary-customer-info-step4">
            <h4>Client</h4>
            <p>Nom: <span id="summary-customer-name">N/A</span></p>
            <p>Téléphone: <span id="summary-customer-phone">N/A</span></p>
        </div>
        <div id="sell-summary-items-list-step4">
            <h4>Articles</h4>
            </div>
        <div id="sell-summary-totals-step4">
            <h4>Total Vente</h4>
            <p>Total Articles: <span id="summary-total-items">0</span></p>
            <p>Montant Total: <span id="summary-grand-total" class="grand-total">XOF 0</span></p>
        </div>
        <button id="btn-validate-sale-step4" disabled>
            <i class="bi bi-check-circle-fill"></i> Valider la Vente
        </button>
    </div>
    <div class="wizard-nav-sell">
      <button class="btn-sell-secondary" data-target-step="3">&larr; Infos Client</button>
      </div>
  </div>

  <script>
// Sell page script
(function() {
    const sellPageEl = document.getElementById('sell');
    // feedbackMessageEl est maintenant géré par showGlobalToast
    let currentSellStep = 1;
    const sellSteps = sellPageEl.querySelectorAll('.sell-step');

    const searchInputSellEl = document.getElementById('search-input-sell');
    const searchResultsContainerEl = document.getElementById('sell-search-results-container');
    const step1NextBtn = document.getElementById('btn-sell-step1-next');
    const step1CartSummaryEl = document.getElementById('sell-step1-cart-summary');

    const cartItemsListStep2El = document.getElementById('sell-cart-items-list-step2');
    const cartEmptyMessageStep2El = document.getElementById('sell-cart-empty-message-step2');
    const totalItemsStep2El = document.getElementById('sell-cart-total-items-step2');
    const grandTotalStep2El = document.getElementById('sell-cart-grand-total-step2');
    const clearCartStep2Btn = document.getElementById('btn-clear-sell-cart-step2');
    const step2NextBtn = document.getElementById('btn-sell-step2-next');

    const customerNameInputEl = document.getElementById('sell-customer-name');
    const customerPhoneInputEl = document.getElementById('sell-customer-phone');

    const summaryCustomerNameEl = document.getElementById('summary-customer-name');
    const summaryCustomerPhoneEl = document.getElementById('summary-customer-phone');
    const summaryItemsListEl = document.getElementById('sell-summary-items-list-step4');
    const summaryTotalItemsEl = document.getElementById('summary-total-items');
    const summaryGrandTotalEl = document.getElementById('summary-grand-total');
    const validateSaleButtonStep4El = document.getElementById('btn-validate-sale-step4');

    let userBooksCache = []; 
    let salesCart = []; 
    let currentUserUID = null;

    function showSellStep(stepNumber) {
        currentSellStep = parseInt(stepNumber, 10);
        sellSteps.forEach(step => {
            step.classList.toggle('active', parseInt(step.dataset.step, 10) === currentSellStep);
        });
        if (currentSellStep === 1) {
            renderStep1CartSummary();
            step1NextBtn.disabled = salesCart.length === 0;
        } else if (currentSellStep === 2) {
            renderSalesCartForStep2();
            step2NextBtn.disabled = salesCart.length === 0;
        } else if (currentSellStep === 4) {
            renderSalesSummaryForStep4();
            validateSaleButtonStep4El.disabled = salesCart.length === 0;
        }
        sellPageEl.scrollTop = 0;
        const activeStepContent = sellPageEl.querySelector(`.sell-step[data-step="${currentSellStep}"] .sell-step-content`);
        if(activeStepContent) activeStepContent.scrollTop = 0;
    }

    sellPageEl.addEventListener('click', function(e) {
        const targetPrev = e.target.closest('.btn-sell-secondary[data-target-step]');
        const targetNext = e.target.closest('.btn-sell-primary[data-target-step]');

        if (targetPrev) {
            showSellStep(targetPrev.dataset.targetStep);
        } else if (targetNext) {
            if (currentSellStep === 1 && salesCart.length === 0) {
                showGlobalToast("Veuillez ajouter au moins un livre au panier.", true, 2000);
                return;
            }
            if (currentSellStep === 2 && salesCart.length === 0) {
                showGlobalToast("Le panier est vide.", true, 2000);
                return;
            }
            showSellStep(targetNext.dataset.targetStep);
        }
    });

    auth.onAuthStateChanged(user => {
        if (user) {
            currentUserUID = user.uid;
            loadUserBooks(); 
        } else {
            currentUserUID = null;
            userBooksCache = [];
            salesCart = [];
            if (document.getElementById('sell')?.classList.contains('visible')) {
                resetSellPage();
            }
        }
    });

    async function loadUserBooks() {
        if (!currentUserUID) return;
        try {
            const snapshot = await db.collection('users').doc(currentUserUID).collection('books').get();
            userBooksCache = snapshot.docs.map(doc => ({ 
                id: doc.id, 
                ...doc.data(),
                averageCost: typeof doc.data().averageCost === 'number' ? doc.data().averageCost : (typeof doc.data().lastPurchasePrice === 'number' ? doc.data().lastPurchasePrice : 0),
                lastPurchasePrice: typeof doc.data().lastPurchasePrice === 'number' ? doc.data().lastPurchasePrice : 0
            }));
            if(currentSellStep === 1) filterAndRenderBookResults();
        } catch (error) {
            console.error("Erreur de chargement des livres de l'utilisateur:", error);
            showGlobalToast("Erreur de chargement des livres.", true);
            userBooksCache = [];
        }
    }

    searchInputSellEl.addEventListener('input', filterAndRenderBookResults);

    function filterAndRenderBookResults() {
        const searchTerm = searchInputSellEl.value.trim().toLowerCase();
        if (!searchTerm && userBooksCache.length > 0) {
            searchResultsContainerEl.innerHTML = '<p class="no-results">Entrez un terme pour rechercher dans votre stock.</p>';
            return;
        }
        if (!userBooksCache.length && !searchTerm){
            searchResultsContainerEl.innerHTML = '<p class="no-results">Votre stock est vide ou non chargé. Commencez par rechercher.</p>';
            return;
        }

        const filteredBooks = userBooksCache.filter(book =>
            book.title.toLowerCase().includes(searchTerm) && book.quantity > 0
        );
        renderSearchResults(filteredBooks);
    }

    function renderSearchResults(books) {
        searchResultsContainerEl.innerHTML = '';
        if (books.length === 0) {
            searchResultsContainerEl.innerHTML = '<p class="no-results">Aucun livre trouvé ou en stock pour cette recherche.</p>';
            return;
        }
        books.forEach(book => {
            const card = document.createElement('div');
            card.className = 'book-card-sell';
            const isAdded = salesCart.some(item => item.bookId === book.id);
            card.innerHTML = `
                <div class="info">
                    <div class="title">${book.title}</div>
                    <div class="details">
                        Stock: ${book.quantity} | Prix Sugg.: <span class="price">${(book.price || 0).toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0})}</span>
                    </div>
                </div>
                <button class="btn-add-to-sell-cart ${isAdded ? 'added' : ''}" data-book-id="${book.id}" aria-label="Ajouter au panier de vente">
                    <i class="bi ${isAdded ? 'bi-check-lg' : 'bi-plus-circle-fill'}"></i>
                </button>
            `;
            const addButton = card.querySelector('.btn-add-to-sell-cart');
            addButton.addEventListener('click', () => {
                if (!salesCart.some(item => item.bookId === book.id)) {
                    addBookToSalesCart(book, addButton);
                } else {
                    showGlobalToast(`"${book.title}" est déjà dans le panier.`, false, 1500);
                }
            });
            searchResultsContainerEl.appendChild(card);
        });
    }

    function addBookToSalesCart(book, buttonElement) {
        if (salesCart.some(item => item.bookId === book.id)) {
            showGlobalToast(`"${book.title}" est déjà dans le panier. Modifiez la quantité si besoin.`, false, 2000);
            return;
        }
        if (book.quantity <= 0) {
            showGlobalToast(`"${book.title}" est en rupture de stock.`, true);
            return;
        }
        const costForSale = book.averageCost !== undefined ? book.averageCost : (book.lastPurchasePrice || 0);
        salesCart.push({
            bookId: book.id,
            title: book.title,
            quantity: 1,
            unitPrice: book.price || 0, 
            stock: book.quantity,
            suggestedPrice: book.price || 0,
            unitCost: costForSale 
        });

        if (buttonElement) {
            buttonElement.classList.add('added');
            buttonElement.innerHTML = '<i class="bi bi-check-lg"></i>';
        }
        showGlobalToast(`"${book.title}" ajouté au panier.`, false, 1500);
        step1NextBtn.disabled = salesCart.length === 0;
        renderStep1CartSummary();
    }

    function renderStep1CartSummary() {
        if (salesCart.length === 0) {
            step1CartSummaryEl.textContent = 'Panier de vente vide.';
        } else {
            const totalItems = salesCart.reduce((sum, item) => sum + item.quantity, 0);
            const grandTotal = salesCart.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            step1CartSummaryEl.textContent = `${totalItems} article(s) dans le panier - Total: ${grandTotal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0})}`;
        }
    }

    function renderSalesCartForStep2() {
        cartItemsListStep2El.innerHTML = '';
        if (salesCart.length === 0) {
            cartEmptyMessageStep2El.style.display = 'block';
        } else {
            cartEmptyMessageStep2El.style.display = 'none';
            salesCart.forEach((item, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'sell-cart-item';
                listItem.setAttribute('data-index', index);
                listItem.innerHTML = `
                    <span class="title" title="${item.title}">${item.title}</span>
                    <div class="sell-cart-item-controls">
                        <input type="number" class="quantity" value="${item.quantity}" min="1" max="${item.stock}" data-index="${index}" aria-label="Quantité pour ${item.title}">
                        <input type="number" class="price" value="${item.unitPrice.toFixed(0)}" step="50" min="0" data-index="${index}" aria-label="Prix de vente pour ${item.title}">
                        <button class="remove-item-btn" data-index="${index}" aria-label="Supprimer ${item.title}"><i class="bi bi-trash-fill"></i></button>
                    </div>
                    <div class="sell-cart-item-subtotal-wrapper">
                        <span class="subtotal" data-index="${index}">${(item.quantity * item.unitPrice).toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0})}</span>
                    </div>
                `;
                const quantityInput = listItem.querySelector('.quantity');
                const priceInput = listItem.querySelector('.price');
                quantityInput.addEventListener('focus', (e) => e.target.select());
                priceInput.addEventListener('focus', (e) => {
                    if (e.target.value === '0') e.target.value = ''; else e.target.select();
                });
                quantityInput.addEventListener('input', (e) => updateCartItemQuantity(index, parseInt(e.target.value)));
                priceInput.addEventListener('input', (e) => updateCartItemPrice(index, parseFloat(e.target.value)));
                listItem.querySelector('.remove-item-btn').addEventListener('click', () => removeCartItem(index));
                cartItemsListStep2El.appendChild(listItem);
            });
        }
        updateCartSummaryForStep2();
        step2NextBtn.disabled = salesCart.length === 0;
    }
    function updateCartItemQuantity(index, newQuantityFromInput) {
        const item = salesCart[index];
        if (!item) return;
        let validatedQuantity = newQuantityFromInput;
        if (isNaN(validatedQuantity) || validatedQuantity < 1) validatedQuantity = 1;
        else if (validatedQuantity > item.stock) {
            validatedQuantity = item.stock;
            showGlobalToast(`Stock maximum pour "${item.title}" est ${item.stock}.`, true, 2000);
        }
        const quantityInputEl = cartItemsListStep2El.querySelector(`input.quantity[data-index="${index}"]`);
        if (item.quantity === validatedQuantity && quantityInputEl && parseInt(quantityInputEl.value) === validatedQuantity) return;
        item.quantity = validatedQuantity;
        if (quantityInputEl && parseInt(quantityInputEl.value) !== validatedQuantity) quantityInputEl.value = validatedQuantity;
       
        const subtotalEl = cartItemsListStep2El.querySelector(`.sell-cart-item[data-index="${index}"] span.subtotal`);
        if (subtotalEl) subtotalEl.textContent = (item.quantity * item.unitPrice).toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
        updateCartSummaryForStep2();
        renderStep1CartSummary();
    }

    function updateCartItemPrice(index, newPriceFromInput) {
        const item = salesCart[index];
        if (!item) return;
        let validatedPrice = newPriceFromInput;
        if (isNaN(validatedPrice) || validatedPrice < 0) validatedPrice = 0;
        const priceInputEl = cartItemsListStep2El.querySelector(`input.price[data-index="${index}"]`);
        if (item.unitPrice === validatedPrice && priceInputEl && parseFloat(priceInputEl.value) === validatedPrice) return;
        item.unitPrice = validatedPrice;
        if (priceInputEl) {
            const currentInputValue = parseFloat(priceInputEl.value);
            if (isNaN(currentInputValue) || currentInputValue < 0 || currentInputValue.toFixed(0) !== validatedPrice.toFixed(0) ) {
                if (isNaN(currentInputValue) || currentInputValue < 0) priceInputEl.value = validatedPrice.toFixed(0);
            }
        }
        const subtotalEl = cartItemsListStep2El.querySelector(`.sell-cart-item[data-index="${index}"] span.subtotal`);
        if (subtotalEl) subtotalEl.textContent = (item.quantity * item.unitPrice).toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
        updateCartSummaryForStep2();
        renderStep1CartSummary();
    }

    function removeCartItem(index) {
        const item = salesCart[index];
        if(!item) return;
        salesCart.splice(index, 1);
        if (item) showGlobalToast(`"${item.title}" retiré du panier.`, false, 1500);
        renderSalesCartForStep2();
        step1NextBtn.disabled = salesCart.length === 0;
        const searchResultButton = searchResultsContainerEl.querySelector(`.btn-add-to-sell-cart[data-book-id="${item.bookId}"]`);
        if (searchResultButton) {
            searchResultButton.classList.remove('added');
            searchResultButton.innerHTML = '<i class="bi bi-plus-circle-fill"></i>';
        }
        renderStep1CartSummary();
    }

    function updateCartSummaryForStep2() {
        let totalQty = 0;
        let currentGrandTotal = 0;
        salesCart.forEach(item => {
            totalQty += item.quantity;
            currentGrandTotal += item.quantity * item.unitPrice;
        });
        totalItemsStep2El.textContent = totalQty;
        grandTotalStep2El.textContent = currentGrandTotal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
    }

    clearCartStep2Btn.addEventListener('click', () => {
        if (salesCart.length > 0) {
            salesCart = [];
            renderSalesCartForStep2();
            showGlobalToast("Panier de vente vidé.", false, 1500);
            step1NextBtn.disabled = true;
            searchResultsContainerEl.querySelectorAll('.btn-add-to-sell-cart.added').forEach(btn => {
                btn.classList.remove('added');
                btn.innerHTML = '<i class="bi bi-plus-circle-fill"></i>';
            });
            renderStep1CartSummary();
        }
    });

    function renderSalesSummaryForStep4() {
        const customerName = customerNameInputEl.value.trim() || "N/A";
        const customerPhone = customerPhoneInputEl.value.trim() || "N/A";
        summaryCustomerNameEl.textContent = customerName;
        summaryCustomerPhoneEl.textContent = customerPhone;
        summaryItemsListEl.innerHTML = '';
        let totalQty = 0;
        let grandTotal = 0;
        if (salesCart.length === 0) {
            summaryItemsListEl.innerHTML = '<p style="text-align:center; color:var(--secondary-text);">Panier vide.</p>';
        } else {
            salesCart.forEach(item => {
                const itemTotal = item.quantity * item.unitPrice;
                totalQty += item.quantity;
                grandTotal += itemTotal;
                const summaryItemDiv = document.createElement('div');
                summaryItemDiv.className = 'summary-item';
                summaryItemDiv.innerHTML = `
                    <span class="title">${item.title}</span>
                    <span class="qty-price">${item.quantity} x ${item.unitPrice.toLocaleString('fr-FR',{style:'currency', currency:'XOF', minimumFractionDigits:0})}</span>
                    <span class="line-total">${itemTotal.toLocaleString('fr-FR',{style:'currency', currency:'XOF', minimumFractionDigits:0})}</span>
                `;
                summaryItemsListEl.appendChild(summaryItemDiv);
            });
        }
        summaryTotalItemsEl.textContent = totalQty;
        summaryGrandTotalEl.textContent = grandTotal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
        validateSaleButtonStep4El.disabled = salesCart.length === 0;
    }

    validateSaleButtonStep4El.addEventListener('click', async () => {
        if (salesCart.length === 0) {
            showGlobalToast("Le panier est vide. Ajoutez des articles pour valider la vente.", true);
            return;
        }
        validateSaleButtonStep4El.disabled = true;
        validateSaleButtonStep4El.innerHTML = '<i class="bi bi-hourglass-split"></i> Validation en cours...';
        showGlobalToast("Traitement de la vente...", false, 5000); // Durée plus longue pour le traitement

        const batch = db.batch();
        const salesDataItems = [];
        let grandTotalSaleAmount = 0;
        let totalCostOfGoodsSoldSale = 0;
        const customerName = customerNameInputEl.value.trim();
        const customerPhone = customerPhoneInputEl.value.trim();

        for (const item of salesCart) {
            const bookRef = db.collection('users').doc(currentUserUID).collection('books').doc(item.bookId);
             if (item.quantity > item.stock) { 
                showGlobalToast(`Stock insuffisant pour "${item.title}" (${item.quantity} demandé(s), ${item.stock} en stock). Vente annulée. Mettez à jour le panier.`, true, 5000);
                validateSaleButtonStep4El.disabled = false;
                validateSaleButtonStep4El.innerHTML = '<i class="bi bi-check-circle-fill"></i> Valider la Vente';
                showSellStep(2); 
                return;
            }
            batch.update(bookRef, { quantity: firebase.firestore.FieldValue.increment(-item.quantity) });
            const itemUnitCostForCOGS = item.unitCost; 
            const itemLineTotal = item.quantity * item.unitPrice; 
            const itemLineCogs = item.quantity * itemUnitCostForCOGS; 
            const itemLineProfit = itemLineTotal - itemLineCogs;
            salesDataItems.push({
                bookId: item.bookId,
                title: item.title,
                quantitySold: item.quantity,
                unitPriceSold: item.unitPrice, 
                unitCostAtTimeOfSale: itemUnitCostForCOGS, 
                lineTotal: itemLineTotal,
                lineProfit: itemLineProfit
            });
            grandTotalSaleAmount += itemLineTotal;
            totalCostOfGoodsSoldSale += itemLineCogs;
        }

        const totalProfitSale = grandTotalSaleAmount - totalCostOfGoodsSoldSale;
        const saleRef = db.collection('users').doc(currentUserUID).collection('sales').doc();
        batch.set(saleRef, {
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            customerName: customerName || "N/A",
            customerPhone: customerPhone || "N/A",
            items: salesDataItems,
            grandTotalAmount: grandTotalSaleAmount,
            totalItemsSold: salesCart.reduce((sum, item) => sum + item.quantity, 0),
            totalCostOfGoodsSold: totalCostOfGoodsSoldSale, 
            totalProfit: totalProfitSale
        });

        try {
            await batch.commit();
            showGlobalToast("Vente enregistrée avec succès !", false, 3000);
            loadUserBooks(); 
            const closeBtn = sellPageEl.querySelector('.btn-close-sell');
            if (closeBtn) {
                closeBtn.click(); 
            } else {
                resetSellPage(); 
                location.hash = "home";
            }
        } catch (error) {
            console.error("Erreur lors de la validation de la vente:", error);
            showGlobalToast("Erreur: " + error.message + ". Veuillez réessayer.", true, 5000);
            validateSaleButtonStep4El.disabled = salesCart.length === 0; 
            validateSaleButtonStep4El.innerHTML = '<i class="bi bi-check-circle-fill"></i> Valider la Vente';
        }
    });

    function resetSellPage() {
        salesCart = [];
        searchInputSellEl.value = '';
        customerNameInputEl.value = '';
        customerPhoneInputEl.value = '';
        searchResultsContainerEl.innerHTML = '<p class="no-results">Commencez par rechercher un livre.</p>';
        showSellStep(1);
        renderStep1CartSummary();
        renderSalesCartForStep2(); 
        renderSalesSummaryForStep4(); 
        step1NextBtn.disabled = true;
        step2NextBtn.disabled = true;
        validateSaleButtonStep4El.disabled = true;
    }

    // La fonction showFeedback est remplacée par showGlobalToast (définie globalement)

    const sellPageObserver = new MutationObserver((mutationsList) => {
        for (const mutation of mutationsList) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                if (sellPageEl.classList.contains('visible')) {
                    if (currentUserUID && userBooksCache.length === 0) { 
                        loadUserBooks();
                    }
                    resetSellPage(); 
                } else {
                    // Le toast global se gère lui-même pour la disparition
                }
            }
        }
    });
    sellPageObserver.observe(sellPageEl, { attributes: true });

})();
</script>
</main>

<main id="supply" class="page">
  <style>
    header#supply-header {
      /* padding: 1rem; // Géré par le style flex et gap */
      background: #fff; 
      border-bottom: 1px solid var(--border-color); 
      position: -webkit-sticky; 
      position: sticky;
      top: 0; 
      z-index: 15; 
    }
    /* header#supply-header h2 { // Géré par le style :has() global
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary-text);
    } */
    main#supply .books-list { 
        display: flex;
        flex-direction: column;
        gap: 1rem; 
        padding: 1rem; 
    }
    main#supply .skeleton-batch-card {
        background: #f9f9f9; 
        height: 120px; 
        margin: 0; 
        border-radius: 0.75rem; 
        animation: pulse 1.5s infinite ease-in-out;
    }
    main#supply .supply-batch-card {
        background: #ffffff;
        border: 1px solid var(--border-color); 
        border-radius: 0.75rem; 
        margin: 0; 
        padding: 1rem;
        box-shadow: none; 
        display: flex; 
        flex-direction: column; 
        gap: 0.75rem; 
    }
    main#supply .supply-batch-card header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start; 
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #efefef; 
    }
    main#supply .supply-batch-card header .supplier-info {
        flex-grow: 1; 
        margin-right: 0.75rem; 
    }
    main#supply .supply-batch-card header .supplier-info strong { 
        font-size: 1.1rem; 
        font-weight: 600;
        color: var(--primary-text);
        display: block;
        margin-bottom: 0.2rem;
    }
    main#supply .supply-batch-card header .supplier-info small { 
        font-size: 0.8rem;
        color: var(--secondary-text);
        display: block;
    }
    main#supply .supply-batch-card header .batch-meta {
        text-align: right;
        flex-shrink: 0; 
    }
    main#supply .supply-batch-card header .batch-meta .batch-total { 
        font-size: 1.05rem;
        font-weight: 700; 
        color: var(--ebay-green); 
        display: block;
    }
    main#supply .supply-batch-card ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem; 
    }
    main#supply .supply-batch-card li {
        font-size: 0.9rem;
        color: var(--primary-text);
        padding: 0.4rem 0; 
        display: flex;
        justify-content: space-between;
        align-items: flex-start; 
        gap: 0.5rem; 
    }
    main#supply .supply-batch-card li .item-title {
        flex-grow: 1;
        font-weight: 500;
        line-height: 1.4;
        margin-right: 0.5rem; 
    }
    main#supply .supply-batch-card li .item-details {
        font-size: 0.8rem;
        color: var(--secondary-text);
        text-align: right;
        flex-shrink: 0;
        line-height: 1.4;
    }
    main#supply .supply-batch-card li .item-details span {
        display: block; 
    }
    main#supply .supply-batch-card li .item-details .item-line-total {
        font-weight: 500;
        color: var(--primary-text); 
        margin-top: 0.15rem;
    }
    .fab {
      position: fixed;
      bottom: calc(env(safe-area-inset-bottom) + 1rem); /* Ajusté car la nav principale est cachée sur cette page */
      right: 1rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--ebay-green);
      color: #fff;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: none; 
      border: 1px solid #6a9a10; 
      z-index: 30; 
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .fab:active {
      background: #5ea83a; 
    }
  </style>

  <header id="supply-header" style="padding: 1rem;"> <button class="btn-page-back" data-hash="home" aria-label="Retour à l'accueil">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h2>Approvisionnement</h2>
  </header>
  <div id="supply-list" class="books-list">
    </div>
  <button id="btn-new-supply" class="fab" aria-label="Nouvel approvisionnement">
    <i class="bi bi-plus-lg"></i>
  </button>

  <script>
    document.getElementById('btn-new-supply')
      .addEventListener('click', () => {
        location.hash = 'new-supply';
      });
  </script>
  <script>
  auth.onAuthStateChanged(user => {
    if (!user) {
      return;
    }

    const suppliesRef = db
      .collection('users')
      .doc(user.uid)
      .collection('supplies')
      .orderBy('date', 'desc');

    const supplyListEl = document.getElementById('supply-list');
    let unsubscribeSupplies; 

    function setupSupplyListener() {
        if (unsubscribeSupplies) unsubscribeSupplies(); 
        if (!supplyListEl) return; // S'assurer que l'élément existe

        supplyListEl.innerHTML = Array(3)
          .fill('')
          .map(() => '<div class="skeleton-batch-card"></div>')
          .join('');

        unsubscribeSupplies = suppliesRef.onSnapshot(snapshot => {
          supplyListEl.innerHTML = ''; 

          if (snapshot.empty) {
            supplyListEl.innerHTML = '<p style="padding:1rem;color:#555;text-align:center;">Aucun approvisionnement pour l’instant.</p>';
            return;
          }

          snapshot.forEach(doc => {
            const supply = doc.data();
            const dateObj = supply.date?.toDate() || new Date();
            const dateStr = dateObj.toLocaleDateString('fr-FR', {
              day: '2-digit', month: '2-digit', year: 'numeric'
            });
            const totalBatch = supply.totalCost || 0; 
            const batchCard = document.createElement('div');
            batchCard.className = 'supply-batch-card';
           
            batchCard.innerHTML = `
              <header>
                <div class="supplier-info">
                  <strong>${supply.supplierName || 'N/A'}</strong>
                  <small>${dateStr}</small>
                </div>
                <div class="batch-meta">
                  <span class="batch-total">${totalBatch.toLocaleString('fr-FR', {
                    style: 'currency', currency: 'XOF', minimumFractionDigits: 0
                  })}</span>
                </div>
              </header>
              <ul>
                ${supply.lines.map(line => {
                  const lineTotal = (line.quantity || 0) * (line.unitCost || 0); 
                  return `<li>
                            <span class="item-title">${line.title || 'Titre inconnu'}</span>
                            <span class="item-details">
                              <span>Qté: ${line.quantity || 0}</span>
                              <span>PU Final: ${(line.unitCost || 0).toLocaleString('fr-FR',{ style:'currency', currency:'XOF', minimumFractionDigits: 0 })}</span>
                              <span class="item-line-total">Total: ${lineTotal.toLocaleString('fr-FR',{ style:'currency', currency:'XOF', minimumFractionDigits: 0 })}</span>
                            </span>
                          </li>`;
                }).join('')}
              </ul>
            `;
            supplyListEl.appendChild(batchCard);
          });
        }, err => {
          console.error('Erreur Firestore supplies :', err);
          supplyListEl.innerHTML = '<p style="padding:1rem;color:#e53238;text-align:center;">Erreur de chargement des approvisionnements.</p>';
        });
    }
   
    function cleanupSupplyListener() {
        if (unsubscribeSupplies) {
          unsubscribeSupplies();
          unsubscribeSupplies = null;
        }
    }

    window.addEventListener('hashchange', () => {
        if (location.hash === '#supply') {
          if (auth.currentUser) setupSupplyListener(); 
        } else {
          cleanupSupplyListener();
        }
    });
     if (location.hash === '#supply') {
        if (auth.currentUser) setupSupplyListener();
    }
  });
</script>
</main>

<main id="new-supply" class="page">
  <style>
    #new-supply {display:none;flex-direction:column;height:100vh;background:var(--surface)}
    #new-supply.visible{display:flex}

    .step{display:none;flex:1;padding:1rem 1rem calc(env(safe-area-inset-bottom) + 50px); /* Ajusté pour le wizard-nav seul */ }
    .step.active{display:flex;flex-direction:column}
    #new-supply h2{font-size:1.25rem;font-weight:500;margin-bottom:1rem}

    .form-group{margin-bottom:1rem}
    #new-supply label{font-size:.9rem;color:var(--secondary-text);margin-bottom:.25rem;display:block}
    #new-supply input[type=text], #new-supply input[type=number], #new-supply input[type=search]{
      width:100%;padding:.8rem;border:1px solid var(--border-color);border-radius:var(--border-radius-card);
      font-size:1rem;outline:none; box-shadow: none;
    }

    .line-row{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;margin-bottom:.6rem}
    .book-search-wrap{position:relative;flex:1 1 100%}
    .line-qty,.line-cost{flex:1 1 calc(50% - .3rem);min-width:110px}
    .line-total{font-weight:600;margin-left:auto}
    .remove-line{background:none;border:none;font-size:1.4rem;color:#e53935; cursor: pointer;}

    #new-supply .fab{ /* FAB pour ajouter une ligne */
        position:fixed;
        right:1rem;
        /* Ajustement pour être au-dessus de .wizard-nav */
        bottom:calc(env(safe-area-inset-bottom) + 50px + 1rem + 10px); /* 50px wizard-nav + 1rem marge + 10px petit espace supplémentaire */
        width:56px;height:56px;
        border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:1.7rem;
        display:flex;align-items:center;justify-content:center;
        box-shadow:none; border: 1px solid #0052a3; 
        z-index:60; /* Au-dessus de wizard-nav */
    }

    .wizard-nav{position:fixed;left:0;bottom:env(safe-area-inset-bottom);width:100%;
      display:flex;gap:.6rem;padding:.7rem 1rem;background:var(--surface);
      box-shadow:none; border-top: 1px solid var(--border-color); 
      z-index: 50; /* Z-index pour la navigation du wizard */
      transition: bottom 0.2s ease-out;
    }
    .btn{flex:1;padding:.8rem;font-size:1rem;font-weight:500;border:none;border-radius:var(--border-radius-card); cursor: pointer; box-shadow:none;}
    .btn.primary{background:var(--accent);color:#fff}.btn.primary:disabled{background:#bfc8d7; cursor: not-allowed;}
    .btn.secondary{background:#f5f5f5; border: 1px solid var(--border-color);}.btn.secondary:disabled{opacity:.6; cursor: not-allowed;}

    .summary{padding:1rem;background:#f9f9f9;border-radius:var(--border-radius-card);margin-bottom:1rem; border: 1px solid var(--border-color); box-shadow:none;}
    .summary div{margin-bottom:.3rem}

    .line-row .book-search {
      background:#f4f4f4;
      cursor:pointer;
    }
    .line-row .book-search[readonly]{
      caret-color:transparent;
    }

    .step[data-step="3"] { display: none; flex-direction: column; } 
    .step[data-step="3"].active { display: flex; }
    .step[data-step="3"] h2 { font-size: 1.3rem; text-align: center; margin-bottom: 1rem; }
    .step[data-step="3"] .form-group { margin-bottom: 1.5rem; }
    .step[data-step="3"] .form-group label { font-size: 0.9rem; color: var(--secondary-text); margin-bottom: 0.3rem; display: block; }
    .step[data-step="3"] .form-group input {
      width: 100%; padding: 0.8rem; font-size: 1rem;
      border: 1px solid var(--border-color); border-radius: var(--border-radius-card); box-shadow: none;
    }
    .step[data-step="3"] .cost-allocation-list { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.5rem; }
    .step[data-step="3"] .allocation-item {
      display: flex; justify-content: space-between; align-items: center;
      background: #f9f9f9; padding: 0.75rem 1rem; border-radius: var(--border-radius-card);
      border: 1px solid var(--border-color); box-shadow:none;
    }
    .step[data-step="3"] .allocation-item .item-label { font-size: 0.95rem; flex: 1; margin-right: 0.5rem; }
    .step[data-step="3"] .allocation-item .item-cost { font-size: 1rem; font-weight: 600; }

    .summary-cards { display: flex; flex-direction: column; gap: 1rem; }
    .summary-card {
      background: #fff; border: 1px solid var(--border-color);
      border-radius: 0.75rem; padding: 1rem; box-shadow: none;
    }
    .summary-card .line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .summary-card .line:last-child { margin-bottom: 0; }
    .summary-card .line .left { display: flex; align-items: center; gap: 0.5rem; }
    .summary-card .icon { font-size: 1.1rem; color: var(--secondary-text); }
    .summary-card .icon.accent { color: var(--accent); }
    .summary-card .label { font-size: 0.9rem; color: var(--secondary-text); }
    .summary-card .value { font-size: 1rem; font-weight: 600; color: var(--primary-text); }
    .summary-card .value.accent { color: var(--accent); }
    .summary-card .line.total { border-top: 1px solid #f0f0f0; padding-top: 0.75rem; margin-top: 0.75rem; }
    .search-noresult { 
      display: inline-flex;
      align-items: center;
      padding: 0.75rem 1rem;
      border-radius: var(--border-radius-pill);
      background: rgba(0,100,210,0.1);
      color: var(--accent);
      font-size: 1rem;
      line-height: 1.2;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
      box-shadow: none;
      border: 1px solid rgba(0,100,210,0.2);
    }
    .search-noresult:active {
      background: rgba(0,100,210,0.2);
    }
    .search-noresult i {
      margin-left: 0.5rem;
      font-size: 1.3rem;
      color: var(--accent);
    }
    /* Style pour le contenu scrollable dans chaque étape */
    .step > div:not(.wizard-nav):not(.fab) { /* Exclure le FAB du calcul de scroll */
        flex-grow: 1;
        overflow-y: auto;
        /* padding-bottom: 1rem; /* Espace pour ne pas être caché par le FAB ou wizard-nav */
    }
    #lines-container { /* Conteneur spécifique des lignes */
        padding-bottom: 70px; /* Espace pour le FAB */
    }
    /* En-tête pour le processus new-supply (si on en ajoute un) */
    #new-supply > header.wizard-main-header {
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        background: #fff;
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 55; /* Au-dessus du contenu, en dessous des modales */
    }
    #new-supply > header.wizard-main-header .btn-page-close {
        margin-right: 0.75rem;
    }
    #new-supply > header.wizard-main-header h2.wizard-main-title {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
    }

  </style>
  <!-- <header class="wizard-main-header">
    <button class="btn-page-close" data-hash="supply" aria-label="Annuler l'approvisionnement">
        <i class="bi bi-x-lg"></i>
    </button>
    <h2 class="wizard-main-title">Nouvel Approvisionnement</h2>
  </header> -->


  <template id="tmpl-line">
    <div class="line-row" data-id="">
      <div class="book-search-wrap">
        <input type="text"
               class="book-search"
               placeholder="Choisir un livre"
               readonly
               autocomplete="off"
               autocorrect="off"
               autocapitalize="none"
               spellcheck="false">
      </div>
      <input type="number" class="line-qty"  min="1" value="1" placeholder="Qté">
      <input type="number" class="line-cost" step="50" value="0" placeholder="PU"> <div class="line-total">XOF 0</div>
      <button type="button" class="remove-line" aria-label="Supprimer">×</button>
    </div>
  </template>

  <div class="step active" data-step="1">
    <h2>Articles</h2>
    <div id="lines-container"> </div>
    <button id="add-line-btn" class="fab" aria-label="Ajouter une ligne">+</button>
    <div class="wizard-nav">
      <button class="btn primary" data-next disabled>Suivant →</button>
    </div>
  </div>

  <div class="step" data-step="2">
    <h2>Allocation du coût d’achat</h2>
    <div style="flex-grow: 1; overflow-y: auto;"> <div class="form-group">
        <label for="additional-cost">Coût supplémentaire (XOF)</label>
        <input
          id="additional-cost"
          type="number"
          step="50"
          min="0"
          placeholder="0"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="none"
          spellcheck="false"
        >
        </div>
        <div class="cost-allocation-list">
        </div>
    </div>
    <div class="wizard-nav">
      <button class="btn secondary" data-prev>← Précédent</button>
      <button class="btn primary" data-next disabled>Suivant →</button>
    </div>
  </div>

  <div class="step" data-step="3">
    <h2>Fournisseur</h2>
    <div style="flex-grow: 1; overflow-y: auto;">
        <div class="form-group">
        <label for="supplier-search">Nom du fournisseur</label>
        <input id="supplier-search" type="search" placeholder="Rechercher ou saisir" autocomplete="off"
               autocorrect="off" autocapitalize="none" spellcheck="false">
        </div>
    </div>
    <div class="wizard-nav">
      <button class="btn secondary" data-prev>← Précédent</button>
      <button class="btn primary" data-next disabled>Suivant →</button>
    </div>
  </div>

  <div class="step" data-step="4">
    <h2>Résumé</h2>
    <div class="summary-cards" id="summary-cards-new-supply" style="flex-grow: 1; overflow-y: auto;">
        </div>
    <div class="wizard-nav">
      <button class="btn secondary" data-prev>← Précédent</button>
      <button id="submit-supply" class="btn primary" disabled>Valider & envoyer</button>
    </div>
  </div>

  <script>
    // New Supply Page Script
    (function(){
      const main      = document.getElementById('new-supply');
      const steps     = [...main.querySelectorAll('.step')];
      const supplierI = main.querySelector('#supplier-search');
      const linesC    = main.querySelector('#lines-container');
      const additionalCostI = main.querySelector('#additional-cost');
      const allocationList  = main.querySelector('.cost-allocation-list');
      const tmplLine  = document.getElementById('tmpl-line').content;
      const addLineBtn= main.querySelector('#add-line-btn');
      const submitBtn = main.querySelector('#submit-supply');

      let currentStep=1;
      function showStep(n){
        steps.forEach(s=>s.classList.toggle('active',+s.dataset.step===n));
        const activeStepEl = steps.find(s => +s.dataset.step === n);
        if (activeStepEl) {
            const firstInput = activeStepEl.querySelector('input:not([type=hidden]):not([readonly]), textarea, select');
            if (firstInput && activeStepEl.id !== 'lines-container' && activeStepEl.dataset.step !== "1") { // Ne pas focus sur l'étape 1 (lignes)
                setTimeout(() => firstInput.focus(), 50); 
            }
        }
      }

      main.addEventListener('click',e=>{
        if (e.target.matches('[data-next]:not([disabled])')) {
          currentStep++;
          if (currentStep === 2) { 
            if (!additionalCostI.value) { 
                additionalCostI.value = "0";
            }
            additionalCostI.dispatchEvent(new Event('input', { bubbles: true })); 
            const step2NextBtn = main.querySelector('[data-step="2"] [data-next]');
            if (step2NextBtn) step2NextBtn.disabled = parseFloat(additionalCostI.value) < 0; 
          }
          if (currentStep === 4) updateSummary(); 
          showStep(currentStep);
        }
        if(e.target.matches('[data-prev]')){currentStep--;showStep(currentStep)}
      });
      showStep(currentStep); 

      supplierI.addEventListener('input',()=> {
          const step3NextBtn = main.querySelector('[data-step="3"] [data-next]');
          if (step3NextBtn) step3NextBtn.disabled = !supplierI.value.trim();
      });

      let lineIdCounter=0;
      addLineBtn.addEventListener('click',()=>addLine());

      function addLine(data={}){ 
        lineIdCounter++;
        const row = document.importNode(tmplLine,true).firstElementChild;
        row.dataset.id=lineIdCounter; // ID unique pour la ligne
        const bookI=row.querySelector('.book-search');
       
        bookI.addEventListener('click', () => {
          // AMÉLIORATION: Utilisation de sessionStorage
          sessionStorage.setItem('targetBookInputRowId_newSupply', row.dataset.id); 
          sessionStorage.setItem('currentBookSearchValue_newSupply', bookI.value);
          location.hash = 'select-book'; 
        });

        const qtyI =row.querySelector('.line-qty');
        const costI=row.querySelector('.line-cost'); 
        const totalEl=row.querySelector('.line-total');

        if(data.title)bookI.value=data.title;
        if(data.qty)  qtyI.value=data.qty;
        if(data.cost !== undefined) costI.value=data.cost; else costI.value = "0"; 
        costI.dataset.baseCost = costI.value; 

        function updateLineTotals(){
          const q=parseInt(qtyI.value,10)||0;
          const c=parseFloat(costI.value)||0; 
          totalEl.textContent='XOF '+(q*c).toLocaleString('fr-FR', {minimumFractionDigits:0});
          toggleNextButtonForStep1();
        }
        qtyI.addEventListener('input',updateLineTotals);
        costI.addEventListener('input',() => { 
            costI.dataset.baseCost = costI.value; 
            updateLineTotals();
        }); 
        // 'change' est mieux si la valeur est modifiée par script (après sélection)
        bookI.addEventListener('change', updateLineTotals); 

        row.querySelector('.remove-line').addEventListener('click',()=>{
          row.remove();
          toggleNextButtonForStep1();
          if (currentStep === 2) { 
            additionalCostI.dispatchEvent(new Event('input', { bubbles: true }));
          } else if (currentStep === 4) { 
            updateSummary();
          }
        });

        linesC.append(row);
        updateLineTotals(); 
        toggleNextButtonForStep1();
        if (linesC.children.length === 1 && !bookI.value) {
          // Ne pas auto-cliquer, laisser l'utilisateur cliquer sur le champ ou le FAB
        } else if (bookI.value) { 
          qtyI.focus();
          qtyI.select();
        }
      }

      // AMÉLIORATION: Fonction pour appliquer le livre sélectionné depuis sessionStorage
      function applySelectedBookFromStorage_newSupply() {
        const targetRowId = sessionStorage.getItem('targetBookInputRowId_newSupply');
        const selectedTitle = sessionStorage.getItem('selectedBookTitle_newSupply');
        const selectedCost = sessionStorage.getItem('selectedBookBaseCost_newSupply');

        if (targetRowId && selectedTitle !== null && selectedCost !== null) {
            const row = linesC.querySelector(`.line-row[data-id="${targetRowId}"]`);
            if (row) {
                const bookInput = row.querySelector('.book-search');
                const costInput = row.querySelector('.line-cost');
                const qtyInput = row.querySelector('.line-qty');

                if (bookInput) bookInput.value = selectedTitle;
                if (costInput) {
                    costInput.value = selectedCost;
                    costInput.dataset.baseCost = selectedCost; // Mettre à jour le baseCost
                }
               
                // Déclencher 'change' sur bookInput pour que updateLineTotals soit appelé si nécessaire
                if (bookInput) bookInput.dispatchEvent(new Event('change', { bubbles: true }));
                if (costInput) costInput.dispatchEvent(new Event('input', { bubbles: true })); // Pour recalculer
               
                if (qtyInput) {
                    if (!qtyInput.value || qtyInput.value === "0") qtyInput.value = 1;
                    qtyInput.dispatchEvent(new Event('input', { bubbles: true }));
                    setTimeout(() => { qtyInput.focus(); qtyInput.select(); }, 50);
                }
            }
        }
        sessionStorage.removeItem('targetBookInputRowId_newSupply');
        sessionStorage.removeItem('selectedBookTitle_newSupply');
        sessionStorage.removeItem('selectedBookBaseCost_newSupply');
        sessionStorage.removeItem('currentBookSearchValue_newSupply');
      }
      // Appeler la fonction ci-dessus lorsque la page #new-supply est affichée
      // Ceci sera géré par le routeur principal ou un observateur spécifique à cette page.
      // Pour l'instant, on peut l'ajouter à un listener de hashchange spécifique à cette page.
      window.addEventListener('hashchange', () => {
        if (location.hash === '#new-supply' && main.classList.contains('visible')) {
            applySelectedBookFromStorage_newSupply();
        }
      });
      // Et pour le chargement initial si on arrive directement sur #new-supply
      if (location.hash === '#new-supply' && main.classList.contains('visible')) {
          applySelectedBookFromStorage_newSupply();
      }
        // Observer pour détecter quand la page devient visible et appliquer les données de sessionStorage
      const newSupplyObserver = new MutationObserver((mutationsList) => {
        for (const mutation of mutationsList) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                if (main.classList.contains('visible')) {
                    applySelectedBookFromStorage_newSupply();
                }
            }
        }
      });
      newSupplyObserver.observe(main, { attributes: true });


      additionalCostI.addEventListener('input', () => {
        const addCost = parseFloat(additionalCostI.value) || 0;
        const rows = [...linesC.children];
        const totalQtyAllBooks = rows.reduce((sum, r) => {
          const q = parseInt(r.querySelector('.line-qty').value, 10) || 0;
          return sum + q;
        }, 0);

        const unitExtraCost = totalQtyAllBooks > 0 ? addCost / totalQtyAllBooks : 0;
        allocationList.innerHTML = ''; 

        rows.forEach(r => {
          const qtyInput      = r.querySelector('.line-qty');
          const costInput     = r.querySelector('.line-cost'); 
          const lineTotalEl = r.querySelector('.line-total');
          const bookSearchInput = r.querySelector('.book-search');
          const currentQty  = parseInt(qtyInput.value, 10) || 0;
          const baseUnitCost = parseFloat(costInput.dataset.baseCost || "0"); 
          const newUnitCostWithExtra = baseUnitCost + unitExtraCost;
          lineTotalEl.textContent = 'XOF ' + (currentQty * newUnitCostWithExtra).toLocaleString('fr-FR', {minimumFractionDigits:0});
          const extraCostForThisLineItem = currentQty * unitExtraCost;
          const title = bookSearchInput.value || 'Livre non spécifié';
          const div = document.createElement('div');
          div.className = 'allocation-item';
          div.innerHTML = `
            <div class="item-label">${title} (Qté: ${currentQty})</div>
            <div class="item-cost">+ ${extraCostForThisLineItem.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</div>
          `;
          allocationList.appendChild(div);
        });

        const step2NextBtn = main.querySelector('[data-step="2"] [data-next]');
        if (step2NextBtn) step2NextBtn.disabled = addCost < 0 || rows.length === 0;
       
        if (rows.length > 0 && addCost >= 0 && currentStep === 4) {
           updateSummary();
        }
      });

      function updateSummary() {
        const rows = [...linesC.children];
        const summaryCardsContainer = document.getElementById('summary-cards-new-supply');
        summaryCardsContainer.innerHTML = ''; 
        const supplierName = supplierI.value.trim() || 'Non spécifié';
        const additionalCostTotal = parseFloat(additionalCostI.value) || 0;
        const totalQtyAllBooksForSummary = rows.reduce((sum, r) => sum + (parseInt(r.querySelector('.line-qty').value, 10) || 0), 0);
        const unitExtraCostForSummary = totalQtyAllBooksForSummary > 0 ? additionalCostTotal / totalQtyAllBooksForSummary : 0;
        let grandTotalQty = 0;
        const generalInfoCard = document.createElement('div');
        generalInfoCard.className = 'summary-card';
        generalInfoCard.innerHTML = `
          <div class="line">
              <div class="left"><i class="bi bi-person-fill icon"></i><span class="label">Fournisseur</span></div>
              <span class="value">${supplierName}</span>
          </div>
          <div class="line">
              <div class="left"><i class="bi bi-cash-stack icon accent"></i><span class="label">Coût Supp. Total</span></div>
              <span class="value accent">${additionalCostTotal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
          </div>
        `;
        summaryCardsContainer.appendChild(generalInfoCard);

        rows.forEach(r => {
          const title = r.querySelector('.book-search').value || 'Livre N/A';
          const qty   = parseInt(r.querySelector('.line-qty').value,10) || 0;
          const baseUnitCost = parseFloat(r.querySelector('.line-cost').dataset.baseCost || r.querySelector('.line-cost').value || "0");
          const unitCostFinal = baseUnitCost + unitExtraCostForSummary; 
          const lineTotal = unitCostFinal * qty;
          grandTotalQty += qty;
          const extraPerUnitForThisItem = unitCostFinal - baseUnitCost;
          const card = document.createElement('div');
          card.className = 'summary-card';
          card.innerHTML = `
            <div class="line">
              <div class="left"><i class="bi bi-book-fill icon"></i><span class="label">Article</span></div>
              <span class="value" style="text-align: right;">${title}</span>
            </div>
            <div class="line">
              <div class="left"><i class="bi bi-tags-fill icon"></i><span class="label">PU de base</span></div>
              <span class="value">${baseUnitCost.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
            </div>
            <div class="line">
              <div class="left"><i class="bi bi-plus-slash-minus icon"></i><span class="label">Part Coût Supp./Unité</span></div>
              <span class="value">${extraPerUnitForThisItem.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
            </div>
              <div class="line">
              <div class="left"><i class="bi bi-currency-exchange icon accent"></i><span class="label">PU Final</span></div>
              <span class="value accent">${unitCostFinal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
            </div>
            <div class="line">
              <div class="left"><i class="bi bi-list-ol icon"></i><span class="label">Qté</span></div>
              <span class="value">${qty}</span>
            </div>
            <div class="line total">
              <div class="left"><i class="bi bi-check-circle-fill icon accent"></i><span class="label">Total Ligne</span></div>
              <span class="value accent">${lineTotal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
            </div>
          `;
          summaryCardsContainer.appendChild(card);
        });

        const finalTotalCard = document.createElement('div');
        finalTotalCard.className = 'summary-card';
        const actualGrandTotalCost = rows.reduce((sum, r) => {
            const qty = parseInt(r.querySelector('.line-qty').value,10) || 0;
            const basePU = parseFloat(r.querySelector('.line-cost').dataset.baseCost || r.querySelector('.line-cost').value || "0");
            const finalPU = basePU + unitExtraCostForSummary;
            return sum + (qty * finalPU);
        },0);
        finalTotalCard.innerHTML = `
          <div class="line" style="border-top: 1px solid #ccc; padding-top: 0.5rem; margin-top:0.5rem;">
              <div class="left"><i class="bi bi-calculator-fill icon"></i><span class="label">Quantité Totale d'articles</span></div>
              <span class="value" style="font-weight: bold;">${grandTotalQty}</span>
          </div>
          <div class="line total">
              <div class="left"><i class="bi bi-receipt-cutoff icon accent"></i><span class="label">Coût Total Appro.</span></div>
              <span class="value accent" style="font-size: 1.2rem; font-weight: bold;">${actualGrandTotalCost.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
          </div>
        `;
        summaryCardsContainer.appendChild(finalTotalCard);
        submitBtn.disabled = rows.length === 0 || !supplierI.value.trim();
      }

      function toggleNextButtonForStep1() {
        const step1NextBtn = main.querySelector('[data-step="1"] [data-next]');
        if(step1NextBtn) {
            step1NextBtn.disabled = linesC.children.length === 0 ||
              [...linesC.children].some(row => !row.querySelector('.book-search').value.trim());
        }
      }

      submitBtn.addEventListener('click',async()=>{
        submitBtn.disabled=true;
        submitBtn.textContent = 'Envoi en cours...';
        const user=auth.currentUser;
        if (!user) {
          console.error("Utilisateur non connecté. Veuillez vous reconnecter.");
          showGlobalToast('Utilisateur non connecté.', true);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Valider & envoyer';
          return;
        }

        const supplierNameValue=supplierI.value.trim();
        const additionalCostOverall = parseFloat(additionalCostI.value) || 0;
        const totalQtyAllBooksForSave = [...linesC.children].reduce((sum, r) => sum + (parseInt(r.querySelector('.line-qty').value, 10) || 0), 0);
        const unitExtraCostForSave = totalQtyAllBooksForSave > 0 ? additionalCostOverall / totalQtyAllBooksForSave : 0;

        const supplyLinesData=[...linesC.children].map(r=> {
            const baseUnitCostFromInput = parseFloat(r.querySelector('.line-cost').dataset.baseCost || r.querySelector('.line-cost').value || "0");
            return {
                title:r.querySelector('.book-search').value,
                quantity:parseInt(r.querySelector('.line-qty').value,10) || 0,
                unitCost: baseUnitCostFromInput + unitExtraCostForSave, 
                baseUnitCost: baseUnitCostFromInput 
            };
        });

        const totalQuantityFinal = supplyLinesData.reduce((sum, ln) => sum + ln.quantity, 0);
        const totalCostFinal = supplyLinesData.reduce((sum, ln) => sum + ln.quantity * ln.unitCost, 0);
       
        const batch=db.batch();
        const supplyRef=db.collection('users').doc(user.uid).collection('supplies').doc();
        batch.set(supplyRef,{
            supplierName:supplierNameValue,
            date:firebase.firestore.FieldValue.serverTimestamp(),
            lines: supplyLinesData, 
            totalQty:totalQuantityFinal,
            totalCost:totalCostFinal, 
            additionalCostApplied: additionalCostOverall
        });

        const uid = auth.currentUser.uid;
        const userBooksRef = db.collection('users').doc(uid).collection('books');

        for(const ln of supplyLinesData){
          if (!ln.title) continue;
          const bookQuerySnapshot = await userBooksRef.where('title','==', ln.title).limit(1).get();

          if (!bookQuerySnapshot.empty) { 
            const bookDocRef = bookQuerySnapshot.docs[0].ref;
            const bookData = bookQuerySnapshot.docs[0].data();
           
            const currentQuantity = bookData.quantity || 0;
            const currentAverageCost = bookData.averageCost !== undefined ? bookData.averageCost : (bookData.lastPurchasePrice || 0); 
            const newQuantity = currentQuantity + ln.quantity;
            let newAverageCost = currentAverageCost; 
            if (newQuantity > 0) { 
                 newAverageCost = 
                    ((currentAverageCost * currentQuantity) + (ln.unitCost * ln.quantity)) / newQuantity;
            } else if (ln.quantity > 0) { 
                 newAverageCost = ln.unitCost;
            }
            batch.update(bookDocRef, {
              quantity: firebase.firestore.FieldValue.increment(ln.quantity),
              lastPurchasePrice: ln.unitCost, 
              averageCost: newAverageCost, 
            });
          } else { 
             batch.set(userBooksRef.doc(), {
              title: ln.title,
              quantity: ln.quantity,
              price: ln.baseUnitCost, 
              lastPurchasePrice: ln.unitCost, 
              averageCost: ln.unitCost, 
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
             });
          }
        }
        try {
            await batch.commit();
            location.hash='supply'; 
            showGlobalToast('Approvisionnement enregistré !', false, 2500);
            supplierI.value = '';
            linesC.innerHTML = '';
            additionalCostI.value = '0';
            allocationList.innerHTML = '';
            document.getElementById('summary-cards-new-supply').innerHTML = '';
            currentStep = 1;
            showStep(currentStep);
            main.querySelector('[data-step="1"] [data-next]').disabled = true;
            main.querySelector('[data-step="2"] [data-next]').disabled = true;
            main.querySelector('[data-step="3"] [data-next]').disabled = true;
            submitBtn.disabled = true;
        } catch (error) {
            console.error("Erreur lors de l'enregistrement de l'approvisionnement: ", error);
            showGlobalToast("Erreur: " + error.message, true, 3500);
        } finally {
            submitBtn.disabled = false; 
            submitBtn.textContent = 'Valider & envoyer';
        }
      });

      const allWizardNavs = main.querySelectorAll('.wizard-nav');
      const allStepContents = main.querySelectorAll('.step');

      function onInputFocus(e) {
        const currentStepEl = e.target.closest('.step');
        const currentWizardNav = currentStepEl ? currentStepEl.querySelector('.wizard-nav') : null;
        if (!currentWizardNav || !currentStepEl) return;
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', handleViewportResize);
            adjustLayoutForKeyboard(currentStepEl, currentWizardNav, e.target);
        }
      }
      function onInputBlur(e) {
        const currentStepEl = e.target.closest('.step');
        const currentWizardNav = currentStepEl ? currentStepEl.querySelector('.wizard-nav') : null;
        if (window.visualViewport) {
            window.visualViewport.removeEventListener('resize', handleViewportResize);
        }
        if (currentWizardNav) currentWizardNav.style.bottom = '';
        if (currentStepEl) currentStepEl.style.paddingBottom = ''; // Réinitialiser le padding
      }
     
      // Stocker les références pour le removeEventListener
      let currentStepElForKeyboard, currentWizardNavForKeyboard, focusedInputForKeyboard;

      function handleViewportResize() {
          adjustLayoutForKeyboard(currentStepElForKeyboard, currentWizardNavForKeyboard, focusedInputForKeyboard);
      }


      function adjustLayoutForKeyboard(stepEl, wizardNavEl, focusedInput) {
        currentStepElForKeyboard = stepEl;
        currentWizardNavForKeyboard = wizardNavEl;
        focusedInputForKeyboard = focusedInput;

        if (!wizardNavEl || !stepEl || document.activeElement !== focusedInput) {
          if (window.visualViewport && document.activeElement !== focusedInput) { 
             if (wizardNavEl) wizardNavEl.style.bottom = '';
             if (stepEl) stepEl.style.paddingBottom = ''; // Réinitialiser le padding
          }
          return;
        }
        const visualViewport = window.visualViewport;
        const keyboardHeight = window.innerHeight - (visualViewport.offsetTop + visualViewport.height);
        const safeAreaBottom = parseInt(getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-bottom)')) || 0;

        if (keyboardHeight > 50) { 
          wizardNavEl.style.bottom = (keyboardHeight - safeAreaBottom) + 'px';
          const navHeight = wizardNavEl.offsetHeight;
          // Ajuster le padding du conteneur de contenu scrollable de l'étape, pas de l'étape elle-même
          const scrollableContent = stepEl.querySelector('div[style*="overflow-y: auto"], #lines-container');
          if (scrollableContent) {
            scrollableContent.style.paddingBottom = (keyboardHeight - safeAreaBottom + navHeight + 15) + 'px';
          } else { // Fallback si pas de conteneur scrollable spécifique trouvé
            stepEl.style.paddingBottom = (keyboardHeight - safeAreaBottom + navHeight + 15) + 'px';
          }
        } else { 
          wizardNavEl.style.bottom = '';
          const scrollableContent = stepEl.querySelector('div[style*="overflow-y: auto"], #lines-container');
          if (scrollableContent) {
            scrollableContent.style.paddingBottom = ''; // Réinitialiser le padding du contenu
          } else {
            stepEl.style.paddingBottom = ''; // Réinitialiser le padding de l'étape
          }
        }
      }
      main.querySelectorAll('input[type="search"], input[type="number"], input[type="text"]').forEach(input => {
          input.addEventListener('focus', onInputFocus);
          input.addEventListener('blur', onInputBlur);
      });
      toggleNextButtonForStep1();
      const step2NextBtn = main.querySelector('[data-step="2"] [data-next]');
      if (step2NextBtn) step2NextBtn.disabled = true; 
      const step3NextBtn = main.querySelector('[data-step="3"] [data-next]');
      if (step3NextBtn) step3NextBtn.disabled = true; 
    })();
  </script>
</main>

<main id="select-book" class="page">
  <style>
    #select-book .books-list .book-card { 
        cursor: pointer;
        transition: background-color 0.15s ease-in-out;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-card);
        padding: 1rem;
        background: #fff;
        box-shadow: none;
    }
    #select-book .books-list .book-card:hover { 
        background-color: #f9f9f9;
    }
    #select-book .books-list .book-card:active { 
        background-color: #f0f0f0;
    }
    #select-book .search-noresult-container { 
        padding: 1rem; text-align: center;
    }
    #select-book .book-title {
      font-size: 1.1rem; font-weight: 600; margin-bottom: 0.4rem; color: var(--primary-text);
    }
    #select-book .book-price { 
      font-size: 0.9rem; font-weight: 500; color: var(--ebay-red); margin-bottom: 0.2rem;
    }
    #select-book .book-quantity {
      font-size: 0.85rem; color: var(--secondary-text);
    }
    #select-book > header.sell-header { 
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        background: #fff;
        border-bottom: 1px solid var(--border-color);
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 15;
    }
    #select-book > header.sell-header .btn-close {
        flex: 0 0 auto; display: flex; align-items: center; justify-content: center;
        padding: 0.5rem; background: none; border: none; font-size: 1.5rem;
        color: var(--primary-text); margin-right: 0.75rem; cursor: pointer; outline: none;
    }
    #select-book > header.sell-header .search-wrapper {
        flex: 1; margin-top: 0;
    }
    #select-book > header.sell-header #select-book-search {
        width: 100%; padding: 0.75rem 2.75rem 0.75rem 2.75rem; 
        border: 1px solid var(--border-color); border-radius: var(--border-radius-pill);
        background: #f4f4f4; font-size: 1rem; outline: none; box-shadow: none;
    }
  </style>
  <header class="sell-header"> 
    <button class="btn-close" data-hash="new-supply" aria-label="Annuler et retourner"> <i class="bi bi-x-lg"></i>
    </button>
    <div class="search-wrapper">
      <i class="bi bi-search"></i>
      <input
        type="search"
        id="select-book-search"
        placeholder="Rechercher un livre existant"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
      >
    </div>
  </header>
  <div id="select-book-results" style="padding-bottom: 1rem;"> <div class="books-list" style="display: flex; flex-direction: column; gap: 0.75rem; padding: 1rem;"></div> </div>

  <script>
  // Select Book Page Script
  (function() {
    const selectBookPage = document.getElementById('select-book');
    const searchInputEl = document.getElementById('select-book-search');
    const resultListEl  = document.querySelector('#select-book-results .books-list');
    let debounceTimer = null;

    searchInputEl.addEventListener('input', performBookSearch);

    window.addEventListener('hashchange', () => {
      if (location.hash === '#select-book' && selectBookPage.classList.contains('visible')) {
          setTimeout(() => searchInputEl.focus(), 50); 
          // AMÉLIORATION: Lire depuis sessionStorage
          const prefillSearch = sessionStorage.getItem('currentBookSearchValue_newSupply');
          if (prefillSearch) {
              searchInputEl.value = prefillSearch;
          } else {
              searchInputEl.value = ''; 
          }
          performBookSearch(); 
      }
    });
      // Exécuter aussi si la page est déjà visible au chargement initial (ex: refresh)
    if (location.hash === '#select-book' && selectBookPage.classList.contains('visible')) {
        setTimeout(() => searchInputEl.focus(), 50);
        const prefillSearch = sessionStorage.getItem('currentBookSearchValue_newSupply');
        if (prefillSearch) {
            searchInputEl.value = prefillSearch;
        } else {
            searchInputEl.value = '';
        }
        performBookSearch();
    }


  async function performBookSearch() {
    const searchTerm = searchInputEl.value.trim();
    clearTimeout(debounceTimer);

    if (searchTerm.length === 0) { 
        loadAllBooks(); 
        return;
    }
    debounceTimer = setTimeout(async () => {
      try {
        if (!auth.currentUser) {
            resultListEl.innerHTML = '<p style="padding:1rem;color:var(--ebay-red);text-align:center;">Utilisateur non connecté.</p>';
            return;
        }
        const uid = auth.currentUser.uid;
        const userBooksRef = db.collection('users').doc(uid).collection('books');
        const snapshot = await userBooksRef.orderBy('title').get();
        const allUserBooks = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        const searchTermLower = searchTerm.toLowerCase();
        const filteredBooks = allUserBooks.filter(book => 
            book.title.toLowerCase().includes(searchTermLower)
        );
        displayResults(filteredBooks, searchTerm);
      } catch (err) {
        resultListEl.innerHTML = '<p style="color:var(--ebay-red);padding:1rem;text-align:center;">Erreur de recherche.</p>';
        console.error("Book search error:", err);
      }
    }, 250); 
  }

  async function loadAllBooks() {
      try {
        if (!auth.currentUser) {
            resultListEl.innerHTML = '<p style="padding:1rem;color:var(--ebay-red);text-align:center;">Utilisateur non connecté.</p>';
            return;
        }
        const uid = auth.currentUser.uid;
        const snapshot = await db.collection('users').doc(uid).collection('books').orderBy('title').limit(50).get(); 
        const books = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        displayResults(books, ""); 
      } catch (err) {
        resultListEl.innerHTML = '<p style="color:var(--ebay-red);padding:1rem;text-align:center;">Erreur de chargement.</p>';
        console.error("Book load error:", err);
      }
  }

  function displayResults(books, searchTerm) {
      resultListEl.innerHTML = ''; 
      if (books.length === 0 && searchTerm) { 
        resultListEl.innerHTML = `
            <div class="search-noresult-container">
              <p>Aucun livre trouvé pour « ${searchTerm} ».</p>
              <div id="add-new-book-chip-from-select" class="search-noresult" style="margin-top: 0.5rem; display: inline-flex; justify-content: center;">
                Ajouter « <strong id="chip-book-title-from-select">${searchTerm}</strong> » comme nouveau livre
                <i class="bi bi-plus-circle-fill" style="margin-left: 0.5rem;"></i>
              </div>
            </div>
          `;
          // AMÉLIORATION: Le clic sur ce chip ouvrira la modale d'ajout de livre
          const addChip = resultListEl.querySelector('#add-new-book-chip-from-select');
          if (addChip) {
              addChip.addEventListener('click', () => {
                  const titleSuggestion = addChip.querySelector('#chip-book-title-from-select').textContent.trim();
                  // La variable 'targetBookInputRowId_newSupply' est déjà dans sessionStorage
                  // si on vient de new-supply.
                  // On stocke le titre suggéré pour la modale.
                  sessionStorage.setItem('suggestedNewBookTitle_newSupply', titleSuggestion);
                  // Le script de la modale `add-book-modal` lira `suggestedNewBookTitle_newSupply`
                  // et `targetBookInputRowId_newSupply` pour savoir où retourner l'info.
                  openGlobalAddBookModal(titleSuggestion); // Utiliser la fonction globale
              });
          }

      } else if (books.length === 0 && !searchTerm) {
         resultListEl.innerHTML = '<p style="padding:1rem; text-align:center;">Aucun livre dans votre catalogue. Ajoutez-en via la section "Approvisionnement".</p>';
      } else {
        books.forEach(bookData => {
          const bookDiv = document.createElement('div');
          bookDiv.className = 'book-card'; 
          const costToDisplay = bookData.averageCost !== undefined ? bookData.averageCost : (bookData.lastPurchasePrice || 0);
          bookDiv.innerHTML = `
            <h4 class="book-title">${bookData.title}</h4>
            <p class="book-price">Coût Moyen Pondéré: ${costToDisplay.toLocaleString('fr-FR',{style:'currency', currency:'XOF', minimumFractionDigits:0})}</p>
            <p class="book-quantity">En Stock: ${bookData.quantity || 0}</p>
            `;
          bookDiv.addEventListener('click', () => {
            // AMÉLIORATION: Utilisation de sessionStorage
            const targetRowId = sessionStorage.getItem('targetBookInputRowId_newSupply');
            if (targetRowId) {
                sessionStorage.setItem('selectedBookTitle_newSupply', bookData.title);
                sessionStorage.setItem('selectedBookBaseCost_newSupply', (bookData.lastPurchasePrice || 0).toFixed(0));
            }
            // sessionStorage.removeItem('targetBookInputRowId_newSupply'); // Ne pas supprimer ici, mais dans new-supply
            sessionStorage.removeItem('currentBookSearchValue_newSupply');
            location.hash = 'new-supply'; 
          });
          resultListEl.appendChild(bookDiv);
        });
      }
  }
  })();
  </script>
</main>

<div id="add-book-modal-overlay" class="modal-overlay-container" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="add-book-modal-title-heading">
    <header>
      <h3 id="add-book-modal-title-heading">Ajouter un nouveau livre</h3>
      <button id="add-book-modal-close-btn" class="modal-close-btn" aria-label="Fermer">&times;</button>
    </header>
    <div class="modal-content">
      <form id="form-add-book-modal-form">
        <div class="form-group">
          <label for="new-book-title-modal-input">Titre du livre</label>
          <input
            type="search" 
            id="new-book-title-modal-input"
            placeholder="Ex: Le Petit Prince"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="sentences" 
            enterkeyhint="done"  
            spellcheck="false"
            required
          >
        </div>
        <button type="submit" id="add-book-modal-submit-btn">Enregistrer le livre</button>
      </form>
    </div>
  </div>
</div>

<script>
// Script pour la MODALE GLOBALE d'ajout de livre
const addBookModalOverlayGlobal = document.getElementById('add-book-modal-overlay');
const addBookModalDialogGlobal = addBookModalOverlayGlobal.querySelector('.modal');
const formAddBookModalGlobal = document.getElementById('form-add-book-modal-form');
const titleInputModalGlobal = document.getElementById('new-book-title-modal-input');
const closeModalBtnModalGlobal = document.getElementById('add-book-modal-close-btn');
const submitBtnModalGlobal = document.getElementById('add-book-modal-submit-btn');
let previousActiveElementGlobal; 
let focusableElementsModalGlobal = [];

function openGlobalAddBookModal(defaultTitle = '') {
  if (!addBookModalOverlayGlobal) return console.error('Modale #add-book-modal-overlay introuvable');
 
  previousActiveElementGlobal = document.activeElement; 
  addBookModalOverlayGlobal.classList.add('visible');
  addBookModalOverlayGlobal.setAttribute('aria-hidden', 'false');
  titleInputModalGlobal.value = defaultTitle;

  // Piéger le focus
  const focusableElementsString = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])';
  focusableElementsModalGlobal = Array.from(addBookModalDialogGlobal.querySelectorAll(focusableElementsString));
  const firstFocusableElement = focusableElementsModalGlobal[0];
 
  setTimeout(() => { // Laisser le temps à la modale de devenir visible
      if (firstFocusableElement) firstFocusableElement.focus();
  }, 100);


  document.addEventListener('keydown', trapFocusInModalGlobal);
  document.addEventListener('keydown', handleEscapeKeyModalGlobal);
  document.body.style.overflow = 'hidden'; // Empêcher le scroll du body
}

function closeGlobalAddBookModal() {
  if (!addBookModalOverlayGlobal) return;
  addBookModalOverlayGlobal.classList.remove('visible');
  addBookModalOverlayGlobal.setAttribute('aria-hidden', 'true');
 
  document.removeEventListener('keydown', trapFocusInModalGlobal);
  document.removeEventListener('keydown', handleEscapeKeyModalGlobal);
  document.body.style.overflow = ''; // Restaurer le scroll du body

  if (previousActiveElementGlobal) {
      previousActiveElementGlobal.focus(); 
  }
  // Nettoyer le titre suggéré si on vient de select-book
  sessionStorage.removeItem('suggestedNewBookTitle_newSupply');
}

if(closeModalBtnModalGlobal) closeModalBtnModalGlobal.addEventListener('click', closeGlobalAddBookModal);
addBookModalOverlayGlobal.addEventListener('click', (e) => {
    if (e.target === addBookModalOverlayGlobal) { 
        closeGlobalAddBookModal();
    }
});

function trapFocusInModalGlobal(e) {
    if (e.key !== 'Tab' || !addBookModalOverlayGlobal.classList.contains('visible')) return;
   
    const firstFocusableElement = focusableElementsModalGlobal[0];
    const lastFocusableElement = focusableElementsModalGlobal[focusableElementsModalGlobal.length - 1];

    if (e.shiftKey) { 
        if (document.activeElement === firstFocusableElement) {
            lastFocusableElement.focus();
            e.preventDefault();
        }
    } else { 
        if (document.activeElement === lastFocusableElement) {
            firstFocusableElement.focus();
        }
    }
}

function handleEscapeKeyModalGlobal(e) {
    if (e.key === 'Escape' && addBookModalOverlayGlobal.classList.contains('visible')) {
        closeGlobalAddBookModal();
    }
}

formAddBookModalGlobal.addEventListener('submit', async e => {
    e.preventDefault();
    const newTitle = titleInputModalGlobal.value.trim();
   
    if (!newTitle) {
      titleInputModalGlobal.style.borderColor = 'var(--ebay-red)';
      setTimeout(() => titleInputModalGlobal.style.borderColor = '', 2000);
      titleInputModalGlobal.focus();
      return;
    }
   
    submitBtnModalGlobal.disabled = true;
    submitBtnModalGlobal.textContent = 'Enregistrement...';

    try {
      if (!auth.currentUser) throw new Error("Utilisateur non authentifié.");
      const uid = auth.currentUser.uid;
      const userBooksRef = db.collection('users').doc(uid).collection('books');
      const querySnapshot = await userBooksRef.get();
      const existingBook = querySnapshot.docs.find(doc => doc.data().title.toLowerCase() === newTitle.toLowerCase());

      if (existingBook) throw new Error(`Un livre intitulé "${existingBook.data().title}" existe déjà.`);

      await userBooksRef.add({
        title: newTitle,
        price: 0, 
        quantity: 0, 
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastPurchasePrice: 0, 
        averageCost: 0 
      });

      closeGlobalAddBookModal(); 
      showGlobalToast(`Livre "${newTitle}" ajouté !`, false, 2500);

      // AMÉLIORATION: Mettre à jour sessionStorage pour la page new-supply si on vient de là
      const targetRowIdForNewSupply = sessionStorage.getItem('targetBookInputRowId_newSupply');
      if (targetRowIdForNewSupply) {
          sessionStorage.setItem('selectedBookTitle_newSupply', newTitle);
          sessionStorage.setItem('selectedBookBaseCost_newSupply', "0"); // Nouveau livre, coût 0
          // Pas besoin de changer le hash ici, applySelectedBookFromStorage_newSupply
          // sera appelé quand #new-supply redevient visible.
          // Le routeur principal s'occupera de ramener à #new-supply si #select-book était intermédiaire.
          if(location.hash === '#select-book') location.hash = 'new-supply';
      }
      titleInputModalGlobal.value = ''; 
    } catch (err) {
      console.error(err);
      showGlobalToast("Erreur: " + err.message, true, 3500);
    } finally {
        submitBtnModalGlobal.disabled = false;
        submitBtnModalGlobal.textContent = 'Enregistrer le livre';
    }
});
</script>

  <main id="orders" class="page">
    <header style="padding:1rem;">
        <button class="btn-page-back" data-hash="account" aria-label="Retour au compte">
            <i class="bi bi-arrow-left"></i>
        </button>
        <h2>My Orders</h2>
    </header>
    <p style="padding:0 1rem 1rem; text-align:center;">Your recent orders will appear here…</p>
  </main>

  <main id="sales" class="page">
  <header id="sales-header">
    <h2>Historique des Ventes</h2>
  </header>
  <div id="sales-summary-filter-container">
    <span id="sales-summary-chip">0 livre(s) vendu(s)</span>
    <div id="sales-date-filter-group">
        <span id="sales-selected-date-display">Aujourd'hui</span>
        <button id="sales-date-filter-btn" aria-label="Choisir une date">
            <i class="bi bi-calendar3"></i>
        </button>
        <input type="date" id="sales-date-picker">
    </div>
  </div>
  <div id="sales-list" class="sales-list">
    </div>
  <script>
    // Script for Sales History Page
    (function() {
      const salesListEl = document.getElementById('sales-list');
      const salesSummaryChipEl = document.getElementById('sales-summary-chip');
      const salesSelectedDateDisplayEl = document.getElementById('sales-selected-date-display');
      const salesDateFilterBtnEl = document.getElementById('sales-date-filter-btn');
      const salesDatePickerEl = document.getElementById('sales-date-picker');

      let unsubscribeSales = null;
      let selectedSalesDate = new Date(); 

      function formatDateForDisplay(date) {
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0'); 
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      }
     
      function updateSelectedDateDisplay(date) {
          const today = new Date();
          if (date.toDateString() === today.toDateString()) {
              salesSelectedDateDisplayEl.textContent = "Aujourd'hui";
          } else {
              salesSelectedDateDisplayEl.textContent = formatDateForDisplay(date);
          }
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          salesDatePickerEl.value = `${year}-${month}-${day}`;
      }

      function getStartOfDayTimestamp(date) {
          const start = new Date(date);
          start.setHours(0, 0, 0, 0);
          return firebase.firestore.Timestamp.fromDate(start);
      }

      function getEndOfDayTimestamp(date) {
          const end = new Date(date);
          end.setHours(23, 59, 59, 999);
          return firebase.firestore.Timestamp.fromDate(end);
      }

      function setupSalesListener(filterDate) {
        if (unsubscribeSales) unsubscribeSales(); 
        if (!auth.currentUser) {
          if(salesListEl) salesListEl.innerHTML = '<p style="padding:1rem;color:#555;text-align:center;">Veuillez vous connecter pour voir l\'historique.</p>';
          if(salesSummaryChipEl) salesSummaryChipEl.textContent = '0 livre(s) vendu(s)';
          return;
        }

        const startOfDay = getStartOfDayTimestamp(filterDate);
        const endOfDay = getEndOfDayTimestamp(filterDate);

        const salesRef = db
          .collection('users')
          .doc(auth.currentUser.uid)
          .collection('sales')
          .where('timestamp', '>=', startOfDay)
          .where('timestamp', '<=', endOfDay)
          .orderBy('timestamp', 'desc'); 

        if(salesListEl) {
            salesListEl.innerHTML = Array(3) 
            .fill('')
            .map(() => '<div class="skeleton-sale-card"></div>')
            .join('');
        }
        if(salesSummaryChipEl) salesSummaryChipEl.textContent = 'Chargement...';

        unsubscribeSales = salesRef.onSnapshot(snapshot => {
          if(!salesListEl) return;
          salesListEl.innerHTML = ''; 

          let totalBooksSoldOnDate = 0;

          if (snapshot.empty) {
            salesListEl.innerHTML = `<p style="padding:1rem;color:#555;text-align:center;">Aucune vente enregistrée pour le ${formatDateForDisplay(filterDate)}.</p>`;
          } else {
            snapshot.forEach(doc => {
              const sale = doc.data();
              const saleId = doc.id;
              const dateObj = sale.timestamp?.toDate() || new Date(); 
              const dateStr = dateObj.toLocaleDateString('fr-FR', {
                day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
              });

              const totalSaleAmount = sale.grandTotalAmount || 0;
              const totalItemsInThisSale = sale.totalItemsSold || 0;
              totalBooksSoldOnDate += totalItemsInThisSale;

              const saleCard = document.createElement('div');
              saleCard.className = 'sale-card'; 
              saleCard.dataset.saleId = saleId;

              let customerDisplayName = sale.customerName || 'Client Anonyme';
              if (customerDisplayName.length > 25) {
                  customerDisplayName = customerDisplayName.substring(0, 22) + '...';
              }

              saleCard.innerHTML = `
                <header>
                  <div class="sale-info">
                    <strong title="${sale.customerName || 'Client Anonyme'}">${customerDisplayName}</strong>
                    <small>${dateStr}</small>
                  </div>
                  <div class="sale-meta">
                    <span class="sale-total-amount">${totalSaleAmount.toLocaleString('fr-FR', {
                      style: 'currency', currency: 'XOF', minimumFractionDigits: 0
                    })}</span>
                    <span class="sale-total-items">Articles: ${totalItemsInThisSale}</span>
                  </div>
                </header>
                ${sale.items && sale.items.length > 0 ? `
                  <ul style="list-style:none; padding-left:0; margin-top:0.5rem; font-size:0.85rem;">
                    ${sale.items.slice(0, 2).map(item => `
                      <li style="display:flex; justify-content:space-between; padding:0.1rem 0;">
                        <span style="flex-grow:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-right:0.5rem;" title="${item.title || 'Article inconnu'}">${item.title || 'Article inconnu'}</span>
                        <span style="flex-shrink:0;">x ${item.quantitySold || 0}</span>
                      </li>
                    `).join('')}
                    ${sale.items.length > 2 ? `<li style="text-align:right; color:var(--secondary-text); font-style:italic;">et ${sale.items.length - 2} autre(s)...</li>` : ''}
                  </ul>` : '<p style="font-size:0.85rem; color:var(--secondary-text); margin-top:0.5rem;">Aucun détail d\'article disponible.</p>'}
              `;
              saleCard.addEventListener('click', () => {
                console.log("Clicked sale:", saleId, sale);
                // Remplacer par une modale ou une vue détaillée
                showGlobalToast(`Détails pour la vente ID: ${saleId} (à implémenter)`, false);
              });
              salesListEl.appendChild(saleCard);
            });
          }
          if(salesSummaryChipEl) salesSummaryChipEl.textContent = `${totalBooksSoldOnDate} livre(s) vendu(s)`;
        }, err => {
          console.error('Erreur Firestore (sales):', err);
          if(salesListEl) salesListEl.innerHTML = '<p style="padding:1rem;color:var(--ebay-red);text-align:center;">Erreur de chargement des ventes.</p>';
          if(salesSummaryChipEl) salesSummaryChipEl.textContent = 'Erreur';
        });
      }

      function cleanupSalesListener() {
        if (unsubscribeSales) {
          unsubscribeSales();
          unsubscribeSales = null;
        }
      }
     
      if (salesDateFilterBtnEl) {
          salesDateFilterBtnEl.addEventListener('click', () => {
              try {
                  salesDatePickerEl.showPicker(); 
              } catch (error) {
                  salesDatePickerEl.focus(); 
                  salesDatePickerEl.click(); 
                  console.warn("salesDatePickerEl.showPicker() non supporté ou a échoué, tentative de fallback.", error);
              }
          });
      }

      if (salesDatePickerEl) {
          salesDatePickerEl.addEventListener('change', (event) => {
              const newDate = new Date(event.target.value + 'T00:00:00'); 
              if (!isNaN(newDate.getTime())) { 
                  selectedSalesDate = newDate;
                  updateSelectedDateDisplay(selectedSalesDate);
                  setupSalesListener(selectedSalesDate);
              }
          });
      }

      function initializeSalesPage() {
          selectedSalesDate = new Date(); 
          updateSelectedDateDisplay(selectedSalesDate);
          if (auth.currentUser) {
              setupSalesListener(selectedSalesDate);
          } else {
              cleanupSalesListener();
              if(salesListEl) salesListEl.innerHTML = '<p style="padding:1rem;color:#555;text-align:center;">Veuillez vous connecter pour voir l\'historique.</p>';
              if(salesSummaryChipEl) salesSummaryChipEl.textContent = '0 livre(s) vendu(s)';
          }
      }
     
      window.addEventListener('hashchange', () => {
        if (location.hash === '#sales') {
          initializeSalesPage();
        } else {
          cleanupSalesListener();
        }
      });

      auth.onAuthStateChanged(user => {
        if (location.hash === '#sales') { 
            initializeSalesPage();
        }
      });

      if (location.hash === '#sales') {
        initializeSalesPage();
      }
    })();
  </script>
</main>

  <main id="cart" class="page">
    <header style="padding:1rem;">
        <button class="btn-page-back" data-hash="home" aria-label="Retour à l'accueil">
            <i class="bi bi-arrow-left"></i>
        </button>
        <h2>Panier</h2>
    </header>
    <div style="padding:1rem; text-align:center;">
      <p>Votre panier est actuellement vide.</p>
      </div>
  </main>

<main id="account" class="page">
  <style>
#account .profile-card {
  display: flex; align-items: center; gap: 1rem;
  background: #fff; border: 1px solid var(--border-color);
  border-radius: var(--border-radius-card); padding: 1rem; margin: 1rem; 
  max-width: none;  box-shadow: none; 
}
#account .profile-avatar {
  flex: 0 0 auto; margin: 0; 
  width: 64px; height: 64px; background: var(--ebay-blue);
  color: #fff; font-weight: bold; font-size: 2rem;
  border-radius: 50%; display: flex;
  align-items: center; justify-content: center;
}
#account .profile-info {
  display: flex; flex-direction: column;
  gap: 0.25rem; text-align: left;
}
#account h2 {  padding: 1rem; font-size: 1.3rem; font-weight: 600;  }
#account #display-name { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.25rem; }
#account #email, #account #member-since {
  font-size: 0.95rem; color: var(--secondary-text); margin-bottom: 0.5rem;
}
#account .section-title {
  padding: 0 1rem; margin: 1.5rem 0 0.75rem;
  font-size: 1.15rem; font-weight: 600; color: var(--primary-text);
}
#account .updates-grid {
  display: flex; gap: 0.75rem; padding: 0 1rem; flex-wrap: wrap; 
}
#account .update-card {
  flex: 1 1 calc(50% - 0.375rem); min-width: 150px; 
  display: flex; align-items: center; justify-content: space-between;
  background: #fff; border: 1px solid var(--border-color);
  border-radius: var(--border-radius-card); padding: 1rem; cursor: pointer;
  transition: background-color 0.2s ease; box-shadow:none;
}
#account .update-card:active { background-color: #f0f0f0; }
#account .update-card h4 { font-size: 1rem; margin: 0 0 0.25rem; font-weight: 500; }
#account .update-card p { font-size: 0.85rem; color: var(--secondary-text); margin: 0; }
#account .update-card i.bi-chevron-right { font-size: 1.2rem; color: var(--secondary-text); }

#account .menu-list { margin-top: 0.5rem; }
#account .menu-item {
  width: 100%; display: flex; align-items: center; justify-content: space-between;
  background: #fff; border: none; border-bottom: 1px solid #eee;
  padding: 0.85rem 1rem; cursor: pointer;
  transition: background-color 0.2s ease;
}
#account .menu-item:first-child { border-top: 1px solid #eee; }
#account .menu-item:active { background-color: #f0f0f0; }
#account .menu-item .item-content { display: flex; align-items: center; gap: 0.75rem; }
#account .menu-item .item-content i {
  font-size: 1.3rem; color: var(--accent);
  width: 24px; text-align: center;
}
#account .menu-item span { font-size: 1rem; font-weight: 500; color: var(--primary-text); }
#account .menu-item small {
  display: block; font-size: 0.8rem; color: var(--secondary-text);
  margin-top: 0.1rem; line-height: 1.2;
}
#account .menu-item .bi-chevron-right { font-size: 1rem; color: var(--secondary-text); }
#account .btn-signout {
  width: calc(100% - 2rem); margin: 1.5rem 1rem 1rem 1rem; 
  padding: 0.85rem 1.2rem; font-size: 1rem; font-weight: 500;
  border: 2px solid var(--ebay-red); border-radius: var(--border-radius-pill);
  background: #fff; color: var(--ebay-red); cursor: pointer;
  text-align: center; transition: background 0.2s, color 0.2s; box-shadow:none;
}
#account .btn-signout:active { background: var(--ebay-red); color: #fff; }
#account .updates-grid .update-card.full-width { flex: 1 1 100%; max-width: 100%; }
  </style>

  <header><h2>Mon compte</h2></header>
  <div> 
    <div class="profile-card">
      <div class="profile-avatar" id="avatar-letter">U</div>
      <div class="profile-info">
        <div id="display-name">Utilisateur</div>
        <div id="email">email@example.com</div>
        <div id="member-since">Membre depuis: …</div>
      </div>
    </div>

    <div class="section-title">Vos mises à jour</div>
    <div class="updates-grid">
      <div class="update-card" data-hash="stock-alerts"> <div> <h4>Alertes de stock</h4>
          <p>Livres bientôt épuisés</p>
        </div>
        <i class="bi bi-chevron-right"></i>
      </div>
      <div class="update-card full-width" data-hash="orders"> <div> <h4>Commandes récentes</h4>
          <p>Voir vos dernières commandes</p>
        </div>
        <i class="bi bi-chevron-right"></i>
      </div>
    </div>

    <div class="section-title">Gestion</div>
    <div class="menu-list">
      <button class="menu-item" data-hash="catalog"> <div class="item-content">
          <i class="bi bi-journal-richtext"></i> <div>
            <span>Catalogue des livres</span>
            <small>Voir et gérer vos livres</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
      <button class="menu-item" data-hash="suppliers"> <div class="item-content">
          <i class="bi bi-people-fill"></i> <div>
            <span>Fournisseurs</span>
            <small>Gérer vos fournisseurs</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
      <button class="menu-item" data-hash="reports"> <div class="item-content">
          <i class="bi bi-bar-chart-line-fill"></i> <div>
            <span>Rapports</span>
            <small>Statistiques & analyses</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
    <button class="btn-signout" id="btn-signout">Déconnexion</button>
  </div>

  <script>
    auth.onAuthStateChanged(user => {
      if (user) {
        const name = user.displayName || (user.email ? user.email.split('@')[0] : '') || "Utilisateur";
        document.getElementById('display-name').textContent = name;
        document.getElementById('email').textContent = user.email || 'Non fourni';
        if (user.metadata && user.metadata.creationTime) {
            const creationDate = new Date(user.metadata.creationTime);
            document.getElementById('member-since').textContent =
            'Membre depuis: ' + creationDate.toLocaleDateString(undefined, { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });
        } else {
            document.getElementById('member-since').textContent = 'Membre depuis: Date inconnue';
        }
        document.getElementById('avatar-letter').textContent = name[0] ? name[0].toUpperCase() : 'U';
      } else {
        document.getElementById('display-name').textContent = "Non connecté";
        document.getElementById('email').textContent = "";
        document.getElementById('member-since').textContent = "";
        document.getElementById('avatar-letter').textContent = "U";
      }
    });
    document.getElementById('btn-signout').addEventListener('click', () => {
      auth.signOut().then(() => {
        window.location.href = 'login.html'; 
      }).catch(error => {
        console.error("Sign out error", error);
        showGlobalToast("Erreur de déconnexion: " + error.message, true);
      });
    });
  </script>
</main>

<main id="catalog" class="page">
  <header id="catalog-main-header">
    <h2>Catalogue</h2>
  </header>
  <div class="catalog-content-wrapper">
    <section class="catalog-stats-overview">
      <h3>Aperçu du Catalogue</h3>
      <div class="stats-grid">
        <div class="stat-card">
          <i class="bi bi-journal-text stat-icon"></i>
          <div class="stat-value" id="stat-unique-titles">0</div>
          <div class="stat-label">Titres Uniques</div>
        </div>
        <div class="stat-card">
          <i class="bi bi-boxes stat-icon"></i>
          <div class="stat-value" id="stat-total-books-stock">0</div>
          <div class="stat-label">Livres en Stock</div>
        </div>
        <div class="stat-card">
          <i class="bi bi-cash-stack stat-icon value"></i>
          <div class="stat-value" id="stat-total-stock-value">XOF 0</div>
          <div class="stat-label">Valeur Stock (CMP)</div>
        </div>
        <div class="stat-card">
          <i class="bi bi-graph-up stat-icon"></i> <div class="stat-value" id="stat-avg-selling-price">XOF 0</div>
          <div class="stat-label">Prix Vente Moyen</div>
        </div>
        <div class="stat-card">
          <i class="bi bi-exclamation-triangle-fill stat-icon low-stock"></i>
          <div class="stat-value" id="stat-low-stock-items">0</div>
          <div class="stat-label">Articles à faible stock</div>
        </div>
      </div>
      <button id="btn-download-catalog-pdf" class="btn-primary full-width">
        <i class="bi bi-file-earmark-pdf-fill"></i> Télécharger l'Inventaire (PDF)
      </button>
    </section>

    <section class="catalog-actions-section">
        <h3>Gestion du Stock</h3>
         <button id="btn-view-stock-list" class="btn-primary full-width" data-hash="stock-list">
            <i class="bi bi-list-ul"></i> Consulter et Rechercher le Stock
        </button>
    </section>
  </div>

  <button id="btn-add-new-book-catalog" class="fab" aria-label="Ajouter un nouveau livre">
    <i class="bi bi-plus-lg"></i>
  </button>

  <script>
  // Catalog Page Script (Dashboard View)
  (function() {
    const catalogPageEl = document.getElementById('catalog');
    if (!catalogPageEl) return;

    // Stats elements
    const statUniqueTitlesEl = catalogPageEl.querySelector('#stat-unique-titles');
    const statTotalBooksStockEl = catalogPageEl.querySelector('#stat-total-books-stock');
    const statTotalStockValueEl = catalogPageEl.querySelector('#stat-total-stock-value');
    const statAvgSellingPriceEl = catalogPageEl.querySelector('#stat-avg-selling-price');
    const statLowStockItemsEl = catalogPageEl.querySelector('#stat-low-stock-items');
    const btnDownloadPdfEl = catalogPageEl.querySelector('#btn-download-catalog-pdf');
    const btnAddNewBookFabEl = catalogPageEl.querySelector('#btn-add-new-book-catalog');

    let allBooksCacheForStats = [];
    let unsubscribeCatalogStats = null;
    const LOW_STOCK_THRESHOLD = 5;

    auth.onAuthStateChanged(user => {
      if (user) {
        if (catalogPageEl.classList.contains('visible')) {
          setupCatalogStatsListener();
        }
      } else {
        cleanupCatalogStatsListener();
        if (catalogPageEl.classList.contains('visible')) {
          resetStats();
        }
      }
    });

    window.addEventListener('hashchange', () => {
      if (location.hash === '#catalog') {
        if (auth.currentUser) setupCatalogStatsListener();
        else resetStats();
      } else {
        cleanupCatalogStatsListener();
      }
    });

    if (location.hash === '#catalog') {
      if (auth.currentUser) setupCatalogStatsListener();
      else resetStats();
    }

    if (btnDownloadPdfEl) {
        btnDownloadPdfEl.addEventListener('click', () => {
            showGlobalToast("Fonctionnalité de téléchargement PDF en cours de développement.", false, 2500);
        });
    }

    if (btnAddNewBookFabEl) {
        btnAddNewBookFabEl.addEventListener('click', () => {
            if (typeof openGlobalAddBookModal === 'function') {
                sessionStorage.removeItem('targetBookInputRowId_newSupply');
                sessionStorage.removeItem('suggestedNewBookTitle_newSupply');
                openGlobalAddBookModal('');
            } else {
                showGlobalToast("Erreur: La fonction d'ajout de livre n'est pas disponible.", true);
            }
        });
    }

    function setupCatalogStatsListener() {
      if (unsubscribeCatalogStats) unsubscribeCatalogStats();
      if (!auth.currentUser) return;

      const userBooksRef = db.collection('users').doc(auth.currentUser.uid).collection('books');
      
      // Mettre les stats en mode chargement
      if(statUniqueTitlesEl) statUniqueTitlesEl.textContent = '...';
      if(statTotalBooksStockEl) statTotalBooksStockEl.textContent = '...';
      if(statTotalStockValueEl) statTotalStockValueEl.textContent = '...';
      if(statAvgSellingPriceEl) statAvgSellingPriceEl.textContent = '...';
      if(statLowStockItemsEl) statLowStockItemsEl.textContent = '...';

      unsubscribeCatalogStats = userBooksRef.onSnapshot(snapshot => {
        allBooksCacheForStats = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        updateCatalogStatsDisplay();
      }, err => {
        console.error('Erreur Firestore catalog/stats:', err);
        resetStats();
        if(statUniqueTitlesEl) statUniqueTitlesEl.textContent = 'Erreur';
      });
    }

    function cleanupCatalogStatsListener() {
      if (unsubscribeCatalogStats) {
        unsubscribeCatalogStats();
        unsubscribeCatalogStats = null;
      }
      allBooksCacheForStats = [];
      // Ne pas effacer les stats ici, elles pourraient être utiles si l'utilisateur revient rapidement
    }

    function resetStats() {
        if(statUniqueTitlesEl) statUniqueTitlesEl.textContent = '0';
        if(statTotalBooksStockEl) statTotalBooksStockEl.textContent = '0';
        if(statTotalStockValueEl) statTotalStockValueEl.textContent = 'XOF 0';
        if(statAvgSellingPriceEl) statAvgSellingPriceEl.textContent = 'XOF 0';
        if(statLowStockItemsEl) statLowStockItemsEl.textContent = '0';
    }

    function updateCatalogStatsDisplay() {
      if (!allBooksCacheForStats.length && !auth.currentUser) { // S'assurer que l'utilisateur est connecté avant de remettre à zéro
        resetStats();
        return;
      }
      if (!allBooksCacheForStats.length && auth.currentUser) { // Utilisateur connecté mais pas de livres
         if(statUniqueTitlesEl) statUniqueTitlesEl.textContent = '0';
         if(statTotalBooksStockEl) statTotalBooksStockEl.textContent = '0';
         if(statTotalStockValueEl) statTotalStockValueEl.textContent = 'XOF 0';
         if(statAvgSellingPriceEl) statAvgSellingPriceEl.textContent = 'XOF 0';
         if(statLowStockItemsEl) statLowStockItemsEl.textContent = '0';
         return;
      }


      const uniqueTitles = allBooksCacheForStats.length;
      const totalBooksInStock = allBooksCacheForStats.reduce((sum, book) => sum + (book.quantity || 0), 0);
      const totalStockValue = allBooksCacheForStats.reduce((sum, book) => {
        const cost = book.averageCost !== undefined ? book.averageCost : (book.lastPurchasePrice || 0);
        return sum + (cost * (book.quantity || 0));
      }, 0);

      let totalSellingPriceSum = 0;
      let booksWithPriceCount = 0;
      allBooksCacheForStats.forEach(book => {
        if (typeof book.price === 'number' && book.quantity > 0) {
          totalSellingPriceSum += book.price * book.quantity;
          booksWithPriceCount += book.quantity;
        }
      });
      const avgSellingPrice = booksWithPriceCount > 0 ? totalSellingPriceSum / booksWithPriceCount : 0;
      const lowStockItems = allBooksCacheForStats.filter(book => book.quantity > 0 && book.quantity <= LOW_STOCK_THRESHOLD).length;

      if(statUniqueTitlesEl) statUniqueTitlesEl.textContent = uniqueTitles.toLocaleString();
      if(statTotalBooksStockEl) statTotalBooksStockEl.textContent = totalBooksInStock.toLocaleString();
      if(statTotalStockValueEl) statTotalStockValueEl.textContent = totalStockValue.toLocaleString('fr-FR', { style: 'currency', currency: 'XOF', minimumFractionDigits: 0 });
      if(statAvgSellingPriceEl) statAvgSellingPriceEl.textContent = avgSellingPrice.toLocaleString('fr-FR', { style: 'currency', currency: 'XOF', minimumFractionDigits: 0 });
      if(statLowStockItemsEl) statLowStockItemsEl.textContent = lowStockItems.toLocaleString();
    }
  })();
  </script>
</main>

<main id="stock-list" class="page">
    <header id="stock-list-header">
        <button class="btn-page-back" data-hash="catalog" aria-label="Retour au Catalogue">
            <i class="bi bi-arrow-left"></i>
        </button>
        <h2>Mon Stock</h2>
        <button id="btn-open-stock-sort-drawer" aria-label="Trier le stock">
            <i class="bi bi-funnel-fill"></i> Trier
        </button>
    </header>
    <div class="stock-list-search-bar-container">
        <div class="search-wrapper">
            <i class="bi bi-search"></i>
            <input type="search" id="search-input-stock-list" placeholder="Rechercher dans le stock..." aria-label="Recherche stock" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
        </div>
    </div>
    <div id="stock-list-results-container" class="books-list">
        </div>

    <div class="drawer-overlay" id="stock-sort-drawer-overlay"></div>
    <div class="catalog-sort-drawer" id="stock-sort-drawer-content"> <div class="drawer-header">
            <h4>Trier le Stock</h4>
            <button id="btn-close-stock-sort-drawer" class="close-drawer-btn" aria-label="Fermer le tiroir de tri"><i class="bi bi-x-lg"></i></button>
        </div>
        <div class="drawer-body">
            <div class="filter-group">
                <span class="filter-group-title"><i class="bi bi-sort-alpha-down"></i> Options de Tri</span>
                <div class="sort-options-list" id="stock-sort-options-container">
                    <div class="sort-option">
                        <input type="radio" id="stock-sort-title-asc" name="stock_sort" value="title_asc" checked>
                        <label for="stock-sort-title-asc">Titre (A-Z)</label>
                    </div>
                    <div class="sort-option">
                        <input type="radio" id="stock-sort-title-desc" name="stock_sort" value="title_desc">
                        <label for="stock-sort-title-desc">Titre (Z-A)</label>
                    </div>
                    <div class="sort-option">
                        <input type="radio" id="stock-sort-quantity-asc" name="stock_sort" value="quantity_asc">
                        <label for="stock-sort-quantity-asc">Stock (Croissant)</label>
                    </div>
                    <div class="sort-option">
                        <input type="radio" id="stock-sort-quantity-desc" name="stock_sort" value="quantity_desc">
                        <label for="stock-sort-quantity-desc">Stock (Décroissant)</label>
                    </div>
                    <div class="sort-option">
                        <input type="radio" id="stock-sort-price-asc" name="stock_sort" value="price_asc">
                        <label for="stock-sort-price-asc">Prix Vente (Croissant)</label>
                    </div>
                    <div class="sort-option">
                        <input type="radio" id="stock-sort-price-desc" name="stock_sort" value="price_desc">
                        <label for="stock-sort-price-desc">Prix Vente (Décroissant)</label>
                    </div>
                    <div class="sort-option">
                        <input type="radio" id="stock-sort-date-desc" name="stock_sort" value="date_desc">
                        <label for="stock-sort-date-desc">Date Ajout (Plus récent)</label>
                    </div>
                    <div class="sort-option">
                        <input type="radio" id="stock-sort-date-asc" name="stock_sort" value="date_asc">
                        <label for="stock-sort-date-asc">Date Ajout (Plus ancien)</label>
                    </div>
                </div>
            </div>
        </div>
        <div class="drawer-footer">
            <button id="btn-apply-stock-sort" class="btn-apply-sort full-width"><i class="bi bi-check-circle-fill"></i>Appliquer le Tri</button>
        </div>
    </div>

    <script>
    // Stock List Page Script
    (function() {
        const stockListPageEl = document.getElementById('stock-list');
        if (!stockListPageEl) return;

        const booksListContainerEl = stockListPageEl.querySelector('#stock-list-results-container');
        const searchInputStockEl = stockListPageEl.querySelector('#search-input-stock-list');

        // Drawer elements for stock list sort
        const btnOpenStockSortDrawerEl = stockListPageEl.querySelector('#btn-open-stock-sort-drawer');
        const btnCloseStockSortDrawerEl = stockListPageEl.querySelector('#btn-close-stock-sort-drawer');
        const stockSortDrawerOverlayEl = stockListPageEl.querySelector('#stock-sort-drawer-overlay');
        const stockSortDrawerContentEl = stockListPageEl.querySelector('#stock-sort-drawer-content');
        const btnApplyStockSortEl = stockListPageEl.querySelector('#btn-apply-stock-sort');
        const stockSortOptionsContainerEl = stockListPageEl.querySelector('#stock-sort-options-container');

        let allBooksForStockListCache = [];
        let unsubscribeStockList = null;
        let currentStockSortCriteria = { field: 'title', direction: 'asc' };
        const LOW_STOCK_THRESHOLD_STOCK_PAGE = 5;

        auth.onAuthStateChanged(user => {
            if (user) {
                if (stockListPageEl.classList.contains('visible')) {
                    setupStockListListener();
                }
            } else {
                cleanupStockListListener();
                if (stockListPageEl.classList.contains('visible') && booksListContainerEl) {
                    booksListContainerEl.innerHTML = '<p class="stock-list-no-results-message">Veuillez vous connecter pour voir le stock.</p>';
                }
            }
        });

        window.addEventListener('hashchange', () => {
            if (location.hash === '#stock-list') {
                if (auth.currentUser) setupStockListListener();
                else if (booksListContainerEl) booksListContainerEl.innerHTML = '<p class="stock-list-no-results-message">Veuillez vous connecter pour voir le stock.</p>';
            } else {
                cleanupStockListListener();
            }
        });

        if (location.hash === '#stock-list') {
            if (auth.currentUser) setupStockListListener();
             else if (booksListContainerEl) booksListContainerEl.innerHTML = '<p class="stock-list-no-results-message">Veuillez vous connecter pour voir le stock.</p>';
        }

        if (searchInputStockEl) {
            searchInputStockEl.addEventListener('input', () => renderStockBooks(searchInputStockEl.value.trim().toLowerCase()));
        }

        // Stock Sort Drawer Logic
        if (btnOpenStockSortDrawerEl) btnOpenStockSortDrawerEl.addEventListener('click', () => toggleStockSortDrawer(true));
        if (btnCloseStockSortDrawerEl) btnCloseStockSortDrawerEl.addEventListener('click', () => toggleStockSortDrawer(false));
        if (stockSortDrawerOverlayEl) stockSortDrawerOverlayEl.addEventListener('click', () => toggleStockSortDrawer(false));
        
        if (btnApplyStockSortEl) {
            btnApplyStockSortEl.addEventListener('click', () => {
                const selectedSortInput = stockSortOptionsContainerEl.querySelector('input[name="stock_sort"]:checked');
                if (selectedSortInput) {
                    const [field, direction] = selectedSortInput.value.split('_');
                    currentStockSortCriteria = { field, direction };
                    renderStockBooks(searchInputStockEl.value.trim().toLowerCase());
                }
                toggleStockSortDrawer(false);
            });
        }

        function setupStockListListener() {
            if (unsubscribeStockList) unsubscribeStockList();
            if (!auth.currentUser || !booksListContainerEl) return;

            const userBooksRef = db.collection('users').doc(auth.currentUser.uid).collection('books');
            showStockListLoadingSkeletons();

            unsubscribeStockList = userBooksRef.onSnapshot(snapshot => {
                allBooksForStockListCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderStockBooks(searchInputStockEl.value.trim().toLowerCase());
            }, err => {
                console.error('Erreur Firestore stock-list/books:', err);
                if (booksListContainerEl) booksListContainerEl.innerHTML = '<p class="stock-list-no-results-message" style="color:var(--ebay-red);">Erreur de chargement du stock.</p>';
            });
        }

        function cleanupStockListListener() {
            if (unsubscribeStockList) {
                unsubscribeStockList();
                unsubscribeStockList = null;
            }
            allBooksForStockListCache = [];
            if (booksListContainerEl) booksListContainerEl.innerHTML = '';
            if(searchInputStockEl) searchInputStockEl.value = '';
        }

        function showStockListLoadingSkeletons() {
            if (!booksListContainerEl) return;
            booksListContainerEl.innerHTML = Array(5).fill('').map(() => `
                <div class="skeleton-book-card-catalog"></div>
            `).join('');
        }

        function sortStockBooks(books) {
            const { field, direction } = currentStockSortCriteria;
            return [...books].sort((a, b) => {
                let valA, valB;
                if (field === 'title') {
                    valA = (a.title || '').toLowerCase();
                    valB = (b.title || '').toLowerCase();
                } else if (field === 'quantity') {
                    valA = a.quantity || 0;
                    valB = b.quantity || 0;
                } else if (field === 'price') {
                    valA = a.price || 0;
                    valB = b.price || 0;
                } else if (field === 'date') {
                    valA = a.createdAt?.toMillis() || 0;
                    valB = b.createdAt?.toMillis() || 0;
                } else {
                    return 0;
                }
                if (valA < valB) return direction === 'asc' ? -1 : 1;
                if (valA > valB) return direction === 'asc' ? 1 : -1;
                return 0;
            });
        }

        function renderStockBooks(searchTerm = '') {
            if (!booksListContainerEl) return;
            booksListContainerEl.innerHTML = '';

            const filteredUnsorted = searchTerm
                ? allBooksForStockListCache.filter(book =>
                    (book.title && book.title.toLowerCase().includes(searchTerm)) ||
                    (book.author && book.author.toLowerCase().includes(searchTerm))
                  )
                : allBooksForStockListCache;

            const sortedBooks = sortStockBooks(filteredUnsorted);

            if (sortedBooks.length === 0) {
                if (searchTerm) {
                    booksListContainerEl.innerHTML = `<p class="stock-list-no-results-message">Aucun livre ne correspond à "${searchTerm}".</p>`;
                } else {
                    booksListContainerEl.innerHTML = '<p class="stock-list-no-results-message">Votre stock est vide.</p>';
                }
                return;
            }

            sortedBooks.forEach(book => {
                const card = document.createElement('div');
                card.className = 'book-card-catalog'; // Réutilisation du style
                card.dataset.bookId = book.id;

                const formattedPriceSell = (book.price || 0).toLocaleString('fr-FR', { style: 'currency', currency: 'XOF', minimumFractionDigits: 0 });
                const formattedLastPurchasePrice = (book.lastPurchasePrice || 0).toLocaleString('fr-FR', { style: 'currency', currency: 'XOF', minimumFractionDigits: 0 });
                const averageCost = book.averageCost !== undefined ? book.averageCost : (book.lastPurchasePrice || 0);
                const formattedAverageCost = averageCost.toLocaleString('fr-FR', { style: 'currency', currency: 'XOF', minimumFractionDigits: 0 });

                let stockClass = 'stock-normal';
                if (book.quantity <= 0) stockClass = 'stock-out';
                else if (book.quantity <= LOW_STOCK_THRESHOLD_STOCK_PAGE) stockClass = 'stock-low';

                card.innerHTML = `
                    <div class="book-card-image-area">
                        <i class="bi bi-book book-placeholder-icon"></i>
                    </div>
                    <div class="book-card-content-area">
                        <div class="book-card-main-info">
                            <h4 class="book-title">${book.title || 'Titre inconnu'}</h4>
                            <p class="book-author"><i class="bi bi-person"></i> <span>${book.author || 'Auteur inconnu'}</span></p>
                            <p class="book-price-sell"><i class="bi bi-tag-fill"></i> Prix Vente: <span>${formattedPriceSell}</span></p>
                            <p class="book-quantity-stock"><i class="bi bi-box-seam"></i> Stock: <span class="stock-value ${stockClass}">${book.quantity || 0}</span></p>
                        </div>
                        <div class="book-card-secondary-info">
                            <p class="book-price-purchase"><i class="bi bi-cart-check"></i> Dernier Coût: <span>${formattedLastPurchasePrice}</span></p>
                            <p class="book-average-cost"><i class="bi bi-calculator"></i> Coût Moyen P.: <span>${formattedAverageCost}</span></p>
                        </div>
                        <div class="book-card-actions">
                            <button class="btn-action-icon btn-view-details-stock" data-book-id="${book.id}" aria-label="Voir détails" title="Voir détails"><i class="bi bi-eye-fill"></i></button>
                            <button class="btn-action-icon btn-edit-book-stock" data-book-id="${book.id}" aria-label="Modifier" title="Modifier"><i class="bi bi-pencil-fill"></i></button>
                            <button class="btn-action-icon btn-delete-book btn-delete-book-stock" data-book-id="${book.id}" aria-label="Supprimer" title="Supprimer"><i class="bi bi-trash3-fill"></i></button>
                        </div>
                    </div>
                `;
                booksListContainerEl.appendChild(card);
            });

            stockListPageEl.querySelectorAll('.btn-view-details-stock, .btn-edit-book-stock, .btn-delete-book-stock').forEach(btn => 
                btn.addEventListener('click', handleStockBookAction)
            );
        }

        function handleStockBookAction(e) {
            const button = e.currentTarget;
            const bookId = button.dataset.bookId;
            const action = button.classList.contains('btn-view-details-stock') ? 'view' :
                           button.classList.contains('btn-edit-book-stock') ? 'edit' : 'delete';

            showGlobalToast(`Action "${action}" pour livre ID: ${bookId} (à implémenter).`, false);
            // Implémenter la logique pour chaque action (ex: ouvrir modale d'édition, confirmation de suppression)
        }

        function toggleStockSortDrawer(show) {
            if (!stockSortDrawerContentEl || !stockSortDrawerOverlayEl) return;
            if (show) {
                const currentSortInput = stockSortDrawerContentEl.querySelector(`input[name="stock_sort"][value="${currentStockSortCriteria.field}_${currentStockSortCriteria.direction}"]`);
                if (currentSortInput) currentSortInput.checked = true;
                stockSortDrawerContentEl.classList.add('visible');
                stockSortDrawerOverlayEl.classList.add('visible');
                document.body.style.overflow = 'hidden';
            } else {
                stockSortDrawerContentEl.classList.remove('visible');
                stockSortDrawerOverlayEl.classList.remove('visible');
                document.body.style.overflow = '';
            }
        }
    })();
    </script>
</main>


<main id="reports" class="page">
  <header id="reports-header" style="padding: 1rem;"> <button class="btn-page-back" data-hash="home" aria-label="Retour à l'accueil">
      <i class="bi bi-arrow-left"></i>
    </button>
    <h2>Rapports & Analyses</h2>
  </header>
  <div class="reports-active-filter-summary-bar">
    <span id="active-filters-display">Période: 30 derniers jours</span>
    <button id="btn-open-reports-filters">
      <i class="bi bi-funnel-fill"></i> Filtres
    </button>
  </div>
  <div class="reports-content-scrollable">
    <div class="reports-data-area" id="reports-data-summary">
      <div class="kpi-grid">
        <div class="kpi-card">
          <i class="bi bi-cash-coin kpi-icon revenue"></i>
          <div class="kpi-value revenue" id="kpi-total-revenue">XOF 0</div>
          <div class="kpi-label">Chiffre d'Affaires</div>
        </div>
        <div class="kpi-card">
          <i class="bi bi-cart-x-fill kpi-icon cogs"></i>
          <div class="kpi-value cogs" id="kpi-total-cogs">XOF 0</div>
          <div class="kpi-label">Coût Marchandises</div>
        </div>
        <div class="kpi-card">
          <i class="bi bi-graph-up-arrow kpi-icon profit"></i>
          <div class="kpi-value profit" id="kpi-total-profit">XOF 0</div>
          <div class="kpi-label">Profit Brut</div>
        </div>
        <div class="kpi-card">
          <i class="bi bi-receipt-cutoff kpi-icon sales-count"></i>
          <div class="kpi-value" id="kpi-total-sales-count">0</div>
          <div class="kpi-label">Nombre de Ventes</div>
        </div>
        <div class="kpi-card">
          <i class="bi bi-box2-fill kpi-icon items-sold"></i>
          <div class="kpi-value" id="kpi-total-items-sold">0</div>
          <div class="kpi-label">Articles Vendus</div>
        </div>
        <div class="kpi-card">
          <i class="bi bi-percent kpi-icon profit-margin"></i>
          <div class="kpi-value" id="kpi-avg-profit-margin">0%</div>
          <div class="kpi-label">Marge Brute Moy.</div>
        </div>
      </div>
    </div>
    <div class="report-type-placeholder" id="reports-data-placeholder" style="display:none;">
      <p>Ce type de rapport sera bientôt disponible.</p>
    </div>
  </div>

  <div class="drawer-overlay" id="reports-filter-overlay"></div>
  <div class="report-filter-drawer" id="report-filter-drawer-content">
    <div class="drawer-header">
      <h4>Filtres des Rapports</h4>
      <button id="btn-close-reports-filters" class="close-drawer-btn"><i class="bi bi-x-lg"></i></button>
    </div>
    <div class="drawer-body">
      <div class="filter-group">
        <span class="filter-group-title"><i class="bi bi-calendar-range-fill"></i> Période</span>
        <div class="filter-options">
          <select id="reports-period-selector">
            <option value="today">Aujourd'hui</option>
            <option value="yesterday">Hier</option>
            <option value="last7days">7 derniers jours</option>
            <option value="last30days" selected>30 derniers jours</option>
            <option value="thisMonth">Ce mois-ci</option>
            <option value="lastMonth">Mois dernier</option>
            <option value="custom">Personnalisée</option>
          </select>
        </div>
        <div class="custom-date-range-inputs" id="custom-date-inputs-reports">
            <div class="custom-date-inputs-wrapper">
                <div>
                    <label for="reports-date-start">Date de début</label>
                    <input type="date" id="reports-date-start">
                </div>
                <div>
                    <label for="reports-date-end">Date de fin</label>
                    <input type="date" id="reports-date-end">
                </div>
            </div>
        </div>
      </div>
      <div class="filter-group">
        <span class="filter-group-title"><i class="bi bi-file-earmark-text-fill"></i> Type de Rapport</span>
        <div class="filter-options">
          <select id="reports-type-selector">
            <option value="summary" selected>Synthèse Globale</option>
            <option value="sales_detail" disabled>Détail des Ventes (Bientôt)</option>
            <option value="product_performance" disabled>Performance Produits (Bientôt)</option>
            <option value="inventory_status" disabled>État des Stocks (Bientôt)</option>
          </select>
        </div>
      </div>
    </div>
    <div class="drawer-footer">
        <button id="btn-apply-drawer-filters" class="btn-apply-filter full-width"><i class="bi bi-check-circle-fill"></i>Appliquer les Filtres</button>
    </div>
  </div>

  <script>
  (function() {
    const reportsPage = document.getElementById('reports');
    if (!reportsPage) return;

    const kpiTotalRevenueEl = document.getElementById('kpi-total-revenue');
    const kpiTotalCogsEl = document.getElementById('kpi-total-cogs');
    const kpiTotalProfitEl = document.getElementById('kpi-total-profit');
    const kpiTotalSalesCountEl = document.getElementById('kpi-total-sales-count');
    const kpiTotalItemsSoldEl = document.getElementById('kpi-total-items-sold');
    const kpiAvgProfitMarginEl = document.getElementById('kpi-avg-profit-margin');
   
    const periodSelectorEl = document.getElementById('reports-period-selector');
    const reportTypeSelectorEl = document.getElementById('reports-type-selector');
    const customDateInputsEl = document.getElementById('custom-date-inputs-reports');
    const dateStartInputEl = document.getElementById('reports-date-start');
    const dateEndInputEl = document.getElementById('reports-date-end');
   
    const reportsDataSummaryEl = document.getElementById('reports-data-summary');
    const reportsDataPlaceholderEl = document.getElementById('reports-data-placeholder');

    const btnOpenFiltersEl = document.getElementById('btn-open-reports-filters');
    const btnCloseFiltersEl = document.getElementById('btn-close-reports-filters');
    const filterDrawerEl = document.getElementById('report-filter-drawer-content');
    const filterOverlayEl = document.getElementById('reports-filter-overlay');
    const btnApplyDrawerFiltersEl = document.getElementById('btn-apply-drawer-filters');
    const activeFiltersDisplayEl = document.getElementById('active-filters-display');

    let allBooksDataCache = {}; // Pas utilisé dans cette version simplifiée, mais utile pour des rapports plus complexes
    let currentStartDate, currentEndDate;
    let tempPeriodSettings = {};

    function toggleFilterDrawer(show) {
        if (show) {
            tempPeriodSettings.period = periodSelectorEl.value;
            tempPeriodSettings.startDate = dateStartInputEl.value;
            tempPeriodSettings.endDate = dateEndInputEl.value;
            tempPeriodSettings.reportType = reportTypeSelectorEl.value;
            filterDrawerEl.classList.add('visible');
            filterOverlayEl.classList.add('visible');
            document.body.style.overflow = 'hidden';
        } else {
            filterDrawerEl.classList.remove('visible');
            filterOverlayEl.classList.remove('visible');
            document.body.style.overflow = '';
        }
    }

    if(btnOpenFiltersEl) btnOpenFiltersEl.addEventListener('click', () => toggleFilterDrawer(true));
    if(btnCloseFiltersEl) btnCloseFiltersEl.addEventListener('click', () => {
        periodSelectorEl.value = tempPeriodSettings.period || 'last30days';
        dateStartInputEl.value = tempPeriodSettings.startDate || '';
        dateEndInputEl.value = tempPeriodSettings.endDate || '';
        reportTypeSelectorEl.value = tempPeriodSettings.reportType || 'summary';
        if (periodSelectorEl.value === 'custom') {
            customDateInputsEl.classList.add('visible');
        } else {
            customDateInputsEl.classList.remove('visible');
        }
        toggleFilterDrawer(false);
    });
    if(filterOverlayEl) filterOverlayEl.addEventListener('click', () => {
        if (btnCloseFiltersEl) btnCloseFiltersEl.click();
    });
   
    function showKpiMessage(type, message = "") {
        const kpiElements = [
            kpiTotalRevenueEl, kpiTotalCogsEl, kpiTotalProfitEl,
            kpiTotalSalesCountEl, kpiTotalItemsSoldEl, kpiAvgProfitMarginEl
        ];
        const defaultValues = ['XOF 0', 'XOF 0', 'XOF 0', '0', '0', '0%'];

        if (type === 'loading') {
            kpiElements.forEach(el => { if(el) el.textContent = 'Chargement...'; });
        } else if (type === 'error') {
            const errorMsg = message || "Erreur";
            kpiElements.forEach(el => { if(el) el.textContent = errorMsg; });
        } else if (type === 'noData') {
            kpiElements.forEach((el, index) => { if(el) el.textContent = defaultValues[index]; });
            if (message && kpiTotalRevenueEl) kpiTotalRevenueEl.textContent = message; // Afficher un message spécifique si fourni
        }
    }
   
    function setDateRange(updateDisplayOnly = false) {
        const selectedPeriod = periodSelectorEl.value;
        const today = new Date();
        let startDate = new Date(today);
        let endDate = new Date(today);
        let displayPeriodText = periodSelectorEl.options[periodSelectorEl.selectedIndex].text;

        if (selectedPeriod === 'custom') {
            customDateInputsEl.classList.add('visible');
        } else {
            customDateInputsEl.classList.remove('visible');
        }

        switch (selectedPeriod) {
            case 'today': break;
            case 'yesterday':
                startDate.setDate(today.getDate() - 1);
                endDate.setDate(today.getDate() - 1);
                break;
            case 'last7days': startDate.setDate(today.getDate() - 6); break;
            case 'last30days': startDate.setDate(today.getDate() - 29); break;
            case 'thisMonth': startDate = new Date(today.getFullYear(), today.getMonth(), 1); break;
            case 'lastMonth':
                endDate = new Date(today.getFullYear(), today.getMonth(), 0);
                startDate = new Date(endDate.getFullYear(), endDate.getMonth(), 1);
                break;
            case 'custom':
                const storedStart = dateStartInputEl.value;
                const storedEnd = dateEndInputEl.value;
                if (storedStart && storedEnd) {
                    startDate = new Date(storedStart + 'T00:00:00'); // Assurer l'interprétation locale
                    endDate = new Date(storedEnd + 'T23:59:59');    // Assurer l'interprétation locale
                    if (startDate > endDate) { // Si la date de début est après la date de fin
                        endDate = new Date(startDate); // Mettre la date de fin égale à la date de début
                        endDate.setHours(23,59,59,999);
                        dateEndInputEl.valueAsDate = endDate; // Mettre à jour l'input
                    }
                    const formatDate = (d) => `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
                    displayPeriodText = `Du ${formatDate(startDate)} au ${formatDate(endDate)}`;
                } else { // Valeurs par défaut si les champs custom sont vides
                    dateEndInputEl.valueAsDate = today;
                    const thirtyDaysAgo = new Date(today);
                    thirtyDaysAgo.setDate(today.getDate() - 29);
                    dateStartInputEl.valueAsDate = thirtyDaysAgo;
                    startDate = thirtyDaysAgo;
                    endDate = today;
                    displayPeriodText = "Personnalisée (30j par défaut)";
                }
                break;
        }

        if (selectedPeriod !== 'custom') { // Mettre à jour les inputs de date si pas 'custom'
            const yearStart = startDate.getFullYear();
            const monthStart = String(startDate.getMonth() + 1).padStart(2, '0');
            const dayStart = String(startDate.getDate()).padStart(2, '0');
            dateStartInputEl.value = `${yearStart}-${monthStart}-${dayStart}`;

            const yearEnd = endDate.getFullYear();
            const monthEnd = String(endDate.getMonth() + 1).padStart(2, '0');
            const dayEnd = String(endDate.getDate()).padStart(2, '0');
            dateEndInputEl.value = `${yearEnd}-${monthEnd}-${dayEnd}`;
        }
       
        startDate.setHours(0, 0, 0, 0);
        endDate.setHours(23, 59, 59, 999);
       
        currentStartDate = startDate;
        currentEndDate = endDate;

        if (updateDisplayOnly && activeFiltersDisplayEl) {
            activeFiltersDisplayEl.textContent = `Période: ${displayPeriodText}`;
        }
    }

    async function loadReportData() {
        if (!auth.currentUser) {
            showKpiMessage('error', "Non connecté.");
            return;
        }
        showKpiMessage('loading');
        // await fetchAllBooksDetails(); // Pas directement utilisé pour les KPIs agrégés pour l'instant

        if (!currentStartDate || !currentEndDate) {
            showKpiMessage('error', "Période invalide.");
            return;
        }
       
        try {
            const salesQuery = db.collection('users').doc(auth.currentUser.uid).collection('sales')
                .where('timestamp', '>=', firebase.firestore.Timestamp.fromDate(currentStartDate))
                .where('timestamp', '<=', firebase.firestore.Timestamp.fromDate(currentEndDate));
                // Pas besoin de .orderBy('timestamp', 'asc') pour l'agrégation
            const salesSnapshot = await salesQuery.get();

            let totalRevenue = 0;
            let totalCogs = 0; // COGS total pour la période
            let totalSalesCount = salesSnapshot.size;
            let totalItemsSoldCount = 0;

            if (salesSnapshot.empty) {
                showKpiMessage('noData', 'Aucune vente sur cette période.');
                return;
            }

            salesSnapshot.forEach(doc => {
                const sale = doc.data();
                totalRevenue += sale.grandTotalAmount || 0;
                totalItemsSoldCount += sale.totalItemsSold || 0;
                // Utiliser le totalCostOfGoodsSold stocké dans chaque vente
                totalCogs += sale.totalCostOfGoodsSold || 0;
            });

            const totalProfit = totalRevenue - totalCogs;
            const avgProfitMargin = totalRevenue > 0 ? (totalProfit / totalRevenue) * 100 : 0;

            if(kpiTotalRevenueEl) kpiTotalRevenueEl.textContent = totalRevenue.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
            if(kpiTotalCogsEl) kpiTotalCogsEl.textContent = totalCogs.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
            if(kpiTotalProfitEl) kpiTotalProfitEl.textContent = totalProfit.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
            if(kpiTotalSalesCountEl) kpiTotalSalesCountEl.textContent = totalSalesCount.toLocaleString();
            if(kpiTotalItemsSoldEl) kpiTotalItemsSoldEl.textContent = totalItemsSoldCount.toLocaleString();
            if(kpiAvgProfitMarginEl) kpiAvgProfitMarginEl.textContent = avgProfitMargin.toFixed(1) + '%';

        } catch (error) {
            console.error("Erreur chargement rapport:", error);
            showKpiMessage('error', "Erreur chargement données.");
        }
    }

    function applyFiltersAndLoadData() {
        setDateRange(true); // Mettre à jour les dates et l'affichage du filtre actif
        const selectedType = reportTypeSelectorEl.value;
        if (selectedType === 'summary') {
            reportsDataSummaryEl.style.display = 'block'; // ou 'flex' si .kpi-grid l'exige
            reportsDataPlaceholderEl.style.display = 'none';
            loadReportData();
        } else {
            reportsDataSummaryEl.style.display = 'none';
            reportsDataPlaceholderEl.style.display = 'block';
             // Vous pouvez ajouter un message spécifique dans le placeholder ici
            reportsDataPlaceholderEl.innerHTML = `<p>Le rapport "${reportTypeSelectorEl.options[reportTypeSelectorEl.selectedIndex].text}" sera bientôt disponible.</p>`;
        }
        toggleFilterDrawer(false); // Fermer le tiroir
    }
   
    if(btnApplyDrawerFiltersEl) btnApplyDrawerFiltersEl.addEventListener('click', applyFiltersAndLoadData);
    if(periodSelectorEl) periodSelectorEl.addEventListener('change', () => setDateRange(false)); // Juste mettre à jour les dates, ne pas charger
   
    if(reportTypeSelectorEl) reportTypeSelectorEl.addEventListener('change', () => {
        // Pas besoin de recharger les données ici, se fera à l'application des filtres
        const selectedType = reportTypeSelectorEl.value;
        if (selectedType !== 'summary') {
            // reportsDataSummaryEl.style.display = 'none'; // Géré par applyFiltersAndLoadData
            // reportsDataPlaceholderEl.style.display = 'block';
        } else {
            // reportsDataSummaryEl.style.display = 'block';
            // reportsDataPlaceholderEl.style.display = 'none';
        }
    });

    function initializeReportsPage() {
        if (auth.currentUser) {
            // setDateRange(true); // Assurer que les dates sont initialisées
            applyFiltersAndLoadData(); // Charger les données avec les filtres par défaut
        } else {
            showKpiMessage('error', "Non connecté.");
            if(activeFiltersDisplayEl) activeFiltersDisplayEl.textContent = "Non connecté";
        }
    }
   
    window.addEventListener('hashchange', () => {
        if (location.hash === '#reports') {
            initializeReportsPage();
        }
    });

    auth.onAuthStateChanged(user => {
        if (location.hash === '#reports') { // Seulement si on est sur la page des rapports
            initializeReportsPage();
        }
    });

    // Initialisation si la page est chargée directement sur #reports
    if (location.hash === '#reports') {
        initializeReportsPage();
    } else {
        // Assurer que les dates sont prêtes même si la page n'est pas active initialement
        setDateRange(false); 
    }

  })();
  </script>
</main>

<main id="activation" class="page">
  <style>
main#activation.page {
  display: none;  padding: 1.5rem; flex-direction: column; 
  align-items: center; justify-content: center; text-align: center;
  height: 100vh; box-sizing: border-box;
}
main#activation.visible { display: flex; }
.activation-container {
  width: 100%; max-width: 360px;  padding: 1rem; 
  background: #fff; border-radius: var(--border-radius-card);
  border: 1px solid var(--border-color); box-shadow: none; 
}
.activation-icon {
  width: 70px; height: 70px; margin: 0 auto 1.25rem; 
  border-radius: 50%; background: rgba(0, 200, 150, 0.1); 
  display: flex; align-items: center; justify-content: center;
}
.activation-icon i { font-size: 1.8rem; color: #00bfa5;  }
main#activation h3 { font-size: 1.3rem; margin-bottom: 0.75rem; font-weight: 600; }
main#activation p {
  color: var(--secondary-text); margin-bottom: 1.25rem; 
  line-height: 1.5; font-size: 0.95rem;
}
.activation-input {
  width: 100%; padding: 0.85rem 1rem; font-size: 1rem; 
  border: 1px solid #ccc; border-radius: var(--border-radius-card); 
  margin-bottom: 1rem; outline: none; text-align: center; 
  letter-spacing: 0.1em; transition: border-color 0.2s ease; box-shadow:none;
}
.activation-input:focus { border-color: var(--accent); }
.activation-btn {
  width: 100%; padding: 0.85rem; font-size: 1rem; font-weight: 600;
  margin-top: 0.5rem; background: var(--accent); color: #fff;
  border: none; border-radius: var(--border-radius-pill); cursor: pointer; box-shadow:none;
}
.activation-btn:active { background: #014fa5; }
.activation-btn:disabled { background: #bfc8d7; cursor: not-allowed; }
</style>

  <div class="activation-container">
    <div class="activation-icon">
      <i class="bi bi-shield-lock-fill"></i> </div>
    <h3>Activation du compte</h3>
    <p>Entrez votre code d’activation reçu pour finaliser l’inscription et accéder à l'application.</p>
    <input
      type="text"
      id="activation-code"
      placeholder="Code d’activation"
      class="activation-input"
      autocomplete="off"
      autocorrect="off"
      autocapitalize="none"
      spellcheck="false"
      maxlength="8" >
    <button id="btn-activate" class="activation-btn">
      Valider le code
    </button>
    <p id="activation-message" style="margin-top: 1rem; font-size: 0.9rem; min-height: 1.2em;"></p>
  </div>
</main>

<main id="not-found" class="page" style="text-align:center; padding: 2rem; justify-content:center; align-items:center;">
  <div>
    <i class="bi bi-emoji-frown" style="font-size: 3rem; color: var(--secondary-text); margin-bottom: 1rem;"></i>
    <h2>Page non trouvée</h2>
    <p style="color: var(--secondary-text); margin-bottom: 1.5rem;">Désolé, la page que vous cherchez n'existe pas ou a été déplacée.</p>
    <a href="#home" data-hash="home" class="btn-primary" style="text-decoration: none;">Retour à l'accueil</a>
  </div>
</main>


<script>
const btnActivate = document.getElementById('btn-activate');
const activationCodeInput = document.getElementById('activation-code');
const activationMessageEl = document.getElementById('activation-message');

if (btnActivate) {
  btnActivate.addEventListener('click', async () => {
    const code = activationCodeInput.value.trim();
    if (!code) {
      activationMessageEl.textContent = 'Veuillez entrer le code.';
      activationMessageEl.style.color = 'var(--ebay-red)';
      activationCodeInput.focus();
      return;
    }

    btnActivate.disabled = true;
    btnActivate.textContent = 'Vérification...';
    activationMessageEl.textContent = '';

    try {
      const result = await verifyActivationCode({ code });
      if (auth.currentUser) { 
        await auth.currentUser.getIdToken(true); // Forcer le rafraîchissement du token
      } else {
        activationMessageEl.textContent = "Erreur: Utilisateur non connecté. Veuillez vous reconnecter.";
        activationMessageEl.style.color = 'var(--ebay-red)';
        btnActivate.disabled = false;
        btnActivate.textContent = 'Valider le code';
        setTimeout(() => window.location.replace('login.html'), 3000);
        return;
      }
      window.location.replace('index.html#home'); // Rediriger vers l'accueil
    } catch (err) {
      console.error("Activation error:", err);
      if (err.code === 'functions/not-found') {
          activationMessageEl.textContent = "Fonction d'activation non disponible.";
      } else if (err.details && err.details.message) {
          activationMessageEl.textContent = err.details.message;
      } else if (err.message) {
          if (err.message.includes("INVALID_ARGUMENT") || err.message.includes("invalid-argument")) {
            activationMessageEl.textContent = "Code d'activation invalide ou mal formé.";
          } else if (err.message.includes("UNAUTHENTICATED") || err.message.includes("permission-denied")) {
            activationMessageEl.textContent = "Erreur d'authentification. Veuillez vous reconnecter.";
          } else {
            activationMessageEl.textContent = "Code invalide ou erreur serveur."; 
          }
      } else {
          activationMessageEl.textContent = "Code invalide ou erreur inconnue.";
      }
      activationMessageEl.style.color = 'var(--ebay-red)';
      btnActivate.disabled = false;
      btnActivate.textContent = 'Valider le code';
    }
  });
}
</script>

<nav aria-label="Main navigation">
  <div class="nav-inner">
    <a href="#home"    data-hash="home"    class="nav-link active" aria-label="Home">
      <i class="bi bi-house-door-fill"></i><span>Accueil</span> </a>
    <a href="#catalog" data-hash="catalog" class="nav-link" aria-label="Catalog">
      <i class="bi bi-journal-richtext"></i><span>Catalogue</span> </a>
    <a href="#sales"   data-hash="sales"   class="nav-link" aria-label="Sales History"> <i class="bi bi-receipt"></i><span>Ventes</span> </a>
    <a href="#account" data-hash="account" class="nav-link" aria-label="Account">
      <i class="bi bi-person-fill"></i><span>Compte</span> </a>
  </div>
</nav>

<div id="global-toast-container" class="toast-notification"></div>

<script>
// Fonction pour afficher un toast global
let globalToastTimeout;
function showGlobalToast(message, isError = false, duration = 3000) {
    const toastContainer = document.getElementById('global-toast-container');
    if (!toastContainer) {
        console.warn("Élément .toast-notification non trouvé. Message:", message);
        alert((isError ? "Erreur: " : "") + message); // Fallback
        return;
    }
    clearTimeout(globalToastTimeout);
    toastContainer.textContent = message;
    toastContainer.className = 'toast-notification'; // Reset classes
    if (isError) {
        toastContainer.classList.add('error');
    } else {
        toastContainer.classList.add('success'); // ou juste pas de classe error pour le style par défaut
    }
    toastContainer.classList.add('visible');

    globalToastTimeout = setTimeout(() => {
        toastContainer.classList.remove('visible');
    }, duration);
}
</script>

<script>
  // Service Worker Registration (inchangé)
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js') 
        .then(reg => {
          console.log('[App] SW enregistré, scope :', reg.scope);
          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            if (newSW) {
                newSW.addEventListener('statechange', () => {
                if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('[App] Nouvelle version disponible → rechargement...');
                    window.location.reload();
                }
                });
            }
            });
        })
        .catch(err => console.error('[App] Échec enregistrement SW :', err));
    });
  }
</script>

<script>
/* === PWA install button === (inchangé) */
let deferredInstallPrompt = null; 
const installButton = document.getElementById('btn-install');

if (installButton) { 
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();  
      deferredInstallPrompt = e;  
      installButton.style.display = 'flex'; // Ou block selon votre style
      installButton.style.alignItems = 'center';
      installButton.style.justifyContent = 'center';
    });

    installButton.addEventListener('click', async () => {
      if (!deferredInstallPrompt) return;  
      installButton.disabled = true;  
      installButton.textContent = 'Installation...';

      deferredInstallPrompt.prompt();  
      const { outcome } = await deferredInstallPrompt.userChoice;
      deferredInstallPrompt = null;  

      if (outcome === 'accepted') {
        console.log('[PWA] Utilisateur a accepté l\'installation');
        installButton.style.display = 'none';
      } else {
        console.log('[PWA] Utilisateur a refusé l\'installation');
        installButton.style.display = 'flex'; 
        installButton.disabled = false;
        installButton.innerHTML = '<i class="bi bi-download" style="margin-right:0.5rem;"></i> Installer l’application';
      }
    });
}

window.addEventListener('appinstalled', () => {
  console.log('[PWA] App installée avec succès 🎉');
  if (installButton) {
    installButton.style.display = 'none';
  }
  deferredInstallPrompt = null; 
});
</script>
  <script>
  // Main Router and Auth Guard - AMÉLIORÉ
  ;(function() {
    const allPages  = document.querySelectorAll('main.page'); 
    const mainNav   = document.querySelector('nav'); 
    let userActivated = false; 
    let currentAuthUser = undefined; // undefined = état non déterminé
    document.body.style.visibility = 'hidden'; // Caché jusqu'à ce que l'auth soit prête

    function showOnlyPage(pageIdToShow) { 
      let pageFound = false;
      allPages.forEach(p => {
        const isVisible = p.id === pageIdToShow;
        p.classList.toggle('visible', isVisible);
        if (isVisible) {
            pageFound = true;
            // Les scripts spécifiques aux pages utilisent maintenant hashchange/authstatechange
            // ou des MutationObservers pour gérer leur propre initialisation/nettoyage.
        }
      });

      if (!pageFound && pageIdToShow !== 'add-book-modal-trigger') { // Ne pas rediriger si c'est un trigger de modale
        // AMÉLIORATION: Afficher la page "not-found"
        allPages.forEach(p => p.classList.toggle('visible', p.id === 'not-found'));
        pageIdToShow = 'not-found'; 
      }
     
      // Pages sans la navigation principale
      const pagesWithoutNav = [
        'activation',
        'sell',       // Processus de vente
        'supply',     // Liste des approvisionnements
        'new-supply', // Processus d'approvisionnement
        'select-book',// Sélection de livre
        'orders',     // Commandes
        'reports',    // Rapports
        'cart',       // Panier
        'stock-list', // Nouvelle page pour la liste du stock
        'not-found'   // Page 404
      ]; 
      if (mainNav) {
        if (pagesWithoutNav.includes(pageIdToShow)) { 
            mainNav.style.display = 'none';
            // Pour les pages sans nav principale, s'assurer que le padding-bottom est retiré ou ajusté
            const activePageElement = document.getElementById(pageIdToShow);
            if (activePageElement) {
                activePageElement.style.paddingBottom = 'env(safe-area-inset-bottom)'; // Ou 0 si pas de safe area
            }
        } else {
            mainNav.style.removeProperty('display');
            // Restaurer le padding pour les pages AVEC nav principale
            const activePageElement = document.getElementById(pageIdToShow);
            if (activePageElement) {
                 activePageElement.style.paddingBottom = 'calc(56px + env(safe-area-inset-bottom))';
            }
        }
      }

      // Mettre à jour le lien actif dans la nav
      document.querySelectorAll('nav [data-hash]').forEach(el =>
        el.classList.toggle('active', el.dataset.hash === pageIdToShow)
      );

      // Scroll to top
      const activePageElement = document.getElementById(pageIdToShow);
      if (activePageElement) { 
        activePageElement.scrollTop = 0;
      }
    }
   
    // AMÉLIORATION: Fonction de routage principale
    async function route() {
      if (currentAuthUser === undefined) { // État d'auth pas encore déterminé
        return; // Ne rien faire, on attend onAuthStateChanged
      }
      document.body.style.visibility = 'visible'; // Rendre visible après la vérification d'auth

      let hashKey = location.hash.slice(1) || 'home';

      if (!currentAuthUser) { 
        userActivated = false; 
        // La redirection vers login.html est déjà gérée par onAuthStateChanged
        return; 
      }

      // Utilisateur connecté, vérifier l'activation
      if (!userActivated && hashKey !== 'activation') {
        if (location.hash !== '#activation') location.hash = '#activation';
        showOnlyPage('activation');
        return;
      }
      if (userActivated && hashKey === 'activation') { 
         location.hash = '#home'; // Rediriger de #activation vers #home si déjà activé
        // showOnlyPage('home') sera appelé par le hashchange
         return;
      }
     
      // AMÉLIORATION: Les modales ne sont plus des "pages" du routeur
      // Si vous voulez supporter des "deep links" pour ouvrir une modale,
      // vous pouvez vérifier le hash ici et appeler openGlobalAddBookModal() par ex.
      // Exemple: if (hashKey === 'open-add-book-modal') { openGlobalAddBookModal(); return; }

      showOnlyPage(hashKey);
    }

    // AMÉLIORATION: Gestion de l'état d'authentification
    auth.onAuthStateChanged(async user => {
      currentAuthUser = user; 
      if (!user) {
        userActivated = false; 
        // Si on n'est pas déjà sur login.html, y rediriger
        if (!window.location.pathname.endsWith('login.html')) {
            window.location.replace('login.html'); 
        } else {
            document.body.style.visibility = 'visible'; // Assurer que login.html est visible
        }
        return;
      }

      // Utilisateur connecté, essayer de récupérer les claims
      try {
        const idTokenResult = await user.getIdTokenResult(true); 
        userActivated = !!idTokenResult.claims.activated;
      } catch (error) {
        console.error("Erreur en récupérant idTokenResult:", error);
        userActivated = false; 
        // AMÉLIORATION: Gestion d'erreur critique
        showGlobalToast("Erreur d'authentification. Déconnexion...", true, 4000);
        setTimeout(() => {
            auth.signOut().finally(() => { // finally pour s'assurer que la redirection se fait
                window.location.replace('login.html');
            });
        }, 4000);
        return; // Ne pas continuer le routage si l'état est incertain
      }
     
      route(); // Appeler route après que l'état d'auth et les claims soient traités
    });

    window.addEventListener('hashchange', route);

    document.body.addEventListener('click', e => {
      const dataHashElement = e.target.closest('[data-hash]');
      if (!dataHashElement) return;

      if (dataHashElement.classList.contains('nav-link')) {
        const rect = dataHashElement.getBoundingClientRect();
        const rippleSize = Math.max(rect.width, rect.height);
        const rippleSpan = document.createElement('span');
        rippleSpan.className = 'ripple';
        rippleSpan.style.width = rippleSpan.style.height = rippleSize + 'px';
        rippleSpan.style.left = (e.clientX - rect.left - rippleSize/2) + 'px';
        rippleSpan.style.top  = (e.clientY - rect.top  - rippleSize/2) + 'px';
       
        const existingRipple = dataHashElement.querySelector('.ripple');
        if (existingRipple) existingRipple.remove();
       
        dataHashElement.appendChild(rippleSpan);
        rippleSpan.addEventListener('animationend', () => rippleSpan.remove(), {once: true});
      }

      // Permettre la navigation par défaut pour les liens <a> avec href="#"
      // Le changement de hash déclenchera l'événement 'hashchange' et donc la fonction route().
      // Si ce n'est pas un <a> mais un <button> ou autre avec data-hash, on met à jour manuellement le hash.
      if (dataHashElement.tagName !== 'A' || !dataHashElement.getAttribute('href')?.startsWith('#')) {
          if (location.hash !== '#' + dataHashElement.dataset.hash) {
              location.hash = dataHashElement.dataset.hash;
          } else {
              // Si on clique sur le lien déjà actif, on peut forcer un "re-rendu" si nécessaire
              route(); 
          }
      }
    });
  })();
  </script> 
</body>
</html>
