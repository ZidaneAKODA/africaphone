<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>BookShop</title>

  <link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
  <style>
    body { visibility: hidden; }
  </style>

  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-functions-compat.js"></script>

  <script>
    // Remplace par ta config
    const firebaseConfig = {
      apiKey: "AIzaSyCvNZ5lhKdP_6W-eRle-7zCmFqejSfRuto", // Replace with your actual API key if necessary
      authDomain: "shoptel-35c7e.firebaseapp.com",
      projectId: "shoptel-35c7e",
      storageBucket: "shoptel-35c7e.appspot.com",
      messagingSenderId: "541177101809",
      appId: "1:541177101809:web:5ae3ea186f198558371850",
      measurementId: "G-VH4MCV6Y6E"
    };

    // 1) Initialise l’app et Auth UNE SEULE FOIS
    firebase.initializeApp(firebaseConfig);

    // 2) Dès que l’état d’auth est connu…
    const auth    = firebase.auth();
    const fn      = firebase.functions();
    const db = firebase.firestore();

    // fonction callable pour vérifier le code
    const verifyActivationCode = fn.httpsCallable('verifyActivationCode');
  </script>

  <style>
    /* ——— Gestion de la visibilité des “pages” ——— */
    main.page {
      display: none;              /* cachée par défaut */
      flex: 1 1 auto;             /* occupe l’espace restant */
      width: 100%;                /* toute la largeur */
      overflow-y: auto;           /* scroll interne si besoin */
      /* padding-bottom pour laisser la place à la nav en bas */
      padding-bottom: calc(56px + env(safe-area-inset-bottom));
    }

    main.page.visible {
      display: flex;              /* devient visible et flex */
      flex-direction: column;
    }

    :root{
      --primary-text:#222;
      --secondary-text:#555;
      --border-radius-pill:2rem;
      --border-radius-card: 0.75rem; /* Updated for consistency */
      --border-color: #e0e0e0; 
      --ebay-red:#e53238;
      --ebay-blue:#0064d2;
      --ebay-yellow:#f5af02;
      --ebay-green:#86b817;
      --accent:#0064d2;
      --surface: #fff; /* Added for consistency with new-supply */
      --stock-low-color: #f5af02; /* Orange for low stock */
      --stock-out-color: #e53238; /* Red for out of stock */
      --action-icon-color: #757575;
      --action-icon-hover-bg: #f0f0f0; /* Used for :active state as well */
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

    html,body{
      width:100%;height:100%;
      font-family:'Roboto',sans-serif;
      background:#fff;color:var(--primary-text);
      -webkit-font-smoothing:antialiased;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
      display:flex;flex-direction:column;
      height:100vh;height:100dvh;
    }

    /* PAGE MANAGEMENT */
    .page {
      display: none;            /* cachée par défaut */
      flex: 1 1 auto;           /* grandit pour remplir l’espace */
      width: 100%;                /* occupe toute la largeur */
      overflow-y: auto;           /* scroll interne si besoin */
    }

    .page.visible {
      display: flex;            /* devient un flex-container vertical */
      flex-direction: column;
    }

    /* COMMON STYLES */
    header{padding:1rem 1rem 0.5rem}
    .cart{margin-left:auto;font-size:1.6rem;color:var(--primary-text)}

    .search-wrapper{
      margin-top:0.75rem;position:relative
    }
    .search-wrapper input{
      width:100%;padding:0.75rem 3.25rem 0.75rem 2.75rem;
      border:1px solid var(--border-color); 
      border-radius:var(--border-radius-pill);
      background:#f4f4f4;font-size:1rem;outline:none;cursor:pointer;
      box-shadow: none; 
    }
    .search-wrapper .bi-search{
      position:absolute;left:1rem;top:50%;
      transform:translateY(-50%);font-size:1.1rem;color:var(--secondary-text)
    }
    .search-wrapper .actions{
      position:absolute;right:0.75rem;top:50%;
      transform:translateY(-50%);display:flex;gap:0.5rem;
      font-size:1.6rem;color:var(--secondary-text)
    }

    .signin-card{text-align:center;margin:0.5rem 0 1.2rem}
    .signin-card p{
      font-size:1.05rem;color:var(--secondary-text);
      margin-bottom:1rem;line-height:1.4
    }
    .signin-actions{display:flex;justify-content:center;gap:1rem}

    .btn-outline{
      flex:0 0 42%;padding:0.7rem 1rem;border:2px solid var(--accent);
      border-radius:var(--border-radius-pill);background:#fff;
      font-weight:500;color:var(--accent);font-size:1rem;
      transition:all 0.2s ease;outline:none; box-shadow: none;
    }
    .btn-outline:active{background:var(--accent);color:#fff}

    .promo-block{
      background:#f5f5f5;padding:1.5rem 1rem;margin-bottom:1.2rem
    }
    .promo-block h2{font-size:1.6rem;margin-bottom:0.5rem}
    .promo-block p{
      color:var(--secondary-text);font-size:1rem;line-height:1.4;margin-bottom:1rem
    }
    .btn-primary{
      padding:0.85rem 1.5rem;background:var(--accent);color:#fff;border:none;
      border-radius:var(--border-radius-pill);font-size:1rem;font-weight:600;
      box-shadow:none; 
      outline:none;
    }
    .btn-primary:active{background:#014fa5}

    .trending{padding:0 1rem 5.5rem}
    .trending h3{font-size:1.35rem;margin-bottom:0.75rem}
    .trend-list{
      display:flex;gap:1.25rem;overflow-x:auto;padding-bottom:0.5rem;
      -ms-overflow-style:none;scrollbar-width:none
    }
    .trend-list::-webkit-scrollbar{display:none}
    .trend-item{
      flex:0 0 auto;text-align:center;user-select:none;padding:0.5rem
    }
    .trend-item img{
      width:5.3rem;height:5.3rem;border-radius:50%;object-fit:cover;
      box-shadow:none; 
      border: 1px solid var(--border-color); 
    }
    .trend-item .product-name{display:block;margin-top:0.5rem;font-weight:500}
    .trend-item .price{
      display:block;margin:0.25rem 0 0.75rem;color:var(--ebay-red);font-weight:600
    }
    .btn-add{font-size:0.85rem;padding:0.4rem 0.8rem}

    /* NAVIGATION BAR */
    nav{
      position:fixed;bottom:0;left:0;width:100%;background:#fff;
      border-top:1px solid var(--border-color);z-index:30
    }
    .nav-inner{display:flex;justify-content:space-evenly;align-items:center;padding:0.4rem 0}
    .nav-link{
      flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
      font-size:0.8rem;color:var(--secondary-text);outline:none;user-select:none;
      position:relative;overflow:hidden;padding:0.6rem 0;border-radius:var(--border-radius-pill);
      background:none;border:none;cursor:pointer;text-decoration:none
    }
    .nav-link i{font-size:1.25rem}
    .nav-link.active{color:var(--accent);background:rgba(0,100,210,0.12)}

    /* RIPPLE EFFECT */
    .ripple{
      position:absolute;border-radius:50%;transform:scale(0);
      background:rgba(0,100,210,0.25);animation:ripple 600ms linear;pointer-events:none
    }
    @keyframes ripple{to{transform:scale(4);opacity:0}}

    /* === Home page actions === */
    .home-actions{
      display:flex;justify-content:space-around;gap:1rem;padding:1rem
    }
    .btn-action{
      flex:1;display:flex;align-items:center;justify-content:center;gap:0.5rem;
      padding:0.8rem 1rem;border:none;border-radius:var(--border-radius-pill);
      font-size:1rem;font-weight:500;box-shadow:none; 
      border: 1px solid var(--border-color); 
      transition:transform 0.1s ease;color:#fff;cursor:pointer;
    }
    .btn-action:active{transform:translateY(1px);}
    .btn-sell{background:var(--ebay-green)}
    .btn-buy {background:var(--ebay-blue)}

    /* === Stock info card === */
    .stock-card{
      background:var(--ebay-yellow);border-radius:var(--border-radius-pill);
      margin:0 1rem 1.5rem;padding:0.75rem 1rem;text-align:center;
      box-shadow:none; 
      border: 1px solid #e6a002; 
    }
    .stock-count{font-size:1.8rem;font-weight:700;color:var(--primary-text)}
    .stock-label{font-size:0.95rem;color:var(--secondary-text)}

    /* ---------- Info cards sans ombre, avec cadre ---------- */
    .info-cards {
      display: flex;
      gap: 0.75rem; /* Espace ajusté */
      padding: 0.75rem 1rem; /* Padding ajusté */
      margin-bottom: 1rem; /* Espace avant la liste des livres */
      overflow-x: auto;
      transition: opacity 0.3s ease, max-height 0.3s ease, margin-bottom 0.3s ease, padding 0.3s ease;
      max-height: 200px;
      overflow: hidden;
    }

    .info-card {
      flex: 1;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-card);
      padding: 0.75rem; /* Padding interne ajusté */
      text-align: center;
      min-width: 0;
      box-shadow: none; 
    }

    .info-number {
      font-size: 1.3rem; /* Taille de police ajustée */
      font-weight: 600;
      color: var(--ebay-blue);
      line-height: 1.2;
    }

    .info-label {
      font-size: 0.8rem; /* Légende ajustée */
      color: var(--secondary-text);
      margin-top: 0.25rem; /* Marge ajustée */
    }

    .info-cards.fade-out {
      opacity: 0;
      max-height: 0;
      margin-bottom: 0;
      padding-top: 0;
      padding-bottom: 0;
      pointer-events: none;
    }

    /* === Styles pour la page Catalogue (main#catalog) === */
    main#catalog {
      padding: 0; 
      margin: 0;
    }

    main#catalog > header { /* Header de la page catalogue (avec la recherche) */
      padding-top: 0.5rem;
      padding-bottom: 0.5rem; 
      position: -webkit-sticky; 
      position: sticky;
      top: 0;
      z-index: 15; 
      background-color: #fff; 
      border-bottom: 1px solid var(--border-color); 
    }

    main#catalog .search-wrapper {
      margin-top: 0; 
    }
   
    /* Liste des livres dans le catalogue */
    #catalog-results-main .books-list {
      display: flex;
      flex-direction: column;
      gap: 1rem; 
      padding: 1rem; 
    }

    /* === Nouvelle Carte Livre pour le Catalogue (MODIFIED) === */
    .book-card-catalog {
      display: flex;
      gap: 1rem;
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-card);
      padding: 1rem;
      /* box-shadow: 0 1px 3px rgba(0,0,0,0.05); MODIFIED: Removed shadow */
      /* transition: box-shadow 0.2s ease-in-out; MODIFIED: Removed transition for shadow */
    }
    /* .book-card-catalog:hover { MODIFIED: Removed hover effect
        box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    } */

    .book-card-image-area {
      flex: 0 0 60px; /* Largeur fixe pour la zone image/icône */
      height: 80px; /* Hauteur fixe */
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #f0f0f0;
      border-radius: calc(var(--border-radius-card) - 0.25rem);
      overflow: hidden; /* Si jamais on met une vraie image */
    }
    .book-card-image-area .book-placeholder-icon {
      font-size: 2.5rem; /* Taille de l'icône placeholder */
      color: var(--secondary-text);
    }

    .book-card-content-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem; /* Espace entre les blocs d'info et les actions */
    }

    .book-card-main-info .book-title {
      font-size: 1.15rem; /* Taille du titre */
      font-weight: 600;
      color: var(--primary-text);
      margin-bottom: 0.25rem;
      line-height: 1.3;
    }
   
    .book-card-main-info p, .book-card-secondary-info p {
      font-size: 0.9rem;
      color: var(--secondary-text);
      margin-bottom: 0.2rem;
      display: flex; /* Pour aligner icône et texte */
      align-items: center;
      gap: 0.4rem; /* Espace entre icône et texte */
    }
    .book-card-main-info p i, .book-card-secondary-info p i {
      font-size: 1rem; /* Taille des icônes d'info */
      color: var(--action-icon-color);
      min-width: 16px; /* Pour alignement */
      text-align: center;
    }
    .book-card-main-info p span, .book-card-secondary-info p span {
        font-weight: 500; /* Mettre en valeur le chiffre/texte */
        color: var(--primary-text);
    }
    .book-card-main-info .book-price-sell span {
        color: var(--ebay-blue); /* Couleur accent pour le prix de vente */
        font-weight: 600;
    }
    .book-card-main-info .stock-value {
        font-weight: 600;
    }
    .book-card-main-info .stock-value.stock-normal { color: var(--ebay-green); }
    .book-card-main-info .stock-value.stock-low { color: var(--stock-low-color); }
    .book-card-main-info .stock-value.stock-out { color: var(--stock-out-color); }


    .book-card-actions {
      margin-top: 0.5rem; /* Espace au-dessus des actions */
      padding-top: 0.5rem; /* Ligne de séparation visuelle */
      border-top: 1px solid #f0f0f0;
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end; /* Aligner les actions à droite */
    }

    .btn-action-icon {
      background-color: transparent;
      border: none;
      color: var(--action-icon-color);
      padding: 0.5rem;
      border-radius: 50%; /* Boutons ronds */
      cursor: pointer;
      font-size: 1.1rem; /* Taille de l'icône dans le bouton */
      width: 36px;
      height: 36px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease, color 0.2s ease;
    }
    /* .btn-action-icon:hover { MODIFIED: Removed hover effect
      background-color: var(--action-icon-hover-bg);
      color: var(--primary-text);
    } */
    .btn-action-icon:active { /* MODIFIED: Added active state for touch feedback */
      background-color: var(--action-icon-hover-bg); /* Using existing variable, can be renamed if a different active style is desired */
      color: var(--primary-text);
    }
    /* .btn-action-icon.btn-delete-book:hover { MODIFIED: Removed hover effect
      background-color: rgba(229, 50, 56, 0.1);
      color: var(--ebay-red);
    } */
    .btn-action-icon.btn-delete-book:active { /* MODIFIED: Added active state for touch feedback */
      background-color: rgba(229, 50, 56, 0.15); /* Slightly more pronounced for active state */
      color: var(--ebay-red);
    }
    .btn-action-icon i { /* Pour s'assurer que l'icône est bien centrée */
        line-height: 1; 
    }

    /* Squelette de chargement pour le catalogue */
    #catalog-results-main .books-list .skeleton-book-card-catalog {
        display: flex;
        gap: 1rem;
        background: #f9f9f9;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-card);
        padding: 1rem;
        height: 150px; /* Hauteur approximative de la carte */
        animation: pulse 1.5s infinite ease-in-out;
    }
     @keyframes pulse {
      0%   { opacity: 1; }
      50%  { opacity: 0.6; }
      100% { opacity: 1; }
    }

    /* === Styles pour la page Historique des Ventes (main#sales) === */
    header#sales-header {
      padding: 1rem;
      background: #fff;
      border-bottom: 1px solid var(--border-color);
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      z-index: 15;
    }
    header#sales-header h2 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary-text);
    }
    main#sales .sales-list { /* This is #sales-list */
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Space between cards */
        padding: 1rem; /* Padding around the entire list */
    }
    main#sales .skeleton-sale-card { /* Skeleton for sales */
        background: #f9f9f9;
        height: 100px; /* Adjusted height */
        margin: 0;
        border-radius: var(--border-radius-card);
        animation: pulse 1.5s infinite ease-in-out;
    }
    main#sales .sale-card { /* Individual sale card */
        background: #ffffff;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-card);
        margin: 0;
        padding: 1rem;
        box-shadow: none;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }
    main#sales .sale-card header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #efefef;
    }
    main#sales .sale-card header .sale-info {
        flex-grow: 1;
        margin-right: 0.75rem;
    }
    main#sales .sale-card header .sale-info strong { /* Customer Name */
        font-size: 1.1rem;
        font-weight: 600;
        color: var(--primary-text);
        display: block;
        margin-bottom: 0.2rem;
    }
    main#sales .sale-card header .sale-info small { /* Date */
        font-size: 0.8rem;
        color: var(--secondary-text);
        display: block;
    }
    main#sales .sale-card header .sale-meta {
        text-align: right;
        flex-shrink: 0;
    }
    main#sales .sale-card header .sale-meta .sale-total-amount { /* Total XOF */
        font-size: 1.05rem;
        font-weight: 700;
        color: var(--ebay-green);
        display: block;
    }
     main#sales .sale-card header .sale-meta .sale-total-items { /* Total items */
        font-size: 0.85rem;
        color: var(--secondary-text);
        display: block;
        margin-top: 0.1rem;
    }
    main#sales .sale-card .sale-items-summary { /* Optional: for a brief summary of items if not expanding */
        font-size: 0.85rem;
        color: var(--secondary-text);
        padding-top: 0.5rem;
    }
    /* End Sales History Styles */

  </style>
</head>

<body>

  <script>
  class AppInput extends HTMLElement {
    constructor() {
      super();
      const shadow = this.attachShadow({ mode: 'open' });
      const inp = document.createElement('input');

      inp.setAttribute('autocomplete', 'off');
      inp.setAttribute('autocorrect',  'off');
      inp.setAttribute('autocapitalize', 'none');
      inp.setAttribute('spellcheck',     'false');

      ['type','placeholder','name','id','value','list'].forEach(name => {
        if (this.hasAttribute(name)) {
          inp.setAttribute(name, this.getAttribute(name));
        }
      });
      shadow.appendChild(inp);
    }
  }
  customElements.define('app-input', AppInput);
</script>

  <main id="home" class="page visible">
    <header><h2 style="padding:1rem">Accueil</h2></header>
    <div class="home-actions">
      <button class="btn-action btn-sell" data-hash="sell" aria-label="Sell">
        <i class="bi bi-tag-fill"></i><span>Vendre</span>
      </button>
      <button class="btn-action btn-buy" data-hash="supply" aria-label="Approvisionnement">
        <i class="bi bi-cart-fill"></i><span>Approvisionnement</span>
      </button>
    </div>
    <button id="btn-install" class="btn-primary"
        style="display:none; margin:1rem auto; width: calc(100% - 2rem);">
      <i class="bi bi-download" style="margin-right:0.5rem;"></i>
      Installer l’application
    </button>
  </main>
 
<main id="sell" class="page">
  <style>

    .sell-step {
      display: none;
      flex-direction: column;
      flex: 1 1 auto; /* Occupe l'espace disponible */
      width: 100%;
      overflow-y: auto;
      /* Padding pour laisser la place à la navigation du wizard en bas */
      padding: 0 0 calc(56px + 1rem + env(safe-area-inset-bottom)); /* 56px nav wizard + 1rem marge */
    }

    .sell-step.active {
      display: flex;
    }

    /* Header commun pour la recherche (Étape 1) */
    #sell .sell-header-step1 {
      display: flex;
      align-items: center;
      padding: 0.75rem 1rem;
      background: #fff;
      border-bottom: 1px solid var(--border-color);
      position: -webkit-sticky;
      position: sticky;
      top: 0;
      z-index: 15;
    }

    #sell .sell-header-step1 .btn-close-sell {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0.5rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: var(--primary-text);
      margin-right: 0.75rem;
      cursor: pointer;
      outline: none;
    }

    #sell .sell-header-step1 .search-wrapper {
      flex: 1;
      margin-top: 0;
    }
      #sell .sell-header-step1 #search-input-sell {
      width: 100%;
      padding: 0.75rem 2.5rem; /* Ajusté pour l'icône de recherche */
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-pill);
      background: #f4f4f4;
      font-size: 1rem;
      outline: none;
      box-shadow: none;
    }

    /* Conteneurs de contenu pour chaque étape */
    .sell-step-content {
      padding: 1rem;
      flex-grow: 1;
    }
    /* Style pour les titres des étapes */
    .sell-step h3.step-title {
    /* Styles existants (assurez-vous qu'ils sont là ou copiez-les depuis votre code actuel) */
    padding: 1rem 1rem 0.5rem;
    font-size: 1.2rem;
    font-weight: 600;
    margin: 0;
    background-color: #fff; /* Pour cacher le contenu qui scrolle derrière */
    border-bottom: 1px solid var(--border-color);
    position: -webkit-sticky;
    position: sticky;
    top: 0; /* Se colle sous le header principal si header principal existe pour l'étape */
    z-index: 14; /* En dessous du header principal, au-dessus du contenu */

    /* === AJOUTS/MODIFICATIONS CI-DESSOUS === */
    display: flex;              /* Pour aligner le titre et le bouton sur la même ligne */
    align-items: center;        /* Pour centrer verticalement les éléments */
    justify-content: space-between; /* Pour pousser le bouton vers la droite */
}

/* Styles pour le bouton "Vider le panier" DANS le titre h3 */
.sell-step h3.step-title #btn-clear-sell-cart-step2 {
    background: none;             /* Enlève le fond du bouton */
    border: none;                 /* Enlève la bordure */
    padding: 0.25rem;             /* Un peu d'espace autour de l'icône */
    margin: 0;                    /* Enlève les marges par défaut si présentes */
    cursor: pointer;              /* Change le curseur en main */
    font-size: 1.3rem;            /* Ajustez la taille de l'icône si nécessaire */
    line-height: 1;               /* Pour un meilleur alignement vertical de l'icône */
    color: var(--ebay-red);       /* Assure la couleur de l'icône (même si style en ligne existe) */
}

/* Si vous voulez être sûr que l'icône hérite bien de la couleur du bouton : */
.sell-step h3.step-title #btn-clear-sell-cart-step2 i {
    color: inherit; /* Hérite la couleur de son parent bouton */
    vertical-align: middle; /* Peut aider à mieux centrer l'icône */
}


    /* Navigation du Wizard */
    .wizard-nav-sell {
      position: fixed;
      bottom: env(safe-area-inset-bottom); /* Au-dessus de la barre de nav principale de l'app */
      left: 0;
      width: 100%;
      display: flex;
      gap: 0.75rem;
      padding: 0.75rem 1rem;
      background: #fff;
      border-top: 1px solid var(--border-color);
      z-index: 20; /* Au-dessus du contenu de l'étape */
    }

    .wizard-nav-sell button {
      flex: 1;
      padding: 0.8rem;
      font-size: 1rem;
      font-weight: 500;
      border-radius: var(--border-radius-pill);
      border: none;
      cursor: pointer;
      box-shadow: none;
    }
    .wizard-nav-sell button.btn-sell-primary {
      background-color: var(--accent);
      color: white;
    }
    .wizard-nav-sell button.btn-sell-primary:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }
    .wizard-nav-sell button.btn-sell-secondary {
      background-color: #f0f0f0;
      color: var(--primary-text);
      border: 1px solid var(--border-color);
    }


    /* Styles pour les résultats de recherche (Étape 1) */
    #sell-search-results-container {
      /* padding: 1rem; */ /* Géré par sell-step-content */
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    #sell-search-results-container .book-card-sell {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--border-radius-card);
      padding: 0.75rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: none;
    }
    #sell-search-results-container .book-card-sell .info .title {
      font-weight: 500; font-size: 1rem; color: var(--primary-text); margin-bottom: 0.2rem;
    }
    #sell-search-results-container .book-card-sell .info .details {
      font-size: 0.85rem; color: var(--secondary-text);
    }
    #sell-search-results-container .book-card-sell .info .details .price {
      color: var(--ebay-blue); font-weight: 500;
    }
    #sell-search-results-container .book-card-sell .btn-add-to-sell-cart {
      background: var(--ebay-blue); color: white; border: none; border-radius: 50%;
      width: 36px; height: 36px; font-size: 1.2rem; display: flex;
      align-items: center; justify-content: center; cursor: pointer; box-shadow: none; padding: 0;
    }
    #sell-search-results-container .book-card-sell .btn-add-to-sell-cart.added {
      background: var(--ebay-green);
    }
    #sell-search-results-container .no-results {
      text-align: center; padding: 1rem; color: var(--secondary-text);
    }
    #sell-step1-cart-summary {
        padding: 0.75rem;
        margin-top: 1rem;
        background-color: #f9f9f9;
        border-top: 1px solid var(--border-color);
        border-bottom: 1px solid var(--border-color);
        text-align: center;
        font-size: 0.9rem;
        color: var(--secondary-text);
    }

    /* Styles pour le panier (Étape 2) */
    #sell-cart-items-list-step2 .sell-cart-item {
      display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem 0;
      border-bottom: 1px solid #f0f0f0;
    }
    #sell-cart-items-list-step2 .sell-cart-item:last-child { border-bottom: none; }
    #sell-cart-items-list-step2 .sell-cart-item .title {
      flex-grow: 1; font-size: 0.95rem; font-weight: 500;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 80px;
    }
    #sell-cart-items-list-step2 .sell-cart-item input[type="number"] {
      width: 60px; padding: 0.4rem; font-size: 0.9rem; text-align: center;
      border: 1px solid var(--border-color); border-radius: 0.25rem; box-shadow: none;
    }
    #sell-cart-items-list-step2 .sell-cart-item input.price { width: 80px; }
    #sell-cart-items-list-step2 .sell-cart-item .subtotal {
      font-size: 0.9rem; font-weight: 500; min-width: 70px; text-align: right;
    }
    #sell-cart-items-list-step2 .sell-cart-item .remove-item-btn {
      background: none; border: none; color: var(--ebay-red); font-size: 1.3rem;
      cursor: pointer; padding: 0.25rem;
    }
    #sell-cart-empty-message-step2 {
      color: var(--secondary-text); font-style: italic; text-align: center; padding: 1rem;
    }
    .cart-summary-section-step2 { /* Similaire au global .cart-summary-section */
      margin-top: 1.5rem; padding-top: 1rem; border-top: 1px solid var(--border-color);
    }
    .cart-summary-section-step2 .summary-line {
      display: flex; justify-content: space-between; font-size: 1rem; margin-bottom: 0.5rem;
    }
    .cart-summary-section-step2 .summary-line.total span { font-weight: bold; font-size: 1.15rem; }
    .cart-summary-section-step2 .summary-line.total span:last-child { color: var(--ebay-green); }
   
    /* Styles pour infos client (Étape 3) */
    .form-group-sell { margin-bottom: 1rem; }
    .form-group-sell label {
      display: block; font-size: 0.9rem; color: var(--secondary-text); margin-bottom: 0.25rem;
    }
    .form-group-sell input {
      width: 100%; padding: 0.7rem 0.8rem; font-size: 1rem;
      border: 1px solid var(--border-color); border-radius: var(--border-radius-card);
      box-shadow: none; outline: none;
    }
    .form-group-sell input:focus { border-color: var(--accent); }

    /* Styles pour Récapitulatif (Étape 4) */
    #sell-summary-customer-info-step4, #sell-summary-items-list-step4, #sell-summary-totals-step4 {
        margin-bottom: 1.5rem;
    }
    #sell-summary-customer-info-step4 p, #sell-summary-totals-step4 p {
        font-size: 0.95rem; margin-bottom: 0.5rem; color: var(--secondary-text);
    }
    #sell-summary-customer-info-step4 p span, #sell-summary-totals-step4 p span {
        font-weight: 500; color: var(--primary-text);
    }
    #sell-summary-items-list-step4 .summary-item {
        display: flex; justify-content: space-between; padding: 0.5rem 0;
        border-bottom: 1px solid #f0f0f0; font-size: 0.9rem;
    }
    #sell-summary-items-list-step4 .summary-item:last-child { border-bottom: none; }
    #sell-summary-items-list-step4 .summary-item .title { flex-grow: 1; font-weight: 500; }
    #sell-summary-items-list-step4 .summary-item .qty-price,
    #sell-summary-items-list-step4 .summary-item .line-total { text-align: right; min-width: 80px; }
    #sell-summary-items-list-step4 .summary-item .line-total { font-weight: 500; }
    #sell-summary-totals-step4 .grand-total {
        font-size: 1.2rem; font-weight: bold; color: var(--ebay-green);
    }
    #btn-validate-sale-step4 {
        width: 100%; padding: 0.8rem; font-size: 1rem; font-weight: 600;
        border-radius: var(--border-radius-pill); border: none; cursor: pointer;
        display: flex; align-items: center; justify-content: center; gap: 0.5rem;
        box-shadow: none; background-color: var(--ebay-green); color: white;
    }
    #btn-validate-sale-step4:disabled { background-color: #ccc; cursor: not-allowed; }


    /* Feedback global */
    #sell-feedback-message {
      font-weight: 500; min-height: 1.5em; text-align:center; padding:0 1rem 1rem;
      position: fixed; bottom: calc(env(safe-area-inset-bottom) + 56px + 1rem); /* Au dessus de la nav wizard */
      width: 100%; left:0; box-sizing: border-box;
      z-index: 25; /* Au dessus de la nav wizard */
    }
    #sell-feedback-message.success { color: var(--ebay-green); }
    #sell-feedback-message.error { color: var(--ebay-red); }
   

  </style>

  <div class="sell-step active" data-step="1">
    <header class="sell-header-step1">
      <button class="btn-close-sell" data-hash="home" aria-label="Quitter la page de vente">
        <i class="bi bi-x-lg"></i>
      </button>
      <div class="search-wrapper">
        <i class="bi bi-search"></i>
        <input type="search" id="search-input-sell" placeholder="Rechercher un livre à vendre" aria-label="Recherche catalogue de vente" autocomplete="off" autocorrect="off" autocapitalize="none" spellcheck="false">
      </div>
    </header>
    <div class="sell-step-content">
        <div id="sell-search-results-container">
            <p class="no-results" style="padding-top:1rem;">Commencez par rechercher un livre dans votre stock.</p>
        </div>
    </div>
    <div id="sell-step1-cart-summary">Panier de vente vide.</div>
    <div class="wizard-nav-sell">
      <button id="btn-sell-step1-next" class="btn-sell-primary" data-target-step="2" disabled>Suivant &rarr;</button>
    </div>
  </div>

  <div class="sell-step" data-step="2"> <h3 class="step-title">
        <span style="display: flex; align-items: center; gap: 0.5em;">
            <i class="bi bi-list-ul"></i>
            <span>Articles pour la Vente</span>
        </span>
        <button id="btn-clear-sell-cart-step2" aria-label="Vider le panier">
            <i class="bi bi-cart-x-fill" style="color:var(--ebay-red);"></i>
        </button>
    </h3>
    <div class="sell-step-content">
        <div id="sell-cart-items-list-step2">
            </div>
        <div id="sell-cart-empty-message-step2" style="text-align: center; padding: 1rem; color: var(--secondary-text);">
            Le panier de vente est vide.
        </div>
        <div class="cart-summary-section-step2">
            <div class="summary-line"><span>Total Articles:</span> <span id="sell-cart-total-items-step2">0</span></div>
            <div class="summary-line total"><span>Montant Total:</span> <span id="sell-cart-grand-total-step2">XOF 0</span></div>
        </div>
        </div>
    <div class="wizard-nav-sell">
        <button class="btn-sell-secondary" data-target-step="1">&larr; Sélection Livres</button>
        <button id="btn-sell-step2-next" class="btn-sell-primary" data-target-step="3" disabled>Suivant &rarr;</button>
    </div>
</div>

  <div class="sell-step" data-step="3">
    <h3 class="step-title"><i class="bi bi-person-badge"></i> Informations Client</h3>
    <div class="sell-step-content">
        <div class="form-group-sell">
            <label for="sell-customer-name">Nom du client</label>
            <input type="text" id="sell-customer-name" placeholder="Nom et prénom (optionnel)">
        </div>
        <div class="form-group-sell">
            <label for="sell-customer-phone">Numéro de téléphone</label>
            <input type="tel" id="sell-customer-phone" placeholder="Téléphone (optionnel)">
        </div>
    </div>
    <div class="wizard-nav-sell">
      <button class="btn-sell-secondary" data-target-step="2">&larr; Panier</button>
      <button id="btn-sell-step3-next" class="btn-sell-primary" data-target-step="4">Suivant &rarr;</button> </div>
  </div>

  <div class="sell-step" data-step="4">
    <h3 class="step-title"><i class="bi bi-check2-circle"></i> Récapitulatif & Validation</h3>
    <div class="sell-step-content">
        <div id="sell-summary-customer-info-step4">
            <h4>Client</h4>
            <p>Nom: <span id="summary-customer-name">N/A</span></p>
            <p>Téléphone: <span id="summary-customer-phone">N/A</span></p>
        </div>
        <div id="sell-summary-items-list-step4">
            <h4>Articles</h4>
            </div>
        <div id="sell-summary-totals-step4">
            <h4>Total Vente</h4>
            <p>Total Articles: <span id="summary-total-items">0</span></p>
            <p>Montant Total: <span id="summary-grand-total" class="grand-total">XOF 0</span></p>
        </div>
        <button id="btn-validate-sale-step4" disabled>
            <i class="bi bi-check-circle-fill"></i> Valider la Vente
        </button>
    </div>
    <div class="wizard-nav-sell">
      <button class="btn-sell-secondary" data-target-step="3">&larr; Infos Client</button>
      </div>
  </div>

  <div id="sell-feedback-message"></div>

  <script>
  (function() {
    // Elements DOM globaux à la page de vente
    const sellPageEl = document.getElementById('sell');
    const feedbackMessageEl = document.getElementById('sell-feedback-message');
    let currentSellStep = 1;
    const sellSteps = sellPageEl.querySelectorAll('.sell-step');

    // --- Éléments Étape 1: Sélection Livres ---
    const searchInputSellEl = document.getElementById('search-input-sell');
    const searchResultsContainerEl = document.getElementById('sell-search-results-container');
    const step1NextBtn = document.getElementById('btn-sell-step1-next');
    const step1CartSummaryEl = document.getElementById('sell-step1-cart-summary');

    // --- Éléments Étape 2: Panier ---
    const cartItemsListStep2El = document.getElementById('sell-cart-items-list-step2');
    const cartEmptyMessageStep2El = document.getElementById('sell-cart-empty-message-step2');
    const totalItemsStep2El = document.getElementById('sell-cart-total-items-step2');
    const grandTotalStep2El = document.getElementById('sell-cart-grand-total-step2');
    const clearCartStep2Btn = document.getElementById('btn-clear-sell-cart-step2');
    const step2NextBtn = document.getElementById('btn-sell-step2-next');

    // --- Éléments Étape 3: Infos Client ---
    const customerNameInputEl = document.getElementById('sell-customer-name');
    const customerPhoneInputEl = document.getElementById('sell-customer-phone');
    // const step3NextBtn = document.getElementById('btn-sell-step3-next'); // Géré par nav globale

    // --- Éléments Étape 4: Récapitulatif & Validation ---
    const summaryCustomerNameEl = document.getElementById('summary-customer-name');
    const summaryCustomerPhoneEl = document.getElementById('summary-customer-phone');
    const summaryItemsListEl = document.getElementById('sell-summary-items-list-step4');
    const summaryTotalItemsEl = document.getElementById('summary-total-items');
    const summaryGrandTotalEl = document.getElementById('summary-grand-total');
    const validateSaleButtonStep4El = document.getElementById('btn-validate-sale-step4');

    // --- État et Données ---
    let userBooksCache = [];
    let salesCart = []; // [{ bookId, title, quantity, unitPrice, stock, suggestedPrice }, ...]
    let currentUserUID = null;

    // --- Fonctions du Wizard ---
    function showSellStep(stepNumber) {
        currentSellStep = parseInt(stepNumber, 10);
        sellSteps.forEach(step => {
            step.classList.toggle('active', parseInt(step.dataset.step, 10) === currentSellStep);
        });
        // Logique spécifique à l'affichage d'une étape
        if (currentSellStep === 1) {
            renderStep1CartSummary();
            step1NextBtn.disabled = salesCart.length === 0;
        } else if (currentSellStep === 2) {
            renderSalesCartForStep2(); // Afficher le panier éditable
            step2NextBtn.disabled = salesCart.length === 0;
        } else if (currentSellStep === 4) {
            renderSalesSummaryForStep4(); // Afficher le récapitulatif final
            validateSaleButtonStep4El.disabled = salesCart.length === 0;
        }
        sellPageEl.scrollTop = 0; // Scroll to top of the main sell page container
        const activeStepContent = sellPageEl.querySelector(`.sell-step[data-step="${currentSellStep}"] .sell-step-content`);
        if(activeStepContent) activeStepContent.scrollTop = 0; // Scroll to top of step content

    }

    sellPageEl.addEventListener('click', function(e) {
        const targetPrev = e.target.closest('.btn-sell-secondary[data-target-step]');
        const targetNext = e.target.closest('.btn-sell-primary[data-target-step]');

        if (targetPrev) {
            showSellStep(targetPrev.dataset.targetStep);
        } else if (targetNext) {
            if (currentSellStep === 1 && salesCart.length === 0) {
                showFeedback("Veuillez ajouter au moins un livre au panier.", true, 2000);
                return;
            }
            if (currentSellStep === 2 && salesCart.length === 0) {
                showFeedback("Le panier est vide.", true, 2000);
                return;
            }
            showSellStep(targetNext.dataset.targetStep);
        }
    });


    // --- Authentification et Chargement Initial ---
    auth.onAuthStateChanged(user => {
        if (user) {
            currentUserUID = user.uid;
            loadUserBooks();
        } else {
            currentUserUID = null;
            userBooksCache = [];
            salesCart = [];
            if (document.getElementById('sell')?.classList.contains('visible')) {
                resetSellPage(); 
            }
        }
    });

    async function loadUserBooks() {
        if (!currentUserUID) return;
        try {
            const snapshot = await db.collection('users').doc(currentUserUID).collection('books').get();
            userBooksCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            if(currentSellStep === 1) filterAndRenderBookResults();
        } catch (error) {
            console.error("Erreur de chargement des livres de l'utilisateur:", error);
            showFeedback("Erreur de chargement des livres.", true);
            userBooksCache = [];
        }
    }

    // --- Étape 1: Fonctions de Sélection de Livres ---
    searchInputSellEl.addEventListener('input', filterAndRenderBookResults);

    function filterAndRenderBookResults() {
        const searchTerm = searchInputSellEl.value.trim().toLowerCase();
        if (!searchTerm && userBooksCache.length > 0) { 
            searchResultsContainerEl.innerHTML = '<p class="no-results">Entrez un terme pour rechercher dans votre stock.</p>';
            return;
        }
        if (!userBooksCache.length && !searchTerm){ 
            searchResultsContainerEl.innerHTML = '<p class="no-results">Votre stock est vide ou non chargé. Commencez par rechercher.</p>';
            return;
        }

        const filteredBooks = userBooksCache.filter(book =>
            book.title.toLowerCase().includes(searchTerm) && book.quantity > 0
        );
        renderSearchResults(filteredBooks);
    }

    function renderSearchResults(books) {
        searchResultsContainerEl.innerHTML = '';
        if (books.length === 0) {
            searchResultsContainerEl.innerHTML = '<p class="no-results">Aucun livre trouvé ou en stock pour cette recherche.</p>';
            return;
        }
        books.forEach(book => {
            const card = document.createElement('div');
            card.className = 'book-card-sell';
            const isAdded = salesCart.some(item => item.bookId === book.id);
            card.innerHTML = `
                <div class="info">
                    <div class="title">${book.title}</div>
                    <div class="details">
                        Stock: ${book.quantity} | Prix Sugg.: <span class="price">${(book.price || 0).toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0})}</span>
                    </div>
                </div>
                <button class="btn-add-to-sell-cart ${isAdded ? 'added' : ''}" data-book-id="${book.id}" aria-label="Ajouter au panier de vente">
                    <i class="bi ${isAdded ? 'bi-check-lg' : 'bi-plus-circle-fill'}"></i>
                </button>
            `;
            const addButton = card.querySelector('.btn-add-to-sell-cart');
            addButton.addEventListener('click', () => {
                if (!salesCart.some(item => item.bookId === book.id)) { 
                    addBookToSalesCart(book, addButton);
                } else {
                    showFeedback(`"${book.title}" est déjà dans le panier.`, false, 1500);
                }
            });
            searchResultsContainerEl.appendChild(card);
        });
    }

    function addBookToSalesCart(book, buttonElement) {
        if (salesCart.some(item => item.bookId === book.id)) {
            showFeedback(`"${book.title}" est déjà dans le panier. Modifiez la quantité si besoin.`, false, 2000);
            return;
        }
        if (book.quantity <= 0) {
            showFeedback(`"${book.title}" est en rupture de stock.`, true);
            return;
        }

        salesCart.push({
            bookId: book.id,
            title: book.title,
            quantity: 1,
            unitPrice: book.price || 0,
            stock: book.quantity,
            suggestedPrice: book.price || 0
        });

        if (buttonElement) {
            buttonElement.classList.add('added');
            buttonElement.innerHTML = '<i class="bi bi-check-lg"></i>';
        }
        showFeedback(`"${book.title}" ajouté au panier.`, false, 1500);
        step1NextBtn.disabled = salesCart.length === 0;
        renderStep1CartSummary();
    }

    function renderStep1CartSummary() {
        if (salesCart.length === 0) {
            step1CartSummaryEl.textContent = 'Panier de vente vide.';
        } else {
            const totalItems = salesCart.reduce((sum, item) => sum + item.quantity, 0);
            const grandTotal = salesCart.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
            step1CartSummaryEl.textContent = `${totalItems} article(s) dans le panier - Total: ${grandTotal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0})}`;
        }
    }

    // --- Étape 2: Fonctions de Gestion du Panier ---
    function renderSalesCartForStep2() {
        cartItemsListStep2El.innerHTML = '';
        if (salesCart.length === 0) {
            cartEmptyMessageStep2El.style.display = 'block';
        } else {
            cartEmptyMessageStep2El.style.display = 'none';
            salesCart.forEach((item, index) => {
                const listItem = document.createElement('div');
                listItem.className = 'sell-cart-item';
                listItem.setAttribute('data-index', index);

                listItem.innerHTML = `
                    <span class="title" title="${item.title}">${item.title}</span>
                    <input type="number" class="quantity" value="${item.quantity}" min="1" max="${item.stock}" data-index="${index}" aria-label="Quantité pour ${item.title}">
                    <input type="number" class="price" value="${item.unitPrice.toFixed(0)}" step="50" min="0" data-index="${index}" aria-label="Prix de vente pour ${item.title}">
                    <span class="subtotal" data-index="${index}">${(item.quantity * item.unitPrice).toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0})}</span>
                    <button class="remove-item-btn" data-index="${index}" aria-label="Supprimer ${item.title}"><i class="bi bi-trash-fill"></i></button>
                `;

                const quantityInput = listItem.querySelector('.quantity');
                const priceInput = listItem.querySelector('.price');

                // Pour le champ QUANTITÉ: Sélectionner le contenu au focus pour remplacement facile
                quantityInput.addEventListener('focus', (e) => {
                    e.target.select();
                });

                // Pour le champ PRIX:
                priceInput.addEventListener('focus', (e) => {
                    if (e.target.value === '0') {
                        e.target.value = ''; // Effacer si c'est "0"
                    } else {
                        e.target.select(); // Sinon, sélectionner pour remplacement facile
                    }
                });

                // Écouteurs pour la mise à jour des données
                quantityInput.addEventListener('input', (e) => {
                    updateCartItemQuantity(index, parseInt(e.target.value));
                });
                priceInput.addEventListener('input', (e) => {
                    updateCartItemPrice(index, parseFloat(e.target.value));
                });

                listItem.querySelector('.remove-item-btn').addEventListener('click', () => removeCartItem(index));
                cartItemsListStep2El.appendChild(listItem);
            });
        }
        updateCartSummaryForStep2();
        step2NextBtn.disabled = salesCart.length === 0;
    }
    function updateCartItemQuantity(index, newQuantityFromInput) {
        const item = salesCart[index];
        if (!item) return;

        let validatedQuantity = newQuantityFromInput;

        if (isNaN(validatedQuantity) || validatedQuantity < 1) {
            validatedQuantity = 1;
        } else if (validatedQuantity > item.stock) {
            validatedQuantity = item.stock;
            showFeedback(`Stock maximum pour "${item.title}" est ${item.stock}.`, true, 2000);
        }
       
        const quantityInputEl = cartItemsListStep2El.querySelector(`input.quantity[data-index="${index}"]`);
        // Vérifier si une mise à jour est réellement nécessaire pour éviter des opérations DOM inutiles
        if (item.quantity === validatedQuantity && quantityInputEl && parseInt(quantityInputEl.value) === validatedQuantity) {
            return; 
        }

        item.quantity = validatedQuantity;

        if (quantityInputEl && parseInt(quantityInputEl.value) !== validatedQuantity) {
             quantityInputEl.value = validatedQuantity; 
        }
       
        const subtotalEl = cartItemsListStep2El.querySelector(`span.subtotal[data-index="${index}"]`);
        if (subtotalEl) {
            subtotalEl.textContent = (item.quantity * item.unitPrice).toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
        }

        updateCartSummaryForStep2(); 
        renderStep1CartSummary();   
    }

    function updateCartItemPrice(index, newPriceFromInput) {
        const item = salesCart[index];
        if (!item) return;

        let validatedPrice = newPriceFromInput;

        if (isNaN(validatedPrice) || validatedPrice < 0) {
            validatedPrice = 0;
        }
       
        const priceInputEl = cartItemsListStep2El.querySelector(`input.price[data-index="${index}"]`);
        // Vérifier si une mise à jour est réellement nécessaire
        if (item.unitPrice === validatedPrice && priceInputEl && parseFloat(priceInputEl.value) === validatedPrice) {
            // Pour les flottants, une comparaison exacte peut être délicate: Math.abs(item.unitPrice - validatedPrice) < EPSILON
            // Mais ici, avec toFixed(0) et step 50, la comparaison directe est souvent suffisante.
            return; 
        }

        item.unitPrice = validatedPrice;
       
        // Si l'input contenait qqch qui n'est pas un nombre (ex: "abc", parseFloat donne NaN, validatedPrice devient 0)
        // ou si l'input était un nombre invalide (ex: négatif), on le corrige.
        if (priceInputEl) {
            const currentInputValue = parseFloat(priceInputEl.value);
            if (isNaN(currentInputValue) || currentInputValue < 0 || currentInputValue.toFixed(0) !== validatedPrice.toFixed(0) ) {
                // On ne met à jour l'input que s'il est invalide ou si la valeur validée est différente
                // pour ne pas perturber la saisie en cours (ex: 15 vs 150)
                // Si l'utilisateur efface le champ, parseFloat(e.target.value) sera NaN, et validatedPrice 0.
                // Il est souhaitable de mettre à jour l'input à '0' dans ce cas.
                if (isNaN(currentInputValue) || currentInputValue < 0) {
                    priceInputEl.value = validatedPrice.toFixed(0);
                }
                // Si on veut que le formatage toFixed(0) se fasse toujours, même pour 150 -> 150:
                // priceInputEl.value = validatedPrice.toFixed(0); 
            }
        }

        const subtotalEl = cartItemsListStep2El.querySelector(`span.subtotal[data-index="${index}"]`);
        if (subtotalEl) {
            subtotalEl.textContent = (item.quantity * item.unitPrice).toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
        }
       
        updateCartSummaryForStep2();
        renderStep1CartSummary();
    }

    function removeCartItem(index) {
        const item = salesCart[index];
        if(!item) return;

        salesCart.splice(index, 1);
        if (item) showFeedback(`"${item.title}" retiré du panier.`, false, 1500);
       
        renderSalesCartForStep2(); // OK ici, la perte de focus n'est pas un enjeu pour une suppression.
                                    // Et la gestion des index DOM est simplifiée.
       
        step1NextBtn.disabled = salesCart.length === 0; 
        const searchResultButton = searchResultsContainerEl.querySelector(`.btn-add-to-sell-cart[data-book-id="${item.bookId}"]`);
        if (searchResultButton) {
            searchResultButton.classList.remove('added');
            searchResultButton.innerHTML = '<i class="bi bi-plus-circle-fill"></i>';
        }
        renderStep1CartSummary();
    }

    function updateCartSummaryForStep2() {
        let totalQty = 0;
        let currentGrandTotal = 0;
        salesCart.forEach(item => {
            totalQty += item.quantity;
            currentGrandTotal += item.quantity * item.unitPrice;
        });
        totalItemsStep2El.textContent = totalQty;
        grandTotalStep2El.textContent = currentGrandTotal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
    }

    clearCartStep2Btn.addEventListener('click', () => {
        if (salesCart.length > 0) {
            // Remplacer window.confirm par une modale custom si possible
            // Pour l'instant, on vide sans confirmation pour éviter le blocage de `confirm`
            salesCart = [];
            renderSalesCartForStep2(); // OK ici.
            showFeedback("Panier de vente vidé.", false, 1500);
            step1NextBtn.disabled = true; 
            searchResultsContainerEl.querySelectorAll('.btn-add-to-sell-cart.added').forEach(btn => {
                btn.classList.remove('added');
                btn.innerHTML = '<i class="bi bi-plus-circle-fill"></i>';
            });
            renderStep1CartSummary();
        }
    });


    // --- Étape 4: Fonctions de Récapitulatif et Validation ---
    function renderSalesSummaryForStep4() {
        const customerName = customerNameInputEl.value.trim() || "N/A";
        const customerPhone = customerPhoneInputEl.value.trim() || "N/A";
        summaryCustomerNameEl.textContent = customerName;
        summaryCustomerPhoneEl.textContent = customerPhone;

        summaryItemsListEl.innerHTML = '';
        let totalQty = 0;
        let grandTotal = 0;

        if (salesCart.length === 0) {
            summaryItemsListEl.innerHTML = '<p style="text-align:center; color:var(--secondary-text);">Panier vide.</p>';
        } else {
            salesCart.forEach(item => {
                const itemTotal = item.quantity * item.unitPrice;
                totalQty += item.quantity;
                grandTotal += itemTotal;
                const summaryItemDiv = document.createElement('div');
                summaryItemDiv.className = 'summary-item';
                summaryItemDiv.innerHTML = `
                    <span class="title">${item.title}</span>
                    <span class="qty-price">${item.quantity} x ${item.unitPrice.toLocaleString('fr-FR',{style:'currency', currency:'XOF', minimumFractionDigits:0})}</span>
                    <span class="line-total">${itemTotal.toLocaleString('fr-FR',{style:'currency', currency:'XOF', minimumFractionDigits:0})}</span>
                `;
                summaryItemsListEl.appendChild(summaryItemDiv);
            });
        }
        summaryTotalItemsEl.textContent = totalQty;
        summaryGrandTotalEl.textContent = grandTotal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
        validateSaleButtonStep4El.disabled = salesCart.length === 0;
    }

    validateSaleButtonStep4El.addEventListener('click', async () => {
        if (salesCart.length === 0) {
            showFeedback("Le panier est vide. Ajoutez des articles pour valider la vente.", true);
            return;
        }
        validateSaleButtonStep4El.disabled = true;
        validateSaleButtonStep4El.innerHTML = '<i class="bi bi-hourglass-split"></i> Validation en cours...';
        showFeedback("Traitement de la vente...", false);

        const batch = db.batch();
        const salesDataItems = [];
        let grandTotalSaleAmount = 0;
        const customerName = customerNameInputEl.value.trim();
        const customerPhone = customerPhoneInputEl.value.trim();

        for (const item of salesCart) {
            const bookRef = db.collection('users').doc(currentUserUID).collection('books').doc(item.bookId);
             if (item.quantity > item.stock) { 
                showFeedback(`Stock insuffisant pour "${item.title}" (${item.quantity} demandé(s), ${item.stock} en stock). Vente annulée. Mettez à jour le panier.`, true, 5000);
                validateSaleButtonStep4El.disabled = false;
                validateSaleButtonStep4El.innerHTML = '<i class="bi bi-check-circle-fill"></i> Valider la Vente';
                showSellStep(2); 
                return;
            }
            batch.update(bookRef, { quantity: firebase.firestore.FieldValue.increment(-item.quantity) });
            salesDataItems.push({
                bookId: item.bookId, title: item.title, quantitySold: item.quantity,
                unitPriceSold: item.unitPrice, lineTotal: item.quantity * item.unitPrice
            });
            grandTotalSaleAmount += item.quantity * item.unitPrice;
        }

        const saleRef = db.collection('users').doc(currentUserUID).collection('sales').doc();
        batch.set(saleRef, {
            timestamp: firebase.firestore.FieldValue.serverTimestamp(),
            customerName: customerName || "N/A", customerPhone: customerPhone || "N/A",
            items: salesDataItems, grandTotalAmount: grandTotalSaleAmount,
            totalItemsSold: salesCart.reduce((sum, item) => sum + item.quantity, 0)
        });

        try {
            await batch.commit();
            showFeedback("Vente enregistrée avec succès !", false, 3000);
            // resetSellPage(); // Est appelé par l'observer ou après fermeture
            loadUserBooks(); 
            const closeBtn = sellPageEl.querySelector('.btn-close-sell');
            if (closeBtn) {
                // Simuler un clic pour que le routeur global gère la navigation vers "home"
                // et que l'observer sur #sell fasse le reset.
                closeBtn.click();
            } else { // Fallback si le bouton n'est pas trouvé pour une raison quelconque
                resetSellPage();
                location.hash = "home";
            }


        } catch (error) {
            console.error("Erreur lors de la validation de la vente:", error);
            showFeedback("Erreur: " + error.message + ". Veuillez réessayer.", true, 5000);
            validateSaleButtonStep4El.disabled = salesCart.length === 0;
            validateSaleButtonStep4El.innerHTML = '<i class="bi bi-check-circle-fill"></i> Valider la Vente';
        }
    });

    // --- Fonctions Générales et Réinitialisation ---
    function resetSellPage() {
        salesCart = [];
        searchInputSellEl.value = '';
        customerNameInputEl.value = '';
        customerPhoneInputEl.value = '';
        searchResultsContainerEl.innerHTML = '<p class="no-results">Commencez par rechercher un livre.</p>';
        showSellStep(1); 
        renderStep1CartSummary();
        renderSalesCartForStep2(); 
        renderSalesSummaryForStep4(); 
        step1NextBtn.disabled = true;
        step2NextBtn.disabled = true;
        validateSaleButtonStep4El.disabled = true;
        // Le feedback message est géré par son propre timeout
    }

    let feedbackTimeout;
    function showFeedback(message, isError = false, duration = 3000) {
        clearTimeout(feedbackTimeout);
        feedbackMessageEl.textContent = message;
        feedbackMessageEl.className = isError ? 'error' : 'success';
        feedbackMessageEl.style.display = 'block'; // Assurez-vous qu'il est visible
        feedbackTimeout = setTimeout(() => {
            feedbackMessageEl.textContent = '';
            feedbackMessageEl.className = '';
            feedbackMessageEl.style.display = 'none'; // Cachez-le après le délai
        }, duration);
    }

    // Observer pour réinitialiser la page si elle devient visible (géré par routeur)
    const sellPageObserver = new MutationObserver((mutationsList) => {
        for (const mutation of mutationsList) {
            if (mutation.type === 'attributes' && mutation.attributeName === 'class') {
                if (sellPageEl.classList.contains('visible')) {
                    if (currentUserUID && userBooksCache.length === 0) {
                         loadUserBooks(); 
                    }
                    resetSellPage(); 
                } else {
                    clearTimeout(feedbackTimeout); 
                    feedbackMessageEl.textContent = '';
                    feedbackMessageEl.className = '';
                    feedbackMessageEl.style.display = 'none';
                }
            }
        }
    });
    sellPageObserver.observe(sellPageEl, { attributes: true });

  })();
  </script>
</main>

<main id="supply" class="page">
  <style>
    /* === Styles Approvisionnement (Updated) === */
    header#supply-header {
      padding: 1rem;
      background: #fff; /* Fond pour le sticky header */
      border-bottom: 1px solid var(--border-color); /* Séparation pour le sticky header */
      position: -webkit-sticky; /* Pour Safari */
      position: sticky;
      top: 0; /* Se colle en haut de la zone de défilement (main#supply) */
      z-index: 15; /* S'assurer qu'il est au-dessus du contenu de la page mais en dessous des modales/nav */
    }
    header#supply-header h2 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary-text);
    }

    main#supply .books-list { /* This is #supply-list */
        display: flex;
        flex-direction: column;
        gap: 1rem; /* Space between cards */
        padding: 1rem; /* Padding around the entire list */
    }

    main#supply .skeleton-batch-card {
        background: #f9f9f9; /* Slightly lighter skeleton */
        height: 120px; /* Adjusted height to better match potential card content */
        margin: 0; /* Relies on .books-list gap for vertical spacing and padding for horizontal */
        border-radius: 0.75rem; /* Match new card radius */
        animation: pulse 1.5s infinite ease-in-out;
    }

    main#supply .supply-batch-card {
        background: #ffffff;
        border: 1px solid var(--border-color); /* Slightly softer border */
        border-radius: 0.75rem; /* More rounded corners */
        margin: 0; /* Relies on .books-list gap and padding */
        padding: 1rem;
        box-shadow: none; /* NO SHADOW */
        display: flex; /* Use flex for internal layout */
        flex-direction: column; /* Stack header and ul */
        gap: 0.75rem; /* Space between header and ul */
    }

    main#supply .supply-batch-card header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start; /* Align to top */
        padding-bottom: 0.5rem;
        border-bottom: 1px solid #efefef; /* Lighter border */
    }

    main#supply .supply-batch-card header .supplier-info {
        flex-grow: 1; /* Takes available width */
        margin-right: 0.75rem; /* Space to the right */
    }

    main#supply .supply-batch-card header .supplier-info strong { /* Supplier Name */
        font-size: 1.1rem; /* Slightly larger */
        font-weight: 600;
        color: var(--primary-text);
        display: block;
        margin-bottom: 0.2rem;
    }

    main#supply .supply-batch-card header .supplier-info small { /* Date */
        font-size: 0.8rem;
        color: var(--secondary-text);
        display: block;
    }

    main#supply .supply-batch-card header .batch-meta {
        text-align: right;
        flex-shrink: 0; /* Don't shrink */
    }

    main#supply .supply-batch-card header .batch-meta .batch-total { /* Total XOF */
        font-size: 1.05rem;
        font-weight: 700; /* Bold */
        color: var(--ebay-green); /* Accent color for total */
        display: block;
    }

    main#supply .supply-batch-card ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.5rem; /* Space between list items */
    }

    main#supply .supply-batch-card li {
        font-size: 0.9rem;
        color: var(--primary-text);
        padding: 0.4rem 0; /* Reduced padding as gap is used in ul */
        display: flex;
        justify-content: space-between;
        align-items: flex-start; /* Align items to start for multi-line details */
        gap: 0.5rem; /* Space between title and details block */
    }

    main#supply .supply-batch-card li .item-title {
        flex-grow: 1;
        font-weight: 500;
        line-height: 1.4;
        margin-right: 0.5rem; /* Ensure space if details are short */
    }

    main#supply .supply-batch-card li .item-details {
        font-size: 0.8rem;
        color: var(--secondary-text);
        text-align: right;
        flex-shrink: 0;
        line-height: 1.4;
    }

    main#supply .supply-batch-card li .item-details span {
        display: block; /* Each piece of detail on a new line */
    }
    main#supply .supply-batch-card li .item-details .item-line-total {
        font-weight: 500;
        color: var(--primary-text); /* Make line total stand out a bit */
        margin-top: 0.15rem;
    }

    /* Floating Action Button - Styles from original code */
    .fab {
      position: fixed;
      bottom: calc(56px + env(safe-area-inset-bottom) + 1rem);
      right: 1rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--ebay-green);
      color: #fff;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: none; /* NO SHADOW */
      border: 1px solid #6a9a10; /* Darker green border if shadow removed */
      z-index: 30; 
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .fab:active {
      background: #5ea83a; /* Darker green on active */
    }

    /* .search-noresult is defined in new-supply, keep it there or make global if needed */
  </style>

  <header id="supply-header">
    <h2>Approvisionnement</h2>
  </header>

  <div id="supply-list" class="books-list">
    </div>

  <button id="btn-new-supply" class="fab" aria-label="Nouvel approvisionnement">
    <i class="bi bi-plus-lg"></i>
  </button>

  <script>
    document.getElementById('btn-new-supply')
      .addEventListener('click', () => {
        location.hash = 'new-supply';
      });
  </script>
  <script>
  auth.onAuthStateChanged(user => {
    if (!user) {
      // return window.location.replace('login.html'); // Router handles this
      return;
    }

    const suppliesRef = db
      .collection('users')
      .doc(user.uid)
      .collection('supplies')
      .orderBy('date', 'desc');

    const supplyListEl = document.getElementById('supply-list');
    let unsubscribeSupplies; // Keep track of listener

    // Function to setup listener, called when #supply is active
    function setupSupplyListener() {
        if (unsubscribeSupplies) unsubscribeSupplies(); // Unsubscribe from previous if any

        supplyListEl.innerHTML = Array(3)
          .fill('')
          .map(() => '<div class="skeleton-batch-card"></div>')
          .join('');

        unsubscribeSupplies = suppliesRef.onSnapshot(snapshot => {
          supplyListEl.innerHTML = ''; 

          if (snapshot.empty) {
            supplyListEl.innerHTML = '<p style="padding:1rem;color:#555;text-align:center;">Aucun approvisionnement pour l’instant.</p>';
            return;
          }

          snapshot.forEach(doc => {
            const supply = doc.data();
            const dateObj = supply.date?.toDate() || new Date();
            const dateStr = dateObj.toLocaleDateString('fr-FR', {
              day: '2-digit', month: '2-digit', year: 'numeric'
            });

            const totalBatch = supply.lines.reduce((sum, l) => sum + (l.quantity * l.unitCost), 0);
            const batchCard = document.createElement('div');
            batchCard.className = 'supply-batch-card';
           
            batchCard.innerHTML = `
              <header>
                <div class="supplier-info">
                  <strong>${supply.supplierName || 'N/A'}</strong>
                  <small>${dateStr}</small>
                </div>
                <div class="batch-meta">
                  <span class="batch-total">${totalBatch.toLocaleString('fr-FR', {
                    style: 'currency', currency: 'XOF', minimumFractionDigits: 0
                  })}</span>
                </div>
              </header>
              <ul>
                ${supply.lines.map(line => {
                  const lineTotal = (line.quantity || 0) * (line.unitCost || 0);
                  return `<li>
                            <span class="item-title">${line.title || 'Titre inconnu'}</span>
                            <span class="item-details">
                              <span>Qté: ${line.quantity || 0}</span>
                              <span>PU: ${(line.unitCost || 0).toLocaleString('fr-FR',{ style:'currency', currency:'XOF', minimumFractionDigits: 0 })}</span>
                              <span class="item-line-total">Total: ${lineTotal.toLocaleString('fr-FR',{ style:'currency', currency:'XOF', minimumFractionDigits: 0 })}</span>
                            </span>
                          </li>`;
                }).join('')}
              </ul>
            `;
            supplyListEl.appendChild(batchCard);
          });
        }, err => {
          console.error('Erreur Firestore supplies :', err);
          supplyListEl.innerHTML = '<p style="padding:1rem;color:#e53238;text-align:center;">Erreur de chargement des approvisionnements.</p>';
        });
    }
   
    // Function to cleanup listener
    function cleanupSupplyListener() {
        if (unsubscribeSupplies) {
          // console.log('Unsubscribing from supplies listener as page changed from #supply');
          unsubscribeSupplies();
          unsubscribeSupplies = null;
        }
    }

    // Listen to hash changes to setup/cleanup listener
    // This is part of the SPA behavior managed by the main router
    // The router should call these functions when appropriate
    window.addEventListener('hashchange', () => {
        if (location.hash === '#supply') {
            if (auth.currentUser) setupSupplyListener(); // Only if user is logged in
        } else {
            cleanupSupplyListener();
        }
    });
    // Initial check in case the page loads on #supply
     if (location.hash === '#supply') {
        if (auth.currentUser) setupSupplyListener();
    }
    // Also, on auth state change, if already on #supply, setup listener
    // This is somewhat redundant if hashchange handles it, but good for initial load
    // The main router logic should ideally handle this when calling showOnlyPage for #supply

  });
</script>
</main>

<main id="new-supply" class="page">
  <style>
    /* :root {} */ 
    #new-supply {display:none;flex-direction:column;height:100vh;background:var(--surface)}
    #new-supply.visible{display:flex}

    .step{display:none;flex:1;padding:1rem 1rem calc(56px + env(safe-area-inset-bottom) + 50px); /* Added 50px for wizard nav */}
    .step.active{display:flex;flex-direction:column}
    #new-supply h2{font-size:1.25rem;font-weight:500;margin-bottom:1rem} /* Specific to h2 in new-supply steps */

    .form-group{margin-bottom:1rem}
    #new-supply label{font-size:.9rem;color:var(--secondary-text);margin-bottom:.25rem;display:block} /* Specific to new-supply labels */
    #new-supply input[type=text], #new-supply input[type=number], #new-supply input[type=search]{
      width:100%;padding:.8rem;border:1px solid var(--border-color);border-radius:var(--border-radius-card);
      font-size:1rem;outline:none; box-shadow: none;
    }

    .line-row{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;margin-bottom:.6rem}
    .book-search-wrap{position:relative;flex:1 1 100%}
    .line-qty,.line-cost{flex:1 1 calc(50% - .3rem);min-width:110px}
    .line-total{font-weight:600;margin-left:auto}
    .remove-line{background:none;border:none;font-size:1.4rem;color:#e53935; cursor: pointer;}

    #new-supply .fab{ 
        position:fixed;
        right:1rem;
        bottom:calc(env(safe-area-inset-bottom) + 1rem + 50px + 1rem); /* 50px wizard nav, 1rem spacing */
        width:56px;height:56px;
        border-radius:50%;background:var(--accent);color:#fff;border:none;font-size:1.7rem;
        display:flex;align-items:center;justify-content:center;
        box-shadow:none; border: 1px solid #0052a3; /* No shadow, add border */
        z-index:40
    }

    .wizard-nav{position:fixed;left:0;bottom:env(safe-area-inset-bottom);width:100%;
      display:flex;gap:.6rem;padding:.7rem 1rem;background:var(--surface);
      box-shadow:none; border-top: 1px solid var(--border-color); /* No shadow, add border */
      z-index: 50; 
      transition: bottom 0.2s ease-out; 
    }
    .btn{flex:1;padding:.8rem;font-size:1rem;font-weight:500;border:none;border-radius:var(--border-radius-card); cursor: pointer; box-shadow:none;}
    .btn.primary{background:var(--accent);color:#fff}.btn.primary:disabled{background:#bfc8d7; cursor: not-allowed;}
    .btn.secondary{background:#f5f5f5; border: 1px solid var(--border-color);}.btn.secondary:disabled{opacity:.6; cursor: not-allowed;}

    .summary{padding:1rem;background:#f9f9f9;border-radius:var(--border-radius-card);margin-bottom:1rem; border: 1px solid var(--border-color); box-shadow:none;}
    .summary div{margin-bottom:.3rem}

    .line-row .book-search {
      background:#f4f4f4;  
      cursor:pointer;    
    }
    .line-row .book-search[readonly]{
      caret-color:transparent;
    }

    .step[data-step="3"] { display: none; flex-direction: column; }
    .step[data-step="3"].active { display: flex; }
    .step[data-step="3"] h2 { font-size: 1.3rem; text-align: center; margin-bottom: 1rem; }
    .step[data-step="3"] .form-group { margin-bottom: 1.5rem; }
    .step[data-step="3"] .form-group label { font-size: 0.9rem; color: var(--secondary-text); margin-bottom: 0.3rem; display: block; }
    .step[data-step="3"] .form-group input {
      width: 100%; padding: 0.8rem; font-size: 1rem;
      border: 1px solid var(--border-color); border-radius: var(--border-radius-card); box-shadow: none;
    }
    .step[data-step="3"] .cost-allocation-list { display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1.5rem; }
    .step[data-step="3"] .allocation-item {
      display: flex; justify-content: space-between; align-items: center;
      background: #f9f9f9; padding: 0.75rem 1rem; border-radius: var(--border-radius-card);
      border: 1px solid var(--border-color); box-shadow:none;
    }
    .step[data-step="3"] .allocation-item .item-label { font-size: 0.95rem; flex: 1; margin-right: 0.5rem; }
    .step[data-step="3"] .allocation-item .item-cost { font-size: 1rem; font-weight: 600; }

    .summary-cards { display: flex; flex-direction: column; gap: 1rem; }
    .summary-card {
      background: #fff; border: 1px solid var(--border-color);
      border-radius: 0.75rem; padding: 1rem; box-shadow: none;
    }
    .summary-card .line { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .summary-card .line:last-child { margin-bottom: 0; }
    .summary-card .line .left { display: flex; align-items: center; gap: 0.5rem; }
    .summary-card .icon { font-size: 1.1rem; color: var(--secondary-text); }
    .summary-card .icon.accent { color: var(--accent); }
    .summary-card .label { font-size: 0.9rem; color: var(--secondary-text); }
    .summary-card .value { font-size: 1rem; font-weight: 600; color: var(--primary-text); }
    .summary-card .value.accent { color: var(--accent); }
    .summary-card .line.total { border-top: 1px solid #f0f0f0; padding-top: 0.75rem; margin-top: 0.75rem; }
    .search-noresult { /* Style for "Add new book" chip */
      display: inline-flex;
      align-items: center;
      padding: 0.75rem 1rem;
      border-radius: var(--border-radius-pill);
      background: rgba(0,100,210,0.1);
      color: var(--accent);
      font-size: 1rem;
      line-height: 1.2;
      cursor: pointer;
      user-select: none;
      transition: background 0.2s;
      box-shadow: none;
      border: 1px solid rgba(0,100,210,0.2);
    }
    .search-noresult:active {
      background: rgba(0,100,210,0.2);
    }
    .search-noresult i {
      margin-left: 0.5rem;
      font-size: 1.3rem;
      color: var(--accent);
    }
  </style>

  <template id="tmpl-line">
    <div class="line-row" data-id="">
      <div class="book-search-wrap">
        <input type="text"
               class="book-search"
               placeholder="Choisir un livre"
               readonly   
               autocomplete="off"
               autocorrect="off"
               autocapitalize="none"
               spellcheck="false">
      </div>
      <input type="number" class="line-qty"  min="1" value="1" placeholder="Qté">
      <input type="number" class="line-cost" step="50" value="0" placeholder="PU"> <div class="line-total">XOF 0</div>
      <button type="button" class="remove-line" aria-label="Supprimer">×</button>
    </div>
  </template>

  <div class="step active" data-step="1">
    <h2>Fournisseur</h2>
    <div class="form-group">
      <label for="supplier-search">Nom du fournisseur</label>
      <input id="supplier-search" type="search" placeholder="Rechercher ou saisir" autocomplete="off"
             autocorrect="off" autocapitalize="none" spellcheck="false">
    </div>
    <div class="wizard-nav">
      <button class="btn secondary" data-next disabled>Suivant →</button>
    </div>
  </div>

  <div class="step" data-step="2">
    <h2>Articles</h2>
    <div id="lines-container" style="flex-grow: 1; overflow-y: auto;">
        </div>
    <button id="add-line-btn" class="fab" aria-label="Ajouter une ligne">+</button>
    <div class="wizard-nav">
      <button class="btn secondary" data-prev>← Précédent</button>
      <button class="btn primary"   data-next disabled>Suivant →</button>
    </div>
  </div>

    <div class="step" data-step="3">
    <h2>Allocation du coût d’achat</h2>
    <div class="form-group">
      <label for="additional-cost">Coût supplémentaire (XOF)</label>
      <input
        id="additional-cost"
        type="number"
        step="50" 
        min="0"
        placeholder="0"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
      >
    </div>
    <div class="cost-allocation-list" style="flex-grow: 1; overflow-y: auto;">
        </div>
    <div class="wizard-nav">
      <button class="btn secondary" data-prev>← Précédent</button>
      <button class="btn primary" data-next disabled>Suivant →</button>
    </div>
  </div>

    <div class="step" data-step="4">
    <h2>Résumé</h2>
    <div class="summary-cards" id="summary-cards-new-supply" style="flex-grow: 1; overflow-y: auto;"> </div>
    <div class="wizard-nav">
      <button class="btn secondary" data-prev>← Précédent</button>
      <button id="submit-supply" class="btn primary" disabled>Valider & envoyer</button>
    </div>
  </div>

  <script>
    (function(){
      const main      = document.getElementById('new-supply');
      const steps     = [...main.querySelectorAll('.step')];
      const supplierI = main.querySelector('#supplier-search');
      const linesC    = main.querySelector('#lines-container');
      const additionalCostI = main.querySelector('#additional-cost');
      const allocationList  = main.querySelector('.cost-allocation-list');
      const tmplLine  = document.getElementById('tmpl-line').content;
      const addLineBtn= main.querySelector('#add-line-btn');
      const submitBtn = main.querySelector('#submit-supply');

      let currentStep=1; 
      function showStep(n){
        steps.forEach(s=>s.classList.toggle('active',+s.dataset.step===n));
        const activeStepEl = steps.find(s => +s.dataset.step === n);
        if (activeStepEl) {
            const firstInput = activeStepEl.querySelector('input:not([type=hidden]):not([readonly]), textarea, select');
            if (firstInput) {
                setTimeout(() => firstInput.focus(), 50); 
            }
        }
      }

      main.addEventListener('click',e=>{
        if (e.target.matches('[data-next]:not([disabled])')) {
          currentStep++;
          if (currentStep === 3) { 
            if (!additionalCostI.value) {
                additionalCostI.value = "0";
            }
            additionalCostI.dispatchEvent(new Event('input', { bubbles: true }));
            const step3NextBtn = main.querySelector('[data-step="3"] [data-next]');
            if (step3NextBtn) step3NextBtn.disabled = parseFloat(additionalCostI.value) < 0;

          }
          if (currentStep === 4) updateSummary(); 
          showStep(currentStep);
        }
        if(e.target.matches('[data-prev]')){currentStep--;showStep(currentStep)}
      });
      showStep(currentStep);

      supplierI.addEventListener('input',()=>main.querySelector('[data-step="1"] [data-next]').disabled=!supplierI.value.trim());

      let lineIdCounter=0; 
      addLineBtn.addEventListener('click',()=>addLine());
     
      function addLine(data={}){
        lineIdCounter++;
        const row = document.importNode(tmplLine,true).firstElementChild;
        row.dataset.id=lineIdCounter;
        const bookI=row.querySelector('.book-search');
        bookI.addEventListener('click', () => {
          window.currentBookInput = bookI; 
          location.hash = 'select-book';
        });

        const qtyI =row.querySelector('.line-qty');
        const costI=row.querySelector('.line-cost');
        const totalEl=row.querySelector('.line-total'); 

        if(data.title)bookI.value=data.title;
        if(data.qty)  qtyI.value=data.qty;
        if(data.cost !== undefined) costI.value=data.cost; else costI.value = "0";


        function updateLineTotals(){ 
          const q=parseInt(qtyI.value,10)||0;
          const c=parseFloat(costI.value)||0;
          totalEl.textContent='XOF '+(q*c).toLocaleString('fr-FR', {minimumFractionDigits:0});
          toggleStep2Next(); 
        }
        qtyI.addEventListener('input',updateLineTotals);
        costI.addEventListener('input',updateLineTotals);
        bookI.addEventListener('change', updateLineTotals); // Use change for readonly field populated by modal

        row.querySelector('.remove-line').addEventListener('click',()=>{
          row.remove();
          toggleStep2Next();
          if (currentStep === 3) {
            additionalCostI.dispatchEvent(new Event('input', { bubbles: true }));
          } else if (currentStep === 4) {
            updateSummary();
          }
        });

        linesC.append(row);
        updateLineTotals(); 
        toggleStep2Next();
        // bookI.focus(); // Focus happens when user clicks to choose book
        if (linesC.children.length === 1 && !bookI.value) { // If it's the first line and no book yet
            setTimeout(() => bookI.click(), 100); // Auto-open book selection for the very first line
        } else if (bookI.value) { // If book is pre-filled, focus quantity
            qtyI.focus();
            qtyI.select();
        }
      }


    additionalCostI.addEventListener('input', () => {
      const addCost = parseFloat(additionalCostI.value) || 0;
      const rows = [...linesC.children];
      const totalQtyAllBooks = rows.reduce((sum, r) => {
        const q = parseInt(r.querySelector('.line-qty').value, 10) || 0;
        return sum + q;
      }, 0);

      const unitExtraCost = totalQtyAllBooks > 0 ? addCost / totalQtyAllBooks : 0;
      allocationList.innerHTML = ''; 

      rows.forEach(r => {
        const qtyInput      = r.querySelector('.line-qty');
        const costInput     = r.querySelector('.line-cost');
        const lineTotalEl = r.querySelector('.line-total');
        const bookSearchInput = r.querySelector('.book-search');

        const currentQty  = parseInt(qtyInput.value, 10) || 0;

        if (!costInput.dataset.baseCost) { 
          costInput.dataset.baseCost = costInput.value || "0";
        }
        const baseUnitCost = parseFloat(costInput.dataset.baseCost) || 0;
        const newUnitCostWithExtra = baseUnitCost + unitExtraCost;

        costInput.value = newUnitCostWithExtra.toFixed(0); // XOF no decimals for PU
        lineTotalEl.textContent = 'XOF ' + (currentQty * newUnitCostWithExtra).toLocaleString('fr-FR', {minimumFractionDigits:0});

        const extraCostForThisLineItem = currentQty * unitExtraCost;
        const title = bookSearchInput.value || 'Livre non spécifié';
        const div = document.createElement('div');
        div.className = 'allocation-item';
        div.innerHTML = `
          <div class="item-label">${title} (Qté: ${currentQty})</div>
          <div class="item-cost">+ ${extraCostForThisLineItem.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</div>
        `;
        allocationList.appendChild(div);
      });

      main.querySelector('[data-step="3"] [data-next]').disabled = addCost < 0 || rows.length === 0;
      if (rows.length > 0 && addCost >= 0) {
         updateSummary(); 
      }
    });

    function updateSummary() {
      const rows = [...linesC.children];
      const summaryCardsContainer = document.getElementById('summary-cards-new-supply'); // Use updated ID
      summaryCardsContainer.innerHTML = ''; 

      const supplierName = supplierI.value.trim() || 'Non spécifié';
      const additionalCostTotal = parseFloat(additionalCostI.value) || 0;
     
      let grandTotalQty = 0;

      const generalInfoCard = document.createElement('div');
      generalInfoCard.className = 'summary-card';
      generalInfoCard.innerHTML = `
        <div class="line">
            <div class="left"><i class="bi bi-person-fill icon"></i><span class="label">Fournisseur</span></div>
            <span class="value">${supplierName}</span>
        </div>
        <div class="line">
            <div class="left"><i class="bi bi-cash-stack icon accent"></i><span class="label">Coût Supp. Total</span></div>
            <span class="value accent">${additionalCostTotal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
        </div>
      `;
      summaryCardsContainer.appendChild(generalInfoCard);

      rows.forEach(r => {
        const title = r.querySelector('.book-search').value || 'Livre N/A';
        const qty   = parseInt(r.querySelector('.line-qty').value,10) || 0;
        const unitCostFinal = parseFloat(r.querySelector('.line-cost').value) || 0;  
        const lineTotal = unitCostFinal * qty;

        grandTotalQty += qty;
        const baseUnitCost = parseFloat(r.querySelector('.line-cost').dataset.baseCost || "0");
        const extraPerUnitForThisItem = unitCostFinal - baseUnitCost;

        const card = document.createElement('div');
        card.className = 'summary-card';
        card.innerHTML = `
          <div class="line">
            <div class="left"><i class="bi bi-book-fill icon"></i><span class="label">Article</span></div>
            <span class="value" style="text-align: right;">${title}</span>
          </div>
          <div class="line">
            <div class="left"><i class="bi bi-tags-fill icon"></i><span class="label">PU de base</span></div>
            <span class="value">${baseUnitCost.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
          </div>
          <div class="line">
            <div class="left"><i class="bi bi-plus-slash-minus icon"></i><span class="label">Part Coût Supp./Unité</span></div>
            <span class="value">${extraPerUnitForThisItem.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
          </div>
            <div class="line">
            <div class="left"><i class="bi bi-currency-exchange icon accent"></i><span class="label">PU Final</span></div>
            <span class="value accent">${unitCostFinal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
          </div>
          <div class="line">
            <div class="left"><i class="bi bi-list-ol icon"></i><span class="label">Qté</span></div>
            <span class="value">${qty}</span>
          </div>
          <div class="line total">
            <div class="left"><i class="bi bi-check-circle-fill icon accent"></i><span class="label">Total Ligne</span></div>
            <span class="value accent">${lineTotal.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
          </div>
        `;
        summaryCardsContainer.appendChild(card);
      });
     
      const finalTotalCard = document.createElement('div');
      finalTotalCard.className = 'summary-card';
      const actualGrandTotalCost = rows.reduce((sum, r) => {
          const qty = parseInt(r.querySelector('.line-qty').value,10) || 0;
          const finalPU = parseFloat(r.querySelector('.line-cost').value) || 0;
          return sum + (qty * finalPU);
      },0);

      finalTotalCard.innerHTML = `
        <div class="line" style="border-top: 1px solid #ccc; padding-top: 0.5rem; margin-top:0.5rem;">
            <div class="left"><i class="bi bi-calculator-fill icon"></i><span class="label">Quantité Totale d'articles</span></div>
            <span class="value" style="font-weight: bold;">${grandTotalQty}</span>
        </div>
        <div class="line total">
            <div class="left"><i class="bi bi-receipt-cutoff icon accent"></i><span class="label">Coût Total Appro.</span></div>
            <span class="value accent" style="font-size: 1.2rem; font-weight: bold;">${actualGrandTotalCost.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits: 0})}</span>
        </div>
      `;
      summaryCardsContainer.appendChild(finalTotalCard);
      submitBtn.disabled = rows.length === 0 || !supplierI.value.trim();
    }

    function toggleStep2Next() {
      const step2NextBtn = main.querySelector('[data-step="2"] [data-next]');
      if(step2NextBtn) {
          step2NextBtn.disabled = linesC.children.length === 0 || 
            [...linesC.children].some(row => !row.querySelector('.book-search').value.trim());
      }
    }

      submitBtn.addEventListener('click',async()=>{
        submitBtn.disabled=true;
        submitBtn.textContent = 'Envoi en cours...';
        const user=auth.currentUser;
        if (!user) {
          // Remplacer alert par une modale custom ou un message dans l'UI
          console.error("Utilisateur non connecté. Veuillez vous reconnecter.");
          // alert("Utilisateur non connecté. Veuillez vous reconnecter."); 
          const toast=document.createElement('div');
          toast.className='toast error';toast.textContent='Utilisateur non connecté.';
          Object.assign(toast.style,{position:'fixed',bottom:'calc(env(safe-area-inset-bottom) + 20px)',left:'50%',transform:'translateX(-50%)', background:'var(--ebay-red)',color:'#fff',padding:'.8rem 1.4rem',borderRadius:'6px',zIndex:1000, textAlign: 'center', boxShadow: '0 2px 5px rgba(0,0,0,0.2)'});
          document.body.append(toast);setTimeout(()=>toast.remove(),3000);
          submitBtn.disabled = false;
          submitBtn.textContent = 'Valider & envoyer';
          return;
        }

        const supplierNameValue=supplierI.value.trim();
       
        const supplyLinesData=[...linesC.children].map(r=>({
          title:r.querySelector('.book-search').value,
          quantity:parseInt(r.querySelector('.line-qty').value,10) || 0,
          unitCost:parseFloat(r.querySelector('.line-cost').value) || 0, 
          baseUnitCost: parseFloat(r.querySelector('.line-cost').dataset.baseCost || r.querySelector('.line-cost').value) || 0
        }));

        const totalQuantityFinal = supplyLinesData.reduce((sum, ln) => sum + ln.quantity, 0);
        const totalCostFinal = supplyLinesData.reduce((sum, ln) => sum + ln.quantity * ln.unitCost, 0);
        const additionalCostOverall = parseFloat(additionalCostI.value) || 0;

        const batch=db.batch();
        const supplyRef=db.collection('users').doc(user.uid).collection('supplies').doc();
        batch.set(supplyRef,{
            supplierName:supplierNameValue, 
            date:firebase.firestore.FieldValue.serverTimestamp(),
            lines: supplyLinesData,
            totalQty:totalQuantityFinal,
            totalCost:totalCostFinal, 
            additionalCostApplied: additionalCostOverall
        });
       
        const uid = auth.currentUser.uid;
        const userBooksRef = db.collection('users').doc(uid).collection('books');

        for(const ln of supplyLinesData){
          if (!ln.title) continue; 
          const snap = await userBooksRef.where('title','==', ln.title).limit(1).get();
         
          if (!snap.empty) { 
            const bookDocRef = snap.docs[0].ref;
            batch.update(bookDocRef, {
              quantity: firebase.firestore.FieldValue.increment(ln.quantity),
              lastPurchasePrice: ln.unitCost, // Update last purchase price (final cost)
              // price: ln.baseUnitCost // Optionally update selling price based on base cost
            });
          } else { 
             batch.set(userBooksRef.doc(), { 
              title: ln.title,
              quantity: ln.quantity,
              price: ln.baseUnitCost, // Default selling price based on base cost
              lastPurchasePrice: ln.unitCost,
              createdAt: firebase.firestore.FieldValue.serverTimestamp()
             });
          }
        }
        try {
            await batch.commit();
            location.hash='supply'; 
            const toast=document.createElement('div');
            toast.className='toast';toast.textContent='Approvisionnement enregistré !';
            Object.assign(toast.style,{position:'fixed',bottom:'calc(env(safe-area-inset-bottom) + 20px)',left:'50%',transform:'translateX(-50%)',
              background:'#333',color:'#fff',padding:'.8rem 1.4rem',borderRadius:'6px',zIndex:1000, textAlign: 'center', boxShadow: '0 2px 5px rgba(0,0,0,0.2)'});
            document.body.append(toast);setTimeout(()=>toast.remove(),2500);

            supplierI.value = '';
            linesC.innerHTML = '';
            additionalCostI.value = '0';
            allocationList.innerHTML = '';
            document.getElementById('summary-cards-new-supply').innerHTML = ''; // Use updated ID
            currentStep = 1;
            showStep(currentStep);
            main.querySelector('[data-step="1"] [data-next]').disabled = true;
            toggleStep2Next();
            main.querySelector('[data-step="3"] [data-next]').disabled = true;
            submitBtn.disabled = true;

        } catch (error) {
            console.error("Erreur lors de l'enregistrement de l'approvisionnement: ", error);
            // alert("Erreur: " + error.message);
            const toast=document.createElement('div');
            toast.className='toast error';toast.textContent="Erreur: " + error.message;
            Object.assign(toast.style,{position:'fixed',bottom:'calc(env(safe-area-inset-bottom) + 20px)',left:'50%',transform:'translateX(-50%)', background:'var(--ebay-red)',color:'#fff',padding:'.8rem 1.4rem',borderRadius:'6px',zIndex:1000, textAlign: 'center', boxShadow: '0 2px 5px rgba(0,0,0,0.2)'});
            document.body.append(toast);setTimeout(()=>toast.remove(),3000);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Valider & envoyer';
        }
      });
     
      const supplierSearchField = main.querySelector('#supplier-search'); 
      const step1Element = main.querySelector('.step[data-step="1"]');
      const step1WizardNav = step1Element ? step1Element.querySelector('.wizard-nav') : null;
      const allWizardNavs = main.querySelectorAll('.wizard-nav'); // All wizard navs
      const allStepContents = main.querySelectorAll('.step'); // All step contents

      function onInputFocus(e) {
        const currentStepEl = e.target.closest('.step');
        const currentWizardNav = currentStepEl ? currentStepEl.querySelector('.wizard-nav') : null;

        if (!currentWizardNav || !currentStepEl) return;
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => adjustLayoutForKeyboard(currentStepEl, currentWizardNav, e.target));
            adjustLayoutForKeyboard(currentStepEl, currentWizardNav, e.target); 
        }
      }
      function onInputBlur(e) {
        const currentStepEl = e.target.closest('.step');
        const currentWizardNav = currentStepEl ? currentStepEl.querySelector('.wizard-nav') : null;

        if (window.visualViewport) {
            window.visualViewport.removeEventListener('resize', () => adjustLayoutForKeyboard(currentStepEl, currentWizardNav, e.target));
        }
        if (currentWizardNav) currentWizardNav.style.bottom = '';  
        if (currentStepEl) currentStepEl.style.paddingBottom = '';
      }

      function adjustLayoutForKeyboard(stepEl, wizardNavEl, focusedInput) {
        if (!wizardNavEl || !stepEl || document.activeElement !== focusedInput) {
          if (window.visualViewport && document.activeElement !== focusedInput) {
             if (wizardNavEl) wizardNavEl.style.bottom = '';
             if (stepEl) stepEl.style.paddingBottom = '';
          }
          return;
        }
        const visualViewport = window.visualViewport;
        const keyboardHeight = window.innerHeight - (visualViewport.offsetTop + visualViewport.height);
        const safeAreaBottom = parseInt(getComputedStyle(document.documentElement).getPropertyValue('env(safe-area-inset-bottom)')) || 0;

        if (keyboardHeight > 50) { 
          wizardNavEl.style.bottom = (keyboardHeight - safeAreaBottom) + 'px'; // Adjust for safe area
          const navHeight = wizardNavEl.offsetHeight; 
          stepEl.style.paddingBottom = (keyboardHeight - safeAreaBottom + navHeight + 15) + 'px'; 
        } else {
          wizardNavEl.style.bottom = '';  
          stepEl.style.paddingBottom = '';
        }
      }
      // Apply to all relevant inputs in new-supply
      main.querySelectorAll('input[type="search"], input[type="number"], input[type="text"]').forEach(input => {
          input.addEventListener('focus', onInputFocus);
          input.addEventListener('blur', onInputBlur);
      });
    })();
  </script>
</main>

<main id="select-book" class="page">
  <style>

    #select-book .books-list .book-card { /* Style for clickable book cards */
        cursor: pointer;
        transition: background-color 0.15s ease-in-out;
        /* Re-using general book-card styles from catalog, specific styling below */
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-card);
        padding: 1rem;
        background: #fff;
        box-shadow: none;
    }
    #select-book .books-list .book-card:hover { /* Desktop hover */
        background-color: #f9f9f9;
    }
    #select-book .books-list .book-card:active { /* Mobile tap */
        background-color: #f0f0f0;
    }
    #select-book .search-noresult-container { /* Container for the chip */
        padding: 1rem; text-align: center;
    }
    /* Styles for book-card content within select-book modal */
    #select-book .book-title {
      font-size: 1.1rem; font-weight: 600; margin-bottom: 0.4rem; color: var(--primary-text);
    }
    #select-book .book-price {
      font-size: 0.9rem; font-weight: 500; color: var(--ebay-red); margin-bottom: 0.2rem;
    }
    #select-book .book-quantity {
      font-size: 0.85rem; color: var(--secondary-text);
    }
    /* Header for select-book page (re-using .sell-header structure) */
    #select-book > header.sell-header { /* More specific selector */
        display: flex;
        align-items: center;
        padding: 0.75rem 1rem;
        background: #fff;
        border-bottom: 1px solid var(--border-color);
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 15;
    }
    #select-book > header.sell-header .btn-close {
        flex: 0 0 auto; display: flex; align-items: center; justify-content: center;
        padding: 0.5rem; background: none; border: none; font-size: 1.5rem;
        color: var(--primary-text); margin-right: 0.75rem; cursor: pointer; outline: none;
    }
    #select-book > header.sell-header .search-wrapper {
        flex: 1; margin-top: 0;
    }
    #select-book > header.sell-header #select-book-search {
        width: 100%; padding: 0.75rem 2.75rem 0.75rem 2.75rem; /* Adjusted for search icon */
        border: 1px solid var(--border-color); border-radius: var(--border-radius-pill);
        background: #f4f4f4; font-size: 1rem; outline: none; box-shadow: none;
    }
  </style>
  <header class="sell-header"> 
    <button class="btn-close" data-hash="new-supply" aria-label="Annuler et retourner"> <i class="bi bi-x-lg"></i>
    </button>
    <div class="search-wrapper">
      <i class="bi bi-search"></i>
      <input
        type="search"
        id="select-book-search"
        placeholder="Rechercher un livre existant"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
      >
    </div>
  </header>
  <div id="select-book-results" style="padding-bottom: 1rem;"> <div class="books-list" style="display: flex; flex-direction: column; gap: 0.75rem; padding: 1rem;"></div> </div>

  <script>
  (function() {
    const selectBookPage = document.getElementById('select-book');
    const searchInputEl = document.getElementById('select-book-search');
    const resultListEl  = document.querySelector('#select-book-results .books-list');
    // const closeBtnSelectBook = document.querySelector('#select-book .btn-close'); // Handled by router

    let debounceTimer = null;
    searchInputEl.addEventListener('input', performBookSearch);

    window.addEventListener('hashchange', () => {
      if (location.hash === '#select-book' && selectBookPage.classList.contains('visible')) {
          setTimeout(() => searchInputEl.focus(), 50); // Delay for transition
          if (window.currentBookInput && window.currentBookInput.value) {
              searchInputEl.value = window.currentBookInput.value;
          } else {
              searchInputEl.value = ''; // Clear search on new focus if no prefill
          }
          performBookSearch(); 
      }
    });

  async function performBookSearch() {
    const searchTerm = searchInputEl.value.trim();
    // resultListEl.innerHTML = '<p style="padding:1rem; text-align:center;">Recherche en cours…</p>';
    clearTimeout(debounceTimer);

    if (searchTerm.length === 0) { 
        // resultListEl.innerHTML = '<p style="padding:1rem; text-align:center;">Saisissez un nom de livre pour rechercher.</p>';
        loadAllBooks(); // Load all books if search is empty
        return;
    }
    // if (searchTerm.length < 2 && searchTerm.length > 0) { 
    //     resultListEl.innerHTML = '<p style="padding:1rem; text-align:center;">Continuez à taper...</p>';
    //     return;
    // }

    debounceTimer = setTimeout(async () => {
      try {
        if (!auth.currentUser) {
            resultListEl.innerHTML = '<p style="padding:1rem;color:var(--ebay-red);text-align:center;">Utilisateur non connecté.</p>';
            return;
        }
        const uid = auth.currentUser.uid;
        const userBooksRef = db.collection('users').doc(uid).collection('books');
       
        // Client-side filtering for simplicity with small datasets
        // For larger datasets, use Firestore queries with indexing (e.g., Algolia for complex search)
        const snapshot = await userBooksRef.orderBy('title').get();
        const allUserBooks = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
       
        const searchTermLower = searchTerm.toLowerCase();
        const filteredBooks = allUserBooks.filter(book => 
            book.title.toLowerCase().includes(searchTermLower)
        );

        displayResults(filteredBooks, searchTerm);
      } catch (err) {
        resultListEl.innerHTML = '<p style="color:var(--ebay-red);padding:1rem;text-align:center;">Erreur de recherche.</p>';
        console.error("Book search error:", err);
      }
    }, 250); 
  }

  async function loadAllBooks() {
      // resultListEl.innerHTML = '<p style="padding:1rem; text-align:center;">Chargement des livres...</p>';
      try {
        if (!auth.currentUser) {
            resultListEl.innerHTML = '<p style="padding:1rem;color:var(--ebay-red);text-align:center;">Utilisateur non connecté.</p>';
            return;
        }
        const uid = auth.currentUser.uid;
        const snapshot = await db.collection('users').doc(uid).collection('books').orderBy('title').limit(50).get(); // Limit initial load
        const books = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
        displayResults(books, ""); // Display all loaded books, empty search term
      } catch (err) {
        resultListEl.innerHTML = '<p style="color:var(--ebay-red);padding:1rem;text-align:center;">Erreur de chargement.</p>';
        console.error("Book load error:", err);
      }
  }


  function displayResults(books, searchTerm) {
      resultListEl.innerHTML = ''; 
      if (books.length === 0 && searchTerm) { // Only show "add new" if there was a search term
        resultListEl.innerHTML = `
            <div class="search-noresult-container">
              <p>Aucun livre trouvé pour « ${searchTerm} ».</p>
              <div id="add-book-chip" class="search-noresult" style="margin-top: 0.5rem; display: inline-flex; justify-content: center;">
                Ajouter « <strong id="chip-book-title">${searchTerm}</strong> » comme nouveau livre
                <i class="bi bi-plus-circle-fill" style="margin-left: 0.5rem;"></i>
              </div>
            </div>
          `;
      } else if (books.length === 0 && !searchTerm) {
         resultListEl.innerHTML = '<p style="padding:1rem; text-align:center;">Aucun livre dans votre catalogue. Ajoutez-en via la section "Approvisionnement".</p>';
      } else {
        books.forEach(bookData => {
          const bookDiv = document.createElement('div');
          bookDiv.className = 'book-card'; 
          bookDiv.innerHTML = `
            <h4 class="book-title">${bookData.title}</h4>
            <p class="book-price">PU Achat: ${(bookData.lastPurchasePrice || bookData.price || 0).toLocaleString('fr-FR',{style:'currency', currency:'XOF', minimumFractionDigits:0})}</p>
            <p class="book-quantity">En Stock: ${bookData.quantity || 0}</p>
            `;
          bookDiv.addEventListener('click', () => {
            if (window.currentBookInput) {
              window.currentBookInput.value = bookData.title;
              const lineRow = window.currentBookInput.closest('.line-row');
              if (lineRow) {
                const costInput = lineRow.querySelector('.line-cost');
                const qtyInput = lineRow.querySelector('.line-qty');
                if (costInput) {
                  const purchasePrice = bookData.lastPurchasePrice || bookData.price || 0;
                  costInput.value = purchasePrice.toFixed(0); // XOF
                  costInput.dataset.baseCost = purchasePrice.toFixed(0); 
                }
                // if (qtyInput && (!qtyInput.value || qtyInput.value === "0") ) { 
                //     qtyInput.value = 1;
                // }
                // Trigger events after setting values
                window.currentBookInput.dispatchEvent(new Event('change', { bubbles:true })); // Use 'change' as value is set programmatically
                if (costInput) costInput.dispatchEvent(new Event('input', { bubbles:true }));
                if (qtyInput) qtyInput.dispatchEvent(new Event('input', { bubbles:true }));

                setTimeout(() => qtyInput.focus(), 0); // Focus quantity after selecting
                qtyInput.select();


              }
            }
            location.hash = 'new-supply'; 
          });
          resultListEl.appendChild(bookDiv);
        });
      }
  }

})();
</script>
</main>

<main id="add-book-modal" class="page modal-overlay" aria-hidden="true"> <style>
#add-book-modal.modal-overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,0.4);
  /* display: none;  Handled by .page and .visible */
  overflow: hidden; height: 100vh; width: 100vw; 
  align-items: center; justify-content: center; z-index: 100; 
}
/* #add-book-modal.modal-overlay.visible { display: flex; } */ /* Handled by .page.visible */
#add-book-modal .modal {
  background: #fff; border-radius: 0.75rem; 
  width: 90%; max-width: 380px; 
  max-height: calc(100dvh - env(safe-area-inset-bottom) - 2rem); 
  overflow-y: auto; display: flex; flex-direction: column;
  box-shadow: none; border: 1px solid var(--border-color); /* NO SHADOW */
}
#add-book-modal .modal header {
  padding: 1rem 1.25rem; border-bottom: 1px solid #eee;
  display: flex; justify-content: space-between; align-items: center;
}
#add-book-modal .modal header h3 { margin: 0; font-size: 1.15rem; font-weight: 600; }
#add-book-modal .modal-close {
  background: none; border: none; font-size: 1.75rem; cursor: pointer;
  color: var(--secondary-text); padding: 0.25rem; line-height: 1;
}
#add-book-modal .modal-content { padding: 0.75rem 1.25rem 1.25rem; }
#add-book-modal .form-group { margin-bottom: 1rem; }
#add-book-modal label {
  display: block; margin-bottom: 0.4rem; font-size: 0.9rem;
  color: var(--secondary-text); font-weight: 500;
}
#add-book-modal input { 
  width: 100%; padding: 0.8rem; border: 1px solid #ccc;
  border-radius: var(--border-radius-card); font-size: 1rem; outline: none;
  transition: border-color 0.2s ease; box-shadow: none;
}
#add-book-modal input:focus { border-color: var(--accent); }
#add-book-modal button[type="submit"] {
  width: 100%; padding: 0.85rem; font-size: 1rem; font-weight: 600;
  border: none; border-radius: var(--border-radius-pill); background: var(--accent);
  color: #fff; cursor: pointer; margin-top: 0.5rem; box-shadow:none;
}
#add-book-modal button[type="submit"]:active { background: #014fa5; }
#add-book-modal .modal { position: relative; transition: transform 0.2s ease-out; }
body.keyboard-visible #add-book-modal .modal { transform: translateY(-15%); } /* Adjust less aggressively */
  </style>

  <div class="modal">
    <header>
      <h3>Ajouter un nouveau livre</h3>
      <button class="modal-close" data-hash="select-book" aria-label="Fermer">&times;</button> </header>
    <div class="modal-content"> <form id="form-add-book">
        <div class="form-group">
          <label for="new-book-title">Titre du livre</label>
          <input
            type="search" 
            id="new-book-title"
            placeholder="Ex: Le Petit Prince"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="sentences" 
            enterkeyhint="done"  
            spellcheck="false"
            required
          >
        </div>
        <button type="submit">Enregistrer le livre</button>
      </form>
    </div>
  </div>
</main>
  <script>
  function openAddBookModal(defaultTitle = '') {
    const modalEl = document.getElementById('add-book-modal');
    if (!modalEl) return console.error('Modal #add-book-modal introuvable');
   
    // modalEl.classList.add('visible'); // Router handles visibility
    // modalEl.setAttribute('aria-hidden', 'false');
    location.hash = 'add-book-modal'; // Let router show the modal "page"
   
    const titleInputEl = document.getElementById('new-book-title');
    if (titleInputEl) {
        titleInputEl.value = defaultTitle; 
        setTimeout(() => titleInputEl.focus(), 100); // Increased delay for page transition
    }
    // document.body.style.overflow = 'hidden'; // Potentially handled by router or CSS for modal
  }

  document.addEventListener('click', e => {
    const chip = e.target.closest('#add-book-chip'); 
    if (!chip) return;
   
    // let suggestedTitle = chip.textContent.trim();
    // suggestedTitle = suggestedTitle.replace(/^Ajouter\s*«\s*/, '').replace(/\s*»(\s*<i.*)?$/, ''); 
    const strongTitleEl = chip.querySelector('#chip-book-title');
    const suggestedTitle = strongTitleEl ? strongTitleEl.textContent.trim() : '';

    openAddBookModal(suggestedTitle);
  });

  function closeAddBookModal() { // This function might be called by router when navigating away
    const modalEl = document.getElementById('add-book-modal');
    // if (modalEl) {
    //     modalEl.classList.remove('visible');
    //     modalEl.setAttribute('aria-hidden', 'true');
    // }
    // document.body.style.overflow = ''; 
    // document.body.classList.remove('keyboard-visible'); 
    if (location.hash === '#add-book-modal') { // If still on modal, go back to select-book
        location.hash = 'select-book';
    }
  }

  // Close button inside modal now uses data-hash, handled by main router
  // const closeBtnEl = document.querySelector('#add-book-modal .modal-close');
  // if (closeBtnEl) {
  //  closeBtnEl.addEventListener('click', closeAddBookModal);
  // }

  // const overlayEl = document.getElementById('add-book-modal');
  // if (overlayEl) {
  //  overlayEl.addEventListener('click', e => {
  //    if (e.target === overlayEl) { 
  //      closeAddBookModal();
  //    }
  //  });
  // }
  // window.addEventListener('keydown', (e) => {
  //  if (e.key === 'Escape' && overlayEl && overlayEl.classList.contains('visible')) {
  //      closeAddBookModal();
  //  }
  // });

  (function() {
    const modalEl = document.getElementById('add-book-modal');
    if (!modalEl) return;
    const modalContentEl = modalEl.querySelector('.modal');

    let initialViewportHeight = window.innerHeight; 
    let isKeyboardLikelyVisible = false;

    const inputs = modalContentEl.querySelectorAll('input, textarea');
    inputs.forEach(input => {
        input.addEventListener('focus', () => {
            initialViewportHeight = window.innerHeight; 
            isKeyboardLikelyVisible = true;  
            setTimeout(() => { // Check after a delay
              // VisualViewport API is more reliable if available
              if (window.visualViewport) {
                if (window.innerHeight - window.visualViewport.height > 150) { // Heuristic for keyboard height
                    document.body.classList.add('keyboard-visible');
                }
              } else if (window.innerHeight < initialViewportHeight * 0.80) { // Fallback
                document.body.classList.add('keyboard-visible');
              }
            }, 100); // Delay to allow keyboard to animate
        });
        input.addEventListener('blur', () => {
            isKeyboardLikelyVisible = false;
            setTimeout(() => {
                const activeEl = document.activeElement;
                if (!modalContentEl.contains(activeEl) || (activeEl.tagName !== 'INPUT' && activeEl.tagName !== 'TEXTAREA')) {
                    document.body.classList.remove('keyboard-visible');
                }
            }, 150);
        });
    });
     window.addEventListener('resize', () => {
        if (isKeyboardLikelyVisible) { 
            if (window.visualViewport) {
                 if (window.innerHeight - window.visualViewport.height > 150) {
                    document.body.classList.add('keyboard-visible');
                } else if (Math.abs(window.innerHeight - window.visualViewport.height) < 50) { // Keyboard likely closed
                    document.body.classList.remove('keyboard-visible');
                }
            } else if (window.innerHeight < initialViewportHeight * 0.80) { // Fallback
                document.body.classList.add('keyboard-visible');
            } else if (window.innerHeight >= initialViewportHeight * 0.95) { 
                document.body.classList.remove('keyboard-visible');
            }
        }
    });
  })();

  const formAddBookEl = document.getElementById('form-add-book');
  formAddBookEl.addEventListener('submit', async e => {
    e.preventDefault();
    const titleInputEl = document.getElementById('new-book-title');
    const newTitle = titleInputEl.value.trim();
   
    if (!newTitle) {
      titleInputEl.style.borderColor = 'var(--ebay-red)';
      setTimeout(() => titleInputEl.style.borderColor = '', 2000);
      titleInputEl.focus();
      return;
    }
   
    const submitButton = formAddBookEl.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.textContent = 'Enregistrement...';

    try {
      if (!auth.currentUser) {
        throw new Error("Utilisateur non authentifié.");
      }
      const uid = auth.currentUser.uid;
      const userBooksRef = db.collection('users').doc(uid).collection('books');

      // Check if book with same title already exists (case-insensitive for better UX)
      const querySnapshot = await userBooksRef.get();
      const existingBook = querySnapshot.docs.find(doc => doc.data().title.toLowerCase() === newTitle.toLowerCase());

      if (existingBook) {
         throw new Error(`Un livre intitulé "${existingBook.data().title}" existe déjà.`);
      }

      await userBooksRef.add({
        title: newTitle,
        price: 0, 
        quantity: 0, 
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        lastPurchasePrice: 0 
      });

      // closeAddBookModal(); // Router will handle navigation away
      location.hash = 'select-book'; // Go back to select book page

      if (window.currentBookInput) { 
          // location.hash = 'new-supply';  // Already handled by select-book logic on item click
          window.currentBookInput.value = newTitle;
          window.currentBookInput.dispatchEvent(new Event('change', { bubbles: true }));
         
          const lineRow = window.currentBookInput.closest('.line-row');
          if (lineRow) {
              const costInput = lineRow.querySelector('.line-cost');
              const qtyInput = lineRow.querySelector('.line-qty');
               if (costInput) { // Set new book base cost to 0, to be filled by user
                  costInput.value = "0";
                  costInput.dataset.baseCost = "0";
                  costInput.dispatchEvent(new Event('input', { bubbles:true }));
              }
              if (qtyInput) {
                  qtyInput.value = "1"; // Default qty to 1 for new book
                  qtyInput.dispatchEvent(new Event('input', { bubbles:true }));
                  setTimeout(() => qtyInput.focus(), 0); // Focus quantity
                  qtyInput.select();
              }
          }
      }
      titleInputEl.value = ''; 
      // Show a success toast
      const toast=document.createElement('div');
      toast.className='toast';toast.textContent=`Livre "${newTitle}" ajouté !`;
      Object.assign(toast.style,{position:'fixed',bottom:'calc(env(safe-area-inset-bottom) + 20px)',left:'50%',transform:'translateX(-50%)',
        background:'#333',color:'#fff',padding:'.8rem 1.4rem',borderRadius:'6px',zIndex:1050, textAlign: 'center', boxShadow: '0 2px 5px rgba(0,0,0,0.2)'});
      document.body.append(toast);setTimeout(()=>toast.remove(),2500);


    } catch (err) {
      console.error(err);
      // alert("Erreur: " + err.message); 
      const toast=document.createElement('div');
      toast.className='toast error';toast.textContent="Erreur: " + err.message;
      Object.assign(toast.style,{position:'fixed',bottom:'calc(env(safe-area-inset-bottom) + 20px)',left:'50%',transform:'translateX(-50%)', background:'var(--ebay-red)',color:'#fff',padding:'.8rem 1.4rem',borderRadius:'6px',zIndex:1050, textAlign: 'center', boxShadow: '0 2px 5px rgba(0,0,0,0.2)'});
      document.body.append(toast);setTimeout(()=>toast.remove(),3500);
    } finally {
        submitButton.disabled = false;
        submitButton.textContent = 'Enregistrer le livre';
    }
  });
</script>

  <main id="orders" class="page">
    <header><h2 style="padding:1rem">My Orders</h2></header>
    <p style="padding:0 1rem 6rem; text-align:center;">Your recent orders will appear here…</p>
  </main>

  <main id="sales" class="page">
  <header id="sales-header">
    <h2>Historique des Ventes</h2>
  </header>
  <div id="sales-list" class="sales-list">
    </div>
  <script>
    // Script for Sales History Page
    (function() {
      const salesListEl = document.getElementById('sales-list');
      let unsubscribeSales = null;

      function setupSalesListener() {
        if (unsubscribeSales) unsubscribeSales(); // Unsubscribe from previous listener
        if (!auth.currentUser) {
          if(salesListEl) salesListEl.innerHTML = '<p style="padding:1rem;color:#555;text-align:center;">Veuillez vous connecter pour voir l\'historique.</p>';
          return;
        }

        const salesRef = db
          .collection('users')
          .doc(auth.currentUser.uid)
          .collection('sales')
          .orderBy('timestamp', 'desc'); // Get newest sales first

        if(salesListEl) {
            salesListEl.innerHTML = Array(3) // Show 3 skeleton cards while loading
            .fill('')
            .map(() => '<div class="skeleton-sale-card"></div>')
            .join('');
        }


        unsubscribeSales = salesRef.onSnapshot(snapshot => {
          if(!salesListEl) return;
          salesListEl.innerHTML = ''; // Clear current list (skeletons or old data)

          if (snapshot.empty) {
            salesListEl.innerHTML = '<p style="padding:1rem;color:#555;text-align:center;">Aucune vente enregistrée pour l’instant.</p>';
            return;
          }

          snapshot.forEach(doc => {
            const sale = doc.data();
            const saleId = doc.id;
            const dateObj = sale.timestamp?.toDate() || new Date(); // Use server timestamp
            const dateStr = dateObj.toLocaleDateString('fr-FR', {
              day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            const totalSaleAmount = sale.grandTotalAmount || 0;
            const totalItems = sale.totalItemsSold || 0;

            const saleCard = document.createElement('div');
            saleCard.className = 'sale-card'; // Using a new class for sales, can be styled like supply-batch-card
            saleCard.dataset.saleId = saleId;

            // Truncate long customer names
            let customerDisplayName = sale.customerName || 'Client Anonyme';
            if (customerDisplayName.length > 25) {
                customerDisplayName = customerDisplayName.substring(0, 22) + '...';
            }


            saleCard.innerHTML = `
              <header>
                <div class="sale-info">
                  <strong title="${sale.customerName || 'Client Anonyme'}">${customerDisplayName}</strong>
                  <small>${dateStr}</small>
                </div>
                <div class="sale-meta">
                  <span class="sale-total-amount">${totalSaleAmount.toLocaleString('fr-FR', {
                    style: 'currency', currency: 'XOF', minimumFractionDigits: 0
                  })}</span>
                  <span class="sale-total-items">Articles: ${totalItems}</span>
                </div>
              </header>
              ${sale.items && sale.items.length > 0 ? `
                <ul style="list-style:none; padding-left:0; margin-top:0.5rem; font-size:0.85rem;">
                  ${sale.items.slice(0, 2).map(item => `
                    <li style="display:flex; justify-content:space-between; padding:0.1rem 0;">
                      <span style="flex-grow:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-right:0.5rem;" title="${item.title || 'Article inconnu'}">${item.title || 'Article inconnu'}</span>
                      <span style="flex-shrink:0;">x ${item.quantitySold || 0}</span>
                    </li>
                  `).join('')}
                  ${sale.items.length > 2 ? `<li style="text-align:right; color:var(--secondary-text); font-style:italic;">et ${sale.items.length - 2} autre(s)...</li>` : ''}
                </ul>` : '<p style="font-size:0.85rem; color:var(--secondary-text); margin-top:0.5rem;">Aucun détail d\'article disponible.</p>'}
            `;
            // Placeholder for click to see full details
            saleCard.addEventListener('click', () => {
                // TODO: Implement a modal or an expansion to show full sale details
                // For now, just log to console
                console.log("Clicked sale:", saleId, sale);
                alert(`Détails pour la vente ID: ${saleId} (à implémenter) \nClient: ${sale.customerName || 'N/A'} \nTotal: ${totalSaleAmount.toLocaleString('fr-FR',{style:'currency', currency:'XOF', minimumFractionDigits:0})}`);
            });

            salesListEl.appendChild(saleCard);
          });
        }, err => {
          console.error('Erreur Firestore (sales):', err);
          if(salesListEl) salesListEl.innerHTML = '<p style="padding:1rem;color:var(--ebay-red);text-align:center;">Erreur de chargement des ventes.</p>';
        });
      }

      function cleanupSalesListener() {
        if (unsubscribeSales) {
          unsubscribeSales();
          unsubscribeSales = null;
        }
      }

      // Listen to hash changes to setup/cleanup listener
      window.addEventListener('hashchange', () => {
        if (location.hash === '#sales') {
          if (auth.currentUser) setupSalesListener();
        } else {
          cleanupSalesListener();
        }
      });

      // Initial check if page loads on #sales
      if (location.hash === '#sales') {
        if (auth.currentUser) setupSalesListener();
      }
      
      // Also setup listener if auth state changes and we are on the sales page
      auth.onAuthStateChanged(user => {
        if (user && location.hash === '#sales') {
            setupSalesListener();
        } else if (!user && location.hash === '#sales') {
            cleanupSalesListener();
             if(salesListEl) salesListEl.innerHTML = '<p style="padding:1rem;color:#555;text-align:center;">Veuillez vous connecter pour voir l\'historique.</p>';
        }
      });
    })();
  </script>
</main>

  <main id="cart" class="page">
    <header><h2 style="padding:1rem">Panier</h2></header>
    <div style="padding:1rem; text-align:center;">
      <p>Votre panier est actuellement vide.</p>
      </div>
  </main>

<main id="account" class="page">
  <style>
#account .profile-card {
  display: flex; align-items: center; gap: 1rem;
  background: #fff; border: 1px solid var(--border-color);
  border-radius: var(--border-radius-card); padding: 1rem; margin: 1rem; 
  max-width: none;  box-shadow: none; 
}
#account .profile-avatar {
  flex: 0 0 auto; margin: 0; 
  width: 64px; height: 64px; background: var(--ebay-blue);
  color: #fff; font-weight: bold; font-size: 2rem;
  border-radius: 50%; display: flex;
  align-items: center; justify-content: center;
}
#account .profile-info {
  display: flex; flex-direction: column;
  gap: 0.25rem; text-align: left;
}
#account h2 {  padding: 1rem; font-size: 1.3rem; font-weight: 600;  }
#account #display-name { font-size: 1.3rem; font-weight: 600; margin-bottom: 0.25rem; }
#account #email, #account #member-since {
  font-size: 0.95rem; color: var(--secondary-text); margin-bottom: 0.5rem;
}
#account .section-title {
  padding: 0 1rem; margin: 1.5rem 0 0.75rem;
  font-size: 1.15rem; font-weight: 600; color: var(--primary-text);
}
#account .updates-grid {
  display: flex; gap: 0.75rem; padding: 0 1rem; flex-wrap: wrap; 
}
#account .update-card {
  flex: 1 1 calc(50% - 0.375rem); min-width: 150px; 
  display: flex; align-items: center; justify-content: space-between;
  background: #fff; border: 1px solid var(--border-color);
  border-radius: var(--border-radius-card); padding: 1rem; cursor: pointer;
  transition: background-color 0.2s ease; box-shadow:none;
}
#account .update-card:active { background-color: #f0f0f0; }
#account .update-card h4 { font-size: 1rem; margin: 0 0 0.25rem; font-weight: 500; }
#account .update-card p { font-size: 0.85rem; color: var(--secondary-text); margin: 0; }
#account .update-card i.bi-chevron-right { font-size: 1.2rem; color: var(--secondary-text); }

#account .menu-list { margin-top: 0.5rem; }
#account .menu-item {
  width: 100%; display: flex; align-items: center; justify-content: space-between;
  background: #fff; border: none; border-bottom: 1px solid #eee;
  padding: 0.85rem 1rem; cursor: pointer;
  transition: background-color 0.2s ease;
}
#account .menu-item:first-child { border-top: 1px solid #eee; }
#account .menu-item:active { background-color: #f0f0f0; }
#account .menu-item .item-content { display: flex; align-items: center; gap: 0.75rem; }
#account .menu-item .item-content i {
  font-size: 1.3rem; color: var(--accent);
  width: 24px; text-align: center;
}
#account .menu-item span { font-size: 1rem; font-weight: 500; color: var(--primary-text); }
#account .menu-item small {
  display: block; font-size: 0.8rem; color: var(--secondary-text);
  margin-top: 0.1rem; line-height: 1.2;
}
#account .menu-item .bi-chevron-right { font-size: 1rem; color: var(--secondary-text); }
#account .btn-signout {
  width: calc(100% - 2rem); margin: 1.5rem 1rem 1rem 1rem; 
  padding: 0.85rem 1.2rem; font-size: 1rem; font-weight: 500;
  border: 2px solid var(--ebay-red); border-radius: var(--border-radius-pill);
  background: #fff; color: var(--ebay-red); cursor: pointer;
  text-align: center; transition: background 0.2s, color 0.2s; box-shadow:none;
}
#account .btn-signout:active { background: var(--ebay-red); color: #fff; }
#account .updates-grid .update-card.full-width { flex: 1 1 100%; max-width: 100%; }
/* #btn-install { 
  width: calc(100% - 2rem);  margin: 1rem; 
} */
  </style>

  <header><h2>Mon compte</h2></header>
  <div> 
    <div class="profile-card">
      <div class="profile-avatar" id="avatar-letter">U</div>
      <div class="profile-info">
        <div id="display-name">Utilisateur</div>
        <div id="email">email@example.com</div>
        <div id="member-since">Membre depuis: …</div>
      </div>
    </div>

    <div class="section-title">Vos mises à jour</div>
    <div class="updates-grid">
      <div class="update-card" data-hash="stock-alerts"> <div> <h4>Alertes de stock</h4>
          <p>Livres bientôt épuisés</p>
        </div>
        <i class="bi bi-chevron-right"></i>
      </div>
      <div class="update-card full-width" data-hash="orders"> <div> <h4>Commandes récentes</h4>
          <p>Voir vos dernières commandes</p>
        </div>
        <i class="bi bi-chevron-right"></i>
      </div>
    </div>

    <div class="section-title">Gestion</div>
    <div class="menu-list">
      <button class="menu-item" data-hash="catalog"> <div class="item-content">
          <i class="bi bi-journal-richtext"></i> <div>
            <span>Catalogue des livres</span>
            <small>Voir et gérer vos livres</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
      <button class="menu-item" data-hash="suppliers"> <div class="item-content">
          <i class="bi bi-people-fill"></i> <div>
            <span>Fournisseurs</span>
            <small>Gérer vos fournisseurs</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
      <button class="menu-item" data-hash="reports"> <div class="item-content">
          <i class="bi bi-bar-chart-line-fill"></i> <div>
            <span>Rapports</span>
            <small>Statistiques & analyses</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
    <button class="btn-signout" id="btn-signout">Déconnexion</button>
  </div>

  <script>
    auth.onAuthStateChanged(user => {
      if (user) {
        const name = user.displayName || (user.email ? user.email.split('@')[0] : '') || "Utilisateur";
        document.getElementById('display-name').textContent = name;
        document.getElementById('email').textContent = user.email || 'Non fourni';
        if (user.metadata && user.metadata.creationTime) {
            const creationDate = new Date(user.metadata.creationTime);
            document.getElementById('member-since').textContent =
            'Membre depuis: ' + creationDate.toLocaleDateString(undefined, { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });
        } else {
            document.getElementById('member-since').textContent = 'Membre depuis: Date inconnue';
        }
        document.getElementById('avatar-letter').textContent = name[0] ? name[0].toUpperCase() : 'U';
      } else {
        document.getElementById('display-name').textContent = "Non connecté";
        document.getElementById('email').textContent = "";
        document.getElementById('member-since').textContent = "";
        document.getElementById('avatar-letter').textContent = "U";
      }
    });
    document.getElementById('btn-signout').addEventListener('click', () => {
      auth.signOut().then(() => {
        window.location.href = 'login.html'; 
      }).catch(error => {
        console.error("Sign out error", error);
        // alert("Erreur de déconnexion: " + error.message);
        const toast=document.createElement('div');
        toast.className='toast error';toast.textContent="Erreur de déconnexion: " + error.message;
        Object.assign(toast.style,{position:'fixed',bottom:'calc(env(safe-area-inset-bottom) + 20px)',left:'50%',transform:'translateX(-50%)', background:'var(--ebay-red)',color:'#fff',padding:'.8rem 1.4rem',borderRadius:'6px',zIndex:1000, textAlign: 'center', boxShadow: '0 2px 5px rgba(0,0,0,0.2)'});
        document.body.append(toast);setTimeout(()=>toast.remove(),3000);
      });
    });
  </script>
</main>

<main id="catalog" class="page"> 
  <header> 
    <div class="search-wrapper">
        <i class="bi bi-search"></i>
        <input
          type="search"
          id="search-input-catalog" placeholder="Rechercher dans le catalogue"
          aria-label="Recherche catalogue"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="none"
          spellcheck="false"
        >
      </div>
    </header>

  <div class="info-cards" id="catalog-info-cards"> <div class="info-card">
      <div class="info-number" id="total-books-catalog">0</div>
      <div class="info-label">Livres en Stock</div> </div>
    <div class="info-card">
      <div class="info-number" id="total-value-catalog">XOF 0</div>
      <div class="info-label">Valeur Achat Stock</div> </div>
  </div>

  <div id="catalog-results-main"> <div class="books-list"></div> </div>

  <script>
  (function() {
    const catalogPage = document.getElementById('catalog'); 
    const booksListEl  = document.querySelector('#catalog-results-main .books-list');
    const totalBooksEl  = document.getElementById('total-books-catalog');
    const totalValueEl  = document.getElementById('total-value-catalog');
    const searchInputCatalogEl = document.getElementById('search-input-catalog');
    const infoCardsEl   = document.getElementById('catalog-info-cards');
    let allBooksCache = []; 
    let unsubscribeCatalog = null; 

    searchInputCatalogEl.addEventListener('input', () => {
      const searchTerm = searchInputCatalogEl.value.trim().toLowerCase();
      infoCardsEl.classList.toggle('fade-out', !!searchTerm);
      renderBooks(searchTerm); 
    });

    function renderBooks(searchTerm = '') {
        booksListEl.innerHTML = ''; 
        const filteredBooks = searchTerm
            ? allBooksCache.filter(book => 
                (book.title && book.title.toLowerCase().includes(searchTerm)) ||
                (book.author && book.author.toLowerCase().includes(searchTerm)) // Optional: search by author too
              )
            : allBooksCache;

        if (filteredBooks.length === 0 && allBooksCache.length > 0 && searchTerm) {
             booksListEl.innerHTML = `<p style="text-align:center; padding:1rem; color:var(--secondary-text);">Aucun livre ne correspond à "${searchInputCatalogEl.value}".</p>`;
        } else if (allBooksCache.length === 0 && !searchTerm) {
            // This case is handled by the onSnapshot empty check below
        }
       
        filteredBooks.forEach(book => {
            const card = document.createElement('div');
            card.className = 'book-card-catalog'; 
            card.dataset.bookId = book.id;

            const formattedPriceSell = (book.price || 0).toLocaleString('fr-FR',{style:'currency', currency:'XOF', minimumFractionDigits:0});
            const formattedPricePurchase = (book.lastPurchasePrice || 0).toLocaleString('fr-FR',{style:'currency', currency:'XOF', minimumFractionDigits:0});
           
            let stockClass = 'stock-normal';
            if (book.quantity <= 0) {
                stockClass = 'stock-out';
            } else if (book.quantity <= 5) { // Example threshold for low stock
                stockClass = 'stock-low';
            }

            card.innerHTML = `
              <div class="book-card-image-area">
                  <i class="bi bi-book book-placeholder-icon"></i>
              </div>
              <div class="book-card-content-area">
                  <div class="book-card-main-info">
                      <h4 class="book-title">${book.title || 'Titre inconnu'}</h4>
                      <p class="book-author"><i class="bi bi-person"></i> <span>${book.author || 'Auteur inconnu'}</span></p>
                      <p class="book-price-sell"><i class="bi bi-tag-fill"></i> Prix Vente: <span>${formattedPriceSell}</span></p>
                      <p class="book-quantity-stock"><i class="bi bi-box-seam"></i> Stock: <span class="stock-value ${stockClass}">${book.quantity || 0}</span></p>
                  </div>
                  <div class="book-card-secondary-info">
                      <p class="book-price-purchase"><i class="bi bi-cart-check"></i> Dernier Coût: <span>${formattedPricePurchase}</span></p>
                      </div>
                  <div class="book-card-actions">
                      <button class="btn-action-icon btn-view-details" data-book-id="${book.id}" aria-label="Voir détails" title="Voir détails"><i class="bi bi-eye-fill"></i></button>
                      <button class="btn-action-icon btn-edit-book" data-book-id="${book.id}" aria-label="Modifier" title="Modifier"><i class="bi bi-pencil-fill"></i></button>
                      <button class="btn-action-icon btn-delete-book" data-book-id="${book.id}" aria-label="Supprimer" title="Supprimer"><i class="bi bi-trash3-fill"></i></button>
                  </div>
              </div>
            `;
            booksListEl.appendChild(card);
        });

        // Add event listeners for new action buttons (placeholder for now)
        document.querySelectorAll('.btn-view-details').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const bookId = e.currentTarget.dataset.bookId;
                console.log('View details for book ID:', bookId);
                // Future: Open details modal for bookId
                alert(`Action "Voir Détails" pour livre ID: ${bookId} (à implémenter)`);
            });
        });
        document.querySelectorAll('.btn-edit-book').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const bookId = e.currentTarget.dataset.bookId;
                console.log('Edit book ID:', bookId);
                // Future: Open edit modal for bookId
                alert(`Action "Modifier" pour livre ID: ${bookId} (à implémenter)`);
            });
        });
        document.querySelectorAll('.btn-delete-book').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const bookId = e.currentTarget.dataset.bookId;
                console.log('Delete book ID:', bookId);
                // Future: Show confirmation and delete bookId
                // Remplacer confirm par une modale custom
                // if(confirm(`Êtes-vous sûr de vouloir supprimer ce livre (ID: ${bookId}) ?`)){
                //     console.log("Suppression confirmée pour", bookId);
                // }
                alert(`Action "Supprimer" pour livre ID: ${bookId} (à implémenter avec confirmation)`);
            });
        });
    }

    function setupCatalogListener() {
        if (unsubscribeCatalog) unsubscribeCatalog(); // Unsubscribe from previous listener
        if (!auth.currentUser) return;

        const userBooksRef = db 
          .collection('users')
          .doc(auth.currentUser.uid)
          .collection('books')
          .orderBy('title'); 

        // Updated skeleton to be a bit more representative
        booksListEl.innerHTML = Array(3).fill('').map(() => `
            <div class="skeleton-book-card-catalog"></div>
        `).join('');


        unsubscribeCatalog = userBooksRef.onSnapshot(snapshot => {
          let totalCount = 0;
          let totalPurchaseValue = 0;
          allBooksCache = []; 

          snapshot.forEach(doc => {
            const bookData = doc.data();
            bookData.id = doc.id; 
            allBooksCache.push(bookData);

            const quantity = bookData.quantity || 0;
            totalCount += quantity;
            totalPurchaseValue += (bookData.lastPurchasePrice || 0) * quantity; // Use lastPurchasePrice for value
          });
         
          if (allBooksCache.length === 0) {
               booksListEl.innerHTML = '<p style="text-align:center; padding:1rem; color:var(--secondary-text);">Votre catalogue est vide. Commencez par ajouter des livres via un approvisionnement.</p>';
          } else {
               renderBooks(searchInputCatalogEl.value.trim().toLowerCase()); 
          }

          totalBooksEl.textContent = totalCount.toLocaleString();
          totalValueEl.textContent = totalPurchaseValue.toLocaleString('fr-FR', {style:'currency', currency:'XOF', minimumFractionDigits:0});
        }, err => {
          console.error('Erreur Firestore catalog/books:', err);
          booksListEl.innerHTML = '<p style="text-align:center; padding:1rem; color:var(--ebay-red);">Erreur de chargement du catalogue.</p>';
        });
    }

    function cleanupCatalogListener() {
        if (unsubscribeCatalog) {
          // console.log('Unsubscribing from catalog listener');
          unsubscribeCatalog();
          unsubscribeCatalog = null;
        }
        allBooksCache = []; // Clear cache
        if (booksListEl) booksListEl.innerHTML = ''; // Clear display
        if (totalBooksEl) totalBooksEl.textContent = '0';
        if (totalValueEl) totalValueEl.textContent = 'XOF 0';
    }
   
    auth.onAuthStateChanged(user => {
        if (user) {
            // If the catalog page is already visible, set up the listener
            if (document.getElementById('catalog')?.classList.contains('visible')) {
                setupCatalogListener();
            }
        } else {
            cleanupCatalogListener();
            // Potentially show a "please login" message if catalog page is visible
            if (document.getElementById('catalog')?.classList.contains('visible')) {
                 if (booksListEl) booksListEl.innerHTML = '<p style="text-align:center; padding:1rem;">Veuillez vous connecter pour voir le catalogue.</p>';
            }
        }
    });

    window.addEventListener('hashchange', () => {
        if (location.hash === '#catalog') {
            if (auth.currentUser) setupCatalogListener();
        } else {
            cleanupCatalogListener();
        }
    });
    // Initial check in case the page loads on #catalog
    if (location.hash === '#catalog') {
        if (auth.currentUser) setupCatalogListener();
    }

  })();
  </script>
</main>

  <nav aria-label="Main navigation">
    <div class="nav-inner">
      <a href="#home"    data-hash="home"    class="nav-link active" aria-label="Home">
        <i class="bi bi-house-door-fill"></i><span>Accueil</span> </a>
      <a href="#catalog" data-hash="catalog" class="nav-link" aria-label="Catalog">
        <i class="bi bi-journal-richtext"></i><span>Catalogue</span> </a>
      <a href="#sales"   data-hash="sales"   class="nav-link" aria-label="Sales History"> <i class="bi bi-receipt"></i><span>Ventes</span> </a>
      <a href="#account" data-hash="account" class="nav-link" aria-label="Account">
        <i class="bi bi-person-fill"></i><span>Compte</span> </a>
    </div>
  </nav>

  <main id="activation" class="page">
    <style>
main#activation.page {
  display: none;  padding: 1.5rem; flex-direction: column; 
  align-items: center; justify-content: center; text-align: center;
  height: 100vh; box-sizing: border-box;
}
main#activation.visible { display: flex; }
.activation-container {
  width: 100%; max-width: 360px;  padding: 1rem; 
  background: #fff; border-radius: var(--border-radius-card);
  border: 1px solid var(--border-color); box-shadow: none; /* NO SHADOW */
}
.activation-icon {
  width: 70px; height: 70px; margin: 0 auto 1.25rem; 
  border-radius: 50%; background: rgba(0, 200, 150, 0.1); 
  display: flex; align-items: center; justify-content: center;
}
.activation-icon i { font-size: 1.8rem; color: #00bfa5;  }
main#activation h3 { font-size: 1.3rem; margin-bottom: 0.75rem; font-weight: 600; }
main#activation p {
  color: var(--secondary-text); margin-bottom: 1.25rem; 
  line-height: 1.5; font-size: 0.95rem;
}
.activation-input {
  width: 100%; padding: 0.85rem 1rem; font-size: 1rem; 
  border: 1px solid #ccc; border-radius: var(--border-radius-card); 
  margin-bottom: 1rem; outline: none; text-align: center; 
  letter-spacing: 0.1em; transition: border-color 0.2s ease; box-shadow:none;
}
.activation-input:focus { border-color: var(--accent); }
.activation-btn {
  width: 100%; padding: 0.85rem; font-size: 1rem; font-weight: 600;
  margin-top: 0.5rem; background: var(--accent); color: #fff;
  border: none; border-radius: var(--border-radius-pill); cursor: pointer; box-shadow:none;
}
.activation-btn:active { background: #014fa5; }
.activation-btn:disabled { background: #bfc8d7; cursor: not-allowed; }
</style>

  <div class="activation-container">
    <div class="activation-icon">
      <i class="bi bi-shield-lock-fill"></i> </div>
    <h3>Activation du compte</h3>
    <p>Entrez votre code d’activation reçu pour finaliser l’inscription et accéder à l'application.</p>
    <input
      type="text"
      id="activation-code"
      placeholder="Code d’activation"
      class="activation-input"
      autocomplete="off"
      autocorrect="off"
      autocapitalize="none"
      spellcheck="false"
      maxlength="8" >
    <button id="btn-activate" class="activation-btn">
      Valider le code
    </button>
    <p id="activation-message" style="margin-top: 1rem; font-size: 0.9rem; min-height: 1.2em;"></p>
  </div>
</main>

  <script>
const btnActivate = document.getElementById('btn-activate');
const activationCodeInput = document.getElementById('activation-code');
const activationMessageEl = document.getElementById('activation-message');

if (btnActivate) {
    btnActivate.addEventListener('click', async () => {
      const code = activationCodeInput.value.trim();
      if (!code) {
        activationMessageEl.textContent = 'Veuillez entrer le code.';
        activationMessageEl.style.color = 'var(--ebay-red)';
        activationCodeInput.focus();
        return;
      }
     
      btnActivate.disabled = true;
      btnActivate.textContent = 'Vérification...';
      activationMessageEl.textContent = '';

      try {
        const result = await verifyActivationCode({ code });  
        await auth.currentUser.getIdToken(true); 
        location.hash = '#home'; 
        location.reload(); 
      } catch (err) {
        console.error("Activation error:", err);
        activationMessageEl.textContent = err.message || "Code invalide ou erreur serveur.";
        if (err.code === 'functions/not-found') {
             activationMessageEl.textContent = "Fonction d'activation non disponible.";
        } else if (err.details && err.details.message) {
             activationMessageEl.textContent = err.details.message;
        } else if (err.message) {
             activationMessageEl.textContent = err.message;
        } else {
             activationMessageEl.textContent = "Code invalide ou erreur inconnue.";
        }
        activationMessageEl.style.color = 'var(--ebay-red)';
        btnActivate.disabled = false;
        btnActivate.textContent = 'Valider le code';
      }
    });
}
  </script>

<script>
  // Service Worker Registration
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js') 
        .then(reg => {
          console.log('[App] SW enregistré, scope :', reg.scope);
          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            if (newSW) {
                newSW.addEventListener('statechange', () => {
                if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                    console.log('[App] Nouvelle version disponible → rechargement...');
                    window.location.reload();
                }
                });
            }
            });
        })
        .catch(err => console.error('[App] Échec enregistrement SW :', err));
    });
  }
</script>

<script>
/* === PWA install button === */
let deferredInstallPrompt = null; 
const installButton = document.getElementById('btn-install');

if (installButton) { // Ensure button exists before adding listeners
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();  
      deferredInstallPrompt = e;  
      installButton.style.display = 'block'; 
    });

    installButton.addEventListener('click', async () => {
      if (!deferredInstallPrompt) return;  
      installButton.disabled = true;  
      installButton.textContent = 'Installation...';

      deferredInstallPrompt.prompt();  
      const { outcome } = await deferredInstallPrompt.userChoice;
      deferredInstallPrompt = null;  

      if (outcome === 'accepted') {
        console.log('[PWA] Utilisateur a accepté l\'installation');
        installButton.style.display = 'none';
      } else {
        console.log('[PWA] Utilisateur a refusé l\'installation');
        installButton.style.display = 'block'; 
        installButton.disabled = false;
        installButton.innerHTML = '<i class="bi bi-download" style="margin-right:0.5rem;"></i> Installer l’application';
      }
    });
}


window.addEventListener('appinstalled', () => {
  console.log('[PWA] App installée avec succès 🎉');
  if (installButton) {
    installButton.style.display = 'none';
  }
  deferredInstallPrompt = null; 
});
</script>
  <script>
  // Main Router and Auth Guard
  ;(function() {
    const allPages  = document.querySelectorAll('main.page'); 
    const mainNav   = document.querySelector('nav'); 
    let userActivated = false; 
    let currentAuthUser = null; 

    function showOnlyPage(pageIdToShow) { 
      let pageFound = false;
      allPages.forEach(p => {
        const isVisible = p.id === pageIdToShow;
        p.classList.toggle('visible', isVisible);
        if (isVisible) {
            pageFound = true;
            // Specific actions when a page becomes visible
            if (p.id === 'catalog' && auth.currentUser) {
              // The catalog's own script will handle setup via hashchange/authstatechange
            } else if (p.id === 'supply' && auth.currentUser) {
              // The supply page's own script will handle setup
            } else if (p.id === 'sales' && auth.currentUser) { // ADDED FOR SALES
              // The sales page's own script will handle setup
            } else if (p.id === 'sell' && auth.currentUser) {
              // The sell page's own script (MutationObserver or similar) handles setup
            } else if (p.id === 'add-book-modal') { // Handle modal "page"
                // document.body.style.overflow = 'hidden'; // Prevent body scroll when modal is open
            }
        } else {
             // Specific cleanup when a page is hidden
            if (p.id === 'catalog') {
              // The catalog's own script will handle cleanup via hashchange
            } else if (p.id === 'supply') {
              // The supply page's own script will handle cleanup
            } else if (p.id === 'sales') { // ADDED FOR SALES
              // The sales page's own script will handle cleanup
            } else if (p.id === 'add-book-modal') {
                // document.body.style.overflow = ''; // Restore body scroll
                // document.body.classList.remove('keyboard-visible');
            }
        }
      });

      if (!pageFound) { 
        console.warn(`Page "${pageIdToShow}" not found, redirecting to home.`);
        location.hash = '#home'; 
        return; 
      }
     
      const pagesWithoutNav = ['activation','sell','new-supply','select-book', 'add-book-modal']; 
      if (mainNav) { // Check if mainNav exists
        if (pagesWithoutNav.includes(pageIdToShow)) { 
            mainNav.style.display = 'none';
        } else {
            mainNav.style.removeProperty('display');
        }
      }


      document.querySelectorAll('[data-hash]').forEach(el =>
        el.classList.toggle('active', el.dataset.hash === pageIdToShow)
      );

      const activePageElement = document.getElementById(pageIdToShow);
      if (activePageElement && pageIdToShow !== 'add-book-modal') { // Don't scroll for modal overlay
        activePageElement.scrollTop = 0;
      }
    }
   
    async function route() {
      if (currentAuthUser === undefined) { // Auth state not yet determined
        document.body.style.visibility = 'hidden'; 
        return;
      }
      document.body.style.visibility = 'visible';

      let hashKey = location.hash.slice(1) || 'home';

      // Handle modal display logic without breaking back button for non-modal pages
      if (hashKey === 'add-book-modal') {
          // Show the modal page, but don't necessarily hide the underlying page (e.g. select-book)
          // The modal itself is an overlay. We make its 'main.page' container visible.
          // The underlying page (e.g. select-book) should remain visible if it was the previous route.
          // This simple router doesn't have a concept of "overlay" routes easily.
          // For now, `showOnlyPage` will make `add-book-modal` the *only* visible `main.page`.
      }


      if (!currentAuthUser) { // User is null (not logged in)
          userActivated = false; 
          // Allow access only to login.html (which is not part of this SPA's routing)
          // Or, if login was a hash route like #login, handle it here.
          // Since login.html is separate, this router assumes user is logged in if not on login.html
          // This part is mostly handled by onAuthStateChanged redirect
          if (window.location.pathname.endsWith('login.html')) {
              // We are on login page, let it handle itself.
          } else if (hashKey !== 'activation') { // If somehow past login page without user, redirect
              // This scenario should be caught by onAuthStateChanged which redirects to login.html
              // window.location.replace('login.html');
          }
          // If login.html isn't the current page, onAuthStateChanged handles redirection.
          // If it IS login.html, we don't want this router to interfere.
          return; // Stop further routing if user is not logged in and not on login page
      }


      // User is logged in (currentAuthUser is not null)
      if (!userActivated && hashKey !== 'activation') {
        if (location.hash !== '#activation') location.hash = '#activation';
        showOnlyPage('activation');
        return;
      }
      if (userActivated && hashKey === 'activation') { 
         location.hash = '#home';
         showOnlyPage('home');
         return;
      }
     
      showOnlyPage(hashKey);
    }

    // Set initial auth state to undefined to wait for first onAuthStateChanged
    currentAuthUser = undefined; 
    document.body.style.visibility = 'hidden';


    auth.onAuthStateChanged(async user => {
      currentAuthUser = user; 
      if (!user) {
        userActivated = false; 
        if (!window.location.pathname.endsWith('login.html')) {
            window.location.replace('login.html'); 
        } else {
            document.body.style.visibility = 'visible'; // Make login page visible
        }
        return;
      }

      // User is logged in, try to get claims
      try {
        const idTokenResult = await user.getIdTokenResult(true); 
        userActivated = !!idTokenResult.claims.activated;
      } catch (error) {
        console.error("Error getting ID token result:", error);
        userActivated = false; 
        // If critical error, might sign out or show error page
        // For now, assume not activated and let logic proceed to activation page if needed
      }
     
      route(); // Call route after auth state and claims are processed
    });

    window.addEventListener('hashchange', route);

    document.body.addEventListener('click', e => {
      const dataHashElement = e.target.closest('[data-hash]');
      if (!dataHashElement) return;

      if (dataHashElement.classList.contains('nav-link')) {
        const rect = dataHashElement.getBoundingClientRect();
        const rippleSize = Math.max(rect.width, rect.height);
        const rippleSpan = document.createElement('span');
        rippleSpan.className = 'ripple';
        rippleSpan.style.width = rippleSpan.style.height = rippleSize + 'px';
        rippleSpan.style.left = (e.clientX - rect.left - rippleSize/2) + 'px';
        rippleSpan.style.top  = (e.clientY - rect.top  - rippleSize/2) + 'px';
       
        const existingRipple = dataHashElement.querySelector('.ripple');
        if (existingRipple) existingRipple.remove();
       
        dataHashElement.appendChild(rippleSpan);
        rippleSpan.addEventListener('animationend', () => rippleSpan.remove(), {once: true});
      }

      if (dataHashElement.tagName === 'A' && dataHashElement.getAttribute('href')?.startsWith('#')) {
        // e.preventDefault(); // Default is already handled by browser for hash links. We just update state.
      }
      // Only change hash if it's different, to prevent re-triggering if already on the page
      // or if an action within the page (not a nav link) has a data-hash for other purposes.
      if (location.hash !== '#' + dataHashElement.dataset.hash) {
         location.hash = dataHashElement.dataset.hash; // This will trigger 'hashchange' and then route()
      } else if (location.hash === '#' + dataHashElement.dataset.hash && dataHashElement.classList.contains('nav-link')) {
        // If clicking the active nav link, still call route to ensure page is scrolled to top etc.
        route();
      }
    });

  })();
  </script>

</body>
</html>
