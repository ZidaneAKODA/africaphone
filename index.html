
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>BookShop</title>


  <link rel="manifest" href="manifest.json">
<meta name="mobile-web-app-capable" content="yes">
   <style>
    body { visibility: hidden; }
  </style>

  <!-- Google Fonts & Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
 <!-- 1) Firebase (compat) SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-functions-compat.js"></script>

  <!-- 2) Initialisation Firebase & Auth -->
  <script>
    // Remplace par ta config
    const firebaseConfig = {
      apiKey: "AIzaSyCvNZ5lhKdP_6W-eRle-7zCmFqejSfRuto",
      authDomain: "shoptel-35c7e.firebaseapp.com",
      projectId: "shoptel-35c7e",
      storageBucket: "shoptel-35c7e.appspot.com",
      messagingSenderId: "541177101809",
      appId: "1:541177101809:web:5ae3ea186f198558371850",
      measurementId: "G-VH4MCV6Y6E"
    };

  // 1) Initialise l’app et Auth UNE SEULE FOIS
  firebase.initializeApp(firebaseConfig);


  // 2) Dès que l’état d’auth est connu…
  
const auth   = firebase.auth();
const fn     = firebase.functions();
const db = firebase.firestore();

// fonction callable pour vérifier le code
const verifyActivationCode = fn.httpsCallable('verifyActivationCode');



  
  </script>

 
  

  <style>
   /* ——— Gestion de la visibilité des “pages” ——— */
main.page {
  display: none;           /* cachée par défaut */
  flex: 1 1 auto;          /* occupe l’espace restant */
  width: 100%;             /* toute la largeur */
  overflow-y: auto;        /* scroll interne si besoin */
  /* padding-bottom pour laisser la place à la nav en bas */
  padding-bottom: calc(56px + env(safe-area-inset-bottom));
}

main.page.visible {
  display: flex;           /* devient visible et flex */
  flex-direction: column;
}


    :root{
      --primary-text:#222;
      --secondary-text:#555;
      --border-radius-pill:2rem;
      --ebay-red:#e53238;
      --ebay-blue:#0064d2;
      --ebay-yellow:#f5af02;
      --ebay-green:#86b817;
      --accent:#0064d2;
    }
    *,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

    html,body{
      width:100%;height:100%;
      font-family:'Roboto',sans-serif;
      background:#fff;color:var(--primary-text);
      -webkit-font-smoothing:antialiased;
      touch-action:manipulation;
      -webkit-tap-highlight-color:transparent;
      display:flex;flex-direction:column;
      height:100vh;height:100dvh;
    }

    /* PAGE MANAGEMENT */
    /* Nouveau code à copier-coller */
.page {
  display: none;           /* cachée par défaut */
  flex: 1 1 auto;          /* grandit pour remplir l’espace */
  width: 100%;             /* occupe toute la largeur */
  overflow-y: auto;        /* scroll interne si besoin */
}

.page.visible {
  display: flex;           /* devient un flex-container vertical */
  flex-direction: column;
}


    /* COMMON STYLES */
    header{padding:1rem 1rem 0.5rem}
    .cart{margin-left:auto;font-size:1.6rem;color:var(--primary-text)}

    .search-wrapper{
      margin-top:0.75rem;position:relative
    }
    .search-wrapper input{
      width:100%;padding:0.75rem 3.25rem 0.75rem 2.75rem;
      border:none;border-radius:var(--border-radius-pill);
      background:#f4f4f4;font-size:1rem;outline:none;cursor:pointer
    }
    .search-wrapper .bi-search{
      position:absolute;left:1rem;top:50%;
      transform:translateY(-50%);font-size:1.1rem;color:var(--secondary-text)
    }
    .search-wrapper .actions{
      position:absolute;right:0.75rem;top:50%;
      transform:translateY(-50%);display:flex;gap:0.5rem;
      font-size:1.6rem;color:var(--secondary-text)
    }

    .signin-card{text-align:center;margin:0.5rem 0 1.2rem}
    .signin-card p{
      font-size:1.05rem;color:var(--secondary-text);
      margin-bottom:1rem;line-height:1.4
    }
    .signin-actions{display:flex;justify-content:center;gap:1rem}

    .btn-outline{
      flex:0 0 42%;padding:0.7rem 1rem;border:2px solid var(--accent);
      border-radius:var(--border-radius-pill);background:#fff;
      font-weight:500;color:var(--accent);font-size:1rem;
      transition:all 0.2s ease;outline:none
    }
    .btn-outline:active{background:var(--accent);color:#fff}

    .promo-block{
      background:#f5f5f5;padding:1.5rem 1rem;margin-bottom:1.2rem
    }
    .promo-block h2{font-size:1.6rem;margin-bottom:0.5rem}
    .promo-block p{
      color:var(--secondary-text);font-size:1rem;line-height:1.4;margin-bottom:1rem
    }
    .btn-primary{
      padding:0.85rem 1.5rem;background:var(--accent);color:#fff;border:none;
      border-radius:var(--border-radius-pill);font-size:1rem;font-weight:600;
      box-shadow:0 4px 10px rgba(0,0,0,0.1);outline:none
    }
    .btn-primary:active{background:#014fa5}

    .trending{padding:0 1rem 5.5rem}
    .trending h3{font-size:1.35rem;margin-bottom:0.75rem}
    .trend-list{
      display:flex;gap:1.25rem;overflow-x:auto;padding-bottom:0.5rem;
      -ms-overflow-style:none;scrollbar-width:none
    }
    .trend-list::-webkit-scrollbar{display:none}
    .trend-item{
      flex:0 0 auto;text-align:center;user-select:none;padding:0.5rem
    }
    .trend-item img{
      width:5.3rem;height:5.3rem;border-radius:50%;object-fit:cover;
      box-shadow:0 2px 6px rgba(0,0,0,0.12)
    }
    .trend-item .product-name{display:block;margin-top:0.5rem;font-weight:500}
    .trend-item .price{
      display:block;margin:0.25rem 0 0.75rem;color:var(--ebay-red);font-weight:600
    }
    .btn-add{font-size:0.85rem;padding:0.4rem 0.8rem}

    /* NAVIGATION BAR */
    nav{
      position:fixed;bottom:0;left:0;width:100%;background:#fff;
      border-top:1px solid #e0e0e0;z-index:30
    }
    .nav-inner{display:flex;justify-content:space-evenly;align-items:center;padding:0.4rem 0}
    .nav-link{
      flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
      font-size:0.8rem;color:var(--secondary-text);outline:none;user-select:none;
      position:relative;overflow:hidden;padding:0.6rem 0;border-radius:var(--border-radius-pill);
      background:none;border:none;cursor:pointer;text-decoration:none
    }
    .nav-link i{font-size:1.25rem}
    .nav-link.active{color:var(--accent);background:rgba(0,100,210,0.12)}

    /* RIPPLE EFFECT */
    .ripple{
      position:absolute;border-radius:50%;transform:scale(0);
      background:rgba(0,100,210,0.25);animation:ripple 600ms linear;pointer-events:none
    }
    @keyframes ripple{to{transform:scale(4);opacity:0}}

    /* CATALOG OVERLAY (devient id="catalog") */
    #catalog{
      position:fixed;inset:0;z-index:20;padding:1rem;background:#fff;
      display:flex;flex-direction:column;height:100vh;
      opacity:0;pointer-events:none;transform:translateY(2%);
      transition:opacity 0.3s ease,transform 0.3s ease
    }
    #catalog.visible{
      opacity:1;pointer-events:auto;transform:translateY(0)
    }

    /* === Home page actions === */
    .home-actions{
      display:flex;justify-content:space-around;gap:1rem;padding:1rem
    }
    .btn-action{
      flex:1;display:flex;align-items:center;justify-content:center;gap:0.5rem;
      padding:0.8rem 1rem;border:none;border-radius:var(--border-radius-pill);
      font-size:1rem;font-weight:500;box-shadow:0 2px 6px rgba(0,0,0,0.12);
      transition:transform 0.1s ease,box-shadow 0.1s ease;color:#fff;cursor:pointer
    }
    .btn-action:active{transform:translateY(1px);box-shadow:0 1px 3px rgba(0,0,0,0.2)}
    .btn-sell{background:var(--ebay-green)}
    .btn-buy {background:var(--ebay-blue)}

    /* === Stock info card === */
    .stock-card{
      background:var(--ebay-yellow);border-radius:var(--border-radius-pill);
      margin:0 1rem 1.5rem;padding:0.75rem 1rem;text-align:center;
      box-shadow:0 2px 6px rgba(0,0,0,0.1)
    }
    .stock-count{font-size:1.8rem;font-weight:700;color:var(--primary-text)}
    .stock-label{font-size:0.95rem;color:var(--secondary-text)}

    /* ---------- Info cards sans ombre, avec cadre ---------- */
.info-cards {
  display: flex;
  gap: 0.5rem;                /* espace réduit */
  padding: 0.5rem 1rem;       /* haut/bas + cotés */
  margin-bottom: 0.5rem;      /* pour espacer du contenu suivant */
  overflow-x: auto;           /* scroll si besoin */
}

.info-card {
  flex: 1;
  background: #fff;                     /* fond blanc pour bien contraster */
  border: 1px solid #ddd;              /* cadre fin, gris clair */
  border-radius: 0.5rem;               /* bords légèrement arrondis */
  padding: 0.6rem;                      /* padding interne réduit */
  text-align: center;
  min-width: 0;                         /* empêche le dépassement */
}

.info-number {
  font-size: 1.2rem;                    /* taille de police compacte */
  font-weight: 600;
  color: var(--ebay-blue);
  line-height: 1.2;
}

.info-label {
  font-size: 0.75rem;                   /* légende plus petite */
  color: var(--secondary-text);
  margin-top: 0.2rem;
}
.info-cards {
  /* transition douce sur opacité et hauteur */
  transition: opacity 0.3s ease, max-height 0.3s ease, margin-bottom 0.3s ease, padding 0.3s ease;
  /* fixer une hauteur max suffisante pour le contenu */
  max-height: 200px;        /* ajustez selon la hauteur de vos cards */
  overflow: hidden;
}

.info-cards.fade-out {
  opacity: 0;
  max-height: 0;
  margin-bottom: 0;
  padding-top: 0;
  padding-bottom: 0;
  pointer-events: none;     /* pour ne plus capter les clics */
}


/* Add this below your existing .info-card styles */

.books-list {
  display: flex;
  flex-direction: column;      /* vertical stack */
  gap: 1rem;                   /* space between cards */
  padding: 1rem;               /* inner spacing */
}

.book-card {
  border: 1px solid #ddd;
  border-radius: 0.5rem;
  padding: 1rem;
  background: #fff;
  box-shadow: 0 2px 6px rgba(0,0,0,0.05);
}

.book-title {
  font-size: 1.2rem;
  font-weight: 600;
  margin-bottom: 0.5rem;
  color: var(--primary-text);
}

.book-price {
  font-size: 1rem;
  font-weight: 500;
  color: var(--ebay-red);
  margin-bottom: 0.25rem;
}

.book-quantity {
  font-size: 0.9rem;
  color: var(--secondary-text);
}


/* Réduire l’espace au-dessus de la barre de recherche sur la page Catalog */
main#catalog > header {
  padding-top: 0.5rem; /* Avant : 1rem ; ajustez à votre goût */
}

/* (Optionnel) Si vous préférez bouger la barre elle-même */
main#catalog .search-wrapper {
  margin-top: -0.25rem; /* déplace la barre vers le haut */
}

/* 1) On force la carte à 100% de la largeur du conteneur */
.books-list .book-card {
  width: 100%;               /* pleine largeur */
  box-sizing: border-box;    /* inclut le padding/les bordures */
  margin: 0 auto;            /* centre au cas où tu fixes un max-width */
}

/* dans ta feuille de styles, après les définitions existantes */

main#catalog {
  padding: 0;
  margin: 0;
}





  </style>
</head>

<body>

  <script>
  class AppInput extends HTMLElement {
    constructor() {
      super();
      const shadow = this.attachShadow({ mode: 'open' });
      const inp = document.createElement('input');

      // 1) Ajoute les attributs anti-autocomplete
      inp.setAttribute('autocomplete', 'off');
      inp.setAttribute('autocorrect',  'off');
      inp.setAttribute('autocapitalize', 'none');
      inp.setAttribute('spellcheck',    'false');

      // 2) Reflète à la volée les attributs usuels passés sur <app-input>
      ['type','placeholder','name','id','value','list'].forEach(name => {
        if (this.hasAttribute(name)) {
          inp.setAttribute(name, this.getAttribute(name));
        }
      });

      // 3) Réinjecte dans le DOM
      shadow.appendChild(inp);
    }
  }

  customElements.define('app-input', AppInput);
</script>


  <!-- HOME PAGE -->
  <main id="home" class="page visible">
    <header><h2 style="padding:1rem">Acceuil</h2></header>

    <!-- Action buttons -->
    <div class="home-actions">
      <button class="btn-action btn-sell" data-hash="sell" aria-label="Sell">
        <i class="bi bi-tag-fill"></i><span>Vendre</span>
      </button>
      <button class="btn-action btn-buy" data-hash="supply" aria-label="Approvisionnement">
        <i class="bi bi-cart-fill"></i><span>Approvisionnement</span>
      </button>

      <!-- Bouton PWA hidden par défaut -->
<button id="btn-install" class="btn-primary"
        style="display:none;margin:0 1rem 1rem 1rem;">
  <i class="bi bi-download" style="margin-right:0.5rem;"></i>
  Installer l’application
</button>

    </div>
  </main>

  <!-- SELL PAGE -->
<main id="sell" class="page">
  <!-- Styles spécifiques à la page SELL -->
  <style>
/* === Styles spécifiques à la page SELL === */
#sell .sell-header {
  display: flex;
  align-items: center;
  padding: 0.75rem 1rem;
  background: #fff;
  border-bottom: 1px solid #e0e0e0;
}

#sell .sell-header .btn-close {
  flex: 0 0 auto;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0.5rem;
  background: none;
  border: none;
  font-size: 1.5rem;
  color: var(--primary-text);
  margin-right: 0.75rem;
  cursor: pointer;
  outline: none;
}

#sell .sell-header .search-wrapper {
  flex: 1;
  position: relative;
  margin-top: 0;
}

#sell .sell-header .search-wrapper .bi-search {
  position: absolute;
  left: 1rem;
  top: 50%;
  transform: translateY(-50%);
  font-size: 1.1rem;
  color: var(--secondary-text);
}

#sell .sell-header #search-input-sell {
  width: 100%;
  padding: 0.75rem 2.5rem;
  border: none;
  border-radius: var(--border-radius-pill);
  font-size: 1rem;
  outline: none;
}

#sell .sell-header .search-wrapper .actions {
  position: absolute;
  right: 1rem;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  gap: 0.5rem;
  font-size: 1.6rem;
  color: var(--secondary-text);
}

/* === Styles pour les book-cards et le bouton d'ajout au panier === */
#sell .book-card {
  position: relative;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 0.5rem;
  padding: 1rem;
  margin-bottom: 1rem;
}

#sell .book-card .btn-add-to-cart {
  position: absolute;
  top: 0.75rem;
  right: 0.75rem;
  width: 2.5rem;
  height: 2.5rem;
  border: none;
  border-radius: 50%;
  background: var(--ebay-blue);
  display: flex;
  align-items: center;
  justify-content: center;
  color: #fff;
  font-size: 1.4rem;
  cursor: pointer;
  box-shadow: none;
  transition: background 0.2s ease;
}

#sell .book-card .btn-add-to-cart:hover {
  background: #0052a3;
}

#sell .book-card .btn-add-to-cart:active {
  background: #004080;
}
/* après vos styles existants, idéalement à la toute fin de votre feuille */
main.page {
  /* 56px = hauteur approximative de votre nav + 1rem de marge de confort */
  padding-bottom: calc(56px + env(safe-area-inset-bottom));
}


</style>


  <!-- Barre de recherche (mise à jour) -->
  <header class="sell-header">
    <button class="btn-close" data-hash="home" aria-label="Quitter la page de vente">
      <i class="bi bi-x-lg"></i>
    </button>
    <div class="search-wrapper">
      <i class="bi bi-search"></i>
      <input
        type="search"
        id="search-input-sell"
        placeholder="Rechercher"
        aria-label="Recherche catalogue"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
      >
      <div class="actions">
        <i class="bi bi-cart"></i>
      </div>
    </div>
  </header>

  <!-- Liste des livres -->
  <div id="catalog-results-sell">
    <div class="books-list">
     <div class="book-card">
  <h4 class="book-title">The Great Gatsby</h4>
  <p class="book-price">$10.99</p>
  <p class="book-quantity">Quantity: 3</p>

  <!-- Nouveau bouton d'ajout -->
  <button class="btn-add-to-cart" aria-label="Ajouter au panier">
    <i class="bi bi-cart-plus"></i>
  </button>
</div>

      <div class="book-card">
        <h4 class="book-title">1984</h4>
        <p class="book-price">$8.50</p>
        <p class="book-quantity">Quantity: 5</p>
      </div>
      <!-- répétez autant de .book-card que nécessaire -->
    </div>
  </div>
</main>

<!-- APPROVISIONNEMENT PAGE -->
<main id="supply" class="page">
  <style>
    /* === Styles Approvisionnement === */
    header#supply-header {
      padding: 1rem;
      background: #fff;
      border-bottom: 1px solid #e0e0e0;
    }
    header#supply-header h2 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
      color: var(--primary-text);
    }

    .books-list {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
    }
    .book-card {
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      padding: 1rem;
      background: #fff;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      position: relative;
    }
    .book-title {
      font-size: 1.2rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: var(--primary-text);
    }
    .book-quantity {
      font-size: 0.9rem;
      color: var(--secondary-text);
      margin-bottom: 0.25rem;
    }
    .book-price {
      font-size: 1rem;
      font-weight: 500;
      color: var(--ebay-red);
      margin-bottom: 0.25rem;
    }
    .book-date {
      font-size: 0.75rem;
      color: var(--secondary-text);
    }

    /* Floating Action Button */
    .fab {
      position: fixed;
      bottom: calc(56px + env(safe-area-inset-bottom) + 1rem);
      right: 1rem;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: var(--ebay-green);
      color: #fff;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      z-index: 30;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .fab:active {
      background: #5ea83a;
    }
  </style>

  <!-- En-tête -->
  <header id="supply-header">
    <h2>Approvisionnement</h2>
  </header>

  <!-- Liste hard-codée des approvisionnements passés -->
  <div id="supply-list" class="books-list">
    <div class="book-card">
      <h4 class="book-title">The Great Gatsby</h4>
      <p class="book-quantity">Quantité : 3</p>
      <p class="book-price">€10.99</p>
      <small class="book-date">Le 01/05/2025</small>
    </div>
    <div class="book-card">
      <h4 class="book-title">1984</h4>
      <p class="book-quantity">Quantité : 5</p>
      <p class="book-price">€8.50</p>
      <small class="book-date">Le 10/04/2025</small>
    </div>
  </div>

  <!-- Bouton flottant “Nouvel approvisionnement” -->
  <button id="btn-new-supply" class="fab" aria-label="Nouvel approvisionnement">
    <i class="bi bi-plus-lg"></i>
  </button>

  <script>
    // Gestion du clic sur le FAB
    document.getElementById('btn-new-supply')
      .addEventListener('click', () => {
        // Ex : passer à une page/#new-supply ou ouvrir un modal
        location.hash = 'new-supply';
      });
  </script>
</main>
<main id="new-supply" class="page">

  <!-- 1) Styles -->
  <style>
    :root {
      --primary: #212121;
      --secondary: #616161;
      --accent: #6200ee;
      --surface: #ffffff;
      --elevation: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
      --spacing: 1rem;
      --radius: 0.5rem;
    }
    /* Conteneur global */
    #new-supply {
      display: none;
      flex-direction: column;
      height: 100vh;
      background: var(--surface);
      font-family: 'Roboto', sans-serif;
      color: var(--primary);
    }
    #new-supply.visible { display: flex; }

    /* Étapes du wizard */
    .step {
      display: none;
      flex: 1;
      padding: var(--spacing);
      overflow-y: auto;
    }
    .step.active {
      display: flex;
      flex-direction: column;
    }

    h2 {
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: var(--spacing);
    }

    /* Inputs & labels */
    .form-group {
      margin-bottom: var(--spacing);
    }
    label {
      display: block;
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
      color: var(--secondary);
    }
    input[list],
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #ddd;
      border-radius: var(--radius);
      font-size: 1rem;
      margin-bottom: 0.5rem;
      outline: none;
    }

    /* Bouton flottant “+ ligne” */
    .fab {
      align-self: flex-end;
      margin-bottom: var(--spacing);
      width: 48px; height: 48px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      box-shadow: var(--elevation);
      cursor: pointer;
    }
    .fab:active { background: #5300cc; }

    /* Template ligne */
    .line-row {
      display: grid;
      grid-template-columns: 2fr 1fr 1fr auto auto;
      gap: 0.5rem;
      align-items: center;
      background: var(--surface);
      box-shadow: var(--elevation);
      border-radius: var(--radius);
      padding: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .line-total {
      font-weight: 600;
      text-align: right;
      color: var(--accent);
    }
    .remove-line {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: #e53935;
      cursor: pointer;
    }

    /* Navigation wizard */
    .wizard-nav {
      display: flex;
      justify-content: space-between;
      margin-top: auto;
    }
    .btn {
      flex: 1;
      padding: 0.75rem;
      border-radius: var(--radius);
      font-size: 1rem;
      font-weight: 500;
      border: none;
      outline: none;
    }
    .btn + .btn { margin-left: 0.5rem; }
    .btn.primary {
      background: var(--accent);
      color: #fff;
    }
    .btn.primary:disabled {
      background: #ccc;
      color: #666;
    }
    .btn.secondary {
      background: #f5f5f5;
      color: var(--primary);
    }
    .btn.secondary:disabled {
      opacity: 0.6;
    }

    /* Résumé */
    .summary {
      padding: var(--spacing);
      background: var(--surface);
      box-shadow: var(--elevation);
      border-radius: var(--radius);
      margin-bottom: var(--spacing);
    }
    .summary div {
      font-size: 1rem;
      margin-bottom: 0.25rem;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 16px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.8);
      color: #fff;
      padding: 0.75rem 1.5rem;
      border-radius: 4px;
      font-size: 0.9rem;
      z-index: 100;
    }
    /* ————— Regrouper Qté & Prix unitaire sur la même ligne ————— */
#new-supply .line-row {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
}

/* Le champ “Livre” reste 100% */
#new-supply .line-row .book-search {
  flex: 1 1 100%;
  box-sizing: border-box;
}

/* Qté et Prix unitaire côte‐à‐côte */
#new-supply .line-row .line-qty,
#new-supply .line-row .line-cost {
  flex: 1 1 calc(50% - 0.25rem); /* deux colonnes égales */
  min-width: 120px;             /* pour éviter que ce soit trop étroit */
}

/* Total et bouton Supprimer restent taille auto */
#new-supply .line-row .line-total,
#new-supply .line-row .remove-line {
  flex: 0 0 auto;
}

  </style>

  <!-- 2) Template HTML pour une ligne -->
  <template id="tmpl-line">
    <div class="line-row" data-id="">
      <input type="text" class="book-search" list="" placeholder="Livre">
      <input type="number" class="line-qty" min="1" value="1">
      <input type="number" class="line-cost" step="0.01" value="0.00">
      <div class="line-total">€0.00</div>
      <button type="button" class="remove-line" aria-label="Supprimer">×</button>
    </div>
  </template>

  <!-- 3) Étape 1 : Fournisseur -->
  <div class="step active" data-step="1">
    <h2>Fournisseur</h2>
    <div class="form-group">
      <label for="supplier-search">Nom du fournisseur</label>
      <input type="search"
             id="supplier-search"
             placeholder="Rechercher ou saisir un fournisseur"
             autocomplete="off"
              autocorrect="off"
              autocapitalize="none"
              spellcheck="false"
             >
    </div>
    <div class="wizard-nav">
      <button type="button" class="btn secondary" data-next disabled>
        Suivant →
      </button>
    </div>
  </div>

  <!-- 4) Étape 2 : Lignes de commande -->
  <div class="step" data-step="2">
    <h2>Articles</h2>
    <div id="lines-container"></div>
    <button type="button"
            id="add-line-btn"
            class="fab"
            aria-label="Ajouter une ligne">+</button>
    <div class="wizard-nav">
      <button type="button" class="btn secondary" data-prev>
        ← Précédent
      </button>
      <button type="button" class="btn primary" data-next disabled>
        Suivant →
      </button>
    </div>
  </div>

  <!-- 5) Étape 3 : Résumé & validation -->
  <div class="step" data-step="3">
    <h2>Résumé</h2>
    <div class="summary">
      <div>Total quantités : <span id="sum-qty">0</span></div>
      <div>Coût total : <span id="sum-cost">€0.00</span></div>
    </div>
    <div class="wizard-nav">
      <button type="button" class="btn secondary" data-prev>
        ← Précédent
      </button>
      <button type="button" id="submit-supply" class="btn primary" disabled>
        Valider et envoyer
      </button>
    </div>
  </div>
</main>

<!-- 6) Script de contrôle (Firebase, wizard, draft, envoi) -->
<script>
  (function(){
    // — Références Firebase —
    const db = firebase.firestore();
    const auth = firebase.auth();

    // — DOM —
    const main = document.getElementById('new-supply');
    main.classList.add('visible');
    const steps = [...main.querySelectorAll('.step')];
    const supplierInput = main.querySelector('#supplier-search');
    const supplierList  = main.querySelector('#supplier-list');
    const btnNext        = [...main.querySelectorAll('[data-next]')];
    const btnPrev        = [...main.querySelectorAll('[data-prev]')];
    const linesContainer = main.querySelector('#lines-container');
    const addLineBtn     = main.querySelector('#add-line-btn');
    const sumQtyEl       = main.querySelector('#sum-qty');
    const sumCostEl      = main.querySelector('#sum-cost');
    const submitBtn      = main.querySelector('#submit-supply');
    const tmplLine       = document.getElementById('tmpl-line').content;

    // — Wizard —
    let currentStep = 1, totalSteps = 3;
    function showStep(n){
      steps.forEach(s=>s.classList.toggle('active', +s.dataset.step===n));
    }
    btnNext.forEach(b=>b.addEventListener('click', ()=>{
      if(currentStep<totalSteps){
        currentStep++;
        if(currentStep===3) updateSummary();
        showStep(currentStep);
      }
    }));
    btnPrev.forEach(b=>b.addEventListener('click', ()=>{
      if(currentStep>1){
        currentStep--;
        showStep(currentStep);
      }
    }));
    showStep(currentStep);

    // — Chargement fournisseurs —
    const suppliers = [];
    async function loadSuppliers(){
      const snap = await db.collection('suppliers').orderBy('name').get();
      snap.forEach(d=>suppliers.push({ id:d.id, name:d.data().name }));
      suppliers.forEach(s=>{
        const o = document.createElement('option');
        o.value = s.name;
        supplierList.append(o);
      });
    }
    loadSuppliers();

    // — Draft dans localStorage —
    function saveDraft(){
      const lines = [...linesContainer.children].map(r=>({
        title: r.querySelector('.book-search').value,
        qty:   r.querySelector('.line-qty').value,
        cost:  r.querySelector('.line-cost').value
      }));
      localStorage.setItem('draftSupply', JSON.stringify({
        supplier: supplierInput.value,
        lines
      }));
    }
    function loadDraft(){
      const d = JSON.parse(localStorage.getItem('draftSupply')||'{}');
      if(d.supplier) supplierInput.value = d.supplier;
      if(d.lines){
        linesContainer.innerHTML = '';
        d.lines.forEach(l=> addLine(l));
      }
      toggleStep1Next();
      toggleStep2Next();
    }
    window.addEventListener('beforeunload', saveDraft);
    loadDraft();

    // — Étape 1 : validation —
    function toggleStep1Next(){
      main.querySelector('[data-step="1"] [data-next]').disabled =
        supplierInput.value.trim()==='';
    }
    supplierInput.addEventListener('input', toggleStep1Next);

    // — Ajout / gestion des lignes —
    let lineId = 0;
    function addLine(data={}){
      lineId++;
      const clone = document.importNode(tmplLine,true);
      const row = clone.querySelector('.line-row');
      row.dataset.id = lineId;
      const bookInput = row.querySelector('.book-search');
      const qtyInput  = row.querySelector('.line-qty');
      const costInput = row.querySelector('.line-cost');
      // liste de suggestions dynamiques
      const dl = document.createElement('datalist');
      dl.id = `books-${lineId}`;
      bookInput.setAttribute('list', dl.id);
      row.insertBefore(dl, qtyInput);
      // préremplissage
      if(data.title) bookInput.value = data.title;
      if(data.qty)   qtyInput.value  = data.qty;
      if(data.cost)  costInput.value = data.cost;
      // live-search
      bookInput.addEventListener('input', async ()=>{
        const t = bookInput.value.trim();
        dl.innerHTML = '';
        if(t.length<2) return;
        const snap = await db.collection('books')
          .where('title','>=',t)
          .where('title','<=',t+'\uf8ff')
          .limit(5).get();
        snap.forEach(d=>{
          const o = document.createElement('option');
          o.value = d.data().title;
          o.dataset.id = d.id;
          dl.append(o);
        });
      });
      // calcul total ligne & résumé
      function upd(){
        const q = parseInt(qtyInput.value,10)||0;
        const c = parseFloat(costInput.value)||0;
        row.querySelector('.line-total').textContent = '€'+(q*c).toFixed(2);
        updateSummary();
        toggleStep2Next();
      }
      qtyInput.addEventListener('input', upd);
      costInput.addEventListener('input', upd);
      // suppression
      row.querySelector('.remove-line').addEventListener('click', ()=>{
        row.remove();
        updateSummary();
        toggleStep2Next();
      });
      linesContainer.append(row);
      upd();
    }
    addLineBtn.addEventListener('click', ()=>addLine());

    function toggleStep2Next(){
      main.querySelector('[data-step="2"] [data-next]').disabled =
        linesContainer.children.length===0;
    }

    // — Résumé & validation finale —
    function updateSummary(){
      let sq=0, sc=0;
      [...linesContainer.children].forEach(r=>{
        const q=parseInt(r.querySelector('.line-qty').value,10)||0;
        const c=parseFloat(r.querySelector('.line-cost').value)||0;
        sq+=q; sc+=q*c;
      });
      sumQtyEl.textContent = sq;
      sumCostEl.textContent= '€'+sc.toFixed(2);
      submitBtn.disabled = !(sq>0 && supplierInput.value.trim()!=='');
    }

    // — Envoi vers Firestore —
    submitBtn.addEventListener('click', async ()=>{
      submitBtn.disabled = true;
      const user = auth.currentUser;
      const name = supplierInput.value.trim();
      let sup = suppliers.find(s=>s.name===name);
      if(!sup){
        const r = await db.collection('suppliers').add({ name });
        sup = { id:r.id, name };
      }
      const lines = [...linesContainer.children].map(r=>({
        title: r.querySelector('.book-search').value,
        quantity: parseInt(r.querySelector('.line-qty').value,10),
        unitCost: parseFloat(r.querySelector('.line-cost').value)
      }));
      const totalQty  = parseInt(sumQtyEl.textContent,10);
      const totalCost = parseFloat(sumCostEl.textContent.replace('€',''));
      const batch = db.batch();
      const supplyRef = db
        .collection('users').doc(user.uid)
        .collection('supplies').doc();
      batch.set(supplyRef, {
        supplierId: sup.id,
        supplierName: sup.name,
        date: firebase.firestore.FieldValue.serverTimestamp(),
        lines, totalQty, totalCost
      });
      for(const ln of lines){
        const snap = await db.collection('books')
          .where('title','==',ln.title)
          .limit(1).get();
        if(!snap.empty){
          batch.update(snap.docs[0].ref, {
            quantity: firebase.firestore.FieldValue.increment(ln.quantity)
          });
        }
      }
      await batch.commit();
      localStorage.removeItem('draftSupply');
      window.location.hash = 'supply';
      // toast de confirmation
      const t = document.createElement('div');
      t.className='toast';
      t.textContent='Approvisionnement enregistré !';
      document.body.append(t);
      setTimeout(()=>t.remove(),2000);
    });

  })();
</script>

  <!-- MY ORDERS PAGE -->
  <main id="orders" class="page">
    <header><h2 style="padding:1rem">My Orders</h2></header>
    <p style="padding:0 1rem 6rem">Your recent orders will appear here…</p>
  </main>

  <!-- CART PAGE -->
  <main id="cart" class="page">
    <header><h2 style="padding:1rem">Panier</h2></header>
    <div style="padding:0 1rem 6rem;">
      <p>Votre panier est actuellement vide</p>
      <button class="btn-primary" style="margin-top:1rem;">View recommendations</button>
    </div>
  </main>

 <!-- ACCOUNT PAGE -->
<main id="account" class="page">
  <!-- Styles spécifiques à la page ACCOUNT -->
  <style>
    /* cadre horizontal pour le profil */
#account .profile-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  background: #fff;
  border: 1px solid #ddd;
  border-radius: 0.5rem;
  padding: 1rem;
  margin: 1rem;            /* aligne à gauche dans le flow */
  max-width: none;         /* pleine largeur possible */
  box-shadow: none;        /* comme les autres cadres */
}

/* avatar à gauche, sans centrage */
#account .profile-avatar {
  flex: 0 0 auto;
  margin: 0;
}

/* wrapper texte : colonne, aligné à gauche */
#account .profile-info {
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
  text-align: left;
}

    #account .profile-avatar {
      width: 64px;
      height: 64px;
      background: var(--ebay-blue);
      color: #fff;
      font-weight: bold;
      font-size: 2rem;
      border-radius: 50%;
      margin: 0 auto 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #account h2 { 
      padding: 1rem; 
      font-size: 1.3rem; 
      font-weight: 600; 
    }
    #account #display-name {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    #account #email,
    #account #member-since {
      font-size: 0.95rem;
      color: var(--secondary-text);
      margin-bottom: 0.5rem;
    }

    /* Titres de section */
    #account .section-title {
      padding: 0 1rem;
      margin: 1.5rem 0 0.75rem;
      font-size: 1.15rem;
      font-weight: 600;
      color: var(--primary-text);
    }

    /* Cartes de mises à jour */
    #account .updates-grid {
      display: flex;
      gap: 0.75rem;
      padding: 0 1rem;
    }
    #account .update-card {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 0.5rem;
      padding: 1rem;
      cursor: pointer;
    }
    #account .update-card h4 {
      font-size: 1rem;
      margin: 0 0 0.25rem;
    }
    #account .update-card p {
      font-size: 0.85rem;
      color: var(--secondary-text);
      margin: 0;
    }
    #account .update-card i.bi-chevron-right {
      font-size: 1.2rem;
      color: var(--secondary-text);
    }

    /* Liste de gestion interne */
    #account .menu-list {
      margin-top: 0.5rem;
    }
    #account .menu-item {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #fff;
      border: none;
      border-bottom: 1px solid #eee;
      padding: 0.75rem 1rem;
      cursor: pointer;
    }
    #account .menu-item:last-child {
      border-bottom: none;
    }
    #account .menu-item .item-content {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    #account .menu-item .item-content i {
      font-size: 1.4rem;
      color: var(--accent);
    }
    #account .menu-item span {
      font-size: 1rem;
      font-weight: 500;
      color: var(--primary-text);
    }
    #account .menu-item small {
      display: block;
      font-size: 0.85rem;
      color: var(--secondary-text);
      margin-top: 0.2rem;
      line-height: 1.2;
    }

    /* Bouton de déconnexion */
    #account .btn-signout {
      width: calc(100% - 2rem);
      margin: 1rem;
      padding: 0.75rem 1.2rem;
      font-size: 1rem;
      font-weight: 500;
      border: 2px solid var(--accent);
      border-radius: var(--border-radius-pill);
      background: #fff;
      color: var(--accent);
      cursor: pointer;
      text-align: center;
      transition: background 0.2s, color 0.2s;
    }
    #account .btn-signout:active {
      background: var(--accent);
      color: #fff;
    }

    /* 1) autoriser le wrapping pour qu’un item puisse aller à la ligne suivante */
#account .updates-grid {
  display: flex;
  gap: 0.75rem;
  flex-wrap: wrap;
}

/* 2) forcer la 2ᵉ carte (Commandes récentes) à occuper 100 % de la largeur */
#account .updates-grid .update-card:nth-child(2) {
  flex: 1 1 100%;
  max-width: 100%;
}

/* à la fin de ta feuille, juste pour le bouton */
#btn-install {
  width: calc(100% - 2rem);  /* même marge que les autres cartes */
}


  </style>

  <!-- En-tête -->
  <header><h2>Mon compte</h2></header>

  <div>
    <div class="profile-card">
  <div class="profile-avatar" id="avatar-letter">Z</div>
  <div class="profile-info">
    <div id="display-name">Utilisateur</div>
    <div id="email">email@example.com</div>
    <div id="member-since">Membre depuis: …</div>
  </div>
</div>


    <!-- Vos mises à jour -->
    <div class="section-title">Vos mises à jour</div>
    <div class="updates-grid">
      <div class="update-card" onclick="location.hash='stock-alerts'">
        <div>
          <h4>Alertes de stock</h4>
          <p>Livres bientôt épuisés</p>
        </div>
        <i class="bi bi-chevron-right"></i>
      </div>
      <div class="update-card" onclick="location.hash='orders'">
        <div>
          <h4>Commandes récentes</h4>
          <p>Voir vos dernières commandes</p>
        </div>
        <i class="bi bi-chevron-right"></i>
      </div>
    </div>

    <!-- Gestion interne -->
    <div class="section-title">Gestion</div>
    <div class="menu-list">
      <button class="menu-item" data-hash="inventory">
        <div class="item-content">
          <i class="bi bi-box-seam"></i>
          <div>
            <span>Inventaire</span>
            <small>Gérer vos livres</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
      <button class="menu-item" data-hash="suppliers">
        <div class="item-content">
          <i class="bi bi-people"></i>
          <div>
            <span>Fournisseurs</span>
            <small>Liste des fournisseurs</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
      <button class="menu-item" data-hash="reports">
        <div class="item-content">
          <i class="bi bi-bar-chart-line"></i>
          <div>
            <span>Rapports</span>
            <small>Statistiques & analyses</small>
          </div>
        </div>
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>

    <!-- Déconnexion -->
    <button class="btn-signout" id="btn-signout">Déconnexion</button>
  </div>

  <!-- Script de peuplement & sign out -->
  <script>
    auth.onAuthStateChanged(user => {
      if (user) {
        const name = user.displayName || user.email.split('@')[0] || "Utilisateur";
        document.getElementById('display-name').textContent = name;
        document.getElementById('email').textContent = user.email;
        const creationDate = new Date(user.metadata.creationTime);
        document.getElementById('member-since').textContent =
          'Membre depuis: ' + creationDate.toLocaleDateString(undefined, {
            year: 'numeric', month: 'short', day: 'numeric'
          });
        document.getElementById('avatar-letter').textContent = name[0].toUpperCase();
      }
    });
    document.getElementById('btn-signout').addEventListener('click', () => {
      auth.signOut().then(() => window.location.href = 'login.html');
    });
  </script>
</main>



  <main id="catalog" class="page">
  <!-- barre de recherche … -->
  <header>
    <div class="search-wrapper">
      <i class="bi bi-search"></i>
      <input
        type="search"
        id="search-input"
        placeholder="Rechercher dans le catalogue"
        aria-label="Recherche catalogue"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="none"
        spellcheck="false"
      >
      <div class="actions">
        <i class="bi bi-cart"></i>
      </div>
    </div>
  </header>

  <!-- Info cards (total livres + valeur) -->
  <div class="info-cards">
    <div class="info-card">
      <div class="info-number" id="total-books">0</div>
      <div class="info-label">Total de livres</div>
    </div>
    <div class="info-card">
      <div class="info-number" id="total-value">€0</div>
      <div class="info-label">Valeur totale</div>
    </div>
  </div>

  <!-- conteneur pour les résultats -->
  <div id="catalog-results">
    <div class="books-list"></div>
  </div>

  <!-- ⬇ Ici on encapsule tout le JS catalog ⬇ -->
  <script>
  (function() {
    const booksList      = document.querySelector('#catalog-results .books-list');
    const totalBooksEl   = document.getElementById('total-books');
    const totalValueEl   = document.getElementById('total-value');
    const searchInput    = document.getElementById('search-input');
    const infoCards      = document.querySelector('.info-cards');

    // Masquer les cards lors de la recherche
    searchInput.addEventListener('input', () => {
      if (searchInput.value.trim()) {
        infoCards.classList.add('fade-out');
      } else {
        infoCards.classList.remove('fade-out');
      }
    });

    // Auth + récupération des items
    auth.onAuthStateChanged(user => {
      if (!user) {
        return window.location.replace('login.html');
      }

      const userCatalogRef = db
        .collection('users')
        .doc(user.uid)
        .collection('catalog');

      userCatalogRef.onSnapshot(snapshot => {
        let count = 0;
        let value = 0;
        booksList.innerHTML = '';

        snapshot.forEach(doc => {
          const { title, price, quantity } = doc.data();
          count += quantity;
          value += price * quantity;

          // création du book-card
          const card = document.createElement('div');
          card.className = 'book-card';
          card.innerHTML = `
            <h4 class="book-title">${title}</h4>
            <p class="book-price">€${price.toFixed(2)}</p>
            <p class="book-quantity">Quantité : ${quantity}</p>
          `;
          booksList.appendChild(card);
        });

        totalBooksEl.textContent = count.toLocaleString();
        totalValueEl.textContent = '€' + value.toFixed(2);
      }, err => {
        console.error('Erreur Firestore catalog :', err);
      });
    });
  })();
  </script>
</main>

  
  <!-- NAVIGATION BAR -->
  <nav aria-label="Main navigation">
    <div class="nav-inner">
      <a href="#home"    data-hash="home"    class="nav-link active" aria-label="Home">
        <i class="bi bi-house"></i><span>Home</span>
      </a>
      <a href="#catalog" data-hash="catalog" class="nav-link" aria-label="Catalog">
        <i class="bi bi-search"></i><span>Catalog</span>
      </a>
      <a href="#cart"    data-hash="cart"    class="nav-link" aria-label="Cart">
        <i class="bi bi-cart"></i><span>Cart</span>
      </a>
      <a href="#account" data-hash="account" class="nav-link" aria-label="Account">
        <i class="bi bi-person"></i><span>Account</span>
      </a>
    </div>
  </nav>

  <main id="activation" class="page">
    <style>
/* --- Page Activation --- */
main#activation.page {
  display: none;           /* cachée par défaut, comme les autres pages */
  padding: 0 1.5rem;
  flex-direction: column;  /* comme les autres pages */
  align-items: center;
  justify-content: center;
  text-align: center;
}
main#activation.visible {
  display: flex;
}

.activation-container {
  width: 100%;
  max-width: 360px;   /* pour caler la largeur */
}

.activation-icon {
  width: 80px;
  height: 80px;
  margin: 0 auto 1.5rem;
  border-radius: 50%;
  background: rgba(0, 200, 150, 0.15); /* couleur pastel */
  display: flex;
  align-items: center;
  justify-content: center;
}
.activation-icon i {
  font-size: 2rem;
  color: #00c896;     /* accent color */
}

main#activation h3 {
  font-size: 1.5rem;
  margin-bottom: 0.5rem;
}

main#activation p {
  color: var(--secondary-text);
  margin-bottom: 1.5rem;
  line-height: 1.4;
}

.activation-input {
  width: 100%;
  padding: 0.75rem 1rem;
  font-size: 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  margin-bottom: 1rem;
  outline: none;
}

.activation-btn {
  width: 100%;
  padding: 0.85rem;
  font-size: 1rem;
  font-weight: 600;
  margin-top: 0.5rem;
}
</style>

  <div class="activation-container">
    <div class="activation-icon">
      <i class="bi bi-box-arrow-in-right"></i>
    </div>
    <h3>Activation du compte</h3>
    <p>Entrez votre code d’activation pour finaliser l’inscription.</p>
    <input
      type="text"
      id="activation-code"
      placeholder="Code d’activation"
      class="activation-input"
    >
    <button id="btn-activate" class="btn-primary activation-btn">
      Valider
    </button>
  </div>
</main>

  <!-- SCRIPTS -->
  <script>

    
// gestion du clic “Valider”
document.getElementById('btn-activate').addEventListener('click', async () => {
  const code = document.getElementById('activation-code').value.trim();
  if (!code) return alert('Veuillez entrer le code.');
  try {
    await verifyActivationCode({ code });
    // on force un refresh du token et on recharge
    await auth.currentUser.getIdToken(true);
    location.reload();
  } catch (err) {
    alert(err.message);
  }
});

    /* Tabs inside catalog */
    function toggleTab(tab) {
      ['recent', 'saved'].forEach(t => {
        const el = document.getElementById('tab-' + t);
        el.style.color = '#555';
        el.style.borderBottom = 'none';
      });
      const active = document.getElementById('tab-' + tab);
      active.style.color = '#0064d2';
      active.style.borderBottom = '2px solid #0064d2';
    }



 // ----- Recherche catalogue : fade-out dès la frappe ----- //

const searchInput = document.getElementById('search-input');
const infoCards   = document.querySelector('.info-cards');

// À chaque saisie dans l'input
searchInput.addEventListener('input', () => {
  if (searchInput.value.trim() !== '') {
    infoCards.classList.add('fade-out');
  } else {
    infoCards.classList.remove('fade-out');
  }
});


  </script>

<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('sw.js')
        .then(reg => {
          console.log('[App] SW enregistré, scope :', reg.scope);

          // Dès qu’on déploie une nouvelle version (CACHE_NAME incrémenté)…
          reg.addEventListener('updatefound', () => {
            const newSW = reg.installing;
            newSW.addEventListener('statechange', () => {
              // Quand le nouvel SW est prêt et qu’il y avait déjà un SW actif
              if (newSW.state === 'installed' && navigator.serviceWorker.controller) {
                console.log('[App] Nouvelle version dispo → reload');
                window.location.reload();
              }
            });
          });
        })
        .catch(err => console.error('[App] Échec enregistrement SW :', err));
    });
  }
</script>

<script>
/* === PWA install button === */
let deferredPrompt = null;             // stocke l’évènement

// 1) Le navigateur signale que l'app peut être installée
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();                  // on annule l’invite auto
  deferredPrompt = e;                  // on garde l’objet
  document.getElementById('btn-install').style.display = 'block';   // on révèle le bouton
});

// 2) Clique sur le bouton “Installer”
document.getElementById('btn-install').addEventListener('click', async () => {
  if (!deferredPrompt) return;         // sécurité
  document.getElementById('btn-install').disabled = true;           // évite le spam

  deferredPrompt.prompt();             // ouvre la modale native
  const { outcome } = await deferredPrompt.userChoice;
  deferredPrompt = null;               // on « consomme » l’évènement

  // Si l’utilisateur a installé → on masque définitivement le bouton
  // Sinon on le ré-affiche pour qu’il puisse réessayer plus tard
  document.getElementById('btn-install').style.display =
    (outcome === 'accepted') ? 'none' : 'block';
  document.getElementById('btn-install').disabled = false;
});

// 3) Si l'app est finalement installée (via menu navigateur, etc.)
window.addEventListener('appinstalled', () => {
  console.log('[PWA] App installée 🎉');
  document.getElementById('btn-install').style.display = 'none';
});
</script>
  <script>
  ;(function() {
    const pages     = document.querySelectorAll('.page');
    const nav       = document.querySelector('nav');
    let activated   = false;

    // 1) Auth + activation guard
    auth.onAuthStateChanged(async user => {
      if (!user) {
        window.location.replace('login.html');
        return;
      }
      const tok = await user.getIdTokenResult(true);
      activated = !!tok.claims.activated;
      document.body.style.visibility = 'visible';
      route();
    });

    // 2) Route() unique
    function route() {
      const key = location.hash.slice(1) || 'home';

      // guard activation
      if (!activated && key !== 'activation') {
        history.replaceState(null, '', '#activation');
        return showOnly('activation');
      }

      // fallback if unknown
      if (![...pages].some(p => p.id === key)) {
        location.hash = 'home';
        return showOnly('home');
      }

      // show the requested page
      showOnly(key);
    }

    // helper to show one page, hide others, gérer nav & onglets
    function showOnly(pageId) {
      pages.forEach(p =>
        p.classList.toggle('visible', p.id === pageId)
      );
      if (['activation','sell','supply','new-supply'].includes(pageId)) {
        nav.style.display = 'none';
      } else {
        nav.style.removeProperty('display');
      }
      document.querySelectorAll('[data-hash]').forEach(el =>
        el.classList.toggle('active', el.dataset.hash === pageId)
      );
    }

    // 3) Listeners
    window.addEventListener('hashchange', route);
    document.body.addEventListener('click', e => {
      const el = e.target.closest('[data-hash]');
      if (!el) return;
      if (el.classList.contains('nav-link')) {
        const rect = el.getBoundingClientRect();
        const size = Math.max(rect.width, rect.height);
        const ripple = document.createElement('span');
        ripple.className = 'ripple';
        ripple.style.width = ripple.style.height = size + 'px';
        ripple.style.left = (e.clientX - rect.left - size/2) + 'px';
        ripple.style.top  = (e.clientY - rect.top  - size/2) + 'px';
        el.querySelector('.ripple')?.remove();
        el.appendChild(ripple);
        ripple.addEventListener('animationend', () => ripple.remove());
      }
      if (el.tagName === 'A') e.preventDefault();
      location.hash = el.dataset.hash;
    });

    // Si on est déjà loggé au chargement
    if (auth.currentUser) {
      auth.currentUser.getIdTokenResult(true).then(tok => {
        activated = !!tok.claims.activated;
        document.body.style.visibility = 'visible';
        route();
      });
    }
  })();
  </script>

</body>
</html>
